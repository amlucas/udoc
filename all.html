<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>uDeviceX Documentation</title>
<link rel="stylesheet" href="/udoc/css/main.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>uDeviceX Documentation</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_developer">Developer</a>
<ul class="sectlevel2">
<li><a href="#_build">build</a>
<ul class="sectlevel3">
<li><a href="#_arch_linux">Arch Linux</a></li>
<li><a href="#_after_adding_files">after adding files</a></li>
</ul>
</li>
<li><a href="#_coding_conventions">coding conventions</a>
<ul class="sectlevel3">
<li><a href="#_modules">modules</a></li>
<li><a href="#_naming">naming</a>
<ul class="sectlevel4">
<li><a href="#_variables">variables</a></li>
<li><a href="#_functions">functions</a></li>
</ul>
</li>
<li><a href="#_file_structure">file structure</a></li>
<li><a href="#_style">style</a></li>
</ul>
</li>
<li><a href="#_emacs_setting">emacs setting</a></li>
<li><a href="#_gource_commands">gource commands</a></li>
<li><a href="#_developper_documentaion">developper documentaion</a>
<ul class="sectlevel3">
<li><a href="#_style_and_conventions">style and conventions</a></li>
<li><a href="#_source_code_modules">source code modules</a></li>
<li><a href="#_useful_links">Useful links</a></li>
</ul>
</li>
<li><a href="#_minmax">minmax</a>
<ul class="sectlevel3">
<li><a href="#_example">example</a></li>
<li><a href="#_interface">interface</a></li>
</ul>
</li>
<li><a href="#_scan">scan</a>
<ul class="sectlevel3">
<li><a href="#_interface_2">interface</a></li>
</ul>
</li>
<li><a href="#_body_forces">body forces</a>
<ul class="sectlevel3">
<li><a href="#_data_structures">data structures</a></li>
<li><a href="#_interface_3">interface</a></li>
<li><a href="#_configuration">configuration</a>
<ul class="sectlevel4">
<li><a href="#_none">none</a></li>
<li><a href="#_constant">constant</a></li>
<li><a href="#_double_poiseuille">double poiseuille</a></li>
<li><a href="#_shear">shear</a></li>
<li><a href="#_4_roller_mill">4 roller mill</a></li>
<li><a href="#_radial">radial</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_clist">clist</a>
<ul class="sectlevel3">
<li><a href="#_example_2">example</a></li>
<li><a href="#_data_structures_2">data structures</a>
<ul class="sectlevel4">
<li><a href="#_clist_2">Clist</a></li>
<li><a href="#_map">Map</a></li>
</ul>
</li>
<li><a href="#_interface_4">interface</a></li>
<li><a href="#_algorithm">algorithm</a></li>
</ul>
</li>
<li><a href="#_cnt">cnt</a>
<ul class="sectlevel3">
<li><a href="#_interface_5">interface</a></li>
</ul>
</li>
<li><a href="#_color">color</a>
<ul class="sectlevel3">
<li><a href="#_purpose">purpose</a></li>
<li><a href="#_modules_2">modules</a>
<ul class="sectlevel4">
<li><a href="#_flux">flux</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_comm">comm</a>
<ul class="sectlevel3">
<li><a href="#_purpose_2">purpose</a></li>
<li><a href="#_data_structures_3">data structures</a></li>
<li><a href="#_allocation_mod">allocation mod</a></li>
<li><a href="#_interface_6">interface</a>
<ul class="sectlevel4">
<li><a href="#_memory_management">memory management</a></li>
<li><a href="#_communication">communication</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_contact_forces">contact forces</a></li>
<li><a href="#_control">Control</a>
<ul class="sectlevel3">
<li><a href="#_velocity_controller">Velocity controller</a>
<ul class="sectlevel4">
<li><a href="#_interface_7">interface</a></li>
<li><a href="#_configuration_2">configuration</a></li>
</ul>
</li>
<li><a href="#_inflow">Inflow</a>
<ul class="sectlevel4">
<li><a href="#_interface_8">interface</a></li>
<li><a href="#_configuration_3">configuration</a></li>
</ul>
</li>
<li><a href="#_outflow">Outflow</a>
<ul class="sectlevel4">
<li><a href="#_interface_9">interface</a></li>
<li><a href="#_configuration_4">configuration</a></li>
</ul>
</li>
<li><a href="#_density_controller">Density controller</a></li>
</ul>
</li>
<li><a href="#_coords">coords</a>
<ul class="sectlevel3">
<li><a href="#_data_structures_4">data structures</a></li>
<li><a href="#_host_interface">Host interface</a>
<ul class="sectlevel4">
<li><a href="#_memory_management_2">Memory management</a></li>
<li><a href="#_getters">Getters</a></li>
<li><a href="#_coordinate_transforms">Coordinate transforms</a></li>
<li><a href="#_helpers">helpers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_generic_d_evice_api">generic [d]evice API</a>
<ul class="sectlevel3">
<li><a href="#_interface_10">interface</a></li>
<li><a href="#_configuration_5">configuration</a></li>
</ul>
</li>
<li><a href="#_debug">debug</a>
<ul class="sectlevel3">
<li><a href="#_interface_11">interface</a></li>
<li><a href="#_configuration_6">configuration</a></li>
</ul>
</li>
<li><a href="#_distr">distr</a>
<ul class="sectlevel3">
<li><a href="#_map_2">map</a>
<ul class="sectlevel4">
<li><a href="#_data_structure">data structure</a></li>
<li><a href="#_interface_12">interface</a></li>
</ul>
</li>
<li><a href="#_flu">flu</a>
<ul class="sectlevel4">
<li><a href="#_data_structures_5">data structures</a></li>
<li><a href="#_interface_13">interface</a></li>
</ul>
</li>
<li><a href="#_rbc">rbc</a>
<ul class="sectlevel4">
<li><a href="#_data_structures_6">data structures</a></li>
<li><a href="#_interface_14">interface</a></li>
</ul>
</li>
<li><a href="#_rig">rig</a>
<ul class="sectlevel4">
<li><a href="#_data_structures_7">data structures</a></li>
<li><a href="#_interface_15">interface</a></li>
</ul>
</li>
<li><a href="#_common">common</a></li>
</ul>
</li>
<li><a href="#_fluforces">fluforces</a>
<ul class="sectlevel3">
<li><a href="#_interface_16">interface</a></li>
<li><a href="#_data_structures_8">data structures</a></li>
<li><a href="#_submodules">submodules</a>
<ul class="sectlevel4">
<li><a href="#_bulk">bulk</a></li>
<li><a href="#_fluforces_halo">fluforces: halo</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_fsi">fsi</a>
<ul class="sectlevel3">
<li><a href="#_interface_17">interface</a></li>
</ul>
</li>
<li><a href="#_math">Math</a>
<ul class="sectlevel3">
<li><a href="#_linal">linal</a>
<ul class="sectlevel4">
<li><a href="#_interface_18">interface</a></li>
</ul>
</li>
<li><a href="#_host_random_number_generation">Host random number generation</a>
<ul class="sectlevel4">
<li><a href="#_interface_19">interface</a></li>
</ul>
</li>
<li><a href="#_linar_coordinate_transformation_for_3d_vector">linar coordinate transformation for 3D vector</a>
<ul class="sectlevel4">
<li><a href="#_interface_20">interface</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_parser">parser</a>
<ul class="sectlevel3">
<li><a href="#_purpose_3">purpose</a></li>
<li><a href="#_data_structure_2">data structure</a></li>
<li><a href="#_interface_21">interface</a></li>
</ul>
</li>
<li><a href="#_partlist">partlist</a>
<ul class="sectlevel3">
<li><a href="#_data_structure_3">data structure</a></li>
<li><a href="#_interface_22">interface</a></li>
</ul>
</li>
<li><a href="#_rbc_membrane_forces">RBC membrane forces</a></li>
<li><a href="#_red_blood_cell">Red blood cell</a>
<ul class="sectlevel3">
<li><a href="#_components">components</a></li>
<li><a href="#_cell_templates">cell templates</a></li>
</ul>
</li>
<li><a href="#_random_force">random force</a></li>
<li><a href="#_signed_distance_function_sdf">signed distance function (sdf)</a>
<ul class="sectlevel3">
<li><a href="#_purpose_4">purpose</a></li>
<li><a href="#_implementation">implementation</a></li>
<li><a href="#_components_2">components</a></li>
</ul>
</li>
<li><a href="#_utils">Utils</a>
<ul class="sectlevel3">
<li><a href="#error">error</a>
<ul class="sectlevel4">
<li><a href="#_usage">Usage</a></li>
<li><a href="#_interface_23">Interface</a></li>
</ul>
</li>
<li><a href="#cc">cc</a>
<ul class="sectlevel4">
<li><a href="#_usage_2">Usage</a></li>
</ul>
</li>
<li><a href="#_mc">mc</a>
<ul class="sectlevel4">
<li><a href="#_usage_3">Usage</a></li>
</ul>
</li>
<li><a href="#_kernel_launch_macros">kernel launch macros</a></li>
</ul>
</li>
<li><a href="#_wvel">wvel</a>
<ul class="sectlevel3">
<li><a href="#_purpose_5">purpose</a></li>
<li><a href="#_data_structures_9">data structures</a></li>
<li><a href="#_interface_24">interface</a>
<ul class="sectlevel4">
<li><a href="#_host">Host</a></li>
<li><a href="#_device">Device</a></li>
</ul>
</li>
<li><a href="#_configuration_7">Configuration</a>
<ul class="sectlevel4">
<li><a href="#_constant_2">constant</a></li>
<li><a href="#_shear_2">shear</a></li>
<li><a href="#_sinusoidal_shear">sinusoidal shear</a></li>
<li><a href="#_hele_shaw">Hele Shaw</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_third_party_dependencies">Third party dependencies</a>
<ul class="sectlevel3">
<li><a href="#_cuda_compiler">cuda compiler</a></li>
<li><a href="#_mpi_library">MPI library</a></li>
<li><a href="#_libconfig">libconfig</a>
<ul class="sectlevel4">
<li><a href="#_from_source">from source</a></li>
<li><a href="#_from_git">from git</a></li>
<li><a href="#_from_apt">from apt</a></li>
<li><a href="#_pkgconfig">pkgconfig</a></li>
</ul>
</li>
<li><a href="#_hdf5">hdf5</a></li>
</ul>
</li>
<li><a href="#wrappers">wrappers</a>
<ul class="sectlevel3">
<li><a href="#intro">intro</a></li>
<li><a href="#mem">MEM</a></li>
<li><a href="#val">VAL</a></li>
<li><a href="#prof">PROF</a></li>
<li><a href="#tim">TIM</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_user">User</a>
<ul class="sectlevel2">
<li><a href="#_user_documentation">user documentation</a></li>
</ul>
</li>
<li><a href="#_units">Units</a>
<ul class="sectlevel2">
<li><a href="#_comm_unit">comm unit</a></li>
<li><a href="#_error_unit">error unit</a>
<ul class="sectlevel3">
<li><a href="#_compile">compile</a></li>
<li><a href="#_usage_4">usage</a></li>
</ul>
</li>
<li><a href="#_hw_unit">hw unit</a></li>
<li><a href="#_hw_unit_2">hw unit</a></li>
<li><a href="#_linal_unit">linal unit</a>
<ul class="sectlevel3">
<li><a href="#_compile_2">compile</a></li>
<li><a href="#_run">run</a></li>
</ul>
</li>
<li><a href="#_units_2">units</a>
<ul class="sectlevel3">
<li><a href="#_build_and_run">Build and run</a></li>
<li><a href="#_update_make_file_fragments">Update make file fragments</a></li>
<li><a href="#_create_a_new_unit">Create a new unit</a></li>
<li><a href="#_list_of_units">list of units</a></li>
</ul>
</li>
<li><a href="#_mesh_bb_unit">mesh bb unit</a>
<ul class="sectlevel3">
<li><a href="#_intro">intro</a></li>
<li><a href="#_params">params</a></li>
</ul>
</li>
<li><a href="#_mpi_error">MPI error</a></li>
<li><a href="#_pair_unit">pair unit</a>
<ul class="sectlevel3">
<li><a href="#_intro_2">Intro</a></li>
<li><a href="#_compile_3">Compile</a></li>
<li><a href="#_build_2">Build</a></li>
<li><a href="#_run_2">Run</a></li>
<li><a href="#_source">Source</a></li>
<li><a href="#_test">Test</a></li>
</ul>
</li>
<li><a href="#_rbc_forces">RBC forces</a></li>
<li><a href="#_rbc_2">RBC</a></li>
<li><a href="#_rbc_random">RBC random</a></li>
<li><a href="#_scan_unit">scan unit</a></li>
<li><a href="#_signed_distance_function_sdf_unit">signed distance function (sdf) unit</a>
<ul class="sectlevel3">
<li><a href="#_compile_4">compile</a></li>
<li><a href="#_run_3">run</a></li>
</ul>
</li>
<li><a href="#_x_unit">x unit</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_developer">Developer</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build">build</h3>
<div class="paragraph">
<p>Shows full compilation and linking commands</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">u.make LOG=</code></pre>
</div>
</div>
<div class="paragraph">
<p>Profile compilation time</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">u.make LOG='@time -f &quot;%e $&lt;&quot;'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Summarize time used to compile</p>
</div>
<div class="listingblock">
<div class="content">
<pre>10.09 flu/imp.cu
10.16 restrain/imp.cu
...</pre>
</div>
</div>
<div class="sect3">
<h4 id="_arch_linux">Arch Linux</h4>
<div class="literalblock">
<div class="content">
<pre>u.make MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="literalblock">
<div class="content">
<pre>MAKEFLAGS="MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64" \
				u.test test/compile</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_after_adding_files">after adding files</h4>
<div class="paragraph">
<p>run from src/</p>
</div>
<div class="literalblock">
<div class="content">
<pre>../tools/deps</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coding_conventions">coding conventions</h3>
<div class="sect3">
<h4 id="_modules">modules</h4>
<div class="paragraph">
<p><em>uDeviceX</em> consists of modules.
Modules are as independant as possible.
They consist of a folder with one or more compilation units, and an
interface.
Whenever it is possible, the structures are hidden from the client of
the module.</p>
</div>
</div>
<div class="sect3">
<h4 id="_naming">naming</h4>
<div class="sect4">
<h5 id="_variables">variables</h5>
<div class="ulist">
<ul>
<li>
<p>names of local variables are short and understandable from the context</p>
</li>
<li>
<p>names of global variables are as descriptive as possible</p>
</li>
<li>
<p>arrays of simple structures <code>x</code> have names <code>xx</code>, eg. <code>pp</code> is an
array of particles, <code>cc</code> is an array of colors, <code>ii</code> is an array of
indices * array of small dimentionality may use an enum type for
readability, e.g.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>enum {X, Y, Z};
int r[3];
r[X] = rx;
r[Y] = ry;
r[Z] = rz;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_functions">functions</h5>
<div class="ulist">
<ul>
<li>
<p>a function name is descriptive on its own or inside a module.</p>
</li>
<li>
<p>arguments are ordered as follow:</p>
<div class="ulist">
<ul>
<li>
<p>input is at the beginning</p>
</li>
<li>
<p>input/output come after input and start with a commented <code>io</code></p>
</li>
<li>
<p>output comes after input/output and start with a comment or <code>o</code> depending on the context</p>
</li>
<li>
<p>sizes have higher priority than arrays</p>
</li>
<li>
<p>workspace comes at the end ans starts with a commented <code>w</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>do <strong>not</strong> use references, use pointers instead</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example of valid function declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> read_int_from_file(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *fname, <span style="color:#777">/**/</span> <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#0a8;font-weight:bold">int</span> *ii);
<span style="color:#088;font-weight:bold">void</span> forward_euler(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Force *ff, <span style="color:#777">/* io */</span> Particle *pp);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function names part of a module interface start with the module name.
Functions private to a module do not need to contain the module name
if the context make it clear. Use the <code>static</code> qualifier for functions
with compilation-unit scope.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_structure">file structure</h4>
<div class="ulist">
<ul>
<li>
<p>no include guards; no "headers in headers" if easily avoidable.</p>
</li>
<li>
<p>all cuda kernels are in a separate header <code>.h</code> file.</p>
</li>
<li>
<p>a module is implemented inside its own directory <code>A</code></p>
<div class="ulist">
<ul>
<li>
<p>it has its own object <code>A/imp.cu</code> or <code>A/imp.cpp</code>(<code>.cpp</code> prefered if possible)</p>
</li>
<li>
<p>interface <code>A/imp.h</code></p>
</li>
<li>
<p>implementation can be done in separate files inside <code>A/imp/</code> directory</p>
</li>
<li>
<p>internal cuda (private to module) code are inside <code>A/dev/</code> directory</p>
</li>
<li>
<p>cuda interface inside <code>A/dev.h</code> (for client use)</p>
</li>
</ul>
</div>
</li>
<li>
<p>modules can have submodules, which follow the same structure as above, e.g. submodule <code>B</code> inside module <code>A</code> belongs to <code>A/B/</code> directory</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_style">style</h4>
<div class="paragraph">
<p>for emacs: the following c++ mode is used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="lisp">(defun u/c-indent-common ()
  (setq c-basic-offset 4
        indent-tabs-mode nil))

(defun u/c++-indent ()
  (u/c-indent-common)
  (c-set-offset 'innamespace [0]))

(defun u/c-indent () (u/c-indent-common))

(add-hook 'c-mode-hook   'u/c-indent)
(add-hook 'c++-mode-hook 'u/c++-indent)

(setq c-default-style
      '((java-mode . &quot;java&quot;)
        (awk-mode  . &quot;awk&quot;)
        (c-mode    . &quot;k&amp;r&quot;)
        (cc-mode   . &quot;k&amp;r&quot;)))

(add-to-list 'auto-mode-alist '(&quot;\\.cu\\'&quot; . c++-mode))
(add-to-list 'auto-mode-alist '(&quot;\\.h\\'&quot;  . c++-mode))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_emacs_setting">emacs setting</h3>
<div class="ulist">
<ul>
<li>
<p><a href="cc.el">cc.el</a>: k&amp;r style with offset 4 and not indention for
namespaces</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_gource_commands">gource commands</h3>
<div class="paragraph">
<p>Dump</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">o=g.ppm
gource -s 0.1 --file-filter 'test_data/' \
              --file-filter 'poc/'  \
              --file-filter 'tcdf/' \
              --file-filter 'cmd/'  \
              --highlight-users   \
              --highlight-colour #FFFFFF \
              --date-format '%d %b %Y' -o $o</code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">i=g.ppm
o=g.mp4
ffmpeg -y -r 60 -f image2pipe -vcodec ppm -i $i -vcodec libx264 \
    -preset ultrafast -pix_fmt yuv420p -crf 1 -threads 0 -bf 0 $o</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="http://gource.io" class="bare">http://gource.io</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_developper_documentaion">developper documentaion</h3>
<div class="paragraph">
<p>uDeviceX developper documentation</p>
</div>
<div class="sect3">
<h4 id="_style_and_conventions">style and conventions</h4>
<div class="paragraph">
<p>A list of coding conventions can be found <a href="conventions.html">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_source_code_modules">source code modules</h4>
<div class="ulist">
<ul>
<li>
<p>prefix sum: <a href="modules/algo/scan.html">scan</a></p>
</li>
<li>
<p>body forces: <a href="modules/bforce.html">bforce</a></p>
</li>
<li>
<p>cell lists: <a href="modules/clist.html">clist</a></p>
</li>
<li>
<p>contact interactions: <a href="modules/cnt.html">cnt</a></p>
</li>
<li>
<p>controlers, open bc: <a href="modules/control/main.html">control</a></p>
</li>
<li>
<p><a href="modules/coords.html">coords</a></p>
</li>
<li>
<p>debug configuration: <a href="modules/dbg.html">dbg</a></p>
</li>
<li>
<p>flow structure interactions: <a href="modules/fsi.html">fsi</a></p>
</li>
<li>
<p>generic communicator: <a href="modules/comm.html">comm</a></p>
</li>
<li>
<p>generic device API: <a href="modules/d.html">d</a></p>
</li>
<li>
<p>math helpers: <a href="modules/math/main.html">math</a></p>
</li>
<li>
<p><a href="modules/algo/minmax.html">minmax</a></p>
</li>
<li>
<p>multi solvent: <a href="modules/color/main.html">color</a></p>
</li>
<li>
<p><a href="modules/partlist.html">partlist</a></p>
</li>
<li>
<p><a href="modules/parser.html">parser</a></p>
</li>
<li>
<p>red blood cell: <a href="modules/rbc/main.html">rbc</a></p>
</li>
<li>
<p>redistribution: <a href="modules/distr.html">distr</a></p>
</li>
<li>
<p>solvent interactions: <a href="modules/fluforces.html">fluforces</a></p>
</li>
<li>
<p>uDevice utilities: <a href="modules/utils/main.html">utils</a></p>
</li>
<li>
<p>wall velocity: <a href="modules/wvel.html">wvel</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_useful_links">Useful links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="third.html">Third party dependencies</a></p>
</li>
<li>
<p><a href="build.html">how to compile uDeviceX ?</a></p>
</li>
<li>
<p><a href="gource.html">gource</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_minmax">minmax</h3>
<div class="paragraph">
<p>compute extends of chunks of particles</p>
</div>
<div class="ulist">
<ul>
<li>
<p>input is an array of particles, the number of chunks and the number of particles per chunk.</p>
</li>
<li>
<p>output is the bounding box in for each chunk of particles.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_example">example</h4>
<div class="paragraph">
<p>Consider the simple case on 1D:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:
	particles positions:
	0.1 0.5 0.2   0.3 1.2 1.0
	number of chunks: 2
	number of particles per chunk: 3

output:
	min:
	0.1 0.3
	max:
	0.5 1.0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface">interface</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> minmax(<span style="color:#088;font-weight:bold">const</span> Particle *<span style="color:#088;font-weight:bold">const</span>, <span style="color:#0a8;font-weight:bold">int</span> nv, <span style="color:#0a8;font-weight:bold">int</span> no, <span style="color:#777">/**/</span> float3 *min, float3 *max);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scan">scan</h3>
<div class="paragraph">
<p>exclusive prefix sum implementation for integer data</p>
</div>
<div class="paragraph">
<p>input is of size <code>n</code>, output is of size <code>n + 1</code> as in the following
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:  4 5 1  2  3  -
output: 0 4 9 10 12 15</pre>
</div>
</div>
<div class="sect3">
<h4 id="_interface_2">interface</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> scan_apply(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *input, <span style="color:#0a8;font-weight:bold">int</span> size, <span style="color:#777">/**/</span> <span style="color:#0a8;font-weight:bold">int</span> *output, <span style="color:#777">/*w*/</span> ScanWork *w); <b class="conum">(1)</b>

<span style="color:#088;font-weight:bold">void</span> scan_work_ini(<span style="color:#0a8;font-weight:bold">int</span> size, <span style="color:#777">/**/</span> ScanWork **w);                                  <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> scan_work_fin(<span style="color:#777">/**/</span> ScanWork *w);                                             <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>perform scan operation on <code>input</code> of size <code>size</code></p>
</li>
<li>
<p>allocate workspace for performing scan of size <code>size</code></p>
</li>
<li>
<p>free workspace</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_body_forces">body forces</h3>
<div class="paragraph">
<p>force applied to every particles</p>
</div>
<div class="sect3">
<h4 id="_data_structures">data structures</h4>
<div class="paragraph">
<p>Defined by two structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BForce</code>, contains all informations needed for the  force
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>BForce_v</code> (<em>BForce view</em>), containing only the information needed at
a specific time. It is passed to device kernels.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interface_3">interface</h4>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> bforce_ini(BForce **p);
<span style="color:#088;font-weight:bold">void</span> bforce_fin(BForce *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize to a given force function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> bforce_ini_none(<span style="color:#777">/**/</span> BForce *p);            <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> bforce_ini_cste(float3 f, <span style="color:#777">/**/</span> BForce *p);  <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> bforce_ini_dp(<span style="color:#0a8;font-weight:bold">float</span> a, <span style="color:#777">/**/</span> BForce *p);     <b class="conum">(3)</b>
<span style="color:#088;font-weight:bold">void</span> bforce_ini_shear(<span style="color:#0a8;font-weight:bold">float</span> a, <span style="color:#777">/**/</span> BForce *p);  <b class="conum">(4)</b>
<span style="color:#088;font-weight:bold">void</span> bforce_ini_rol(<span style="color:#0a8;font-weight:bold">float</span> a, <span style="color:#777">/**/</span> BForce *p);    <b class="conum">(5)</b>
<span style="color:#088;font-weight:bold">void</span> bforce_ini_rad(<span style="color:#0a8;font-weight:bold">float</span> a, <span style="color:#777">/**/</span> BForce *p);    <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>no force</p>
</li>
<li>
<p>constant force <code>f</code></p>
</li>
<li>
<p>double poiseuille</p>
</li>
<li>
<p>shear</p>
</li>
<li>
<p>4 roller mill</p>
</li>
<li>
<p>radial force</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> bforce_ini_conf(<span style="color:#088;font-weight:bold">const</span> Config *cfg, <span style="color:#777">/**/</span> BForce *bf);</code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> bforce_adjust(float3 f, <span style="color:#777">/**/</span> BForce *fpar); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> bforce_apply(<span style="color:#0a8;font-weight:bold">long</span> it, <span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> mass, <span style="color:#088;font-weight:bold">const</span> BForce *bf, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp, <span style="color:#777">/**/</span> Force *ff); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>change value of the force</p>
</li>
<li>
<p>apply body force to particles</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">configuration</h4>
<div class="sect4">
<h5 id="_none">none</h5>
<div class="paragraph">
<p>no body force (default value)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce {
    type = &quot;none&quot;;
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_constant">constant</h5>
<div class="paragraph">
<p>constant force</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce {
    type = &quot;constant&quot;;
    f    = [1.0, 0.0, 0.0];
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_double_poiseuille">double poiseuille</h5>
<div class="paragraph">
<p><code>fx = y &gt; yc ? a : -a</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce {
    type = &quot;double_poiseuille&quot;;
    a    = 1.0;
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_shear">shear</h5>
<div class="paragraph">
<p><code>fx = a * (y - yc)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce {
    type = &quot;shear&quot;;
    a    = 1.0;
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_4_roller_mill">4 roller mill</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce {
    type = &quot;four_roller&quot;;
    a    = 1.0;
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_radial">radial</h5>
<div class="paragraph">
<p><code>fr = a * er / r</code>, where <code>fr</code> is radial force, <code>er</code> is unit radial
vector at position <code>r</code> and <code>r</code> is radial position.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce {
    type = &quot;rad&quot;;
    a    = 1.0;
};</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clist">clist</h3>
<div class="paragraph">
<p>Helpers to find which particles are in a given cell.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reorder data according to particle positions into cells</p>
</li>
<li>
<p>access particles within a given cell</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_example_2">example</h4>
<div class="paragraph">
<p>consider a 1D example of particles with positions in domain <code>[0, 4)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 2.5 0.1 1.1 0.5 1.6</pre>
</div>
</div>
<div class="paragraph">
<p>After cell list building (we take 1 as cell size), the above data becomes</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 0.1 0.5 1.1 1.6 2.5  -
cc: 2       2       1    0
ss: 0       2       4    5</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>pp</code> is the particle array, <code>cc</code> (counts) is the number of particles per
cell and <code>ss</code> (starts) is the prefix sum of <code>cc</code>.</p>
</div>
<div class="paragraph">
<p>Accessing all particles in cell <code>i=1</code> (<code>[1,2)</code>) can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>loop: j = 0, ..., cc[i]
      id = ss[i] + j
      p = pp[id]
      work(p)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above can be easily extended in 3D, only ordering changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_2">data structures</h4>
<div class="sect4">
<h5 id="_clist_2">Clist</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> Clist {
    int3 dims;
    <span style="color:#0a8;font-weight:bold">int</span> ncells;
    <span style="color:#0a8;font-weight:bold">int</span> *starts, *counts;
};</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dims</code> dimesnsions of the grid</p>
</li>
<li>
<p><code>ncells</code> number of cells</p>
</li>
<li>
<p><code>counts</code> number of particles per cell</p>
</li>
<li>
<p><code>starts</code> exclusive prefic scan of the above</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_map">Map</h5>
<div class="paragraph">
<p>Helper to build the cell lists (hidden from client)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> ClistMap {
    <span style="color:#0a8;font-weight:bold">int</span> nA;              <span style="color:#777">/* number of source arrays to build the cell lists, e.g remote+bulk -&gt; 2 */</span>
    uchar4 *ee[MAXA];    <span style="color:#777">/* cell entries */</span>
    uint *ii;            <span style="color:#777">/* codes containing: indices of data to fetch and array id from which to fetch */</span>
    ScanWork *scan;      <span style="color:#777">/* scan workspace */</span>
    <span style="color:#0a8;font-weight:bold">long</span> maxp;           <span style="color:#777">/* maximum number of particles per input vector */</span>
};</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nA</code> number of source arrays</p>
</li>
<li>
<p><code>ee</code> cell entries: one array per source array, containing a list of
<code>uchar4</code> with entries (<code>xcid</code>, <code>ycid</code>, <code>zcid</code>, <code>sid</code>)</p>
<div class="ulist">
<ul>
<li>
<p><code>xcid</code>: x cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.x</code></p>
</li>
<li>
<p><code>ycid</code>: y cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.y</code></p>
</li>
<li>
<p><code>zcid</code>: z cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.z</code></p>
</li>
<li>
<p><code>sid</code>: source array id, in 0, &#8230;&#8203;, <code>nA</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ii</code> indices of particles to fetch. can be decoded into the source
array id and the particle id inside this array</p>
</li>
<li>
<p><code>scan</code> scan workspace, see <a href="algo/scan.html">scan</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ids can be accessed from</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">const</span> uint* clist_get_ids(<span style="color:#088;font-weight:bold">const</span> ClistMap *m);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_4">interface</h4>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> clist_ini(<span style="color:#0a8;font-weight:bold">int</span> LX, <span style="color:#0a8;font-weight:bold">int</span> LY, <span style="color:#0a8;font-weight:bold">int</span> LZ, <span style="color:#777">/**/</span> Clist *c);
<span style="color:#088;font-weight:bold">void</span> clist_fin(<span style="color:#777">/**/</span> Clist *c);

<span style="color:#088;font-weight:bold">void</span> clist_ini_map(<span style="color:#0a8;font-weight:bold">int</span> maxp, <span style="color:#0a8;font-weight:bold">int</span> nA, <span style="color:#088;font-weight:bold">const</span> Clist *c, <span style="color:#777">/**/</span> ClistMap **m);
<span style="color:#088;font-weight:bold">void</span> clist_fin_map(ClistMap *m);</code></pre>
</div>
</div>
<div class="paragraph">
<p>build interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> clist_ini_counts(Clist *c);
<span style="color:#088;font-weight:bold">void</span> clist_subindex(<span style="color:#0a8;font-weight:bold">bool</span> project, <span style="color:#0a8;font-weight:bold">int</span> aid, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> PartList lp, <span style="color:#777">/**/</span> Clist *c, ClistMap *m);
<span style="color:#088;font-weight:bold">void</span> clist_build_map(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> nn[], <span style="color:#777">/**/</span> Clist *c, ClistMap *m);

<span style="color:#777">/* special for fluid distribution */</span>
<span style="color:#088;font-weight:bold">void</span> clist_subindex_local(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> PartList lp, <span style="color:#777">/**/</span> Clist *c, ClistMap *m);
<span style="color:#088;font-weight:bold">void</span> clist_subindex_remote(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> PartList lp, <span style="color:#777">/**/</span> Clist *c, ClistMap *m);

<span style="color:#088;font-weight:bold">void</span> clist_gather_pp(<span style="color:#088;font-weight:bold">const</span> Particle *pplo, <span style="color:#088;font-weight:bold">const</span> Particle *ppre, <span style="color:#088;font-weight:bold">const</span> ClistMap *m, <span style="color:#0a8;font-weight:bold">long</span> nout, <span style="color:#777">/**/</span> Particle *ppout);
<span style="color:#088;font-weight:bold">void</span> clist_gather_ii(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *iilo, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *iire, <span style="color:#088;font-weight:bold">const</span> ClistMap *m, <span style="color:#0a8;font-weight:bold">long</span> nout, <span style="color:#777">/**/</span> <span style="color:#0a8;font-weight:bold">int</span> *iiout);

<span style="color:#777">/* quick cell build for single array */</span>
<span style="color:#088;font-weight:bold">void</span> clist_build(<span style="color:#0a8;font-weight:bold">int</span> nlo, <span style="color:#0a8;font-weight:bold">int</span> nout, <span style="color:#088;font-weight:bold">const</span> Particle *pplo, <span style="color:#777">/**/</span> Particle *ppout, Clist *c, ClistMap *m);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface: code/decode map ids</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">static</span> __device__ uint clist_encode_id(<span style="color:#0a8;font-weight:bold">int</span> s, <span style="color:#0a8;font-weight:bold">int</span> pid)
<span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#088;font-weight:bold">void</span> clist_decode_id(uint c, <span style="color:#777">/**/</span> <span style="color:#0a8;font-weight:bold">int</span> *s, <span style="color:#0a8;font-weight:bold">int</span> *pid)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_algorithm">algorithm</h4>
<div class="paragraph">
<p>The cell build process is linear in number of particles <code>np</code> and <code>n log(n)</code>
in number of cells <code>n</code>.
The process to build cell lists is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>- build ee and counts: O(np)
  - set counts[i] = 0 for all i
  - for each particle, compute its cell id cid
  - get unique subindex k within the cell by updating cc[cid]
- scan counts to get starts O(nlog n)
- construct ii: O(np)
  - for each particle with id i, compute new index j = ss[cid] + k[i]
  - set ii[j] = i
- Gather data: O(np)
  - new particle vector pp1 from pp: pp1[i] = pp[ii[i]]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cnt">cnt</h3>
<div class="paragraph">
<p><em>contact</em> interactions between objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect3">
<h4 id="_interface_5">interface</h4>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> cnt_ini(<span style="color:#0a8;font-weight:bold">int</span> rank, <span style="color:#777">/**/</span> Contact **c);
<span style="color:#088;font-weight:bold">void</span> cnt_fin(Contact *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> cnt_build_cells(<span style="color:#0a8;font-weight:bold">int</span> nw, <span style="color:#088;font-weight:bold">const</span> PaWrap *pw, <span style="color:#777">/**/</span> Contact *c); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> cnt_bulk(<span style="color:#088;font-weight:bold">const</span> Contact *c, <span style="color:#0a8;font-weight:bold">int</span> nw, PaWrap *pw, FoWrap *fw); <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> cnt_halo(<span style="color:#088;font-weight:bold">const</span> Contact *c, <span style="color:#0a8;font-weight:bold">int</span> nw, PaWrap *pw, FoWrap *fw, Pap26 PP, Fop26 FF, <span style="color:#0a8;font-weight:bold">int</span> counts[<span style="color:#00D">26</span>]); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>build cell lists for local objects</p>
</li>
<li>
<p>compute the interactions between local objects particles</p>
</li>
<li>
<p>compute the interactions between local and remote objects particles</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_color">color</h3>
<div class="sect3">
<h4 id="_purpose">purpose</h4>
<div class="paragraph">
<p>Each particle of the solvent has an assigned color when the
<code>multi_solvent</code> flag is enabled.
It is helpful for modeling different solvent with different
viscosities, surface tensions etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modules_2">modules</h4>
<div class="paragraph">
<p>Some utility modules are implemeted in <code>/src/color</code>.</p>
</div>
<div class="sect4">
<h5 id="_flux">flux</h5>
<div class="paragraph">
<p>recolor particles crossing the face of the periodic domain in the
positive direction x, y or z</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">namespace</span> recolor {
<span style="color:#088;font-weight:bold">void</span> linear_flux(<span style="color:#088;font-weight:bold">const</span> Coords *coords, <span style="color:#0a8;font-weight:bold">int</span> dir, <span style="color:#0a8;font-weight:bold">int</span> color, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp, <span style="color:#0a8;font-weight:bold">int</span> *cc);
} <span style="color:#777">// recolor</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dir</code> is the direction x, y or z</p>
</li>
<li>
<p><code>color</code> is the new color</p>
</li>
<li>
<p><code>pp</code> are input particles of size <code>n</code></p>
</li>
<li>
<p><code>cc</code> are output colors (stay the same if does not cross the face)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comm">comm</h3>
<div class="paragraph">
<p>generic communicator with "halo".</p>
</div>
<div class="sect3">
<h4 id="_purpose_2">purpose</h4>
<div class="paragraph">
<p>Communicate data with the neighboring ranks</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_3">data structures</h4>
<div class="paragraph">
<p><code>hBags</code>: buffers on the host, contains all necessary information of the data to communicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> hBags {
    data_t *data[NBAGS]; <span style="color:#777">/* data on the host                    */</span>
    <span style="color:#0a8;font-weight:bold">int</span>         *counts; <span style="color:#777">/* size of the data                    */</span>
    <span style="color:#0a8;font-weight:bold">int</span> capacity[NBAGS]; <span style="color:#777">/* capacity of each frag (elem number) */</span>
    size_t bsize;        <span style="color:#777">/* size of one datum in bytes          */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>dBags</code>: buffers on the device</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> dBags {
    data_t *data[NBAGS]; <span style="color:#777">/* data on the device         */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Comm</code>: contains the communication related variables. It is hidden
from user.</p>
</div>
</div>
<div class="sect3">
<h4 id="_allocation_mod">allocation mod</h4>
<div class="paragraph">
<p>User can choose how the buffers are allocated with the enum type <code>AllocMod</code>.
This is used in the funcion <code>ini</code> and <code>fin</code>. allocation mode and free mode are assumed to be the same</p>
</div>
<div class="paragraph">
<p>currently supported allocation modes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">    HST_ONLY,   <span style="color:#777">/* only host bags allocated                 */</span>
    DEV_ONLY,   <span style="color:#777">/* only device bags allocated               */</span>
    PINNED,     <span style="color:#777">/* both host and device pinned              */</span>
    PINNED_HST, <span style="color:#777">/* host pinned; no device memory            */</span>
    PINNED_DEV, <span style="color:#777">/* host pinned; device global memory on gpu */</span>
    NONE        <span style="color:#777">/* no allocation                            */</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_6">interface</h4>
<div class="sect4">
<h5 id="_memory_management">memory management</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">int</span> comm_bags_ini(AllocMod fmod, AllocMod bmod, size_t bsize, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> capacity[NBAGS], <span style="color:#777">/**/</span> hBags *hb, dBags *db);
<span style="color:#0a8;font-weight:bold">int</span> comm_bags_fin(AllocMod fmod, AllocMod bmod, <span style="color:#777">/**/</span> hBags *hb, dBags *db);
<span style="color:#0a8;font-weight:bold">int</span> comm_ini(MPI_Comm cart, <span style="color:#777">/**/</span> Comm **c);
<span style="color:#0a8;font-weight:bold">int</span> comm_fin(<span style="color:#777">/**/</span> Comm *c);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bags alloc:</strong> Given two structures <code>hBags</code> and <code>dBags</code>, <code>ini</code> allocates the buffers on host and device. <code>ini</code> expects 2 allocation modes:</p>
<div class="ulist">
<ul>
<li>
<p><code>fmod</code>: allocation mode for fragment buffers</p>
</li>
<li>
<p><code>bmod</code>: allocation mode for bulk buffer</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>comm alloc</strong>: initialize <code>Comm</code> structure</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_communication">communication</h5>
<div class="paragraph">
<p>Communication happens between host bags (see <code>hBags</code> structure).
It needs 3 entities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>receiver bags</p>
</li>
<li>
<p>sender bags</p>
</li>
<li>
<p>a <code>Comm</code> for communicating through MPI</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interface is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">int</span> comm_post_recv(hBags *b, Comm *c);           <b class="conum">(1)</b>
<span style="color:#0a8;font-weight:bold">int</span> comm_post_send(<span style="color:#088;font-weight:bold">const</span> hBags *b, Comm *c);     <b class="conum">(2)</b>

<span style="color:#0a8;font-weight:bold">int</span> comm_wait_recv(Comm *c, <span style="color:#777">/**/</span> hBags *b);      <b class="conum">(3)</b>
<span style="color:#0a8;font-weight:bold">int</span> comm_wait_send(Comm *c);                     <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>call MPI asynchroneous recv and store requests in <code>s</code></p>
</li>
<li>
<p>call MPI asynchroneous send and store requests in <code>s</code></p>
</li>
<li>
<p>wait for recv requests</p>
</li>
<li>
<p>wait for send requests</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_contact_forces">contact forces</h3>
<div class="paragraph">
<p>computs interactions between objects.</p>
</div>
</div>
<div class="sect2">
<h3 id="_control">Control</h3>
<div class="ulist">
<ul>
<li>
<p>velocity controller</p>
</li>
<li>
<p>open boundary conditions</p>
</li>
<li>
<p>density controller</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_velocity_controller">Velocity controller</h4>
<div class="paragraph">
<p>control velocity by modifying the imposed hydrostatic force</p>
</div>
<div class="sect4">
<h5 id="_interface_7">interface</h5>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> vcont_ini(MPI_Comm comm, int3 L, float3 vtarget, <span style="color:#0a8;font-weight:bold">float</span> factor, <span style="color:#777">/**/</span> PidVCont **c);
<span style="color:#088;font-weight:bold">void</span> vcont_fin(<span style="color:#777">/**/</span> PidVCont *cont);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the transformation structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> vcon_set_cart(<span style="color:#777">/**/</span> PidVCont *cont);
<span style="color:#088;font-weight:bold">void</span> vcon_set_radial(<span style="color:#777">/**/</span> PidVCont *cont);</code></pre>
</div>
</div>
<div class="paragraph">
<p>the transformation is the way of averaging the velocity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cartesian transformation keeps the velocity as it is before averaging.</p>
</li>
<li>
<p>radial transformation returns the velocity in polar coordinates
scaled by the radial position. the <code>z</code> component corresponds to
cartesian transformation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Control operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span>   vcont_sample(<span style="color:#088;font-weight:bold">const</span> Coords *coords, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *starts, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *counts, <span style="color:#777">/**/</span> PidVCont *c); <b class="conum">(1)</b>
float3 vcont_adjustF(<span style="color:#777">/**/</span> PidVCont *c); <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span>   vcont_log(<span style="color:#088;font-weight:bold">const</span> PidVCont *c);    <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get average velocity according to transformation and store it</p>
</li>
<li>
<p>reduce sampled quantities and update the controller. return the force</p>
</li>
<li>
<p>logging informations; dumped into the file <code>vcon.txt</code></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_2">configuration</h5>
<div class="paragraph">
<p>syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">vcon = {
     active = true;
     type   = &quot;cart&quot;;          # can be also &quot;rad&quot;
     U      = [1.0, 1.0, 0.0]; # target velocity in transformed space
     log_freq    = 500;
     adjust_freq = 500;
     sample_freq = 1;
};</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inflow">Inflow</h4>
<div class="paragraph">
<p>Mass rate inflow</p>
</div>
<div class="sect4">
<h5 id="_interface_8">interface</h5>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> inflow_ini(int2 nc, Inflow **i);
<span style="color:#088;font-weight:bold">void</span> inflow_fin(Inflow *i);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the inflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> inflow_ini_velocity(Inflow *i);

<span style="color:#088;font-weight:bold">void</span> inflow_ini_params_plate(<span style="color:#088;font-weight:bold">const</span> Coords *c, float3 o, <span style="color:#0a8;font-weight:bold">int</span> dir, <span style="color:#0a8;font-weight:bold">float</span> L1, <span style="color:#0a8;font-weight:bold">float</span> L2,
                             float3 u, <span style="color:#0a8;font-weight:bold">bool</span> upoiseuille, <span style="color:#0a8;font-weight:bold">bool</span> vpoiseuille,
                             <span style="color:#777">/**/</span> Inflow *i);
<span style="color:#088;font-weight:bold">void</span> inflow_ini_params_circle(<span style="color:#088;font-weight:bold">const</span> Coords *c, float3 o, <span style="color:#0a8;font-weight:bold">float</span> R, <span style="color:#0a8;font-weight:bold">float</span> H, <span style="color:#0a8;font-weight:bold">float</span> u, <span style="color:#0a8;font-weight:bold">bool</span> poiseuille,
                              <span style="color:#777">/**/</span> Inflow *i);</code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the type of inflow, call the appropriate
<code>ini_params_xxx</code>.
<code>ini_velocity</code> must be called after initializing the parameters.
it is used to setup the inlet velocity from parameters.</p>
</div>
<div class="paragraph">
<p>initialize from config parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> inflow_ini_params_conf(<span style="color:#088;font-weight:bold">const</span> Coords *coords, <span style="color:#088;font-weight:bold">const</span> Config *cfg, <span style="color:#777">/**/</span> Inflow *i);</code></pre>
</div>
</div>
<div class="paragraph">
<p>create particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> inflow_create_pp(Inflow *i, <span style="color:#0a8;font-weight:bold">int</span> *n, Particle *pp); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> inflow_create_pp_cc(<span style="color:#0a8;font-weight:bold">int</span> newcolor, Inflow *i, <span style="color:#0a8;font-weight:bold">int</span> *n, Particle *pp, <span style="color:#0a8;font-weight:bold">int</span> *cc); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add particles to the array <code>pp</code> and increase <code>n</code> accordingly</p>
</li>
<li>
<p>same as above, with colors <code>cc</code> set to <code>color</code></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_3">configuration</h5>
<div class="sect5">
<h6 id="_plate">plate</h6>
<div class="paragraph">
<p>syntax for a <code>8.0 x 16.0</code> plate perpendicular to the x axis passing by
the point <code>(1, 2, 3)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">inflow = {
    active      = true;
    type        = &quot;plate&quot;;
    L1          = 1.0;
    L2          = 16.0;
    direction   = 0;                # [0,1,2] = [X,Y,Z]
    origin      = [1.0, 2.0, 3.0];
    upoiseuille = false;            # true for parabolic profile along L1
    vpoiseuille = false;            # true for parabolic profile along L2
    u           = [10.0, 0.0, 0.0];
};</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_circle">circle</h6>
<div class="paragraph">
<p>syntax for cylinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">inflow = {
    active = true;
    type   = &quot;circle&quot;;
    R      = 1.0;              # radius
    H      = 16.0;             # hight of the cylinder
    U      = 1.0;              # maximum velocity
    center = [8.0, 8.0, 8.0];
    poiseuille = false;        # parabolic profile along H if true
};</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_outflow">Outflow</h4>
<div class="paragraph">
<p>Delete particles satisfying a predicate</p>
</div>
<div class="sect4">
<h5 id="_interface_9">interface</h5>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> ini(<span style="color:#0a8;font-weight:bold">int</span> maxp, <span style="color:#777">/**/</span> Outflow **o);
<span style="color:#088;font-weight:bold">void</span> fin(<span style="color:#777">/**/</span> Outflow *o);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the outflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> ini_params_circle(<span style="color:#088;font-weight:bold">const</span> Coords *coords, float3 c, <span style="color:#0a8;font-weight:bold">float</span> R, Outflow *o);
<span style="color:#088;font-weight:bold">void</span> ini_params_plate(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">int</span> dir, <span style="color:#0a8;font-weight:bold">float</span> r0, Outflow *o);</code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the geometry of outflow, call the appropriate
<code>ini_params_xxx</code>.</p>
</div>
<div class="paragraph">
<p>filter and mark particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> filter_particles(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp, <span style="color:#777">/**/</span> Outflow *o); <b class="conum">(1)</b>

<span style="color:#088;font-weight:bold">void</span> download_ndead(Outflow *o);                                   <b class="conum">(2)</b>

<span style="color:#0a8;font-weight:bold">int</span>* get_deathlist(Outflow *o);                                    <b class="conum">(3)</b>
<span style="color:#0a8;font-weight:bold">int</span>  get_ndead(Outflow *o);                                        <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>store dying particles infos inside Outflow struct</p>
</li>
<li>
<p>copy from device to host number of dead particles</p>
</li>
<li>
<p>return the list of dead marks (dead=1, alive=0)</p>
</li>
<li>
<p>return the number of dead particles</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_4">configuration</h5>
<div class="sect5">
<h6 id="_plate_2">plate</h6>
<div class="paragraph">
<p>will delete particles crossing a plate along the positive direction.
syntax for the plate <code>y=4</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">outflow = {
    active     = true;
    type       = &quot;plate&quot;;
    direction  = 1;      # [0,1,2] = [X,Y,Z]
    position   = 4.0;    # position along &quot;direction&quot;
};</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_circle_2">circle</h6>
<div class="paragraph">
<p>delete particles going out of the cylinder.
syntax for a cylinder of radius 8 centered at <code>(8, 8, 8)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">outflow = {
    active = true;
    type   = &quot;circle&quot;;
    R      = 8.0;
    center = [8.0, 8.0, 8.0];
};</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_density_controller">Density controller</h4>

</div>
</div>
<div class="sect2">
<h3 id="_coords">coords</h3>
<div class="paragraph">
<p>Coordinate transforms utility.</p>
</div>
<div class="paragraph">
<p>In <em>uDeviceX</em>, the simulation domain is decomposed into a grid of
subdomains of equal sizes.
Computations are performed in <em>local</em> coordinates and all objects are
relative to these coordinates.
Operations, such as initialisation of the data, io, etc., need
<em>global</em> coordinates informations.</p>
</div>
<div class="paragraph">
<p>For convenience, we consider the three coordinate systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Global</em>: Relative to the lower corner of the full domain of size
\((G_x, G_y, G_z)\)</p>
</li>
<li>
<p><em>Local</em>: Relative to the center of the subdomain of size
\((L_x, L_y, L_z)\)</p>
</li>
<li>
<p><em>Center</em>: Relative to the center of the full domain: \((C_x,
C_y, C_z) = (G_x/2, G_y/2, G_z/2)\)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_data_structures_4">data structures</h4>
<div class="paragraph">
<p>All the needed information is stored in the hidden structure <code>Coords</code>.
A <em>view</em> structure <code>Coords_v</code> is public to device code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> Coords_v {
    <span style="color:#0a8;font-weight:bold">int</span> xc, yc, zc; <span style="color:#777">/* rank coordinates */</span>
    <span style="color:#0a8;font-weight:bold">int</span> xd, yd, zd; <span style="color:#777">/* rank sizes       */</span>
};</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_host_interface">Host interface</h4>
<div class="sect4">
<h5 id="_memory_management_2">Memory management</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> coords_ini(MPI_Comm cart, Coords **c); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> coords_fin(Coords *c);                 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate and set the data according to the cartesian communicator</p>
</li>
<li>
<p>deallocate the structure</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_getters">Getters</h5>
<div class="paragraph">
<p>Obtain a view structure from <code>Coords</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> coords_get_view(<span style="color:#088;font-weight:bold">const</span> Coords *c, Coords_v *v);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((G_x, G_y, G_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">int</span> xdomain(<span style="color:#088;font-weight:bold">const</span> Coords *c);
<span style="color:#0a8;font-weight:bold">int</span> ydomain(<span style="color:#088;font-weight:bold">const</span> Coords *c);
<span style="color:#0a8;font-weight:bold">int</span> zdomain(<span style="color:#088;font-weight:bold">const</span> Coords *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((L_x, L_y, L_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">int</span> xs(<span style="color:#088;font-weight:bold">const</span> Coords*);
<span style="color:#0a8;font-weight:bold">int</span> ys(<span style="color:#088;font-weight:bold">const</span> Coords*);
<span style="color:#0a8;font-weight:bold">int</span> zs(<span style="color:#088;font-weight:bold">const</span> Coords*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get (from <em>local</em> coordinates) \((-L_x/2, -L_y/2, -L_z/2)\) and
\((L_x/2, L_y/2, L_z/2)\) in <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">int</span> xlo(<span style="color:#088;font-weight:bold">const</span> Coords*);
<span style="color:#0a8;font-weight:bold">int</span> ylo(<span style="color:#088;font-weight:bold">const</span> Coords*);
<span style="color:#0a8;font-weight:bold">int</span> zlo(<span style="color:#088;font-weight:bold">const</span> Coords*);

<span style="color:#0a8;font-weight:bold">int</span> xhi(<span style="color:#088;font-weight:bold">const</span> Coords*);
<span style="color:#0a8;font-weight:bold">int</span> yhi(<span style="color:#088;font-weight:bold">const</span> Coords*);
<span style="color:#0a8;font-weight:bold">int</span> zhi(<span style="color:#088;font-weight:bold">const</span> Coords*);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_coordinate_transforms">Coordinate transforms</h5>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>center</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">float</span> xl2xc(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> xl);
<span style="color:#0a8;font-weight:bold">float</span> yl2yc(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> yl);
<span style="color:#0a8;font-weight:bold">float</span> zl2zc(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> zl);
<span style="color:#088;font-weight:bold">void</span> local2center(<span style="color:#088;font-weight:bold">const</span> Coords *c, float3 rl, <span style="color:#777">/**/</span> float3 *rc);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>center</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">float</span> xc2xl(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> xc);
<span style="color:#0a8;font-weight:bold">float</span> yc2yl(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> yc);
<span style="color:#0a8;font-weight:bold">float</span> zc2zl(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> zc);
<span style="color:#088;font-weight:bold">void</span> center2local(<span style="color:#088;font-weight:bold">const</span> Coords *c, float3 rc, <span style="color:#777">/**/</span> float3 *rl);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">float</span> xl2xg(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> xl);
<span style="color:#0a8;font-weight:bold">float</span> yl2yg(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> yl);
<span style="color:#0a8;font-weight:bold">float</span> zl2zg(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> zl);
<span style="color:#088;font-weight:bold">void</span> local2global(<span style="color:#088;font-weight:bold">const</span> Coords *c, float3 rl, <span style="color:#777">/**/</span> float3 *rg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>global</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#0a8;font-weight:bold">float</span> xg2xl(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> xg);
<span style="color:#0a8;font-weight:bold">float</span> yg2yl(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> yg);
<span style="color:#0a8;font-weight:bold">float</span> zg2zl(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">float</span> zg);
<span style="color:#088;font-weight:bold">void</span> global2local(<span style="color:#088;font-weight:bold">const</span> Coords *c, float3 rg, <span style="color:#777">/**/</span> float3 *rl);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_helpers">helpers</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* rank predicates */</span>
<span style="color:#0a8;font-weight:bold">bool</span> is_end(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#0a8;font-weight:bold">int</span> dir);

<span style="color:#777">/* a string unique for a rank */</span>
<span style="color:#088;font-weight:bold">void</span> coord_stamp(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#777">/**/</span> <span style="color:#0a8;font-weight:bold">char</span> *s);

<span style="color:#777">/* number of subdomains */</span>
<span style="color:#0a8;font-weight:bold">int</span> coords_size(<span style="color:#088;font-weight:bold">const</span> Coords *c);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generic_d_evice_api">generic [d]evice API</h3>
<div class="paragraph">
<p>The goal is to make cuda API and kernel functions generic. Meaning
they can be replaced by CPU calls.</p>
</div>
<div class="sect3">
<h4 id="_interface_10">interface</h4>
<div class="paragraph">
<p>Wrappers for cuda functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">namespace</span> d {  <span style="color:#777">/* a wrapper for device API */</span>
<span style="color:#080;font-weight:bold">typedef</span> <span style="color:#0a8;font-weight:bold">int</span> Stream_t; <span style="color:#777">/* TODO: streams are not supported */</span>
<span style="color:#080;font-weight:bold">enum</span> {MemcpyHostToHost, MemcpyHostToDevice, MemcpyDeviceToHost, MemcpyDeviceToDevice, MemcpyDefault};

<span style="color:#0a8;font-weight:bold">int</span> ini();
<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *emsg(); <span style="color:#777">/* last error message */</span>
<span style="color:#0a8;font-weight:bold">int</span> alloc_pinned(<span style="color:#088;font-weight:bold">void</span> **pHost, size_t size);

<span style="color:#0a8;font-weight:bold">int</span> Malloc(<span style="color:#088;font-weight:bold">void</span> **p, size_t);
<span style="color:#0a8;font-weight:bold">int</span> MemcpyToSymbol(<span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">void</span> *symbol, <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">void</span> *src, size_t count, size_t offset=<span style="color:#00D">0</span>, <span style="color:#0a8;font-weight:bold">int</span> kind=MemcpyHostToDevice);
<span style="color:#0a8;font-weight:bold">int</span> MemcpyFromSymbol(<span style="color:#088;font-weight:bold">void</span> *dst, <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">void</span> *symbol, size_t count, size_t offset=<span style="color:#00D">0</span>, <span style="color:#0a8;font-weight:bold">int</span> kind=MemcpyDeviceToHost);
<span style="color:#0a8;font-weight:bold">int</span> HostGetDevicePointer(<span style="color:#088;font-weight:bold">void</span> **pDevice, <span style="color:#088;font-weight:bold">void</span> *pHost, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> flags);
<span style="color:#0a8;font-weight:bold">int</span> Memcpy (<span style="color:#088;font-weight:bold">void</span> *dst, <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">void</span> *src, size_t count, <span style="color:#0a8;font-weight:bold">int</span> kind);
<span style="color:#0a8;font-weight:bold">int</span> MemsetAsync (<span style="color:#088;font-weight:bold">void</span> *devPtr, <span style="color:#0a8;font-weight:bold">int</span> value, size_t count, Stream_t stream=<span style="color:#00D">0</span>);
<span style="color:#0a8;font-weight:bold">int</span> Memset (<span style="color:#088;font-weight:bold">void</span> *devPtr, <span style="color:#0a8;font-weight:bold">int</span> value, size_t count);
<span style="color:#0a8;font-weight:bold">int</span> MemcpyAsync (<span style="color:#088;font-weight:bold">void</span> * dst, <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">void</span> * src, size_t count, <span style="color:#0a8;font-weight:bold">int</span> kind, Stream_t stream = <span style="color:#00D">0</span>);
<span style="color:#0a8;font-weight:bold">int</span> Free (<span style="color:#088;font-weight:bold">void</span> *devPtr);
<span style="color:#0a8;font-weight:bold">int</span> FreeHost (<span style="color:#088;font-weight:bold">void</span> *hstPtr);
<span style="color:#0a8;font-weight:bold">int</span> DeviceSynchronize (<span style="color:#088;font-weight:bold">void</span>);
<span style="color:#0a8;font-weight:bold">int</span> PeekAtLastError(<span style="color:#088;font-weight:bold">void</span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>generic files of the interface
* <code>d/api.h</code> API calls
* <code>d/q.h</code> function and variable type qualifiers
* <code>d/ker.h</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_5">configuration</h4>
<div class="paragraph">
<p>Generic device can by implemented by <code>cuda</code> and by <code>cpu</code>
* <code>d/cuda</code>
* <code>d/cpu</code></p>
</div>
<div class="paragraph">
<p>if <code>DEV_CUDA</code> defined it is <code>cuda</code>, if <code>DEV_CPU</code> is defined it is
<code>cpu</code>. For <code>cpu</code> <code>KL_CPU</code> should be also defined.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debug">debug</h3>
<div class="paragraph">
<p>Helper to check the particle positions, velocities, forces and
cell-lists from device arrays</p>
</div>
<div class="paragraph">
<p>The hidden structure <code>Dbg</code> holds the debugging configuration.
Configuration is encoded using the following enum values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#080;font-weight:bold">enum</span> {
    DBG_POS,      <b class="conum">(1)</b>
    DBG_POS_SOFT, <b class="conum">(2)</b>
    DBG_VEL,      <b class="conum">(3)</b>
    DBG_FORCES,   <b class="conum">(4)</b>
    DBG_COLORS,   <b class="conum">(5)</b>
    DBG_CLIST,    <b class="conum">(6)</b>
    DBG_NKIND_
};</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>positions are inside subdomain</p>
</li>
<li>
<p>positions are inside subdomain plus a margin</p>
</li>
<li>
<p>velocities</p>
</li>
<li>
<p>forces</p>
</li>
<li>
<p>colors</p>
</li>
<li>
<p>cell lists</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Consider subdomain of dimensions \((L_x, Ly, Lz)\).
A position \((r_x, r_y, r_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[-\frac{L_\alpha - M} {2}  \leq r_\alpha &lt; \frac{L_\alpha + M} 2,\]
</div>
</div>
<div class="paragraph">
<p>where \(M\) is the margin. It is \(M = 0\) for <code>DBG_POS</code> and
\(M = 3\) for <code>DBG_POS_SOFT</code>.</p>
</div>
<div class="paragraph">
<p>For a given timestep \(dt\), the velocity \((v_x, v_y, v_z)\) is
valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |v_\alpha| dt \leq L_\alpha.\]
</div>
</div>
<div class="paragraph">
<p>The force \((f_x, f_y, f_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |f_\alpha| dt^2 \leq L_\alpha.\]
</div>
</div>
<div class="sect3">
<h4 id="_interface_11">interface</h4>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> dbg_ini(Dbg**);
<span style="color:#088;font-weight:bold">void</span> dbg_fin(Dbg*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>set debugging modes and verbosity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> dbg_enable(<span style="color:#0a8;font-weight:bold">int</span> kind, Dbg *dbg);
<span style="color:#088;font-weight:bold">void</span> dbg_disable(<span style="color:#0a8;font-weight:bold">int</span> kind, Dbg *dbg);
<span style="color:#088;font-weight:bold">void</span> dbg_set_verbose(<span style="color:#0a8;font-weight:bold">bool</span>, Dbg *dbg);
<span style="color:#088;font-weight:bold">void</span> dbg_set_dump(<span style="color:#0a8;font-weight:bold">bool</span>, Dbg *dbg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> dbg_set_conf(<span style="color:#088;font-weight:bold">const</span> Config*, Dbg*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> dbg_check_pos(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *base, <span style="color:#088;font-weight:bold">const</span> Dbg *dbg, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp);
<span style="color:#088;font-weight:bold">void</span> dbg_check_pos_soft(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *base, <span style="color:#088;font-weight:bold">const</span> Dbg *dbg, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp);
<span style="color:#088;font-weight:bold">void</span> dbg_check_vel(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *base, <span style="color:#088;font-weight:bold">const</span> Dbg *dbg, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp);
<span style="color:#088;font-weight:bold">void</span> dbg_check_forces(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *base, <span style="color:#088;font-weight:bold">const</span> Dbg *dbg, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp, <span style="color:#088;font-weight:bold">const</span> Force *ff);
<span style="color:#088;font-weight:bold">void</span> dbg_check_colors(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#088;font-weight:bold">const</span> Dbg *dbg, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *cc);
<span style="color:#088;font-weight:bold">void</span> dbg_check_clist(<span style="color:#088;font-weight:bold">const</span> Coords *c, <span style="color:#088;font-weight:bold">const</span> Dbg *dbg, int3 L, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *starts, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *counts, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> Particle *pp);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_6">configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">dbg = {
    verbose  = true;
    pos      = false;
    pos_soft = false;
    vel      = false;
    forces   = false;
    colors   = false;
    clist    = false;
};</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distr">distr</h3>
<div class="paragraph">
<p>Redistribution of quantities across nodes.
Each node has a local coordinate system. The origin is the center of a
"subdomain" of size <code>Sx</code>, <code>Sy</code>, <code>Sz</code>.</p>
</div>
<div class="paragraph">
<p>A quantity is sent to a neighboring rank if its position is outside of
the subdomain.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to redistribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_map_2">map</h4>
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all quantities.</p>
</div>
<div class="sect4">
<h5 id="_data_structure">data structure</h5>
<div class="paragraph">
<p>The structure to map local data from an array to packed data in 27
arrays is implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* [D]istr Map */</span>
<span style="color:#080;font-weight:bold">struct</span> DMap {
    <span style="color:#0a8;font-weight:bold">int</span> *counts;  <span style="color:#777">/* number of entities leaving in each fragment */</span>
    <span style="color:#0a8;font-weight:bold">int</span> *starts;  <span style="color:#777">/* cumulative sum of the above                 */</span>
    <span style="color:#0a8;font-weight:bold">int</span> *ids[<span style="color:#00D">27</span>]; <span style="color:#777">/* indices of leaving objects                  */</span>

    <span style="color:#0a8;font-weight:bold">int</span> *hcounts; <span style="color:#777">/* counts on host (pinned) */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be allocated on device or on host memory (see interface).</p>
</div>
</div>
<div class="sect4">
<h5 id="_interface_12">interface</h5>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> dmap_ini(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> capacity[], <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_fin(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_reini(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap m);
<span style="color:#088;font-weight:bold">void</span> dmap_download_counts(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_ini_host(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> capacity[], <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_fin_host(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_reini_host(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap m);
<span style="color:#088;font-weight:bold">void</span> dmap_D2H(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#088;font-weight:bold">const</span> DMap *d, <span style="color:#777">/**/</span> DMap *h);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* exclusive scan */</span>
<span style="color:#080;font-weight:bold">template</span> &lt;<span style="color:#0a8;font-weight:bold">int</span> NCOUNTS&gt;
<span style="color:#088;font-weight:bold">static</span> __global__ <span style="color:#088;font-weight:bold">void</span> dmap_scan(<span style="color:#777">/**/</span> DMap m)              <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#0a8;font-weight:bold">int</span> dmap_get_fid(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> r[<span style="color:#00D">3</span>])       <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#088;font-weight:bold">void</span> dmap_add(<span style="color:#0a8;font-weight:bold">int</span> pid, <span style="color:#0a8;font-weight:bold">int</span> fid, DMap m)  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>prefix sum on counts to obtain starts</p>
</li>
<li>
<p>get fragment id from position</p>
</li>
<li>
<p>add a quantity to the map</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_flu">flu</h4>
<div class="paragraph">
<p>Redistribute solvent particles accross nodes.</p>
</div>
<div class="sect4">
<h5 id="_data_structures_5">data structures</h5>
<div class="paragraph">
<p>Solvent distribution follow the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> DFluPack {
    DMap map;
    dBags dpp, dii, dcc;
    hBags hpp, hii, hcc;
    <span style="color:#0a8;font-weight:bold">int</span> nhalo; <span style="color:#777">/* number of sent particles */</span>
};

<span style="color:#080;font-weight:bold">struct</span> DFluComm {
    Comm *pp, *ii, *cc;
};

<span style="color:#080;font-weight:bold">struct</span> DFluUnpack {
    hBags hpp, hii, hcc;
    Particle *ppre;
    <span style="color:#0a8;font-weight:bold">int</span> *iire, *ccre;
    <span style="color:#0a8;font-weight:bold">int</span> nhalo; <span style="color:#777">/* number of received particles */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>[d,h]xx</code> means quantities on <code>[device,host]</code> and <code>pp</code>
corresponds to particles, <code>cc</code> to colors and <code>ii</code> to global ids.
The <code>xxre</code> variables in <code>Unpack</code> are buffer for remote quantities.</p>
</div>
</div>
<div class="sect4">
<h5 id="_interface_13">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> dflu_pack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxdensity, DFluPack **p);
<span style="color:#088;font-weight:bold">void</span> dflu_comm_ini(MPI_Comm comm, <span style="color:#777">/**/</span> DFluComm **c);
<span style="color:#088;font-weight:bold">void</span> dflu_unpack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxdensity, DFluUnpack **u);

<span style="color:#088;font-weight:bold">void</span> dflu_pack_fin(DFluPack *p);
<span style="color:#088;font-weight:bold">void</span> dflu_comm_fin(DFluComm *c);
<span style="color:#088;font-weight:bold">void</span> dflu_unpack_fin(DFluUnpack *u);

<span style="color:#777">/* map */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_build_map(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> PartList lp, DFluPack *p);

<span style="color:#777">/* pack */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_pack(<span style="color:#088;font-weight:bold">const</span> FluQuants *q, <span style="color:#777">/**/</span> DFluPack *p);
<span style="color:#088;font-weight:bold">void</span> dflu_download(DFluPack *p, <span style="color:#777">/**/</span> DFluStatus *s);

<span style="color:#777">/* communication */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_post_recv(DFluComm *c, DFluUnpack *u);
<span style="color:#088;font-weight:bold">void</span> dflu_post_send(DFluPack *p, DFluComm   *c);
<span style="color:#088;font-weight:bold">void</span> dflu_wait_recv(DFluComm *c, DFluUnpack *u);
<span style="color:#088;font-weight:bold">void</span> dflu_wait_send(DFluComm *c);

<span style="color:#777">/* unpack */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_unpack(<span style="color:#777">/**/</span> DFluUnpack *u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The map is build from <a href="partlist.html">partlist</a>, allowing the
process to delete particles.</p>
</div>
<div class="paragraph">
<p>The solvent distribution also include cell list generation (see
<a href="clist.html">cell lists</a>).
It is done in two phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>subindices, independant for bulk and remote particles</p>
</li>
<li>
<p>gather, which needs the subindices to be computed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bulk subindices can be computed while comunicating remote particles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* cell lists */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_bulk(PartList lp, <span style="color:#777">/**/</span> FluQuants *q);
<span style="color:#088;font-weight:bold">void</span> dflu_halo(<span style="color:#088;font-weight:bold">const</span> DFluUnpack *u, <span style="color:#777">/**/</span> FluQuants *q);
<span style="color:#088;font-weight:bold">void</span> dflu_gather(<span style="color:#0a8;font-weight:bold">int</span> ndead, <span style="color:#088;font-weight:bold">const</span> DFluPack *p, <span style="color:#088;font-weight:bold">const</span> DFluUnpack *u, <span style="color:#777">/**/</span> FluQuants *q);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rbc">rbc</h4>
<div class="paragraph">
<p>Redistribute red blood cells accross nodes according to the center of
mass of their bounding box (see <a href="algo/minmax.html">minmax</a>).</p>
</div>
<div class="sect4">
<h5 id="_data_structures_6">data structures</h5>
<div class="paragraph">
<p>RBC distribution follows the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> DRbcPack {
    DMap map;
    float3 *minext, *maxext;
    dBags dpp;
    hBags hpp;

    <span style="color:#777">/* optional: ids */</span>
    DMap hmap;
    hBags hii;
};

<span style="color:#080;font-weight:bold">struct</span> DRbcComm {
    <span style="color:#777">/* optional: ids */</span>
    Comm *pp, *ii;
};

<span style="color:#080;font-weight:bold">struct</span> DRbcUnpack {
    hBags hpp;

    <span style="color:#777">/* optional: ids */</span>
    hBags hii;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>minext</code> and <code>maxext</code> contain the bounding box informations of
each RBC. Other variables have the same naming conventions than <code>distr::flu</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_interface_14">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> drbc_pack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxc, <span style="color:#0a8;font-weight:bold">int</span> nv, DRbcPack **p);
<span style="color:#088;font-weight:bold">void</span> drbc_comm_ini(MPI_Comm comm, <span style="color:#777">/**/</span> DRbcComm **c);
<span style="color:#088;font-weight:bold">void</span> drbc_unpack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxc, <span style="color:#0a8;font-weight:bold">int</span> nv, DRbcUnpack **u);

<span style="color:#088;font-weight:bold">void</span> drbc_pack_fin(DRbcPack *p);
<span style="color:#088;font-weight:bold">void</span> drbc_comm_fin(DRbcComm *c);
<span style="color:#088;font-weight:bold">void</span> drbc_unpack_fin(DRbcUnpack *u);

<span style="color:#088;font-weight:bold">void</span> drbc_build_map(<span style="color:#0a8;font-weight:bold">int</span> nc, <span style="color:#0a8;font-weight:bold">int</span> nv, <span style="color:#088;font-weight:bold">const</span> Particle *pp, DRbcPack *p);
<span style="color:#088;font-weight:bold">void</span> drbc_pack(<span style="color:#088;font-weight:bold">const</span> RbcQuants *q, <span style="color:#777">/**/</span> DRbcPack *p);
<span style="color:#088;font-weight:bold">void</span> drbc_download(DRbcPack *p);

<span style="color:#088;font-weight:bold">void</span> drbc_post_recv(DRbcComm *c, DRbcUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drbc_post_send(DRbcPack *p, DRbcComm *c);
<span style="color:#088;font-weight:bold">void</span> drbc_wait_recv(DRbcComm *c, DRbcUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drbc_wait_send(DRbcComm *c);

<span style="color:#088;font-weight:bold">void</span> drbc_unpack_bulk(<span style="color:#088;font-weight:bold">const</span> DRbcPack *p, <span style="color:#777">/**/</span> RbcQuants *q);
<span style="color:#088;font-weight:bold">void</span> drbc_unpack_halo(<span style="color:#088;font-weight:bold">const</span> DRbcUnpack *u, <span style="color:#777">/**/</span> RbcQuants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rig">rig</h4>
<div class="paragraph">
<p>Redistribute rigid objects accross nodes according to their center of
mass.</p>
</div>
<div class="sect4">
<h5 id="_data_structures_7">data structures</h5>
<div class="paragraph">
<p>Rigid bodies distribution is very similar to the above. The <em>hidden</em> data
structures fit again in the general workflow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/*
 ipp: particles of the mesh
 ss:  &quot;Solid&quot; structures
*/</span>

<span style="color:#080;font-weight:bold">struct</span> DRigPack {
    DMap map;
    dBags dipp, dss;
    hBags hipp, hss;
};

<span style="color:#080;font-weight:bold">struct</span> DRigComm {
    Comm *ipp, *ss;
};

<span style="color:#080;font-weight:bold">struct</span> DRigUnpack {
    hBags hipp, hss;
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_15">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> drig_pack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxns, <span style="color:#0a8;font-weight:bold">int</span> nv, DRigPack **p);
<span style="color:#088;font-weight:bold">void</span> drig_comm_ini(MPI_Comm comm, <span style="color:#777">/**/</span> DRigComm **c);
<span style="color:#088;font-weight:bold">void</span> drig_unpack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxns, <span style="color:#0a8;font-weight:bold">int</span> nv, DRigUnpack **u);

<span style="color:#088;font-weight:bold">void</span> drig_pack_fin(DRigPack *p);
<span style="color:#088;font-weight:bold">void</span> drig_comm_fin(DRigComm *c);
<span style="color:#088;font-weight:bold">void</span> drig_unpack_fin(DRigUnpack *u);

<span style="color:#088;font-weight:bold">void</span> drig_build_map(<span style="color:#0a8;font-weight:bold">int</span> ns, <span style="color:#088;font-weight:bold">const</span> Solid *ss, <span style="color:#777">/**/</span> DRigPack *p);
<span style="color:#088;font-weight:bold">void</span> drig_pack(<span style="color:#0a8;font-weight:bold">int</span> ns, <span style="color:#0a8;font-weight:bold">int</span> nv, <span style="color:#088;font-weight:bold">const</span> Solid *ss, <span style="color:#088;font-weight:bold">const</span> Particle *ipp, <span style="color:#777">/**/</span> DRigPack *p);
<span style="color:#088;font-weight:bold">void</span> drig_download(DRigPack *p);

<span style="color:#088;font-weight:bold">void</span> drig_post_recv(DRigComm *c, DRigUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drig_post_send(DRigPack *p, DRigComm *c);
<span style="color:#088;font-weight:bold">void</span> drig_wait_recv(DRigComm *c, DRigUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drig_wait_send(DRigComm *c);

<span style="color:#088;font-weight:bold">void</span> drig_unpack_bulk(<span style="color:#088;font-weight:bold">const</span> DRigPack *p, <span style="color:#777">/**/</span> RigQuants *q);
<span style="color:#088;font-weight:bold">void</span> drig_unpack_halo(<span style="color:#088;font-weight:bold">const</span> DRigUnpack *u, <span style="color:#777">/**/</span> RigQuants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_common">common</h4>
<div class="paragraph">
<p>helpers: common kernels</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> dcommon_pack_pp_packets(<span style="color:#0a8;font-weight:bold">int</span> nc, <span style="color:#0a8;font-weight:bold">int</span> nv, <span style="color:#088;font-weight:bold">const</span> Particle *pp, DMap m, <span style="color:#777">/**/</span> Sarray&lt;Particle*, <span style="color:#00D">27</span>&gt; buf); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> dcommon_shift_one_frag(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> fid, <span style="color:#777">/**/</span> Particle *pp); <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> dcommon_shift_halo(<span style="color:#0a8;font-weight:bold">int</span> nhalo, <span style="color:#088;font-weight:bold">const</span> Sarray&lt;<span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#00D">27</span>&gt; starts, <span style="color:#777">/**/</span> Particle *pp); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>pack <code>nc</code>  packets of <code>nv</code> particles into 27 buffers <code>buf</code> according to map</p>
</li>
<li>
<p>shift particles in the fragment direction</p>
</li>
<li>
<p>shift all particles according to the fragment direction</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fluforces">fluforces</h3>
<div class="paragraph">
<p>solvent forces</p>
</div>
<div class="sect3">
<h4 id="_interface_16">interface</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_8">data structures</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_submodules">submodules</h4>
<div class="sect4">
<h5 id="_bulk">bulk</h5>
<div class="paragraph">
<p>compute local interactions of solvent particles, given cell starts,
cell counts (see <a href="clist.html">clist</a>) and particles array</p>
</div>
</div>
<div class="sect4">
<h5 id="_fluforces_halo">fluforces: halo</h5>
<div class="paragraph">
<p>solvent forces with remote particles (fragments)</p>
</div>
<div class="sect5">
<h6 id="_internals">Internals</h6>
<div class="paragraph">
<p>main kernel is <code>dev::forces</code> and performs all interactions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>dispatch threads along fragments</p>
</li>
<li>
<p>fetch generalized particle</p>
</li>
<li>
<p>build map (how to access neighboring particles?)</p>
</li>
<li>
<p>loop over neighboring particles according to map</p>
</li>
<li>
<p>compute pairwise interactions</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fsi">fsi</h3>
<div class="paragraph">
<p>flow-structure interactions between solvent and objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect3">
<h4 id="_interface_17">interface</h4>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> fsi_ini(<span style="color:#0a8;font-weight:bold">int</span> rank, <span style="color:#777">/**/</span> Fsi **fsi);
<span style="color:#088;font-weight:bold">void</span> fsi_fin(Fsi *fsi);</code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> fsi_bind_solvent(Cloud c, Force *ff, <span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#0a8;font-weight:bold">int</span> *starts, <span style="color:#777">/**/</span> Fsi *fsi); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> fsi_bulk(Fsi *fsi, <span style="color:#0a8;font-weight:bold">int</span> nw, PaWrap *pw, FoWrap *fw);                      <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> fsi_halo(Fsi *fsi, Pap26 PP, Fop26 FF, <span style="color:#0a8;font-weight:bold">int</span> counts[<span style="color:#00D">26</span>]);                  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>store solvent interactions inside hidden structure <code>Fsi</code></p>
</li>
<li>
<p>compute the interactions between local objects and local solvent</p>
</li>
<li>
<p>compute the interactions between remote objects and local solvent</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_math">Math</h3>
<div class="paragraph">
<p>Helpers for math operations and random number generation</p>
</div>
<div class="sect3">
<h4 id="_linal">linal</h4>
<div class="paragraph">
<p>Linear algebra helpers on host</p>
</div>
<div class="sect4">
<h5 id="_interface_18">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* invert symmetric matrix m0[6] */</span>
<span style="color:#088;font-weight:bold">void</span> linal_inv3x3(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> *m0, <span style="color:#777">/**/</span> <span style="color:#0a8;font-weight:bold">float</span> *minv0); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>inverse symmetric 3 by 3 matrix; fails and returns an error for
singular matrices with determinant smaller than epsilon (hardcoded
to <code>1e-8</code>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>structure of the matrix is <code>xx, xy, yy, yz, zz</code>, where</p>
</div>
<div class="listingblock">
<div class="content">
<pre>     ( xx xy xz)
A =  ( xy yy yz)
     ( xz yz zz)</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_host_random_number_generation">Host random number generation</h4>
<div class="paragraph">
<p>Generate uniform random numbers on host in floating point precision</p>
</div>
<div class="sect4">
<h5 id="_interface_19">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> RNDunif;                                             <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> rnd_ini(<span style="color:#0a8;font-weight:bold">int</span> x, <span style="color:#0a8;font-weight:bold">int</span> y, <span style="color:#0a8;font-weight:bold">int</span> z, <span style="color:#0a8;font-weight:bold">int</span> c, <span style="color:#777">/**/</span> RNDunif **r); <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> rnd_fin(RNDunif *r);                                   <b class="conum">(3)</b>
<span style="color:#0a8;font-weight:bold">float</span> rnd_get(RNDunif *r);                                  <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>hidden structure containing state of the rng</p>
</li>
<li>
<p>allocate and initialize the rng (<code>x</code>, <code>y</code>, <code>z</code> and <code>c</code> are states of the rng)</p>
</li>
<li>
<p>deallocate rng states</p>
</li>
<li>
<p>generate a random number in single precision; modify the state</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_linar_coordinate_transformation_for_3d_vector">linar coordinate transformation for 3D vector</h4>
<div class="paragraph">
<p>Transform vector <code>a[3]</code> to <code>b[3]</code> using</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    b[X] = s[X]*a[X] + o[X]
    b[Y] = s[Y]*a[Y] + o[Y]
    b[Z] = s[Z]*a[Z] + o[Z]</pre>
</div>
</div>
<div class="paragraph">
<p>Coefficient <code>s</code> and <code>o</code> are defined implicitly by API calls.</p>
</div>
<div class="sect4">
<h5 id="_interface_20">interface</h5>
<div class="sect5">
<h6 id="_allocate_deallocate">Allocate/Deallocate</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> tform_ini(Tform**);
<span style="color:#088;font-weight:bold">void</span> tform_fin(Tform*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters of the transformation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> tform_vector(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> a0[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> a1[<span style="color:#00D">3</span>],   <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> b0[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> b1[<span style="color:#00D">3</span>], <span style="color:#777">/**/</span> Tform*); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> tform_chain(Tform*, Tform*, <span style="color:#777">/**/</span> Tform*); <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> tform_grid2grid(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> f_lo[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> f_hi[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> f_n[<span style="color:#00D">3</span>],
                     <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> t_lo[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> t_hi[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> t_n[<span style="color:#00D">3</span>], <span style="color:#777">/**/</span>
                     Tform*);
<span style="color:#088;font-weight:bold">void</span> tform_to_grid(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> a0[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> b0[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> n[<span style="color:#00D">3</span>], <span style="color:#777">/**/</span> Tform*);
<span style="color:#088;font-weight:bold">void</span> tform_from_grid(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> a0[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> b0[<span style="color:#00D">3</span>], <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> n[<span style="color:#00D">3</span>], <span style="color:#777">/**/</span> Tform*);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>transfrom which convert vectors <code>a0</code> to <code>a1</code> and <code>b0</code> to <code>b1</code></p>
</li>
<li>
<p>transform is a chain of two transforms</p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="_convert_vector">Convert vector</h7>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> tform_convert(Tform*, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> a0[<span style="color:#00D">3</span>], <span style="color:#777">/**/</span> <span style="color:#0a8;font-weight:bold">float</span> a1[<span style="color:#00D">3</span>]);</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_convert_to_view">convert to view</h7>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> tform_to_view(Tform*, <span style="color:#777">/**/</span> Tform_v*);</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_log">log</h7>
<div class="paragraph">
<p>Log or dump the state of 'Tform'</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> tform_log(Tform*);
<span style="color:#088;font-weight:bold">void</span> tform_dump(Tform*, FILE*);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parser">parser</h3>
<div class="sect3">
<h4 id="_purpose_3">purpose</h4>
<div class="ulist">
<ul>
<li>
<p>wrapper for the <code>libconfig</code> library</p>
</li>
<li>
<p>holds configurations from 3 sources:</p>
<div class="ulist">
<ul>
<li>
<p>arguments (priority 3)</p>
</li>
<li>
<p>configuration file (priority 2)</p>
</li>
<li>
<p>default parameters (priority 1)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When retrieving a value, the source with higher priority is used.
If not found in a source, the value is retrieved from the next highest
priority.
If no source contains the parmeter, an error is raised.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structure_2">data structure</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#080;font-weight:bold">enum</span> {
    EXE, <span style="color:#777">/* from program         */</span>
    ARG, <span style="color:#777">/* from arguments       */</span>
    OPT, <span style="color:#777">/* from additional file */</span>
    DEF, <span style="color:#777">/* from default file    */</span>
    NCFG
};

<span style="color:#080;font-weight:bold">struct</span> Config {
    config_t c[NCFG];
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Consists of an array of <code>config_t</code> descriptors, ordered by priority.
Indices correspond to the <code>enum</code> keys.
The first key has the highest priority, second key has second highest
priority etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_21">interface</h4>
<div class="paragraph">
<p>Allocate and free the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> conf_ini(<span style="color:#777">/**/</span> Config **c);
<span style="color:#088;font-weight:bold">void</span> conf_fin(<span style="color:#777">/**/</span> Config *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read data from the default, optional and command line config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> conf_read(<span style="color:#0a8;font-weight:bold">int</span> argc, <span style="color:#0a8;font-weight:bold">char</span> **argv, <span style="color:#777">/**/</span> Config *cfg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> conf_lookup_int(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *a);
<span style="color:#088;font-weight:bold">void</span> conf_lookup_float(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">float</span> *a);
<span style="color:#088;font-weight:bold">void</span> conf_lookup_bool(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *a);
<span style="color:#088;font-weight:bold">void</span> conf_lookup_string(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> **a);
<span style="color:#088;font-weight:bold">void</span> conf_lookup_vint(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#0a8;font-weight:bold">int</span> a[]);
<span style="color:#088;font-weight:bold">void</span> conf_lookup_vfloat(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#0a8;font-weight:bold">float</span> a[]);
<span style="color:#088;font-weight:bold">void</span> conf_lookup_float3(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, float3 *a);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the program raises an error if the argument is not found.</p>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#0a8;font-weight:bold">bool</span> conf_opt_int(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *a);
<span style="color:#0a8;font-weight:bold">bool</span> conf_opt_float(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">float</span> *a);
<span style="color:#0a8;font-weight:bold">bool</span> conf_opt_bool(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *a);
<span style="color:#0a8;font-weight:bold">bool</span> conf_opt_string(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> **a);
<span style="color:#0a8;font-weight:bold">bool</span> conf_opt_vint(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#0a8;font-weight:bold">int</span> a[]);
<span style="color:#0a8;font-weight:bold">bool</span> conf_opt_vfloat(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, <span style="color:#0a8;font-weight:bold">int</span> *n, <span style="color:#0a8;font-weight:bold">float</span> a[]);
<span style="color:#0a8;font-weight:bold">bool</span> conf_opt_float3(<span style="color:#088;font-weight:bold">const</span> Config *c, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *desc, float3 *a);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program does not raise error if the variable is not found.
The return value is <code>true</code> if the variable has been found and <code>false</code> otherwise.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_partlist">partlist</h3>
<div class="paragraph">
<p>Part list: a structure to handle a list of dead or alive particles
Purpose: kill particles during redistribution or cell lists build</p>
</div>
<div class="sect3">
<h4 id="_data_structure_3">data structure</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> PartList {
    <span style="color:#088;font-weight:bold">const</span> Particle *pp;   <span style="color:#777">/* particles array          */</span>
    <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> *deathlist; <span style="color:#777">/* what pp is dead or alive */</span>
};</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_22">interface</h4>
<div class="paragraph">
<p>contains only device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#0a8;font-weight:bold">bool</span> is_dead(<span style="color:#0a8;font-weight:bold">int</span> i, <span style="color:#088;font-weight:bold">const</span> PartList lp) {
    <span style="color:#080;font-weight:bold">if</span> (lp.deathlist)
        <span style="color:#080;font-weight:bold">return</span> lp.deathlist[i] == DEAD;
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>;
}

<span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#0a8;font-weight:bold">bool</span> is_alive(<span style="color:#0a8;font-weight:bold">int</span> i, <span style="color:#088;font-weight:bold">const</span> PartList lp) {
    <span style="color:#080;font-weight:bold">return</span> !is_dead(i, lp);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rbc_membrane_forces">RBC membrane forces</h3>
<div class="stemblock">
<div class="content">
\[e^{i\pi} = -1\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_red_blood_cell">Red blood cell</h3>
<div class="paragraph">
<p>Red blood cell. <a href="type.h">src/rbc/type.h</a> defines <code>struct rbc::Quants</code></p>
</div>
<div class="sect3">
<h4 id="_components">components</h4>
<div class="ulist">
<ul>
<li>
<p>adj adjacency list: a structure to pack mesh to read on device</p>
</li>
<li>
<p>com compute center of mass</p>
</li>
<li>
<p>edg store information for every edge (host)</p>
</li>
<li>
<p>internal forces: <a href="forces.html">forces</a></p>
</li>
<li>
<p>gen generate <code>pp</code> from cell template (<code>rbc.off</code>) and initial condition
files (<code>rbcs-ic.txt</code>)</p>
</li>
<li>
<p><a href="com">main</a> initialization, restart</p>
</li>
<li>
<p>rnd random numbers for internal forces</p>
</li>
<li>
<p>rnd/api low level api for random number generator</p>
</li>
<li>
<p>force/area_volume compute area and volume</p>
</li>
<li>
<p>stretch apply a force to every vertex of every cell, force is set from
a file <code>rbc.stretch</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also <code>src/u/rbc</code>, <code>src/test/rbccom</code>, <code>src/test/rbc</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_cell_templates">cell templates</h4>
<div class="paragraph">
<p>See <code>src/data/cells</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_random_force">random force</h3>
<div class="paragraph">
<p>Activate by <code>RBC_RND</code> in <code>conf.h</code>. If environment variable <code>RBC_RNC</code> is
set it is used as seed. Magnitude of the force is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>g = RBCgammaC; T = RBCkbT
f0  = sqrtf(2*g*T/dt)*rnd</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_signed_distance_function_sdf">signed distance function (sdf)</h3>
<div class="sect3">
<h4 id="_purpose_4">purpose</h4>
<div class="paragraph">
<p>Signed distance function is interpolated from a uniform grid.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementation">implementation</h4>

</div>
<div class="sect3">
<h4 id="_components_2">components</h4>
<div class="ulist">
<ul>
<li>
<p><code>field</code>: read sdf field from a file</p>
</li>
<li>
<p><code>bounce</code>: bounce back particles</p>
</li>
<li>
<p><code>label</code>: label which particle stays in bulk, turns into wall, or
deleted</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_utils">Utils</h3>
<div class="sect3">
<h4 id="error">error</h4>
<div class="paragraph">
<p>Custom error handling with context.</p>
</div>
<div class="sect4">
<h5 id="_usage">Usage</h5>
<div class="ulist">
<ul>
<li>
<p>an error can be raised by the use of one of the following macros:</p>
<div class="ulist">
<ul>
<li>
<p><code>signal_error_extra(fmt, &#8230;&#8203;)</code> will raise an error with extra
information formatted by the caller in a prinf format fashion</p>
</li>
</ul>
</div>
</li>
<li>
<p>use macro <code>UC</code> on any function which might contain an error signal in
one of the subfunctions.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_interface_23">Interface</h5>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cc">cc</h4>
<div class="paragraph">
<p>[C]uda [C]heck.</p>
</div>
<div class="paragraph">
<p>Error handling for cuda API calls.</p>
</div>
<div class="sect4">
<h5 id="_usage_2">Usage</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">CC(my_cuda_api_call());</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">error</a>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mc">mc</h4>
<div class="paragraph">
<p>[M]PI [C]heck.</p>
</div>
<div class="paragraph">
<p>Error handling for MPI API calls.</p>
</div>
<div class="sect4">
<h5 id="_usage_3">Usage</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">MC(my_mpi_api_call());</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">error</a>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_kernel_launch_macros">kernel launch macros</h4>
<div class="paragraph">
<p>[K]ernel [L]aunch.</p>
</div>
<div class="paragraph">
<p>a macro for cuds kernel launches</p>
</div>
<div class="paragraph">
<p>All but <code>unsafe</code> skip kernels with zero thread number.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">KL(fun, (i+<span style="color:#00D">1</span>, j, k), ())     -&gt; fun&lt;&lt;&lt;i+<span style="color:#00D">1</span>, j, k&gt;&gt;&gt;()
KL(fun, (i+<span style="color:#00D">1</span>, j, k), (a, b)) -&gt; fun&lt;&lt;&lt;i+<span style="color:#00D">1</span>, j, k&gt;&gt;&gt;(a, b)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wvel">wvel</h3>
<div class="paragraph">
<p>wall velocity field</p>
</div>
<div class="sect3">
<h4 id="_purpose_5">purpose</h4>
<div class="ulist">
<ul>
<li>
<p>set velocity to wall particles for wall interactions</p>
</li>
<li>
<p>get wall velocity for bounce back on walls</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_9">data structures</h4>
<div class="paragraph">
<p>data structures are separated into 2 kinds of data structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Wvel</code>, which contains all informations needed for the velocity
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>Wvel_v</code> (<code>Wvel view</code>), containing only the information needed for one
specific time. It is passed to device kernels.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interface_24">interface</h4>
<div class="paragraph">
<p>Interface is splitted between host and device</p>
</div>
<div class="sect4">
<h5 id="_host">Host</h5>
<div class="paragraph">
<p>Host code is responsible for initialisation of <code>Wvel</code> and convert
<code>Wvel</code> to a view at a given timestep.</p>
</div>
<div class="paragraph">
<p>alloc, free structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> wvel_ini(Wvel **wv);
<span style="color:#088;font-weight:bold">void</span> wvel_fin(Wvel *wv);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> wvel_set_cste(float3 u, Wvel *vw);
<span style="color:#088;font-weight:bold">void</span> wvel_set_shear(<span style="color:#0a8;font-weight:bold">float</span> gdot, <span style="color:#0a8;font-weight:bold">int</span> vdir, <span style="color:#0a8;font-weight:bold">int</span> gdir, <span style="color:#0a8;font-weight:bold">int</span> half, Wvel *vw);
<span style="color:#088;font-weight:bold">void</span> wvel_set_shear_sin(<span style="color:#0a8;font-weight:bold">float</span> gdot, <span style="color:#0a8;font-weight:bold">int</span> vdir, <span style="color:#0a8;font-weight:bold">int</span> gdir, <span style="color:#0a8;font-weight:bold">int</span> half, <span style="color:#0a8;font-weight:bold">float</span> w, <span style="color:#0a8;font-weight:bold">int</span> log_freq, Wvel *vw);
<span style="color:#088;font-weight:bold">void</span> wvel_set_hs(<span style="color:#0a8;font-weight:bold">float</span> u, <span style="color:#0a8;font-weight:bold">float</span> h, Wvel *vw);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> wvel_set_conf(<span style="color:#088;font-weight:bold">const</span> Config *cfg, Wvel *vw);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get <em>view</em> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">void</span> wvel_get_view(<span style="color:#0a8;font-weight:bold">long</span> it, <span style="color:#088;font-weight:bold">const</span> Wvel *wv, <span style="color:#777">/**/</span> Wvel_v *view);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_device">Device</h5>
<div class="paragraph">
<p>Device code contains the functions describing the field.
Also contains bouncer function: gives bounced-back velocity from
position and velocity of particle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#088;font-weight:bold">void</span> wvel(Wvel_v wv, Coords_v c, float3 r, <span style="color:#777">/**/</span> float3 *v)
<span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#088;font-weight:bold">void</span> bounce_vel(Wvel_v wv, Coords_v c, float3 rw, <span style="color:#777">/* io */</span> float3* v)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_7">Configuration</h4>
<div class="sect4">
<h5 id="_constant_2">constant</h5>
<div class="paragraph">
<p>constant velocity \(u = (1, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel {
    type = &quot;constant&quot;;
    u    = [1.0, 0.0, 0.0];
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_shear_2">shear</h5>
<div class="paragraph">
<p>shear velocity \(u = (3 y, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel {
    type = &quot;shear&quot;;
    gdot = 3.0;
    vdir = 0;
    gdir = 1;
    half = 0;
};</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sinusoidal_shear">sinusoidal shear</h5>
<div class="paragraph">
<p>shear velocity \(u(t) = (3 y \sin(5 t), 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel {
    type = &quot;shear sin&quot;;
    gdot = 3.0;
    vdir = 0;
    gdir = 1;
    half = 0;
    w = 5.0;
    log_freq = 1000;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>in this case, the value \(3 * \sin(5 t)\) is printed every 1000 iterations.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hele_shaw">Hele Shaw</h5>
<div class="paragraph">
<p>velocity \(u_r = \frac u r \left(1 - \frac {4 z^2}{h^2}\right)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel {
    type = &quot;hele shaw&quot;;
    u = 1.0;
    h = 8.0;
};</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_third_party_dependencies">Third party dependencies</h3>
<div class="sect3">
<h4 id="_cuda_compiler">cuda compiler</h4>
<div class="paragraph">
<p>link:http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc</p>
</div>
</div>
<div class="sect3">
<h4 id="_mpi_library">MPI library</h4>
<div class="paragraph">
<p>To get the flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mpicxx -show</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pkg-config --libs mpich</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_libconfig">libconfig</h4>
<div class="paragraph">
<p>a library for processing structured configuration files</p>
</div>
<div class="paragraph">
<p>link:http://hyperrealm.com/libconfig/libconfig.html</p>
</div>
<div class="sect4">
<h5 id="_from_source">from source</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">v=1.7.1
wget https://hyperrealm.github.io/libconfig/dist/libconfig-$v.tar.gz
tar zxvf libconfig-$v.tar.gz
cd libconfig-$v
./configure --prefix=${HOME}/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_from_git">from git</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">git clone git@github.com:hyperrealm/libconfig.git
cd libconfig
autoreconf
./configure --prefix=${HOME}/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_from_apt">from apt</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo apt install libconfig-dev</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pkgconfig">pkgconfig</h5>
<div class="paragraph">
<p>add path for pkg config</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:$HOME/prefix/libconfig/lib/pkgconfig</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hdf5">hdf5</h4>
<div class="paragraph">
<p>a data model, library, and file format for storing and managing data</p>
</div>
<div class="paragraph">
<p><a href="https://support.hdfgroup.org/HDF5" class="bare">https://support.hdfgroup.org/HDF5</a></p>
</div>
<div class="paragraph">
<p>To get flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">h5c++ -show</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">pkg-config hdf5-mpich --libs</code></pre>
</div>
</div>
<div class="paragraph">
<p>To build from source</p>
</div>
<div class="paragraph">
<p>link:https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.17/src/hdf5-1.8.17.tar.gz</p>
</div>
<div class="paragraph">
<p>Configuration options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">      --prefix=$HOME/prefix/hdf5
          --enable-parallel
          CXX=/usr/lib64/mpich/bin/mpic++
          CC=/usr/lib64/mpich/bin/mpicc</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wrappers">wrappers</h3>
<div class="sect3">
<h4 id="intro">intro</h4>
<div class="paragraph">
<p><code>u.run</code> respects several environment variables to modify the way <code>udx</code>
is run</p>
</div>
</div>
<div class="sect3">
<h4 id="mem">MEM</h4>
<div class="paragraph">
<p>if <code>MEM</code> is set <code>udx</code> is ran with <code>cuda-memcheck</code> and <code>MEM</code> is used as a
list of parameters</p>
</div>
<div class="literalblock">
<div class="content">
<pre>MEM= u.test test/*
MEM='--leakcheck --blocking'              u.test test/*
MEM='--tool initcheck'                    u.test test/*</pre>
</div>
</div>
<div class="paragraph">
<p>see also <a href="poc/memcheck">poc/memcheck</a></p>
</div>
</div>
<div class="sect3">
<h4 id="val">VAL</h4>
<div class="paragraph">
<p>if <code>VAL</code> is set <code>udx</code> is ran with valgrind and <code>VAL</code> is used as a list
of parameters.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>VAL= u.test test/*
VAL="--leak-check=full --show-leak-kinds=all"  u.test test/*</pre>
</div>
</div>
<div class="paragraph">
<p><code>u.run</code> respect <code>DRYRUN</code> : only show the commands do not execute them</p>
</div>
<div class="literalblock">
<div class="content">
<pre>DRYRUN= VAL=--option u.run ./udx

module: load cray-hdf5-parallel cudatoolkit daint-gpu
cmd: srun -n 1 -u valgrind --option ./udx 1 1 1</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="prof">PROF</h4>
<div class="paragraph">
<p>if <code>PROF</code> is set is ran with <code>nvprof</code></p>
</div>
<div class="paragraph">
<p>See also <a href="poc/prof/ppbandwidth">poc/ppbandwidth</a></p>
</div>
</div>
<div class="sect3">
<h4 id="tim">TIM</h4>
<div class="paragraph">
<p>if <code>TIM</code> is set is ran with <code>time</code></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user">User</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_user_documentation">user documentation</h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_units">Units</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_comm_unit">comm unit</h3>
<div class="paragraph">
<p>a send/recv unit with the 26 neighbors using <a href="../dev/modules/comm.html">comm module</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_error_unit">error unit</h3>
<div class="paragraph">
<p>a unit to test error handling <code>UC</code>, <code>CC</code> and <code>MC</code> (see <a href="../dev/modules/utils/main.html">utils</a>)</p>
</div>
<div class="sect3">
<h4 id="_compile">compile</h4>
<div class="paragraph">
<p>from <code>/src/</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">u.conf0 u/error
u.make -j</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_usage_4">usage</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">ERR_KIND=&lt;kind&gt; ./udx</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>&lt;kind&gt;</code> must be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0 for rasing an error from host code</p>
</li>
<li>
<p>1 for testing <code>MC</code> on a failing MPI call</p>
</li>
<li>
<p>2 for testing <code>CC</code> on a failing cuda API call</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The output should result in an error message, location of the error
and a backtrace</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hw_unit">hw unit</h3>
<div class="paragraph">
<p>a "Hello World!" unit with kernel launch.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hw_unit_2">hw unit</h3>
<div class="paragraph">
<p>a "Hello World!" unit. This serves as a base for creating new units</p>
</div>
</div>
<div class="sect2">
<h3 id="_linal_unit">linal unit</h3>
<div class="paragraph">
<p>a unit to test linear algebra functions</p>
</div>
<div class="sect3">
<h4 id="_compile_2">compile</h4>
<div class="paragraph">
<p>Run from src/</p>
</div>
<div class="listingblock">
<div class="content">
<pre>u.conf0 u/linal</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run">run</h4>
<div class="paragraph">
<p>Invert symmetric 3x3 matrix</p>
</div>
<div class="listingblock">
<div class="content">
<pre>u.run ./udx -- 2 1 5   3 4   -2
2.857143e-01 -2.857143e-01 1.428571e-01 3.766234e-01 3.896104e-02 -6.493507e-02</pre>
</div>
</div>
<div class="paragraph">
<p>compare to octave/matlab</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt;&gt; C = [2,1,5;1,3,4;5,4,-2]
&gt;&gt; C^(-1)
ans =

   0.285714  -0.285714   0.142857
  -0.285714   0.376623   0.038961
   0.142857   0.038961  -0.064935</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_units_2">units</h3>
<div class="paragraph">
<p>uDeviceX consists of units. They are implemented in link::/src/u/[/src/u/].</p>
</div>
<div class="sect3">
<h4 id="_build_and_run">Build and run</h4>
<div class="paragraph">
<p>Compile unit <code>A</code>: from <code>/src</code> directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">u.conf0 ./u/A
u.make -j</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_update_make_file_fragments">Update make file fragments</h4>
<div class="paragraph">
<p>From <code>/src</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">u.u u/A</code></pre>
</div>
</div>
<div class="paragraph">
<p>updates <code>hw/make/*.mk</code> files</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_new_unit">Create a new unit</h4>
<div class="paragraph">
<p>From <code>/src</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">mkdir -p hw/make</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add two file: <code>hw/make/i</code> and <code>hw/make/e</code>. The files are used by <code>u.u</code>
to create a list of unit source files. <code>i</code> is a script which returns a
list of [i]ncluded files. <code>e</code> returns a list of [e]xcluded files. The
<code>i</code> list "minus" <code>e</code> list is used as a source. <code>e</code> file is
optional. In other words <code>e</code> "black lists" files returned by <code>i</code>.</p>
</div>
<div class="paragraph">
<p>For <code>i</code> and <code>e</code> the variable <code>$U</code> is set to <code>u/hw/hst</code>.</p>
</div>
<div class="paragraph">
<p>Run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">u.u u/hw/hst</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add <code>u/hw/hst/make/dep.mk u/hw/hst/make/obj.mk u/hw/hstmake/dir.mk
u/hw/hst/make/rule.mk</code> to git.</p>
</div>
</div>
<div class="sect3">
<h4 id="_list_of_units">list of units</h4>
<div class="ulist">
<ul>
<li>
<p><a href="comm.html">comm</a></p>
</li>
<li>
<p><a href="error.html">error</a></p>
</li>
<li>
<p>hello world</p>
<div class="ulist">
<ul>
<li>
<p><a href="hw/hst.html">host</a></p>
</li>
<li>
<p><a href="hw/dev.html">cuda</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="meshbb.html">meshbb</a></p>
</li>
<li>
<p><a href="mpi.html">mpi</a></p>
</li>
<li>
<p><a href="pair.html">pair</a></p>
</li>
<li>
<p>red blood cell units</p>
<div class="ulist">
<ul>
<li>
<p><a href="rbc/force.html">force</a></p>
</li>
<li>
<p><a href="rbc/main.html">main</a></p>
</li>
<li>
<p><a href="rbc/rnd.html">rnd</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="sdf.html">sdf</a></p>
</li>
<li>
<p><a href="scan.html">scan</a></p>
</li>
<li>
<p><a href="x.html">x</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mesh_bb_unit">mesh bb unit</h3>
<div class="sect3">
<h4 id="_intro">intro</h4>
<div class="paragraph">
<p>Bounce back on triangulated mesh</p>
</div>
</div>
<div class="sect3">
<h4 id="_params">params</h4>
<div class="paragraph">
<p>if <code>MESHBB_LOG_ROOTS</code> is defined logs coeficeints of cubic polynomials
and roots to <code>meshbb.roots</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mpi_error">MPI error</h3>
<div class="paragraph">
<p>Units triggers mpi error. A test for <code>MC</code> macro.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pair_unit">pair unit</h3>
<div class="sect3">
<h4 id="_intro_2">Intro</h4>
<div class="paragraph">
<p>It is for test pair interactions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compile_3">Compile</h4>
<div class="paragraph">
<p>Run from src/</p>
</div>
<div class="listingblock">
<div class="content">
<pre>u.conf0 u/pair</pre>
</div>
</div>
<div class="paragraph">
<p>or from other directorie</p>
</div>
<div class="listingblock">
<div class="content">
<pre>s=&lt;path to src&gt;
echo run | u.conf $s u/pair $s/conf/test.h</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_build_2">Build</h4>
<div class="listingblock">
<div class="content">
<pre>u.make -j</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_2">Run</h4>
<div class="paragraph">
<p>Particles coordinates, velocities, kinds, and colors are provided via
<code>stdin</code>. An example is in <a href="/src/data/pair/2">src/data/pair/2</a>.
If <code>RND</code> is set it is used as a scale of random force for all pairs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>s=&lt;path to src&gt;
./udx        &lt; $s/data/pair/2
RND=42 ./udx &lt; $s/data/pair/2</pre>
</div>
</div>
<div class="paragraph">
<p>Returns force between two particles</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-2.4 0 0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_source">Source</h4>
<div class="paragraph">
<p><a href="/src/u/pair/imp/main.h">u/pair/imp/main.h</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_test">Test</h4>
<div class="listingblock">
<div class="content">
<pre>u.test test/pair</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rbc_forces">RBC forces</h3>
<div class="paragraph">
<p>Dumps internal RBC forces.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rbc_2">RBC</h3>
<div class="paragraph">
<p>Runs RBC without solvent and contact forces.</p>
</div>
<div class="paragraph">
<p>See also <a href="src/test/rbc/u/main">src/test/rbc/u/main</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_rbc_random">RBC random</h3>
<div class="paragraph">
<p>Dumps random numbers generated by <a href="src/rbc/rnd">src/rbc/rnd</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_scan_unit">scan unit</h3>
<div class="paragraph">
<p>a unit to test scan algorithm (exclusive prefix sum , see e.g. <a href="https://en.wikipedia.org/wiki/Prefix_sum" class="bare">https://en.wikipedia.org/wiki/Prefix_sum</a>) on host and device.</p>
</div>
</div>
<div class="sect2">
<h3 id="_signed_distance_function_sdf_unit">signed distance function (sdf) unit</h3>
<div class="paragraph">
<p>a unit to test sdf field.</p>
</div>
<div class="sect3">
<h4 id="_compile_4">compile</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">u.conf0 u/sdf
u.make -j</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_3">run</h4>
<div class="paragraph">
<p>Copy sdf file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cp  src/data/sdf/cyl1/cyl.dat sdf.dat</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pass coordinates as arguments</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x=2.5 y=0 z=0
u.run ./udx $x $y $z</pre>
</div>
</div>
<div class="paragraph">
<p>Returns</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1.45547</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_x_unit">x unit</h3>
<div class="paragraph">
<p>standard uDeviceX code</p>
</div>
</div>
</div>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>