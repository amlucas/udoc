<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="Alexeev, D., Amoudruz, L., Bernaschi, M., Bisson, M., Conti, C., Economides, A., Fatica, M., Hadjidoukas, P., Joubert, W., Karniadakis G., Koumoutsakos, P., Kulakova, L., Litvinov, S., Lykov, K., Pivkin, I., Rossinelli, D., Tang, Y.-H.">
<title>uDeviceX Documentation</title>
<link rel="stylesheet" href="/udoc/css/main.css">
<link rel="stylesheet" href="./pygments-colorful.css">
</head>
<body class="article">
<div id="header">
<h1>uDeviceX Documentation</h1>
<div class="details">
<span id="author" class="author">Alexeev, D.</span><br>
<span id="author2" class="author">Amoudruz, L.</span><br>
<span id="author3" class="author">Bernaschi, M.</span><br>
<span id="author4" class="author">Bisson, M.</span><br>
<span id="author5" class="author">Conti, C.</span><br>
<span id="author6" class="author">Economides, A.</span><br>
<span id="author7" class="author">Fatica, M.</span><br>
<span id="author8" class="author">Hadjidoukas, P.</span><br>
<span id="author9" class="author">Joubert, W.</span><br>
<span id="author10" class="author">Karniadakis G.</span><br>
<span id="author11" class="author">Koumoutsakos, P.</span><br>
<span id="author12" class="author">Kulakova, L.</span><br>
<span id="author13" class="author">Litvinov, S.</span><br>
<span id="author14" class="author">Lykov, K.</span><br>
<span id="author15" class="author">Pivkin, I.</span><br>
<span id="author16" class="author">Rossinelli, D.</span><br>
<span id="author17" class="author">Tang, Y.-H.</span><br>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="include/pach.png" alt="pach">
</div>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_developer">1. Developer</a>
<ul class="sectlevel2">
<li><a href="#_introduction">1.1. introduction</a></li>
<li><a href="#_build">1.2. build</a></li>
<li><a href="#_coding_conventions">1.3. coding conventions</a></li>
<li><a href="#_emacs_setting">1.4. emacs setting</a></li>
<li><a href="#_doc">1.5. doc</a></li>
<li><a href="#_gource_commands">1.6. gource commands</a></li>
<li><a href="#_minmax">1.7. minmax</a></li>
<li><a href="#_scan">1.8. scan</a></li>
<li><a href="#_body_forces">1.9. body forces</a></li>
<li><a href="#_clist">1.10. clist</a></li>
<li><a href="#_cnt">1.11. cnt</a></li>
<li><a href="#_color">1.12. color</a></li>
<li><a href="#_comm">1.13. comm</a></li>
<li><a href="#_contact_forces">1.14. contact forces</a></li>
<li><a href="#_control">1.15. Control</a></li>
<li><a href="#_coords">1.16. coords</a></li>
<li><a href="#_generic_d_evice_api">1.17. generic [d]evice API</a></li>
<li><a href="#_debug">1.18. debug</a></li>
<li><a href="#_distr">1.19. distr</a></li>
<li><a href="#_exch">1.20. exch</a></li>
<li><a href="#_fluforces">1.21. fluforces</a></li>
<li><a href="#_frag">1.22. frag</a></li>
<li><a href="#_fsi">1.23. fsi</a></li>
<li><a href="#_io">1.24. IO</a></li>
<li><a href="#_math">1.25. Math</a></li>
<li><a href="#_scheme_move">1.26. scheme/move</a></li>
<li><a href="#_pair">1.27. pair</a></li>
<li><a href="#_parray">1.28. parray</a></li>
<li><a href="#_farray">1.29. farray</a></li>
<li><a href="#_parser">1.30. parser</a></li>
<li><a href="#_partlist">1.31. partlist</a></li>
<li><a href="#_forces">1.32. Forces</a></li>
<li><a href="#_red_blood_cell">1.33. Red blood cell</a></li>
<li><a href="#_random_force">1.34. random force</a></li>
<li><a href="#_shape_rbc">1.35. shape RBC</a></li>
<li><a href="#_stretch_rbc">1.36. stretch RBC</a></li>
<li><a href="#_scheme_restrain">1.37. scheme/restrain</a></li>
<li><a href="#_rigid">1.38. Rigid</a></li>
<li><a href="#_signed_distance_function_sdf">1.39. signed distance function (sdf)</a></li>
<li><a href="#_time">1.40. Time</a></li>
<li><a href="#_time_step">1.41. Time step</a></li>
<li><a href="#_utils">1.42. Utils</a></li>
<li><a href="#_wvel">1.43. wvel</a></li>
<li><a href="#_third_party_dependencies">1.44. Third party dependencies</a></li>
<li><a href="#wrappers">1.45. wrappers</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="_developer">1. Developer</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction">1.1. introduction</h3>
<div class="sect3">
<h4 id="_what_is_em_udevicex_em">1.1.1. what is <em>uDeviceX</em>?</h4>
<div class="paragraph">
<p>It is a dissipate particle dynamic particle simulation code which can
model multiphase flows, rigid objects, and some biological structures.</p>
</div>
</div>
<div class="sect3">
<h4 id="_em_udevicex_em_code">1.1.2. <em>uDeviceX</em> code</h4>
<div class="paragraph">
<p>It is written in C++ using cuda and MPI. Simulation are controlled
from a configuration file and from command line options. Here is an
example</p>
</div>
<div class="listingblock">
<div class="content">
<pre>udx conf.cfg 'glb { dt = 0.1 }'</pre>
</div>
</div>
<div class="paragraph">
<p>Configuration files and command option follow the syntax of
<em>libconfig</em> library. Some parameters have default values and are set
in '$HOME/.udx/defult.cfg'.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build">1.2. build</h3>
<div class="paragraph">
<p>Shows full compilation and linking commands</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>u.make <span class="tok-nv">LOG</span><span class="tok-o">=</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Profile compilation time</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>u.make <span class="tok-nv">LOG</span><span class="tok-o">=</span><span class="tok-s1">&#39;@time -f &quot;%e $&lt;&quot;&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hide compilation messages</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>u.make <span class="tok-nv">LOG</span><span class="tok-o">=</span>@</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_arch_linux">1.2.1. Arch Linux</h4>
<div class="literalblock">
<div class="content">
<pre>u.make MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="literalblock">
<div class="content">
<pre>MAKEFLAGS="MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64" \
				u.test test/compile</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_after_adding_files">1.2.2. after adding files</h4>
<div class="paragraph">
<p>run from src/</p>
</div>
<div class="literalblock">
<div class="content">
<pre>../tools/deps</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coding_conventions">1.3. coding conventions</h3>
<div class="sect3">
<h4 id="_modules">1.3.1. modules</h4>
<div class="paragraph">
<p><em>uDeviceX</em> consists of modules.
Modules are as independant as possible.
They consist of a folder with one or more compilation units, and an
interface.
Whenever it is possible, the structures are hidden from the client of
the module.</p>
</div>
</div>
<div class="sect3">
<h4 id="_naming">1.3.2. naming</h4>
<div class="sect4">
<h5 id="_variables">variables</h5>
<div class="ulist">
<ul>
<li>
<p>names of local variables are short and understandable from the context</p>
</li>
<li>
<p>names of global variables are as descriptive as possible</p>
</li>
<li>
<p>arrays of simple structures <code>x</code> have names <code>xx</code>, eg. <code>pp</code> is an
array of particles, <code>cc</code> is an array of colors, <code>ii</code> is an array of
indices * array of small dimentionality may use an enum type for
readability, e.g.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span><span class="tok-n">X</span><span class="tok-p">,</span> <span class="tok-n">Y</span><span class="tok-p">,</span> <span class="tok-n">Z</span><span class="tok-p">};</span>
<span class="tok-kt">int</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span>
<span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">X</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">rx</span><span class="tok-p">;</span>
<span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">Y</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">ry</span><span class="tok-p">;</span>
<span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">Z</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">rz</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_functions">functions</h5>
<div class="ulist">
<ul>
<li>
<p>a function name is descriptive on its own or inside a module.</p>
</li>
<li>
<p>arguments are ordered as follow:</p>
<div class="ulist">
<ul>
<li>
<p>input is at the beginning</p>
</li>
<li>
<p>input/output come after input and start with a commented <code>io</code></p>
</li>
<li>
<p>output comes after input/output and start with a comment or <code>o</code> depending on the context</p>
</li>
<li>
<p>sizes have higher priority than arrays</p>
</li>
<li>
<p>workspace comes at the end ans starts with a commented <code>w</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>do <strong>not</strong> use references, use pointers instead</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example of valid function declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">read_int_from_file</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">fname</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">forward_euler</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-cm">/* io */</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Function names part of a module interface start with the module name.
Functions private to a module do not need to contain the module name
if the context make it clear. Use the <code>static</code> qualifier for functions
with compilation-unit scope.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_file_structure">1.3.3. file structure</h4>
<div class="ulist">
<ul>
<li>
<p>no include guards; no "headers in headers" if easily avoidable</p>
</li>
<li>
<p>all cuda kernels are in a separate header <code>.h</code> file</p>
</li>
<li>
<p>a module is implemented inside its own directory <code>A</code></p>
<div class="ulist">
<ul>
<li>
<p>it has its own object <code>A/imp.cu</code> or <code>A/imp.cpp</code> (<code>.cpp</code> prefered if possible)</p>
</li>
<li>
<p>interface <code>A/imp.h</code></p>
</li>
<li>
<p>implementation can be done in separate files inside <code>A/imp/</code> directory</p>
</li>
<li>
<p>internal cuda (private to module) code are inside <code>A/dev/</code> directory</p>
</li>
<li>
<p>cuda interface inside <code>A/dev.h</code> (for client use)</p>
</li>
</ul>
</div>
</li>
<li>
<p>modules can have submodules, which follow the same structure as above, e.g. submodule <code>B</code> inside module <code>A</code> belongs to <code>A/B/</code> directory</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_style">1.3.4. style</h4>
<div class="paragraph">
<p>for emacs: the following c++ mode is used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><span></span><span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">u/c-indent-common</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-k">setq</span> <span class="tok-nv">c-basic-offset</span> <span class="tok-mi">4</span>
	<span class="tok-nv">indent-tabs-mode</span> <span class="tok-no">nil</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">u/c++-indent</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-nv">u/c-indent-common</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">c-set-offset</span> <span class="tok-ss">&#39;innamespace</span> <span class="tok-nv">[0]</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">u/c-indent</span> <span class="tok-p">()</span> <span class="tok-p">(</span><span class="tok-nv">u/c-indent-common</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nv">add-hook</span> <span class="tok-ss">&#39;c-mode-hook</span>   <span class="tok-ss">&#39;u/c-indent</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-nv">add-hook</span> <span class="tok-ss">&#39;c++-mode-hook</span> <span class="tok-ss">&#39;u/c++-indent</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">setq</span> <span class="tok-nv">c-default-style</span>
      <span class="tok-o">&#39;</span><span class="tok-p">((</span><span class="tok-nv">java-mode</span> <span class="tok-o">.</span> <span class="tok-s">&quot;java&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">awk-mode</span>  <span class="tok-o">.</span> <span class="tok-s">&quot;awk&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">c-mode</span>    <span class="tok-o">.</span> <span class="tok-s">&quot;k&amp;r&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">cc-mode</span>   <span class="tok-o">.</span> <span class="tok-s">&quot;k&amp;r&quot;</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nv">add-to-list</span> <span class="tok-ss">&#39;auto-mode-alist</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;\\.cu\\&#39;&quot;</span> <span class="tok-o">.</span> <span class="tok-nv">c++-mode</span><span class="tok-p">))</span>
<span class="tok-p">(</span><span class="tok-nv">add-to-list</span> <span class="tok-ss">&#39;auto-mode-alist</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;\\.h\\&#39;&quot;</span>  <span class="tok-o">.</span> <span class="tok-nv">c++-mode</span><span class="tok-p">))</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_emacs_setting">1.4. emacs setting</h3>
<div class="ulist">
<ul>
<li>
<p><a href="cc.el">cc.el</a>: k&amp;r style with offset 4 and not indention for
namespaces</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_doc">1.5. doc</h3>
<div class="paragraph">
<p>Requires <code>asciidoctor</code> and <code>pygments.rb</code>.</p>
</div>
<div class="sect3">
<h4 id="_mac_os_x">1.5.1. Mac OS X</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>gem install asciidoctor
gem install pygments.rb</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arch_linux_2">1.5.2. Arch linux</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>sudo pacman -S asciidoctor
gem install pygments.rb</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gource_commands">1.6. gource commands</h3>
<div class="paragraph">
<p>Display git history of <em>uDeviceX</em> as animated tree.</p>
</div>
<div class="paragraph">
<p>Dump</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nv">o</span><span class="tok-o">=</span>g.ppm
gource -s <span class="tok-m">0</span>.1 --file-filter <span class="tok-s1">&#39;test_data/&#39;</span> <span class="tok-se">\</span>
	      --file-filter <span class="tok-s1">&#39;poc/&#39;</span>  <span class="tok-se">\</span>
	      --file-filter <span class="tok-s1">&#39;tcdf/&#39;</span> <span class="tok-se">\</span>
	      --file-filter <span class="tok-s1">&#39;cmd/&#39;</span>  <span class="tok-se">\</span>
	      --highlight-users   <span class="tok-se">\</span>
	      --highlight-colour FFFFFF <span class="tok-se">\</span>
	      --date-format <span class="tok-s1">&#39;%d %b %Y&#39;</span> -o <span class="tok-nv">$o</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert to mp4</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nv">i</span><span class="tok-o">=</span>g.ppm
<span class="tok-nv">o</span><span class="tok-o">=</span>g.mp4
ffmpeg -y -r <span class="tok-m">60</span> -f image2pipe -vcodec ppm -i <span class="tok-nv">$i</span> -vcodec libx264 <span class="tok-se">\</span>
    -preset ultrafast -pix_fmt yuv420p -crf <span class="tok-m">1</span> -threads <span class="tok-m">0</span> -bf <span class="tok-m">0</span> <span class="tok-nv">$o</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>$ ffmpeg -version
ffmpeg version <span class="tok-m">2</span>.8.11-0ubuntu0.16.04.1 Copyright <span class="tok-o">(</span>c<span class="tok-o">)</span> <span class="tok-m">2000</span>-2017 the FFmpeg developers</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="http://gource.io" class="bare">http://gource.io</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_minmax">1.7. minmax</h3>
<div class="paragraph">
<p>compute extends of chunks of particles</p>
</div>
<div class="ulist">
<ul>
<li>
<p>input is an array of particles, the number of chunks and the number of particles per chunk.</p>
</li>
<li>
<p>output is the bounding box in for each chunk of particles.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_example">1.7.1. example</h4>
<div class="paragraph">
<p>Consider the simple case on 1D:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:
	particles positions:
	0.1 0.5 0.2   0.3 1.2 1.0
	number of chunks: 2
	number of particles per chunk: 3

output:
	min:
	0.1 0.3
	max:
	0.5 1.0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface">1.7.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">minmax</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-k">const</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">no</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">min</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">max</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scan">1.8. scan</h3>
<div class="paragraph">
<p>exclusive prefix sum implementation for integer data</p>
</div>
<div class="paragraph">
<p>input is of size <code>n</code>, output is of size <code>n + 1</code> as in the following
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:  4 5 1  2  3  -
output: 0 4 9 10 12 15</pre>
</div>
</div>
<div class="sect3">
<h4 id="_interface_2">1.8.1. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scan_apply</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">input</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">output</span><span class="tok-p">,</span> <span class="tok-cm">/*w*/</span> <span class="tok-n">Scan</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">);</span> <b class="conum">(1)</b>

<span class="tok-kt">void</span> <span class="tok-nf">scan_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Scan</span> <span class="tok-o">**</span><span class="tok-n">w</span><span class="tok-p">);</span>                                  <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scan_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Scan</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">);</span>                                             <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>perform scan operation on <code>input</code> of size <code>size</code></p>
</li>
<li>
<p>allocate workspace for performing scan of size <code>size</code></p>
</li>
<li>
<p>free workspace</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_body_forces">1.9. body forces</h3>
<div class="paragraph">
<p>force applied to every particles</p>
</div>
<div class="sect3">
<h4 id="_data_structures">1.9.1. data structures</h4>
<div class="paragraph">
<p>Defined by two structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BForce</code>, contains all informations needed for the  force
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>BForce_v</code> (<em>BForce view</em>), containing only the information needed at
a specific time. It is passed to device kernels.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interface_3">1.9.2. interface</h4>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_ini</span><span class="tok-p">(</span><span class="tok-n">BForce</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_fin</span><span class="tok-p">(</span><span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize to a given force function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_none</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>            <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_cste</span><span class="tok-p">(</span><span class="tok-n">float3</span> <span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>  <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_dp</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>     <b class="conum">(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_shear</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>  <b class="conum">(4)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_rol</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>    <b class="conum">(5)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_rad</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>    <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>no force</p>
</li>
<li>
<p>constant force <code>f</code></p>
</li>
<li>
<p>double poiseuille</p>
</li>
<li>
<p>shear</p>
</li>
<li>
<p>4 roller mill</p>
</li>
<li>
<p>radial force</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">bf</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_adjust</span><span class="tok-p">(</span><span class="tok-n">float3</span> <span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">fpar</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_apply</span><span class="tok-p">(</span><span class="tok-kt">long</span> <span class="tok-n">it</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">mass</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">bf</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>change value of the force</p>
</li>
<li>
<p>apply body force to particles</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">1.9.3. configuration</h4>
<div class="sect4">
<h5 id="_none">none</h5>
<div class="paragraph">
<p>no body force (default value)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;none&quot;;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_constant">constant</h5>
<div class="paragraph">
<p>constant force</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;constant&quot;;</span>
<span class="tok-s">    f    = [1.0, 0.0, 0.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_double_poiseuille">double poiseuille</h5>
<div class="paragraph">
<p><code>fx = y &gt; yc ? a : -a</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;double_poiseuille&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_shear">shear</h5>
<div class="paragraph">
<p><code>fx = a * (y - yc)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;shear&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_4_roller_mill">4 roller mill</h5>
<div class="listingblock">
<div class="content">
<pre>    f.x =  2*sin(x)*cos(y) * a;
    f.y = -2*cos(x)*sin(y) * a;</pre>
</div>
</div>
<div class="paragraph">
<p>while <code>x</code> and <code>y</code> are coordinates relative to the domain center and
normalized to have <code>x = Pi</code> and <code>x = -Pi</code> at the domain edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;four_roller&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_radial">radial</h5>
<div class="paragraph">
<p><code>fr = a * er / r</code>, where <code>fr</code> is radial force, <code>er</code> is unit radial
vector at position <code>r</code> and <code>r</code> is radial position.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;rad&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clist">1.10. clist</h3>
<div class="paragraph">
<p>Helpers to find which particles are in a given cell.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reorder data according to particle positions into cells</p>
</li>
<li>
<p>access particles within a given cell</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_example_2">1.10.1. example</h4>
<div class="paragraph">
<p>consider a 1D example of particles with positions in domain <code>[0, 4)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 2.5 0.1 1.1 0.5 1.6</pre>
</div>
</div>
<div class="paragraph">
<p>After cell list building (we take 1 as cell size), the above data becomes</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 0.1 0.5 1.1 1.6 2.5  -
cc: 2       2       1    0
ss: 0       2       4    5</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>pp</code> is the particle array, <code>cc</code> (counts) is the number of particles per
cell and <code>ss</code> (starts) is the prefix sum of <code>cc</code>.</p>
</div>
<div class="paragraph">
<p>Accessing all particles in cell <code>i=1</code> (<code>[1,2)</code>) can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>loop: j = 0, ..., cc[i]
      id = ss[i] + j
      p = pp[id]
      work(p)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above can be easily extended in 3D, only ordering changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_2">1.10.2. data structures</h4>
<div class="sect4">
<h5 id="_clist_2">Clist</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">Clist</span> <span class="tok-p">{</span>
    <span class="tok-n">int3</span> <span class="tok-n">dims</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">ncells</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dims</code> dimesnsions of the grid</p>
</li>
<li>
<p><code>ncells</code> number of cells</p>
</li>
<li>
<p><code>counts</code> number of particles per cell</p>
</li>
<li>
<p><code>starts</code> exclusive prefic scan of the above</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_map">Map</h5>
<div class="paragraph">
<p>Helper to build the cell lists (hidden from client)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">ClistMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">nA</span><span class="tok-p">;</span>              <span class="tok-cm">/* number of source arrays to build the cell lists, e.g remote+bulk -&gt; 2 */</span>
    <span class="tok-n">uchar4</span> <span class="tok-o">*</span><span class="tok-n">ee</span><span class="tok-p">[</span><span class="tok-n">MAXA</span><span class="tok-p">];</span>    <span class="tok-cm">/* cell entries */</span>
    <span class="tok-n">uint</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">;</span>            <span class="tok-cm">/* codes containing: indices of data to fetch and array id from which to fetch */</span>
    <span class="tok-n">Scan</span> <span class="tok-o">*</span><span class="tok-n">scan</span><span class="tok-p">;</span>      <span class="tok-cm">/* scan workspace */</span>
    <span class="tok-kt">long</span> <span class="tok-n">maxp</span><span class="tok-p">;</span>           <span class="tok-cm">/* maximum number of particles per input vector */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nA</code> number of source arrays</p>
</li>
<li>
<p><code>ee</code> cell entries: one array per source array, containing a list of
<code>uchar4</code> with entries (<code>xcid</code>, <code>ycid</code>, <code>zcid</code>, <code>sid</code>)</p>
<div class="ulist">
<ul>
<li>
<p><code>xcid</code>: x cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.x</code></p>
</li>
<li>
<p><code>ycid</code>: y cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.y</code></p>
</li>
<li>
<p><code>zcid</code>: z cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.z</code></p>
</li>
<li>
<p><code>sid</code>: source array id, in 0, &#8230;&#8203;, <code>nA</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ii</code> indices of particles to fetch. can be decoded into the source
array id and the particle id inside this array</p>
</li>
<li>
<p><code>scan</code> scan workspace, see <a href="algo/scan.html">scan</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ids can be accessed from</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">const</span> <span class="tok-n">uint</span><span class="tok-o">*</span> <span class="tok-nf">clist_get_ids</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_4">1.10.3. interface</h4>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">clist_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">LX</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">LY</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">LZ</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">clist_ini_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nA</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">ClistMap</span> <span class="tok-o">**</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_fin_map</span><span class="tok-p">(</span><span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>build interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">clist_ini_counts</span><span class="tok-p">(</span><span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_subindex</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">project</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">aid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_build_map</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">nn</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>

<span class="tok-cm">/* special for fluid distribution */</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_subindex_local</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_subindex_remote</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">clist_gather_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pplo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppre</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-kt">long</span> <span class="tok-n">nout</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppout</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_gather_ii</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iilo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iire</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-kt">long</span> <span class="tok-n">nout</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iiout</span><span class="tok-p">);</span>

<span class="tok-cm">/* quick cell build for single array */</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_build</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nlo</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nout</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pplo</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppout</span><span class="tok-p">,</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface: code/decode map ids</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-n">uint</span> <span class="tok-n">clist_encode_id</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">pid</span><span class="tok-p">)</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">clist_decode_id</span><span class="tok-p">(</span><span class="tok-n">uint</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">pid</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_algorithm">1.10.4. algorithm</h4>
<div class="paragraph">
<p>The cell build process is linear in number of particles <code>np</code> and <code>n log(n)</code>
in number of cells <code>n</code>.
The process to build cell lists is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>- build ee and counts: O(np)
  - set counts[i] = 0 for all i
  - for each particle, compute its cell id cid
  - get unique subindex k within the cell by updating cc[cid]
- scan counts to get starts O(nlog n)
- construct ii: O(np)
  - for each particle with id i, compute new index j = ss[cid] + k[i]
  - set ii[j] = i
- Gather data: O(np)
  - new particle vector pp1 from pp: pp1[i] = pp[ii[i]]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cnt">1.11. cnt</h3>
<div class="paragraph">
<p><em>contact</em> interactions between objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect3">
<h4 id="_interface_5">1.11.1. interface</h4>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">cnt_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">rank</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Contact</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">cnt_fin</span><span class="tok-p">(</span><span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">cnt_build_cells</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">cnt_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-n">FoWrap</span> <span class="tok-o">*</span><span class="tok-n">fw</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">cnt_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-n">FoWrap</span> <span class="tok-o">*</span><span class="tok-n">fw</span><span class="tok-p">,</span> <span class="tok-n">Pap26</span> <span class="tok-n">PP</span><span class="tok-p">,</span> <span class="tok-n">Fop26</span> <span class="tok-n">FF</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[</span><span class="tok-mi">26</span><span class="tok-p">]);</span> <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>build cell lists for local objects</p>
</li>
<li>
<p>compute the interactions between local objects particles</p>
</li>
<li>
<p>compute the interactions between local and remote objects particles</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_color">1.12. color</h3>
<div class="sect3">
<h4 id="_purpose">1.12.1. purpose</h4>
<div class="paragraph">
<p>Each particle of the solvent has an assigned color when the
<code>multi_solvent</code> flag is enabled.
It is helpful for modeling different solvent with different
viscosities, surface tensions etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modules_2">1.12.2. modules</h4>
<div class="paragraph">
<p>Some utility modules are implemeted in <code>/src/color</code>.</p>
</div>
<div class="sect4">
<h5 id="_flux">flux</h5>
<div class="paragraph">
<p>recolor particles crossing the face of the periodic domain in the
positive direction x, y or z</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">int3</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">color_linear_flux</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">color</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dir</code> is the direction x, y or z</p>
</li>
<li>
<p><code>color</code> is the new color</p>
</li>
<li>
<p><code>pp</code> are input particles of size <code>n</code></p>
</li>
<li>
<p><code>cc</code> are output colors (stay the same if does not cross the face)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comm">1.13. comm</h3>
<div class="paragraph">
<p>generic communicator with "halo".</p>
</div>
<div class="sect3">
<h4 id="_purpose_2">1.13.1. purpose</h4>
<div class="paragraph">
<p>Communicate data with the neighboring ranks</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_3">1.13.2. data structures</h4>
<div class="paragraph">
<p><code>hBags</code>: buffers on the host, contains all necessary information of the data to communicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">hBags</span> <span class="tok-p">{</span>
    <span class="tok-n">data_t</span> <span class="tok-o">*</span><span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* data on the host                    */</span>
    <span class="tok-kt">int</span>         <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span> <span class="tok-cm">/* size of the data                    */</span>
    <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* capacity of each frag (elem number) */</span>
    <span class="tok-kt">size_t</span> <span class="tok-n">bsize</span><span class="tok-p">;</span>        <span class="tok-cm">/* size of one datum in bytes          */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>dBags</code>: buffers on the device</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">dBags</span> <span class="tok-p">{</span>
    <span class="tok-n">data_t</span> <span class="tok-o">*</span><span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* data on the device         */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Comm</code>: contains the communication related variables. It is hidden
from user.</p>
</div>
</div>
<div class="sect3">
<h4 id="_allocation_mod">1.13.3. allocation mod</h4>
<div class="paragraph">
<p>User can choose how the buffers are allocated with the enum type <code>AllocMod</code>.
This is used in the funcion <code>ini</code> and <code>fin</code>. allocation mode and free mode are assumed to be the same</p>
</div>
<div class="paragraph">
<p>currently supported allocation modes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>    <span class="tok-n">HST_ONLY</span><span class="tok-p">,</span>   <span class="tok-cm">/* only host bags allocated                 */</span>
    <span class="tok-n">DEV_ONLY</span><span class="tok-p">,</span>   <span class="tok-cm">/* only device bags allocated               */</span>
    <span class="tok-n">PINNED</span><span class="tok-p">,</span>     <span class="tok-cm">/* both host and device pinned              */</span>
    <span class="tok-n">PINNED_HST</span><span class="tok-p">,</span> <span class="tok-cm">/* host pinned; no device memory            */</span>
    <span class="tok-n">PINNED_DEV</span><span class="tok-p">,</span> <span class="tok-cm">/* host pinned; device global memory on gpu */</span>
    <span class="tok-n">NONE</span>        <span class="tok-cm">/* no allocation                            */</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_6">1.13.4. interface</h4>
<div class="sect4">
<h5 id="_memory_management">memory management</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">comm_bags_ini</span><span class="tok-p">(</span><span class="tok-n">AllocMod</span> <span class="tok-n">fmod</span><span class="tok-p">,</span> <span class="tok-n">AllocMod</span> <span class="tok-n">bmod</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">bsize</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">hb</span><span class="tok-p">,</span> <span class="tok-n">dBags</span> <span class="tok-o">*</span><span class="tok-n">db</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">comm_bags_fin</span><span class="tok-p">(</span><span class="tok-n">AllocMod</span> <span class="tok-n">fmod</span><span class="tok-p">,</span> <span class="tok-n">AllocMod</span> <span class="tok-n">bmod</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">hb</span><span class="tok-p">,</span> <span class="tok-n">dBags</span> <span class="tok-o">*</span><span class="tok-n">db</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">cart</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Comm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">comm_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bags alloc:</strong> Given two structures <code>hBags</code> and <code>dBags</code>, <code>ini</code> allocates the buffers on host and device. <code>ini</code> expects 2 allocation modes:</p>
<div class="ulist">
<ul>
<li>
<p><code>fmod</code>: allocation mode for fragment buffers</p>
</li>
<li>
<p><code>bmod</code>: allocation mode for bulk buffer</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>comm alloc</strong>: initialize <code>Comm</code> structure</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_communication">communication</h5>
<div class="paragraph">
<p>Communication happens between host bags (see <code>hBags</code> structure).
It needs 3 entities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>receiver bags</p>
</li>
<li>
<p>sender bags</p>
</li>
<li>
<p>a <code>Comm</code> for communicating through MPI</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interface is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">comm_post_recv</span><span class="tok-p">(</span><span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>           <b class="conum">(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">comm_post_send</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>     <b class="conum">(2)</b>

<span class="tok-kt">int</span> <span class="tok-nf">comm_wait_recv</span><span class="tok-p">(</span><span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">);</span>      <b class="conum">(3)</b>
<span class="tok-kt">int</span> <span class="tok-nf">comm_wait_send</span><span class="tok-p">(</span><span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>                     <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>call MPI asynchroneous recv and store requests in <code>s</code></p>
</li>
<li>
<p>call MPI asynchroneous send and store requests in <code>s</code></p>
</li>
<li>
<p>wait for recv requests</p>
</li>
<li>
<p>wait for send requests</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_contact_forces">1.14. contact forces</h3>
<div class="paragraph">
<p>computs interactions between objects.</p>
</div>
</div>
<div class="sect2">
<h3 id="_control">1.15. Control</h3>
<div class="ulist">
<ul>
<li>
<p>velocity controller</p>
</li>
<li>
<p>open boundary conditions</p>
</li>
<li>
<p>density controller</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_velocity_controller">1.15.1. Velocity controller</h4>
<div class="paragraph">
<p>control velocity by modifying the imposed hydrostatic force</p>
</div>
<div class="sect4">
<h5 id="_interface_7">interface</h5>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vcont_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">vtarget</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">factor</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vcont_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">cont</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the transformation structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vcon_set_cart</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">cont</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vcon_set_radial</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">cont</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the transformation is the way of averaging the velocity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cartesian transformation keeps the velocity as it is before averaging.</p>
</li>
<li>
<p>radial transformation returns the velocity in polar coordinates
scaled by the radial position. the <code>z</code> component corresponds to
cartesian transformation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Control operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span>   <span class="tok-nf">vcont_sample</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-n">float3</span> <span class="tok-nf">vcont_adjustF</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span>   <span class="tok-nf">vcont_log</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>    <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get average velocity according to transformation and store it</p>
</li>
<li>
<p>reduce sampled quantities and update the controller. return the force</p>
</li>
<li>
<p>logging informations; dumped into the file <code>vcon.txt</code></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_2">configuration</h5>
<div class="paragraph">
<p>syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">vcon</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">     active = true;</span>
<span class="tok-s">     type   = &quot;cart&quot;;          # can be also &quot;rad&quot;</span>
<span class="tok-s">     U      = [1.0, 1.0, 0.0]; # target velocity in transformed space</span>
<span class="tok-s">     log_freq    = 500;</span>
<span class="tok-s">     adjust_freq = 500;</span>
<span class="tok-s">     sample_freq = 1;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inflow">1.15.2. Inflow</h4>
<div class="paragraph">
<p>Mass rate inflow</p>
</div>
<div class="sect4">
<h5 id="_interface_8">interface</h5>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini</span><span class="tok-p">(</span><span class="tok-n">int2</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">**</span><span class="tok-n">i</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_fin</span><span class="tok-p">(</span><span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the inflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_velocity</span><span class="tok-p">(</span><span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_plate</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">o</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">L1</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">L2</span><span class="tok-p">,</span>
                             <span class="tok-n">float3</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">upoiseuille</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">vpoiseuille</span><span class="tok-p">,</span>
                             <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_circle</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">o</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">R</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">H</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">poiseuille</span><span class="tok-p">,</span>
                              <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the type of inflow, call the appropriate
<code>ini_params_xxx</code>.
<code>ini_velocity</code> must be called after initializing the parameters.
it is used to setup the inlet velocity from parameters.</p>
</div>
<div class="paragraph">
<p>initialize from config parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>create particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_create_pp</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">kBT</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_create_pp_cc</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">kBT</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">newcolor</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add particles to the array <code>pp</code> and increase <code>n</code> accordingly</p>
</li>
<li>
<p>same as above, with colors <code>cc</code> set to <code>color</code></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_3">configuration</h5>
<div class="sect5">
<h6 id="_plate">plate</h6>
<div class="paragraph">
<p>syntax for a <code>8.0 x 16.0</code> plate perpendicular to the x axis passing by
the point <code>(1, 2, 3)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">inflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active      = true;</span>
<span class="tok-s">    type        = &quot;plate&quot;;</span>
<span class="tok-s">    L1          = 1.0;</span>
<span class="tok-s">    L2          = 16.0;</span>
<span class="tok-s">    direction   = 0;                # [0,1,2] = [X,Y,Z]</span>
<span class="tok-s">    origin      = [1.0, 2.0, 3.0];</span>
<span class="tok-s">    upoiseuille = false;            # true for parabolic profile along L1</span>
<span class="tok-s">    vpoiseuille = false;            # true for parabolic profile along L2</span>
<span class="tok-s">    u           = [10.0, 0.0, 0.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_circle">circle</h6>
<div class="paragraph">
<p>syntax for cylinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">inflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active = true;</span>
<span class="tok-s">    type   = &quot;circle&quot;;</span>
<span class="tok-s">    R      = 1.0;              # radius</span>
<span class="tok-s">    H      = 16.0;             # hight of the cylinder</span>
<span class="tok-s">    U      = 1.0;              # maximum velocity</span>
<span class="tok-s">    center = [8.0, 8.0, 8.0];</span>
<span class="tok-s">    poiseuille = false;        # parabolic profile along H if true</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_outflow">1.15.3. Outflow</h4>
<div class="paragraph">
<p>Delete particles satisfying a predicate</p>
</div>
<div class="sect4">
<h5 id="_interface_9">interface</h5>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">**</span><span class="tok-n">o</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the outflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ini_params_circle</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">R</span><span class="tok-p">,</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">ini_params_plate</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">r0</span><span class="tok-p">,</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the geometry of outflow, call the appropriate
<code>ini_params_xxx</code>.</p>
</div>
<div class="paragraph">
<p>filter and mark particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">filter_particles</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span> <b class="conum">(1)</b>

<span class="tok-kt">void</span> <span class="tok-nf">download_ndead</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                   <b class="conum">(2)</b>

<span class="tok-kt">int</span><span class="tok-o">*</span> <span class="tok-nf">get_deathlist</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                    <b class="conum">(3)</b>
<span class="tok-kt">int</span>  <span class="tok-nf">get_ndead</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                        <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>store dying particles infos inside Outflow struct</p>
</li>
<li>
<p>copy from device to host number of dead particles</p>
</li>
<li>
<p>return the list of dead marks (dead=1, alive=0)</p>
</li>
<li>
<p>return the number of dead particles</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_4">configuration</h5>
<div class="sect5">
<h6 id="_plate_2">plate</h6>
<div class="paragraph">
<p>will delete particles crossing a plate along the positive direction.
syntax for the plate <code>y=4</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">outflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active     = true;</span>
<span class="tok-s">    type       = &quot;plate&quot;;</span>
<span class="tok-s">    direction  = 1;      # [0,1,2] = [X,Y,Z]</span>
<span class="tok-s">    position   = 4.0;    # position along &quot;direction&quot;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_circle_2">circle</h6>
<div class="paragraph">
<p>delete particles going out of the cylinder.
syntax for a cylinder of radius 8 centered at <code>(8, 8, 8)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">outflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active = true;</span>
<span class="tok-s">    type   = &quot;circle&quot;;</span>
<span class="tok-s">    R      = 8.0;</span>
<span class="tok-s">    center = [8.0, 8.0, 8.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_density_controller">1.15.4. Density controller</h4>

</div>
</div>
<div class="sect2">
<h3 id="_coords">1.16. coords</h3>
<div class="paragraph">
<p>Coordinate transforms utility.</p>
</div>
<div class="paragraph">
<p>In <em>uDeviceX</em>, the simulation domain is decomposed into a grid of
subdomains of equal sizes.
Computations are performed in <em>local</em> coordinates and all objects are
relative to these coordinates.
Operations, such as initialisation of the data, io, etc., need
<em>global</em> coordinates informations.</p>
</div>
<div class="paragraph">
<p>For convenience, we consider the three coordinate systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Global</em>: Relative to the lower corner of the full domain of size
\((G_x, G_y, G_z)\)</p>
</li>
<li>
<p><em>Local</em>: Relative to the center of the subdomain of size
\((L_x, L_y, L_z)\)</p>
</li>
<li>
<p><em>Center</em>: Relative to the center of the full domain: \((C_x,
C_y, C_z) = (G_x/2, G_y/2, G_z/2)\)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_data_structures_4">1.16.1. data structures</h4>
<div class="paragraph">
<p>All the needed information is stored in the hidden structure <code>Coords</code>.
A <em>view</em> structure <code>Coords_v</code> is public to device code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">Coords_v</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">xc</span><span class="tok-p">,</span> <span class="tok-n">yc</span><span class="tok-p">,</span> <span class="tok-n">zc</span><span class="tok-p">;</span> <span class="tok-cm">/* rank coordinates        */</span>
    <span class="tok-kt">int</span> <span class="tok-n">xd</span><span class="tok-p">,</span> <span class="tok-n">yd</span><span class="tok-p">,</span> <span class="tok-n">zd</span><span class="tok-p">;</span> <span class="tok-cm">/* rank sizes              */</span>
    <span class="tok-kt">int</span> <span class="tok-n">Lx</span><span class="tok-p">,</span> <span class="tok-n">Ly</span><span class="tok-p">,</span> <span class="tok-n">Lz</span><span class="tok-p">;</span> <span class="tok-cm">/* [L]ocal: subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_host_interface">1.16.2. Host interface</h4>
<div class="sect4">
<h5 id="_memory_management_2">Memory management</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">coords_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">cart</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">Lx</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">Ly</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">Lz</span><span class="tok-p">,</span> <span class="tok-n">Coords</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">coords_fin</span><span class="tok-p">(</span><span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate and set the data according to the cartesian communicator</p>
</li>
<li>
<p>deallocate the structure</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The resources can also be allocated using configuration informations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">coords_ini_conf</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">cart</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-n">Coords</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_getters">Getters</h5>
<div class="paragraph">
<p>Obtain a view structure from <code>Coords</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">coords_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((G_x, G_y, G_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">xdomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">ydomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zdomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((L_x, L_y, L_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">xs</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">ys</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zs</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-n">int3</span> <span class="tok-nf">subdomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get (from <em>local</em> coordinates) \((-L_x/2, -L_y/2, -L_z/2)\) and
\((L_x/2, L_y/2, L_z/2)\) in <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">xlo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">ylo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zlo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">int</span> <span class="tok-nf">xhi</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">yhi</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zhi</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_coordinate_transforms">Coordinate transforms</h5>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>center</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xl2xc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yl2yc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zl2zc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zl</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">local2center</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rl</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rc</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>center</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xc2xl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xc</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yc2yl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yc</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zc2zl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zc</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">center2local</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rc</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rl</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xl2xg</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yl2yg</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zl2zg</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zl</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">local2global</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rl</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>global</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xg2xl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xg</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yg2yl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yg</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zg2zl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">global2local</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rl</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_helpers">helpers</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* rank predicates */</span>
<span class="tok-kt">bool</span> <span class="tok-nf">is_end</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">);</span>

<span class="tok-cm">/* a string unique for a rank */</span>
<span class="tok-kt">void</span> <span class="tok-nf">coord_stamp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">);</span>

<span class="tok-cm">/* number of subdomains */</span>
<span class="tok-kt">int</span> <span class="tok-nf">coords_size</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_5">1.16.3. Configuration</h4>
<div class="paragraph">
<p>Set subdomain sizes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">glb</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    L = [16, 12, 24]</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generic_d_evice_api">1.17. generic [d]evice API</h3>
<div class="paragraph">
<p>The goal is to make cuda API and kernel functions generic. Meaning
they can be replaced by CPU calls.</p>
</div>
<div class="paragraph">
<p>There are two groups: functions which "mirror" cuda API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">Malloc</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemcpyToSymbol</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">symbol</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">offset</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-o">=</span><span class="tok-n">MemcpyHostToDevice</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemcpyFromSymbol</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">dst</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">symbol</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">offset</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-o">=</span><span class="tok-n">MemcpyDeviceToHost</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">HostGetDevicePointer</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">**</span><span class="tok-n">pDevice</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">pHost</span><span class="tok-p">,</span> <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">flags</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">Memcpy</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">dst</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemsetAsync</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">devPtr</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">value</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-n">Stream_t</span> <span class="tok-n">stream</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">Memset</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">devPtr</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">value</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemcpyAsync</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span> <span class="tok-n">dst</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span> <span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">,</span> <span class="tok-n">Stream_t</span> <span class="tok-n">stream</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">Free</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">devPtr</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">FreeHost</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">hstPtr</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">DeviceSynchronize</span> <span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">PeekAtLastError</span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>functions unique for <em>uDeviceX</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-nf">emsg</span><span class="tok-p">();</span>
<span class="tok-kt">int</span> <span class="tok-nf">alloc_pinned</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">**</span><span class="tok-n">pHost</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">size</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">is_device_pointer</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">ptr</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>files of the interface
- <code>d/api.h</code> API calls
- <code>d/q.h</code> function and variable type qualifiers
- <code>d/ker.h</code></p>
</div>
<div class="paragraph">
<p>if <code>DEV_CUDA</code> is defined interfaces is implimented by cuda, if
<code>DEV_CPU</code> is defined it is implimented by host calls.</p>
</div>
</div>
<div class="sect2">
<h3 id="_debug">1.18. debug</h3>
<div class="paragraph">
<p>Helper to check the particle positions, velocities, forces and
cell-lists from device arrays</p>
</div>
<div class="paragraph">
<p>The hidden structure <code>Dbg</code> holds the debugging configuration.
Configuration is encoded using the following enum values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span>
    <span class="tok-n">DBG_POS</span><span class="tok-p">,</span>      <b class="conum">(1)</b>
    <span class="tok-n">DBG_POS_SOFT</span><span class="tok-p">,</span> <b class="conum">(2)</b>
    <span class="tok-n">DBG_VEL</span><span class="tok-p">,</span>      <b class="conum">(3)</b>
    <span class="tok-n">DBG_FORCES</span><span class="tok-p">,</span>   <b class="conum">(4)</b>
    <span class="tok-n">DBG_COLORS</span><span class="tok-p">,</span>   <b class="conum">(5)</b>
    <span class="tok-n">DBG_CLIST</span><span class="tok-p">,</span>    <b class="conum">(6)</b>
    <span class="tok-n">DBG_NKIND_</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>positions are inside subdomain</p>
</li>
<li>
<p>positions are inside subdomain plus a margin</p>
</li>
<li>
<p>velocities</p>
</li>
<li>
<p>forces</p>
</li>
<li>
<p>colors</p>
</li>
<li>
<p>cell lists</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Consider subdomain of dimensions \((L_x, Ly, Lz)\).
A position \((r_x, r_y, r_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[-\frac{L_\alpha - M} {2}  \leq r_\alpha &lt; \frac{L_\alpha + M} 2,\]
</div>
</div>
<div class="paragraph">
<p>where \(M\) is the margin. It is \(M = 0\) for <code>DBG_POS</code> and
\(M = 3\) for <code>DBG_POS_SOFT</code>.</p>
</div>
<div class="paragraph">
<p>For a given timestep \(dt\), the velocity \((v_x, v_y, v_z)\) is
valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |v_\alpha| dt \leq L_\alpha.\]
</div>
</div>
<div class="paragraph">
<p>The force \((f_x, f_y, f_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |f_\alpha| dt^2 \leq L_\alpha.\]
</div>
</div>
<div class="sect3">
<h4 id="_interface_10">1.18.1. interface</h4>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_ini</span><span class="tok-p">(</span><span class="tok-n">Dbg</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_fin</span><span class="tok-p">(</span><span class="tok-n">Dbg</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>set debugging modes and verbosity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_enable</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_disable</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_set_verbose</span><span class="tok-p">(</span><span class="tok-kt">bool</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_set_dump</span><span class="tok-p">(</span><span class="tok-kt">bool</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_check_pos</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_pos_soft</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_vel</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_forces</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_colors</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_clist</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_6">1.18.2. configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">dbg</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    verbose  = true;</span>
<span class="tok-s">    pos      = false;</span>
<span class="tok-s">    pos_soft = false;</span>
<span class="tok-s">    vel      = false;</span>
<span class="tok-s">    forces   = false;</span>
<span class="tok-s">    colors   = false;</span>
<span class="tok-s">    clist    = false;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distr">1.19. distr</h3>
<div class="paragraph">
<p>Redistribution of quantities across nodes.
Each node has a local coordinate system. The origin is the center of a
"subdomain" of size <code>Sx</code>, <code>Sy</code>, <code>Sz</code>.</p>
</div>
<div class="paragraph">
<p>A quantity is sent to a neighboring rank if its position is outside of
the subdomain.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to redistribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_map_2">1.19.1. map</h4>
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all quantities.</p>
</div>
<div class="sect4">
<h5 id="_data_structure">data structure</h5>
<div class="paragraph">
<p>The structure to map local data from an array to packed data in 27
arrays is implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* [D]istr Map */</span>
<span class="tok-k">struct</span> <span class="tok-n">DMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span>  <span class="tok-cm">/* number of entities leaving in each fragment */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">;</span>  <span class="tok-cm">/* cumulative sum of the above                 */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">ids</span><span class="tok-p">[</span><span class="tok-mi">27</span><span class="tok-p">];</span> <span class="tok-cm">/* indices of leaving objects                  */</span>

    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hcounts</span><span class="tok-p">;</span> <span class="tok-cm">/* counts on host (pinned) */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be allocated on device or on host memory (see interface).</p>
</div>
</div>
<div class="sect4">
<h5 id="_interface_11">interface</h5>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dmap_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_fin</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_reini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_download_counts</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_ini_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_fin_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_reini_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_D2H</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">h</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* exclusive scan */</span>
<span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">NCOUNTS</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__global__</span> <span class="tok-kt">void</span> <span class="tok-n">dmap_scan</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">)</span>              <b class="conum">(1)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">dmap_get_fid</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">])</span>       <b class="conum">(2)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">dmap_add</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">pid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">)</span>  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>prefix sum on counts to obtain starts</p>
</li>
<li>
<p>get fragment id from position</p>
</li>
<li>
<p>add a quantity to the map</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_flu">1.19.2. flu</h4>
<div class="paragraph">
<p>Redistribute solvent particles accross nodes.</p>
</div>
<div class="sect4">
<h5 id="_data_structures_5">data structures</h5>
<div class="paragraph">
<p>Solvent distribution follow the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">Opt</span> <span class="tok-p">{</span>
    <span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">ids</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dpp</span><span class="tok-p">,</span> <span class="tok-n">dii</span><span class="tok-p">,</span> <span class="tok-n">dcc</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">,</span> <span class="tok-n">hii</span><span class="tok-p">,</span> <span class="tok-n">hcc</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">;</span> <span class="tok-cm">/* number of sent particles */</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
    <span class="tok-n">Opt</span> <span class="tok-n">opt</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluComm</span> <span class="tok-p">{</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">;</span>
    <span class="tok-n">Opt</span> <span class="tok-n">opt</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">,</span> <span class="tok-n">hii</span><span class="tok-p">,</span> <span class="tok-n">hcc</span><span class="tok-p">;</span>
    <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppre</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iire</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ccre</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">;</span> <span class="tok-cm">/* number of received particles */</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
    <span class="tok-n">Opt</span> <span class="tok-n">opt</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>[d,h]xx</code> means quantities on <code>[device,host]</code> and <code>pp</code>
corresponds to particles, <code>cc</code> to colors and <code>ii</code> to global ids.
The <code>xxre</code> variables in <code>Unpack</code> are buffer for remote quantities.</p>
</div>
</div>
<div class="sect4">
<h5 id="_interface_12">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dflu_pack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxdensity</span><span class="tok-p">,</span> <span class="tok-n">DFluPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_comm_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxdensity</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">dflu_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-cm">/* map */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-cm">/* pack */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_download</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluStatus</span> <span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">);</span>

<span class="tok-cm">/* communication */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_post_recv</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_post_send</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DFluComm</span>   <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_wait_send</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-cm">/* unpack */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The map is build from <a href="partlist.html">partlist</a>, allowing the
process to delete particles.</p>
</div>
<div class="paragraph">
<p>The solvent distribution also include cell list generation (see
<a href="clist.html">cell lists</a>).
It is done in two phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>subindices, independant for bulk and remote particles</p>
</li>
<li>
<p>gather, which needs the subindices to be computed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bulk subindices can be computed while comunicating remote particles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* cell lists */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_bulk</span><span class="tok-p">(</span><span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_gather</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ndead</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rbc">1.19.3. rbc</h4>
<div class="paragraph">
<p>Redistribute red blood cells accross nodes according to the center of
mass of their bounding box (see <a href="algo/minmax.html">minmax</a>).</p>
</div>
<div class="sect4">
<h5 id="_data_structures_6">data structures</h5>
<div class="paragraph">
<p>RBC distribution follows the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">DRbcPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">minext</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">maxext</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dpp</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">;</span>

    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-n">DMap</span> <span class="tok-n">hmap</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hii</span><span class="tok-p">;</span>

    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRbcComm</span> <span class="tok-p">{</span>
    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">;</span>

    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hii</span><span class="tok-p">;</span>

    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>minext</code> and <code>maxext</code> contain the bounding box informations of
each RBC. Other variables have the same naming conventions than <code>distr::flu</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_interface_13">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">drbc_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRbcComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_download</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_post_recv</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_post_send</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_wait_send</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rig">1.19.4. rig</h4>
<div class="paragraph">
<p>Redistribute rigid objects accross nodes according to their center of
mass.</p>
</div>
<div class="sect4">
<h5 id="_data_structures_7">data structures</h5>
<div class="paragraph">
<p>Rigid bodies distribution is very similar to the above. The <em>hidden</em> data
structures fit again in the general workflow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/*</span>
<span class="tok-cm"> ipp: particles of the mesh</span>
<span class="tok-cm"> ss:  &quot;Solid&quot; structures</span>
<span class="tok-cm">*/</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dipp</span><span class="tok-p">,</span> <span class="tok-n">dss</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hipp</span><span class="tok-p">,</span> <span class="tok-n">hss</span><span class="tok-p">;</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span>  <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigComm</span> <span class="tok-p">{</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">ipp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hipp</span><span class="tok-p">,</span> <span class="tok-n">hss</span><span class="tok-p">;</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span>  <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_14">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">drig_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRigPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_pack</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ipp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_download</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_post_recv</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_post_send</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_wait_send</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_common">1.19.5. common</h4>
<div class="paragraph">
<p>helpers: common kernels</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dcommon_pack_pp_packets</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Sarray</span><span class="tok-o">&lt;</span><span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-mi">27</span><span class="tok-o">&gt;</span> <span class="tok-n">buf</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dcommon_shift_one_frag</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dcommon_shift_halo</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Sarray</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-p">,</span> <span class="tok-mi">27</span><span class="tok-o">&gt;</span> <span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>pack <code>nc</code>  packets of <code>nv</code> particles into 27 buffers <code>buf</code> according to map</p>
</li>
<li>
<p>shift particles in the fragment direction</p>
</li>
<li>
<p>shift all particles according to the fragment direction</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exch">1.20. exch</h3>
<div class="paragraph">
<p>Exchange quantities across nodes for "ghost particles".</p>
</div>
<div class="paragraph">
<p>A quantity is exchanged with a neighboring node if its position is
within a given distance from the subdomain boundaries.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to exchange:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optionally, other quantities can be exchanged back, e.g. forces.</p>
</div>
<div class="sect3">
<h4 id="_map_3">1.20.1. map</h4>
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all
quantities.
As opposed to the <em>distr</em> module, the mapping is not <em>one to one</em>.
A single quantity can be exchanged with up to 7 neighboring nodes if
it is in a corner.</p>
</div>
<div class="sect4">
<h5 id="_data_structure_2">data structure</h5>
<div class="paragraph">
<p>A single structure is able to build a map for up to <code>nw</code> objects
(e.g. rbc and rigid give <code>nw = 2</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">EMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span>      <span class="tok-cm">/* number of entities leaving in each fragment */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">;</span>      <span class="tok-cm">/* cumulative sum of the above                 */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">offsets</span><span class="tok-p">;</span>     <span class="tok-cm">/* offsets per fragment for each solute        */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">ids</span><span class="tok-p">[</span><span class="tok-n">NFRAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* indices of leaving objects                  */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_15">interface</h5>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emap_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">cap</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMap</span> <span class="tok-o">*</span><span class="tok-n">map</span><span class="tok-p">);</span>               <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_fin</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-n">EMap</span> <span class="tok-o">*</span><span class="tok-n">map</span><span class="tok-p">);</span>                                       <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_reini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMap</span> <span class="tok-n">map</span><span class="tok-p">);</span>                         <b class="conum">(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_scan</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMap</span> <span class="tok-n">map</span><span class="tok-p">);</span>                          <b class="conum">(4)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_download_counts</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-n">EMap</span> <span class="tok-n">map</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[]);</span> <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate the map structure on device</p>
</li>
<li>
<p>deallocate the map structure</p>
</li>
<li>
<p>reset the map structure</p>
</li>
<li>
<p>scan the map structure to get starts</p>
</li>
<li>
<p>copy counts from device to host</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">emap_code</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">])</span> <b class="conum">(1)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">emap_code_box</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">lo</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">hi</span><span class="tok-p">)</span>  <b class="conum">(2)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">emap_add</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">soluteid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">pid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-n">EMap</span> <span class="tok-n">m</span><span class="tok-p">)</span> <b class="conum">(3)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">emap_decode</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">code</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-n">fids</span><span class="tok-p">[</span><span class="tok-n">MAX_DSTS</span><span class="tok-p">])</span> <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get code (local fragment id) from position</p>
</li>
<li>
<p>get code (local fragment id) from box position</p>
</li>
<li>
<p>add a quantity to the map</p>
</li>
<li>
<p>get destination fragments from code</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_flu_2">1.20.2. flu</h4>
<div class="paragraph">
<p>Exchange solvent particles within a cutoff radius from the neighboring
nodes.</p>
</div>
<div class="sect4">
<h5 id="_interface_16">interface</h5>
<div class="paragraph">
<p>allocate, deallocate the structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_pack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-n">EFluPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_comm_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EFluComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_pack_fin</span><span class="tok-p">(</span><span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_comm_fin</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>build the map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_compute_map</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">start</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_download_cell_starts</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>pack and copy data on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">parray</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_download_data</span><span class="tok-p">(</span><span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate the packed data with neighbors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_post_recv</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_post_send</span><span class="tok-p">(</span><span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_wait_recv</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_wait_send</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack</span><span class="tok-p">(</span><span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">LFrag26</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">RFrag26</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_local_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">LFrag26</span> <span class="tok-o">*</span><span class="tok-n">lfrags</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_remote_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RFrag26</span> <span class="tok-o">*</span><span class="tok-n">rfrags</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack and get data informations needed by the <em>fluforces</em> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack</span><span class="tok-p">(</span><span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">LFrag26</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">RFrag26</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_local_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">LFrag26</span> <span class="tok-o">*</span><span class="tok-n">lfrags</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_remote_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RFrag26</span> <span class="tok-o">*</span><span class="tok-n">rfrags</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_obj">1.20.3. obj</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_mesh">1.20.4. mesh</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_common_2">1.20.5. common</h4>
<div class="paragraph">
<p>helper for common exchange operations</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ecommon_pack_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">PackHelper</span> <span class="tok-n">ph</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Pap26</span> <span class="tok-n">buf</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">ecommon_shift_one_frag</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>pack particles <code>pp</code> into 27 buffers <code>buf</code> according to the local map <code>ph</code></p>
</li>
<li>
<p>shift particles in the fragment direction</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The local map is defined through the structure</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">PackHelper</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">offsets</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">indices</span><span class="tok-p">[</span><span class="tok-n">NFRAGS</span><span class="tok-p">];</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which is a map for a single set of quantities.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fluforces">1.21. fluforces</h3>
<div class="paragraph">
<p>solvent forces</p>
</div>
<div class="sect3">
<h4 id="_interface_17">1.21.1. interface</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_8">1.21.2. data structures</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_submodules">1.21.3. submodules</h4>
<div class="sect4">
<h5 id="_bulk">bulk</h5>
<div class="paragraph">
<p>compute local interactions of solvent particles, given cell starts,
cell counts (see <a href="clist.html">clist</a>) and particles array</p>
</div>
<div class="paragraph">
<p>The algorithm is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>each particle of the array has one thread assigned.</p>
</li>
<li>
<p>the thread runs over half of the 27 cell lists overlapping one cutoff radius
(this makes 13 cells + the "self cell")</p>
</li>
<li>
<p>in each cell, the particle ids are fetched from the cell starts
array</p>
</li>
<li>
<p>run over particles, atomic add the forces to them and gather forces
on the main particle</p>
</li>
<li>
<p>atomic add main forces to force array</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Performance is strongly related to the pattern used to run over the
particles.
Better performance is achieved by grouping as much as possible
consecutive particles (row), meaning that the <code>x</code> cell index runs
fastest.</p>
</div>
<div class="paragraph">
<p>The cell run order is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+----&gt; x   plane dz = -1:    plane dz =  0:    plane dz = +1:
|
|            00 01 02          09 10 11          xx xx xx
v y          03 04 05          12 13 xx          xx xx xx
             06 07 08          xx xx xx          xx xx xx</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>xx</code> denotes that the cell is not used by the current thread.</p>
</div>
</div>
<div class="sect4">
<h5 id="_fluforces_halo">fluforces: halo</h5>
<div class="paragraph">
<p>solvent forces with remote particles (fragments)</p>
</div>
<div class="sect5">
<h6 id="_internals">Internals</h6>
<div class="paragraph">
<p>main kernel is <code>dev::forces</code> and performs all interactions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>dispatch threads along fragments</p>
</li>
<li>
<p>fetch generalized particle</p>
</li>
<li>
<p>build map (how to access neighboring particles?)</p>
</li>
<li>
<p>loop over neighboring particles according to map</p>
</li>
<li>
<p>compute pairwise interactions</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_frag">1.22. frag</h3>
<div class="paragraph">
<p>Fragment functions on host and device</p>
</div>
<div class="sect3">
<h4 id="_purpose_3">1.22.1. purpose</h4>
<div class="paragraph">
<p>A <em>fragment</em> designates one of the 27 directions \((dx, dy, dz)\),
where \(dx, dy, dz \in \{-1, 0, 1\}\).</p>
</div>
<div class="paragraph">
<p>The fragment \((0, 0, 0)\) is called <em>bulk</em> and has the id <code>frag_bulk</code>.</p>
</div>
<div class="paragraph">
<p>The purpose of this module is to encode and decode the <em>fragments</em>
between <em>fragment ids</em> (numbered from 0 to 26) and <em>directions</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_18">1.22.2. interface</h4>
<div class="paragraph">
<p>The major part of the functions are available to both device and host,
within the namespaces <code>fragdev</code> and <code>fraghst</code>, respectively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">i2dx</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                 <b class="conum">(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">i2dy</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                 <b class="conum">(2)</b>
<span class="tok-kt">int</span> <span class="tok-nf">i2dz</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                 <b class="conum">(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">i2d3</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-n">d</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span> <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get \(dx\) from fragment id</p>
</li>
<li>
<p>get \(dy\) from fragment id</p>
</li>
<li>
<p>get \(dz\) from fragment id</p>
</li>
<li>
<p>get \((dx, dy, dz)\) from fragment id</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">d2i</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">z</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">d32i</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">d</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span>     <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get fragment id from \((dx, dy, dz)\)</p>
</li>
<li>
<p>idem with array as input</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">ncell</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span> <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>given sub-domain sizes <code>L</code>, returns number of neighboring cells to
fragment with id <code>i</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">antid2i</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">z</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">anti</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                  <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>given \((dx, dy, dz)\), return the id of the <em>anti</em> fragment (i.e. with direction \((-dx, -dy, -dz)\))</p>
</li>
<li>
<p>given a fragment id, returns the id of the <em>anti</em> fragment</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Only on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">estimates</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cap</span><span class="tok-p">);</span> <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>given a maximum number density <code>maxp</code>, return an estimate of the
number of particles in each fragment layer.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fsi">1.23. fsi</h3>
<div class="paragraph">
<p>flow-structure interactions between solvent and objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect3">
<h4 id="_interface_19">1.23.1. interface</h4>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">fsi_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">rank</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Fsi</span> <span class="tok-o">**</span><span class="tok-n">fsi</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">fsi_fin</span><span class="tok-p">(</span><span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">fsi_bind_solvent</span><span class="tok-p">(</span><span class="tok-n">PaArray</span> <span class="tok-n">pa</span><span class="tok-p">,</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">fsi_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-n">FoWrap</span> <span class="tok-o">*</span><span class="tok-n">fw</span><span class="tok-p">);</span>      <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">fsi_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">,</span> <span class="tok-n">Pap26</span> <span class="tok-n">PP</span><span class="tok-p">,</span> <span class="tok-n">Fop26</span> <span class="tok-n">FF</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[</span><span class="tok-mi">26</span><span class="tok-p">]);</span>  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>store solvent interactions inside hidden structure <code>Fsi</code></p>
</li>
<li>
<p>compute the interactions between local objects and local solvent</p>
</li>
<li>
<p>compute the interactions between remote objects and local solvent</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_io">1.24. IO</h3>
<div class="sect3">
<h4 id="_text">1.24.1. Text</h4>
<div class="paragraph">
<p>Write one row per particle in a text file <code>path</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">txt_write_pp</span><span class="tok-p">(</span><span class="tok-kt">long</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_write_pp_ff</span><span class="tok-p">(</span><span class="tok-kt">long</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Read particles to a structure <code>TxtRead</code>. The <code>TxtRead</code> API returns the
number of particles and pointers to the data. <code>txt_read_fin</code> frees the
memory and invalidated pointers returned by <code>txt_read_get_pp</code> or
<code>txt_read_get_pp_ff</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">txt_read_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">TxtRead</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_read_pp_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">TxtRead</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_read_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">TxtRead</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_read_fin</span><span class="tok-p">(</span><span class="tok-n">TxtRead</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">int</span> <span class="tok-nf">txt_read_get_n</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">TxtRead</span> <span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span> <span class="tok-nf">txt_read_get_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">TxtRead</span> <span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-k">const</span> <span class="tok-n">Force</span><span class="tok-o">*</span>    <span class="tok-nf">txt_read_get_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">TxtRead</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Text format is a as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x y z vx vy vz [fx fy fz]
...
x y z vx vy vz [fx fy fz]</pre>
</div>
</div>
<div class="paragraph">
<p>where every row corresponds to a particle.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_math">1.25. Math</h3>
<div class="paragraph">
<p>Helpers for math operations and random number generation</p>
</div>
<div class="sect3">
<h4 id="_linal">1.25.1. linal</h4>
<div class="paragraph">
<p>Linear algebra helpers on host</p>
</div>
<div class="sect4">
<h5 id="_interface_20">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* invert symmetric matrix m0[6] */</span>
<span class="tok-kt">void</span> <span class="tok-nf">linal_inv3x3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">m0</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">minv0</span><span class="tok-p">);</span> <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>inverse symmetric 3 by 3 matrix; fails and returns an error for
singular matrices with determinant smaller than epsilon (hardcoded
to <code>1e-8</code>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>structure of the matrix is <code>xx, xy, yy, yz, zz</code>, where</p>
</div>
<div class="listingblock">
<div class="content">
<pre>     ( xx xy xz)
A =  ( xy yy yz)
     ( xz yz zz)</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_host_random_number_generation">1.25.2. Host random number generation</h4>
<div class="paragraph">
<p>Generate uniform random numbers on host in floating point precision</p>
</div>
<div class="sect4">
<h5 id="_interface_21">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">RNDunif</span><span class="tok-p">;</span>                                             <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rnd_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">z</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RNDunif</span> <span class="tok-o">**</span><span class="tok-n">r</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rnd_fin</span><span class="tok-p">(</span><span class="tok-n">RNDunif</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">);</span>                                   <b class="conum">(3)</b>
<span class="tok-kt">float</span> <span class="tok-nf">rnd_get</span><span class="tok-p">(</span><span class="tok-n">RNDunif</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">);</span>                                  <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>hidden structure containing state of the rng</p>
</li>
<li>
<p>allocate and initialize the rng (<code>x</code>, <code>y</code>, <code>z</code> and <code>c</code> are states of the rng)</p>
</li>
<li>
<p>deallocate rng states</p>
</li>
<li>
<p>generate a random number in single precision; modify the state</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_linar_coordinate_transformation_for_3d_vector">1.25.3. linar coordinate transformation for 3D vector</h4>
<div class="paragraph">
<p>Transform vector <code>a[3]</code> to <code>b[3]</code> using</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    b[X] = s[X]*a[X] + o[X]
    b[Y] = s[Y]*a[Y] + o[Y]
    b[Z] = s[Z]*a[Z] + o[Z]</pre>
</div>
</div>
<div class="paragraph">
<p>Coefficient <code>s</code> and <code>o</code> are defined implicitly by API calls.</p>
</div>
<div class="sect4">
<h5 id="_interface_22">interface</h5>
<div class="sect5">
<h6 id="_allocate_deallocate">Allocate/Deallocate</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_ini</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">tform_fin</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters of the transformation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_vector</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a1</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span>   <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">b0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">b1</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">tform_chain</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">tform_grid2grid</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">f_lo</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">f_hi</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">f_n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span>
                     <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">t_lo</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">t_hi</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">t_n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span>
                     <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">tform_to_grid</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">b0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">tform_from_grid</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">b0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>transfrom which convert vectors <code>a0</code> to <code>a1</code> and <code>b0</code> to <code>b1</code></p>
</li>
<li>
<p>transform is a chain of two transforms</p>
</li>
</ol>
</div>
<div class="sect6">
<h7 id="_convert_vector">Convert vector</h7>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_convert</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span> <span class="tok-n">a1</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_convert_to_view">convert to view</h7>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_to_view</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform_v</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_log">log</h7>
<div class="paragraph">
<p>Log or dump the state of 'Tform'</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_log</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">tform_dump</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">FILE</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scheme_move">1.26. scheme/move</h3>
<div class="paragraph">
<p>Time scheme update</p>
</div>
<div class="paragraph">
<p>Currently implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Forward Euler</p>
</li>
<li>
<p>Velocity-Verlet</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_interface_23">1.26.1. interface</h4>
<div class="paragraph">
<p>allocate and free host parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_move_params_ini</span><span class="tok-p">(</span><span class="tok-n">MoveParams</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_move_params_fin</span><span class="tok-p">(</span><span class="tok-n">MoveParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set time scheme parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters from configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_move_params_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">MoveParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert host structure to a view, usable by kernels:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-n">MoveParams_v</span> <span class="tok-nf">scheme_move_params_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">MoveParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Main interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_move_apply</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-n">MoveParams</span><span class="tok-o">*</span> <span class="tok-n">moveparams</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">mass</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_move_clear_vel</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>apply one step of the time scheme to the particles</p>
</li>
<li>
<p>set velocity of particles to 0</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_7">1.26.2. configuration</h4>
<div class="paragraph">
<p>Set parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">TODO: NOT YET IMPLEMENTED</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pair">1.27. pair</h3>
<div class="paragraph">
<p>pairwise forces.
manages the parameters for dpd and repulsive Lennard-Jones parameters.</p>
</div>
<div class="sect3">
<h4 id="_dpd_interactions">1.27.1. dpd interactions</h4>
<div class="paragraph">
<p>DPD particles interact via the following force:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{F}_{ij} = \left( F_{ij}^C + F_{ij}^R + F_{ij}^D \right) \mathbf{e}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^C = \alpha \max \left( 1 - \frac{r_{ij}} {r_c}, 0 \right)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^R = \sigma w(r_{ij}) W_{ij}\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^D = -\gamma w(r_{ij})^2 \mathbf{v}_{ij} \cdot \mathbf{r}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{r}_{ij} = \mathbf{r}_i - \mathbf{r}_j, \\
r_{ij} = | \mathbf{r}_{ij} |, \\
\mathbf{v}_{ij} = \mathbf{v}_i - \mathbf{v}_j.\]
</div>
</div>
<div class="paragraph">
<p>The viscous kernel is given by</p>
</div>
<div class="stemblock">
<div class="content">
\[w(r) = r^{\frac{1}{2^s}},\]
</div>
</div>
<div class="paragraph">
<p>where \(s\) is the <code>S_LEVEL</code> compile time option set to <code>2</code> by default.</p>
</div>
</div>
<div class="sect3">
<h4 id="_repulsive_lj">1.27.2. repulsive LJ</h4>
<div class="paragraph">
<p>Repulsive forces for contact are implemented using the repulsive LJ
potential. It is given by</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{F}_{ij} = F_{ij}^{rLJ} \mathbf{e}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^{rLJ} = \max \left( 0, F^{LJ}(r_{ij})\right)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F^{LJ}(r) = 24 \epsilon \frac{1}{r} \left( 2 \left[\frac \sigma r
\right]^12 - \left[\frac \sigma r \right]^6 \right)\]
</div>
</div>
<div class="paragraph">
<p>for numerical reasons, the magnitude is limited to \(10^4\).</p>
</div>
</div>
<div class="sect3">
<h4 id="_host_interface_2">1.27.3. Host interface</h4>
<div class="paragraph">
<p>allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_ini</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_fin</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>set parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_set_dpd</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ncol</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">g</span><span class="tok-p">[],</span> <span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">pair_set_lj</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">sigma</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">eps</span><span class="tok-p">,</span> <span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set the DPD parameters. <code>ncol</code> is the number of colors. This is
mandatory for any view</p>
</li>
<li>
<p>set the Lennard-Jones parameters \(\sigma\) and
\(\epsilon\). This may be called only when the LJ parameters are needed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>set parameters from configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">name_space</span><span class="tok-p">,</span> <span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the argument <code>name_space</code> denotes the namespace where to look for the
parameters (see below).</p>
</div>
<div class="paragraph">
<p>Compute the \(\sigma\) parameter for a given temperature and timestep:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_ini</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_fin</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get the different views:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPD</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd_color</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPDC</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd_mirrored</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPDCM</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd_lj</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPDLJ</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_device_interface">1.27.4. device interface</h4>
<div class="paragraph">
<p>Inside a CUDA kernel, the pairwise force can be called by the generic function</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-k">typename</span> <span class="tok-n">Param</span><span class="tok-p">,</span> <span class="tok-k">typename</span> <span class="tok-n">Fo</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">pair_force</span><span class="tok-p">(</span><span class="tok-n">Param</span> <span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">PairPa</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">PairPa</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">rnd</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Fo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>PairPa</code> structure is a generic particle with color.
This should be used with the <em>parray</em> module.
The <code>Fo</code> structure is a generic force and can be either <code>PairFo</code> or
<code>PairSFo</code>, respectively, for force or force and stress computation.
This should be used with the <em>farray</em> module.
The input parameter <code>Param p</code> is a view for pair parameters.</p>
</div>
<div class="paragraph">
<p>The above function behaves differently given different types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PairDPD</code>: standard DPD interaction</p>
</li>
<li>
<p><code>PairDPDLJ</code>: standard DPD and repulsive LJ interaction</p>
</li>
<li>
<p><code>PairDPDC</code>: <em>colored</em> DPD interaction: pick up parameters as a function
of the particle colors</p>
</li>
<li>
<p><code>PairDPDCM</code>: <em>mirrored</em> DPD: same as <em>colored</em> DPD considering that
particle <code>b</code> has the same color as particle <code>a</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Inside a kernel, the generic force can be added by using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">pair_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">)</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">pair_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_8">1.27.5. Configuration</h4>
<div class="paragraph">
<p>parameters are configured through 3 namespaces: <code>flu</code>, <code>fsi</code> and
<code>cnt</code>.</p>
</div>
<div class="paragraph">
<p>example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">flu</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    dpd = true</span>
<span class="tok-s">    a = [10.0, 80.0, 10.0]</span>
<span class="tok-s">    g = [1.0, 8.0, 15.0]</span>
<span class="tok-s">    lj = false</span>
<span class="tok-na">}</span>

<span class="tok-na">fsi</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    dpd = true</span>
<span class="tok-s">    a = [10.0, 80.0, 10.0]</span>
<span class="tok-s">    g = [1.0, 8.0, 15.0]</span>
<span class="tok-s">    lj = false</span>
<span class="tok-na">}</span>

<span class="tok-na">cnt</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    dpd = true</span>
<span class="tok-s">    a = [0.0]</span>
<span class="tok-s">    g = [16.0]</span>
<span class="tok-s">    lj = true</span>
<span class="tok-s">    ljs = 0.3</span>
<span class="tok-s">    lje = 0.44</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The DPD parameters can be different when many colors are set.
User provides parameters in an array following the packed symmetric
matrix convention. For example the interaction table for 3 colors</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    x_{11} &amp; x_{12} &amp; x_{13} \\
    x_{12} &amp; x_{22} &amp; x_{23} \\
    x_{13} &amp; x_{23} &amp; x_{33}
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>becomes</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    x_{11} &amp; x_{12} &amp; x_{13} &amp; x_{22} &amp; x_{23} &amp; x_{33}
\end{bmatrix}.\]
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parray">1.28. parray</h3>
<div class="paragraph">
<p>Generic particle array to be passed to interaction kernels.</p>
</div>
<div class="sect3">
<h4 id="_host_interface_3">1.28.1. host interface</h4>
<div class="paragraph">
<p>A <code>PaArray</code> structure can be configured by pushing particles and,
optionally, colors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">parray_push_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">parray_push_cc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">,</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Particles must be pushed before colors
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Client can check if the colors has been pushed by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">bool</span> <span class="tok-nf">parray_is_colored</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The particle array data are meant to be passed to kernels.
In order to inline the fetching mode (see device interface), different
views can be generated from the <code>PaArray</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">parray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">PaArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span>  <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">parray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">PaCArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get a view to fetch particles without colors</p>
</li>
<li>
<p>Get a view to fetch particles with colors</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_device_interface_2">1.28.2. device interface</h4>
<div class="paragraph">
<p>Generic particle (see <em>pair</em> module)  can be fetched depending on the view:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">parray_get</span><span class="tok-p">(</span><span class="tok-n">PaArray_v</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairPa</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span> <b class="conum">(1)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">parray_get</span><span class="tok-p">(</span><span class="tok-n">PaCArray_v</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairPa</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>fetch position and velocity only</p>
</li>
<li>
<p>fetch position, velocity and color</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_farray">1.29. farray</h3>
<div class="paragraph">
<p>Generic force array to be passed to interaction kernels.
Implemented versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>forces only</p>
</li>
<li>
<p>forces and stresses</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_host_interface_4">1.29.1. host interface</h4>
<div class="paragraph">
<p>A <code>FoArray</code> structure can be configured by pushing forces and,
optionally, stresses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">farray_push_ff</span><span class="tok-p">(</span><span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">farray_push_ss</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Forces must be pushed before stresses
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Client can check if the stresses has been pushed by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">bool</span> <span class="tok-nf">farray_has_stress</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The force array data are meant to be passed to kernels.
In order to inline the forces computations mode (see device interface), different
views can be generated from the <code>FoArray</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">farray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">FoArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span>  <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">farray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">FoSArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get a view to compute forces only</p>
</li>
<li>
<p>Get a view to compute forces and stresses</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_device_interface_3">1.29.2. device interface</h4>
<div class="paragraph">
<p>Generic forces (see <em>pair</em> module) can be added to the generic force
array depending on the view type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">farray_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span> <b class="conum">(1)</b>
<span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">farray_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoSArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add forces only to the array</p>
</li>
<li>
<p>add forces and stresse to the array</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The template parameter <code>S</code> is the sign, must be either <code>-1</code> or <code>1</code>.
Note that it only affects the forces, stresses are always added with
positive sign, as opposed to forces.</p>
</div>
<div class="paragraph">
<p>For equivalent atomic operations, the following functions can be called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">farray_atomic_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span>
<span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">farray_atomic_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoSArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generic Force structure can be initialised to 0 based on the type
of the Generic array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-n">PairFo</span> <span class="tok-n">farray_fo0</span><span class="tok-p">(</span><span class="tok-n">FoArray_v</span><span class="tok-p">)</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-n">PairSFo</span> <span class="tok-n">farray_fo0</span><span class="tok-p">(</span><span class="tok-n">FoSArray_v</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parser">1.30. parser</h3>
<div class="sect3">
<h4 id="_purpose_4">1.30.1. purpose</h4>
<div class="ulist">
<ul>
<li>
<p>wrapper for the <code>libconfig</code> library</p>
</li>
<li>
<p>holds configurations from 4 sources:</p>
<div class="ulist">
<ul>
<li>
<p>set by program (priority 4)</p>
</li>
<li>
<p>arguments (priority 3)</p>
</li>
<li>
<p>configuration file (priority 2)</p>
</li>
<li>
<p>default parameters (priority 1)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When retrieving a value, the source with higher priority is used.
If not found in a source, the value is retrieved from the next highest
priority.
If no source contains the parmeter, an error is raised.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_structure_3">1.30.2. data structure</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span>
    <span class="tok-n">EXE</span><span class="tok-p">,</span> <span class="tok-cm">/* from program setters */</span>
    <span class="tok-n">ARG</span><span class="tok-p">,</span> <span class="tok-cm">/* from arguments       */</span>
    <span class="tok-n">OPT</span><span class="tok-p">,</span> <span class="tok-cm">/* from additional file */</span>
    <span class="tok-n">DEF</span><span class="tok-p">,</span> <span class="tok-cm">/* from default file    */</span>
    <span class="tok-n">NCFG</span>
<span class="tok-p">};</span>

<span class="tok-k">enum</span> <span class="tok-p">{</span><span class="tok-n">INI</span> <span class="tok-o">=</span> <span class="tok-mi">123</span><span class="tok-p">};</span> <span class="tok-cm">/* status */</span>
<span class="tok-k">struct</span> <span class="tok-n">Config</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">status</span><span class="tok-p">;</span>
    <span class="tok-n">config_t</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-n">NCFG</span><span class="tok-p">];</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Consists of an array of <code>config_t</code> descriptors, ordered by priority.
Indices correspond to the <code>enum</code> keys.
The first key has the highest priority, second key has second highest
priority etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_24">1.30.3. interface</h4>
<div class="paragraph">
<p>Allocate and free the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_ini</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Config</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Read data from the default, optional and command line config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_read</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_int</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_float</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_bool</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_string</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_vint</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_int3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_vfloat</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_float3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the program raises an error if the argument is not found or
if an error occured (e.g. wrong type).</p>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_int</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_float</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_bool</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_string</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_vint</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_int3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_vfloat</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_float3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The program does not raise error if the variable is not found.
The return value is <code>true</code> if the variable has been found and <code>false</code>
otherwise.</p>
</div>
<div class="paragraph">
<p>The client may overwrite variables in the config object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_set_int</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_vint</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-kt">int</span> <span class="tok-n">nelem</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">[],</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_int3</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-n">int3</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_float</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_vfloat</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-kt">int</span> <span class="tok-n">nelem</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[],</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_float3</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-n">float3</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_bool</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_string</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[],</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>desc</code> is an array containing the names of the nested groups.
<code>n</code> is the nesting level of the description (minimum is 1). It is the
same as the size of <code>desc</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">[]</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s">&quot;main&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;sub&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">};</span>
<span class="tok-kt">int</span> <span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-mi">3</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>will correspond to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-n">main</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-n">sub</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-p">...</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The written fields may be dumped in a stream using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_write_exe</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-kt">FILE</span> <span class="tok-o">*</span><span class="tok-n">stream</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_partlist">1.31. partlist</h3>
<div class="paragraph">
<p>Part list: a structure to handle a list of dead or alive particles
Purpose: kill particles during redistribution or cell lists build</p>
</div>
<div class="sect3">
<h4 id="_data_structure_4">1.31.1. data structure</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">PartList</span> <span class="tok-p">{</span>
    <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">;</span>   <span class="tok-cm">/* particles array          */</span>
    <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">deathlist</span><span class="tok-p">;</span> <span class="tok-cm">/* what pp is dead or alive */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_25">1.31.2. interface</h4>
<div class="paragraph">
<p>contains only device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">bool</span> <span class="tok-nf">is_dead</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">lp</span><span class="tok-p">.</span><span class="tok-n">deathlist</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">lp</span><span class="tok-p">.</span><span class="tok-n">deathlist</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">DEAD</span><span class="tok-p">;</span>
    <span class="tok-k">return</span> <span class="tok-nb">false</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">bool</span> <span class="tok-nf">is_alive</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-o">!</span><span class="tok-n">is_dead</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">lp</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_forces">1.32. Forces</h3>
<div class="stemblock">
<div class="content">
\[E^{spring} \propto \left( x - x_0 \right)^2 + E^{nonlin} \\
E^{tot}_{area} \propto \left( A^{tot} - A_{0}^{tot} \right)^2 \\
E^{local}_{area} \propto \left( A - A_{0} \right)^2 \\
E^{local}_{area} \propto \left( A - A_{0} \right)^2 \\
E^{tot}_{vol} \propto \left( V^{tot} - V_{0}^{tot} \right)^2 \\
E_{bnd} \propto \left(\theta - \theta_0 \right)^2\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_red_blood_cell">1.33. Red blood cell</h3>
<div class="paragraph">
<p>Red blood cell. <a href="type.h">src/rbc/type.h</a> defines <code>struct rbc::Quants</code></p>
</div>
<div class="sect3">
<h4 id="_components">1.33.1. components</h4>
<div class="ulist">
<ul>
<li>
<p>adj adjacency list: a structure to pack mesh to read on device</p>
</li>
<li>
<p>com compute center of mass</p>
</li>
<li>
<p>edg store information for every edge (host)</p>
</li>
<li>
<p>internal forces: <a href="forces.html">forces</a></p>
</li>
<li>
<p>gen generate <code>pp</code> from cell template (<code>rbc.off</code>) and initial condition
files (<code>rbcs-ic.txt</code>)</p>
</li>
<li>
<p><a href="com">main</a> initialization, restart</p>
</li>
<li>
<p>rnd random numbers for internal forces</p>
</li>
<li>
<p>rnd/api low level api for random number generator</p>
</li>
<li>
<p>force/area_volume compute area and volume</p>
</li>
<li>
<p>stretch apply a force to every vertex of every cell, force is set from
a file <code>rbc.stretch</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also <code>src/u/rbc</code>, <code>src/test/rbccom</code>, <code>src/test/rbc</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_cell_templates">1.33.2. cell templates</h4>
<div class="paragraph">
<p>See <code>src/data/cells</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_random_force">1.34. random force</h3>
<div class="paragraph">
<p>Activate by <code>RBC_RND</code> in <code>conf.h</code>. If environment variable <code>RBC_RNC</code>
is set it is used as seed. Magnitude of the force is</p>
</div>
<div class="listingblock">
<div class="content">
<pre>g = gammaC; T = kBT0
f0  = sqrtf(2*g*T/dt)*rnd</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_shape_rbc">1.35. shape RBC</h3>
<div class="paragraph">
<p>Compute membrane quantities on host. <code>rbc_shape_edg</code> and
<code>rbc_shape_area</code> return the output in the way accessible with <code>Adj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_ini</span><span class="tok-p">(</span><span class="tok-n">Adj</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">rr</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcShape</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_edg</span> <span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_area</span><span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">**</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_total_area</span><span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_total_volume</span><span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_stretch_rbc">1.36. stretch RBC</h3>
<div class="paragraph">
<p>Apply force to every vertex of an every cell constant force. Force is
configured from a file <code>path</code>. The format of the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>fx0 fy0 fz0
fx1 fy1 fz1
...
fx_nv fy_nv fz_nv</pre>
</div>
</div>
<div class="paragraph">
<p><code>nv</code> is the number of vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rbc_stretch_ini</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcStretch</span><span class="tok-o">**</span><span class="tok-p">);</span> <span class="tok-cm">/* `nv` is for error check */</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_stretch_fin</span><span class="tok-p">(</span><span class="tok-n">RbcStretch</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_stretch_apply</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RbcStretch</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scheme_restrain">1.37. scheme/restrain</h3>
<div class="paragraph">
<p>Restrain the movement of drop or rbc membrane by shifting center of
mass velocity.</p>
</div>
<div class="paragraph">
<p>Consider a subset of particles \(P\) with indices \(I \subset \{i\}_{i = 1}^{n}\).
The <code>Restrain</code> module  shifts the center of mass velocity of \(P\) such that</p>
</div>
<div class="stemblock">
<div class="content">
\[\sum\limits_{i \in I} \mathbf{v}_i = 0.\]
</div>
</div>
<div class="paragraph">
<p>The subset \(I\) depends on the colors of the solvent in case of a
single drop.</p>
</div>
<div class="sect3">
<h4 id="_interface_26">1.37.1. interface</h4>
<div class="paragraph">
<p>allocate and free host structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_ini</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_fin</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_red</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_rbc</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_none</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_freq</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">freq</span><span class="tok-p">,</span> <span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set to restrain the "red" solvent only</p>
</li>
<li>
<p>Set to restrain the rbc membrane only</p>
</li>
<li>
<p>Set for no restrain</p>
</li>
<li>
<p>Set the diagnosis frequency (0 for no diagnosis)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Set parameters from configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply restrain (note: this calls collective mpi operation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_apply</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">,</span> <span class="tok-kt">long</span> <span class="tok-n">it</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Restrain</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-n">SchemeQQ</span> <span class="tok-n">qq</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_9">1.37.2. configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">restrain</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    kind = [&quot;none&quot;, &quot;red&quot;, &quot;rbc&quot;]</span>
<span class="tok-s">    freq = 1000;</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rigid">1.38. Rigid</h3>
<div class="paragraph">
<p>Rigid objects consist of frozen particles moving in a rigid fashion.
Interactions with other objects are modeled via pairwise interactions
with the frozen particles.</p>
</div>
<div class="paragraph">
<p>Rigid objects also contain a surface representation on which other
particles may bounce back.</p>
</div>
<div class="sect3">
<h4 id="_quantities">1.38.1. Quantities</h4>
<div class="sect4">
<h5 id="_data_structure_5">data structure</h5>
<div class="paragraph">
<p><code>RigidQuants</code> structure contains particles of rigid objects as well as
mesh particles.
<code>Solid</code> structures contain center of mass, orientation, angular and
linear velocity of the rigid object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">struct</span> <span class="tok-n">RigQuants</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-n">nps</span><span class="tok-p">;</span>              <span class="tok-cm">/* number of particles (total), solid, particle per solid        */</span>
    <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">;</span>       <span class="tok-cm">/* particles on hst and device                                   */</span>
    <span class="tok-n">Solid</span>    <span class="tok-o">*</span><span class="tok-n">ss_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">;</span>       <span class="tok-cm">/* rigid strutures                                               */</span>
    <span class="tok-kt">float</span>   <span class="tok-o">*</span><span class="tok-n">rr0_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">rr0</span><span class="tok-p">;</span>      <span class="tok-cm">/* frozen particle templates                                     */</span>

    <span class="tok-cm">/* mesh related quantities */</span>
    <span class="tok-kt">int</span> <span class="tok-n">nt</span><span class="tok-p">,</span> <span class="tok-n">nv</span><span class="tok-p">;</span>                   <span class="tok-cm">/* number of [t]riangles and [v]ertices                          */</span>
    <span class="tok-n">int4</span> <span class="tok-o">*</span><span class="tok-n">htt</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">dtt</span><span class="tok-p">;</span>              <span class="tok-cm">/* triangle indices of [h]ost and [d]evice                       */</span>
    <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">hvv</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">dvv</span><span class="tok-p">;</span>             <span class="tok-cm">/* vertices of [h]ost and [d]evice (template)                    */</span>
    <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">i_pp_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">i_pp</span><span class="tok-p">;</span>    <span class="tok-cm">/* particles representing all meshes of all solids of that node  */</span>

    <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss_dmp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ss_dmp_bb</span><span class="tok-p">;</span>

    <span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">;</span> <span class="tok-cm">/* maximum particle number */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_27">Interface</h5>
<div class="paragraph">
<p>allocate and deallocate the quantities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rig_fin</span><span class="tok-p">(</span><span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>maxp</code> is the maximum particle number per node.</p>
</div>
<div class="paragraph">
<p>generate the quantities from solvent particles or from restart files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_gen_quants</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-n">pi</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">opp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">on</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rig_strt_quants</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rigid objects are numbered and need a unique id for dump.
This is initialised using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_set_ids</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart files are dumped using the following functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_strt_dump_templ</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>         <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_strt_dump</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>to be called only once: dump the frozen particle in local referential (common to every rigid objects)</p>
</li>
<li>
<p>dump <code>Solid</code> structures, describing position, orientation and velocity of the rigid objects</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_update">1.38.2. update</h4>
<div class="paragraph">
<p>Position and velocities of rigid objects are updated from forces
exerted on the particles.</p>
</div>
<div class="sect4">
<h5 id="_pin_info">pin info</h5>
<div class="paragraph">
<p>The hidden structure <code>RigPinInfo</code> is used to store information about
constrained rigid motion.
This can be used to disable the movement of the center of mass of the rigid object along
\(x, y\) or \(z\) axis (see <code>com</code> parameter).
User can also block the rotation along one of the axes  (see <code>axis</code>
parameter).</p>
</div>
<div class="paragraph">
<p>example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>rigid object can rotate but is only able to  move along the \(x\) axis:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>com = {0, 1, 1}
axis = {0, 0, 0}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>rigid object can only rotate along the \(z\) axis and its center
of mass is not able to move:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>com = {1, 1, 1}
axis = {1, 1, 0}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_ini_pininfo</span><span class="tok-p">(</span><span class="tok-n">RigPinInfo</span> <span class="tok-o">**</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_fin_pininfo</span><span class="tok-p">(</span><span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_set_pininfo</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">com</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">axis</span><span class="tok-p">,</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_set_pdir</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">pdir</span><span class="tok-p">,</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(4)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_set_pininfo_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(5)</b>

<span class="tok-kt">int</span> <span class="tok-nf">rig_get_pdir</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate the hidden structure</p>
</li>
<li>
<p>deallocate the hidden structure</p>
</li>
<li>
<p>set the motion constrains</p>
</li>
<li>
<p>for periodic objects, set the direction of periodicity
(e.g. cylinder)</p>
</li>
<li>
<p>set the above parameters from configuration file</p>
</li>
<li>
<p>get the perioid direction</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The periodic direction can be 0, 1 or 2 for the \(x, y\) or
\(z\) axis, respectively.
Default value for no periodicty is set via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span><span class="tok-n">NOT_PERIODIC</span> <span class="tok-o">=</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration has the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">rig</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    pin_com = [0, 0, 0]</span>
<span class="tok-s">    pin_axis = [0, 0, 0]</span>
<span class="tok-s">    pdir = -1</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_28">interface</h5>
<div class="paragraph">
<p>naming:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ns</code>: number of rigid objects</p>
</li>
<li>
<p><code>ss</code>: array of rigid structures <code>Solid</code></p>
</li>
<li>
<p><code>rr0</code>: positions of the rigid particles in the rigid object
reference frame</p>
</li>
<li>
<p><code>nps</code>: number of rigid particle per rigid object</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_reinit_ft</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_update</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-n">pi</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">rr0</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_generate</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nps</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">rr0</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_update_mesh</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">vv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set the force and torque to 0</p>
</li>
<li>
<p>update particle and rigid objects positions and velocity</p>
</li>
<li>
<p>generate rigid particles from template positions and rigid
structures</p>
</li>
<li>
<p>update the mesh position</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_signed_distance_function_sdf">1.39. signed distance function (sdf)</h3>
<div class="sect3">
<h4 id="_purpose_5">1.39.1. purpose</h4>
<div class="paragraph">
<p>Signed distance function is interpolated from a uniform grid.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementation">1.39.2. implementation</h4>

</div>
<div class="sect3">
<h4 id="_components_2">1.39.3. components</h4>
<div class="ulist">
<ul>
<li>
<p><code>field</code>: read sdf field from a file</p>
</li>
<li>
<p><code>bounce</code>: bounce back particles</p>
</li>
<li>
<p><code>label</code>: label which particle stays in bulk, turns into wall, or
deleted</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_time">1.40. Time</h3>
<div class="paragraph">
<p>Keeps current simulation time.</p>
</div>
<div class="paragraph">
<p><code>time_next(Time*, float dt)</code> is called every time step and updates the state of Time*.</p>
</div>
<div class="paragraph">
<p><code>time_cross(Time*, float interval)</code> true if <code>n*interval</code> is in between
current and previus timestep. In other wards did simulation "just
crossed" <code>n*interval</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">time_ini</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">start</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Time</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_fin</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">time_next</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">);</span>
<span class="tok-kt">int</span>  <span class="tok-nf">time_cross</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">interval</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_current</span> <span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_dt</span> <span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_dt0</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_time_step">1.41. Time step</h3>
<div class="paragraph">
<p>Return time step based on the current state of the simulation. If
<code>type=const</code> always return the same timestep. If <code>type=disp</code> return
timestep based on the maximum accelaration. <code>TimeStepAccel</code> is
constructed using <code>time_step_accel_push</code>.</p>
</div>
<div class="paragraph">
<p><code>float time_step_dt(TimeStep*, MPI_Comm, TimeStepAccel*);</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">time_step_accel_ini</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">TimeStepAccel</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_accel_fin</span><span class="tok-p">(</span><span class="tok-n">TimeStepAccel</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_accel_push</span><span class="tok-p">(</span><span class="tok-n">TimeStepAccel</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">time_step_ini</span><span class="tok-p">(</span><span class="tok-n">Config</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">TimeStep</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_fin</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_step_dt</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span><span class="tok-p">,</span> <span class="tok-n">TimeStepAccel</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_step_dt0</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_log</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_utils">1.42. Utils</h3>
<div class="sect3">
<h4 id="_error">1.42.1. error</h4>
<div class="paragraph">
<p>Custom error handling with context.</p>
</div>
<div class="sect4">
<h5 id="_usage">Usage</h5>
<div class="ulist">
<ul>
<li>
<p>an error can be raised by the use of one of the following macros:</p>
<div class="ulist">
<ul>
<li>
<p><code>signal_error_extra(fmt, &#8230;&#8203;)</code> will raise an error with extra
information formatted by the caller in a prinf format fashion</p>
</li>
</ul>
</div>
</li>
<li>
<p>use macro <code>UC</code> on any function which might contain an error signal in
one of the subfunctions.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_interface_29">Interface</h5>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cc">1.42.2. cc</h4>
<div class="paragraph">
<p>[C]uda [C]heck.</p>
</div>
<div class="paragraph">
<p>Error handling for cuda API calls.</p>
</div>
<div class="sect4">
<h5 id="_usage_2">Usage</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">CC</span><span class="tok-p">(</span><span class="tok-n">my_cuda_api_call</span><span class="tok-p">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">[error]</a>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mc">1.42.3. mc</h4>
<div class="paragraph">
<p>[M]PI [C]heck.</p>
</div>
<div class="paragraph">
<p>Error handling for MPI API calls.</p>
</div>
<div class="sect4">
<h5 id="_usage_3">Usage</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">MC</span><span class="tok-p">(</span><span class="tok-n">my_mpi_api_call</span><span class="tok-p">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">[error]</a>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_kernel_launch_macros">1.42.4. kernel launch macros</h4>
<div class="paragraph">
<p>[K]ernel [L]aunch.</p>
</div>
<div class="paragraph">
<p>a macro for cuds kernel launches</p>
</div>
<div class="paragraph">
<p>All but <code>unsafe</code> skip kernels with zero thread number.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">KL</span><span class="tok-p">(</span><span class="tok-n">fun</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">),</span> <span class="tok-p">())</span>     <span class="tok-o">-&gt;</span> <span class="tok-n">fun</span><span class="tok-o">&lt;&lt;&lt;</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-o">&gt;&gt;&gt;</span><span class="tok-p">()</span>
<span class="tok-n">KL</span><span class="tok-p">(</span><span class="tok-n">fun</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">))</span> <span class="tok-o">-&gt;</span> <span class="tok-n">fun</span><span class="tok-o">&lt;&lt;&lt;</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-o">&gt;&gt;&gt;</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wvel">1.43. wvel</h3>
<div class="paragraph">
<p>wall velocity field</p>
</div>
<div class="sect3">
<h4 id="_purpose_6">1.43.1. purpose</h4>
<div class="ulist">
<ul>
<li>
<p>set velocity to wall particles for wall interactions</p>
</li>
<li>
<p>get wall velocity for bounce back on walls</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_data_structures_9">1.43.2. data structures</h4>
<div class="paragraph">
<p>data structures are separated into 2 kinds of data structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Wvel</code>, which contains all informations needed for the velocity
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>Wvel_v</code> (<code>Wvel view</code>), containing only the information needed for one
specific time. It is passed to device kernels.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interface_30">1.43.3. interface</h4>
<div class="paragraph">
<p>Interface is splitted between host and device</p>
</div>
<div class="sect4">
<h5 id="_host">Host</h5>
<div class="paragraph">
<p>Host code is responsible for initialisation of <code>Wvel</code> and convert
<code>Wvel</code> to a view at a given timestep.</p>
</div>
<div class="paragraph">
<p>alloc, free structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_ini</span><span class="tok-p">(</span><span class="tok-n">Wvel</span> <span class="tok-o">**</span><span class="tok-n">wv</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_fin</span><span class="tok-p">(</span><span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">wv</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_set_cste</span><span class="tok-p">(</span><span class="tok-n">float3</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_shear</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">gdot</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">vdir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">gdir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">half</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_shear_sin</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">gdot</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">vdir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">gdir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">half</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">w</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">log_freq</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_hs</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">h</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_timestep</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get <em>view</em> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_get_view</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">long</span> <span class="tok-n">it</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">wv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Wvel_v</span> <span class="tok-o">*</span><span class="tok-n">view</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_device">Device</h5>
<div class="paragraph">
<p>Device code contains the functions describing the field.
Also contains bouncer function: gives bounced-back velocity from
position and velocity of particle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">wvel</span><span class="tok-p">(</span><span class="tok-n">Wvel_v</span> <span class="tok-n">wv</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">bounce_vel</span><span class="tok-p">(</span><span class="tok-n">Wvel_v</span> <span class="tok-n">wv</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rw</span><span class="tok-p">,</span> <span class="tok-cm">/* io */</span> <span class="tok-n">float3</span><span class="tok-o">*</span> <span class="tok-n">v</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_10">1.43.4. Configuration</h4>
<div class="sect4">
<h5 id="_constant_2">constant</h5>
<div class="paragraph">
<p>constant velocity \(u = (1, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;constant&quot;;</span>
<span class="tok-s">    u    = [1.0, 0.0, 0.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_shear_2">shear</h5>
<div class="paragraph">
<p>shear velocity \(u = (3 y, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;shear&quot;;</span>
<span class="tok-s">    gdot = 3.0;</span>
<span class="tok-s">    vdir = 0;</span>
<span class="tok-s">    gdir = 1;</span>
<span class="tok-s">    half = 0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sinusoidal_shear">sinusoidal shear</h5>
<div class="paragraph">
<p>shear velocity \(u(t) = (3 y \sin(5 t), 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;shear sin&quot;;</span>
<span class="tok-s">    gdot = 3.0;</span>
<span class="tok-s">    vdir = 0;</span>
<span class="tok-s">    gdir = 1;</span>
<span class="tok-s">    half = 0;</span>
<span class="tok-s">    w = 5.0;</span>
<span class="tok-s">    log_freq = 1000;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>in this case, the value \(3 * \sin(5 t)\) is printed every 1000 iterations.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hele_shaw">Hele Shaw</h5>
<div class="paragraph">
<p>velocity \(u_r = \frac u r \left(1 - \frac {4 z^2}{h^2}\right)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;hele shaw&quot;;</span>
<span class="tok-s">    u = 1.0;</span>
<span class="tok-s">    h = 8.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_third_party_dependencies">1.44. Third party dependencies</h3>
<div class="sect3">
<h4 id="_cuda_compiler">1.44.1. cuda compiler</h4>
<div class="paragraph">
<p><a href="http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc" class="bare">http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_mpi_library">1.44.2. MPI library</h4>
<div class="paragraph">
<p>To get the flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mpicxx -show</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pkg-config --libs mpich</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_libconfig">1.44.3. libconfig</h4>
<div class="paragraph">
<p>a library for processing structured configuration files</p>
</div>
<div class="paragraph">
<p>link:http://hyperrealm.com/libconfig/libconfig.html</p>
</div>
<div class="sect4">
<h5 id="_from_source">from source</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nv">v</span><span class="tok-o">=</span><span class="tok-m">1</span>.7.1
wget https://hyperrealm.github.io/libconfig/dist/libconfig-<span class="tok-nv">$v</span>.tar.gz
tar zxvf libconfig-<span class="tok-nv">$v</span>.tar.gz
<span class="tok-nb">cd</span> libconfig-<span class="tok-nv">$v</span>
./configure --prefix<span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">HOME</span><span class="tok-si">}</span>/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_from_git">from git</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>git clone git@github.com:hyperrealm/libconfig.git
<span class="tok-nb">cd</span> libconfig
autoreconf
./configure --prefix<span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">HOME</span><span class="tok-si">}</span>/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_from_apt">from apt</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>sudo apt install libconfig-dev</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pkgconfig">pkgconfig</h5>
<div class="paragraph">
<p>add path for pkg config</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nb">export</span> <span class="tok-nv">PKG_CONFIG_PATH</span><span class="tok-o">=</span><span class="tok-nv">$PKG_CONFIG_PATH</span>:<span class="tok-nv">$HOME</span>/prefix/libconfig/lib/pkgconfig</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hdf5">1.44.4. hdf5</h4>
<div class="paragraph">
<p>a data model, library, and file format for storing and managing data</p>
</div>
<div class="paragraph">
<p><a href="https://support.hdfgroup.org/HDF5" class="bare">https://support.hdfgroup.org/HDF5</a></p>
</div>
<div class="paragraph">
<p>To get flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>h5c++ -show</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>pkg-config hdf5-mpich --libs</code></pre>
</div>
</div>
<div class="paragraph">
<p>To build from source</p>
</div>
<div class="paragraph">
<p>link:https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.17/src/hdf5-1.8.17.tar.gz</p>
</div>
<div class="paragraph">
<p>Configuration options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>      --prefix<span class="tok-o">=</span><span class="tok-nv">$HOME</span>/prefix/hdf5
	  --enable-parallel
	  <span class="tok-nv">CXX</span><span class="tok-o">=</span>/usr/lib64/mpich/bin/mpic++
	  <span class="tok-nv">CC</span><span class="tok-o">=</span>/usr/lib64/mpich/bin/mpicc</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wrappers">1.45. wrappers</h3>
<div class="sect3">
<h4 id="intro">1.45.1. intro</h4>
<div class="paragraph">
<p><code>u.run</code> respects several environment variables to modify the way <code>udx</code>
is run</p>
</div>
</div>
<div class="sect3">
<h4 id="mem">1.45.2. MEM</h4>
<div class="paragraph">
<p>if <code>MEM</code> is set <code>udx</code> is ran with <code>cuda-memcheck</code> and <code>MEM</code> is used as a
list of parameters</p>
</div>
<div class="literalblock">
<div class="content">
<pre>MEM= u.test test/*
MEM='--leakcheck --blocking'              u.test test/*
MEM='--tool initcheck'                    u.test test/*
----

see also link:poc/memcheck[poc/memcheck]

[[val]]
== VAL

if `VAL` is set `udx` is ran with valgrind and `VAL` is used as a list
of parameters.

----
VAL= u.test test/*
VAL="--leak-check=full --show-leak-kinds=all"  u.test test/*
----

`u.run` respect `DRYRUN` : only show the commands do not execute them

----
DRYRUN= VAL=--option u.run ./udx

module: load cray-hdf5-parallel cudatoolkit daint-gpu
cmd: srun -n 1 -u valgrind --option ./udx
----

[[prof]]
== PROF

if `PROF` is set is ran with `nvprof`

----
PROF="--export-profile main.prof" u.run ./udx
nvprof -i main.prof
----

See also link:poc/prof/ppbandwidth[poc/ppbandwidth]

[[tim]]
== TIM

if `TIM` is set is ran with `time`

:leveloffset:  0

== User

== Units

:leveloffset:  2

= comm unit
:lext: .adoc

a send/recv unit with the 26 neighbors using link:../dev/modules/comm{lext}[comm module]

= error unit
:lext: .adoc

a unit to test error handling `UC`, `CC` and `MC` (see link:../dev/modules/utils/main{lext}[utils])

== compile

from `/src/` directory:

[source,sh]
----
u.conf0 u/error
u.make -j
----

== usage

[source,sh]
----
ERR_KIND=&lt;kind&gt; ./udx
----

where `&lt;kind&gt;` must be:

* 0 for rasing an error from host code
* 1 for testing `MC` on a failing MPI call
* 2 for testing `CC` on a failing cuda API call

The output should result in an error message, location of the error
and a backtrace

= hw unit

a "Hello World!" unit with kernel launch.

= hw unit

a "Hello World!" unit. This serves as a base for creating new units

= linal unit

a unit to test linear algebra functions

== compile

Run from src/

----
u.conf0 u/linal
----

== run

Invert symmetric 3x3 matrix

----
u.run ./udx -- 2 1 5   3 4   -2
2.857143e-01 -2.857143e-01 1.428571e-01 3.766234e-01 3.896104e-02 -6.493507e-02
----

compare to octave/matlab
----
&gt;&gt; C = [2,1,5;1,3,4;5,4,-2]
&gt;&gt; C^(-1)
ans =

   0.285714  -0.285714   0.142857
  -0.285714   0.376623   0.038961
   0.142857   0.038961  -0.064935
----

= mesh bb unit
== intro

Bounce back on triangulated mesh

== params

if `MESHBB_LOG_ROOTS` is defined logs coeficeints of cubic polynomials
and roots to `meshbb.roots`.

= MPI error

Units triggers mpi error. A test for `MC` macro.

= pair unit

== Intro

It is for test pair interactions.

== Compile

Run from src/

----
u.conf0 u/pair
----

or from other directorie

----
s=&lt;path to src&gt;
echo run | u.conf $s u/pair $s/conf/test.h
----

== Build

----
u.make -j
----

== Run

Particles coordinates, velocities, kinds, and colors are provided via
`stdin`. An example is in link:/src/data/pair/2[src/data/pair/2].
If `RND` is set it is used as a scale of random force for all pairs.

----
s=&lt;path to src&gt;
./udx        &lt; $s/data/pair/2
RND=42 ./udx &lt; $s/data/pair/2
----

Returns force between two particles

----
-2.4 0 0
----

== Source

link:/src/u/pair/imp/main.h[u/pair/imp/main.h]

== Test

----
u.test test/pair
----

= RBC forces

Dumps internal RBC forces.

= RBC

Runs RBC without solvent and contact forces.

See also link:src/test/rbc/u/main[src/test/rbc/u/main]

= RBC random

Dumps random numbers generated by link:src/rbc/rnd[src/rbc/rnd]

= scan unit

a unit to test scan algorithm (exclusive prefix sum , see e.g. https://en.wikipedia.org/wiki/Prefix_sum) on host and device.

= signed distance function (sdf) unit
:lext: .adoc

a unit to test sdf field.

== compile

[source,sh]
----
u.conf0 u/sdf
u.make -j
----

== run

Copy sdf file

[source,sh]
----
u.cp.sdf cyl1/cyl sdf.dat
----

`cyl1/cyl` along `z` and center at the domain center and radius
`lx/4`.

Pass coordinates as arguments
----
x=2.5 y=0 z=0
u.run ./udx $x $y $z
----

Returns
----
0 0 2.5 1.45547
----

= x unit

standard _uDeviceX_ code</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>