<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Control</title>
<link rel="stylesheet" href="/udoc/css/main.css">
<link rel="stylesheet" href="./pygments-colorful.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Control</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_velocity_controller">1. Velocity controller</a>
<ul class="sectlevel2">
<li><a href="#_interface">1.1. interface</a></li>
<li><a href="#_configuration">1.2. configuration</a></li>
</ul>
</li>
<li><a href="#_inflow">2. Inflow</a>
<ul class="sectlevel2">
<li><a href="#_interface_2">2.1. interface</a></li>
<li><a href="#_configuration_2">2.2. configuration</a></li>
</ul>
</li>
<li><a href="#_outflow">3. Outflow</a>
<ul class="sectlevel2">
<li><a href="#_interface_3">3.1. interface</a></li>
<li><a href="#_configuration_3">3.2. configuration</a></li>
</ul>
</li>
<li><a href="#_density_controller">4. Density controller</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>velocity controller</p>
</li>
<li>
<p>open boundary conditions</p>
</li>
<li>
<p>density controller</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_velocity_controller">1. Velocity controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>control velocity by modifying the imposed hydrostatic force</p>
</div>
<div class="sect2">
<h3 id="_interface">1.1. interface</h3>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vcont_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">vtarget</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">factor</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vcont_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">cont</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the transformation structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vcon_set_cart</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">cont</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vcon_set_radial</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">cont</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the transformation is the way of averaging the velocity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cartesian transformation keeps the velocity as it is before averaging.</p>
</li>
<li>
<p>radial transformation returns the velocity in polar coordinates
scaled by the radial position. the <code>z</code> component corresponds to
cartesian transformation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Control operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span>   <span class="tok-nf">vcont_sample</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-n">float3</span> <span class="tok-nf">vcont_adjustF</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span>   <span class="tok-nf">vcont_log</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>    <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get average velocity according to transformation and store it</p>
</li>
<li>
<p>reduce sampled quantities and update the controller. return the force</p>
</li>
<li>
<p>logging informations; dumped into the file <code>vcon.txt</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration">1.2. configuration</h3>
<div class="paragraph">
<p>syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">vcon</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">     active = true;</span>
<span class="tok-s">     type   = &quot;cart&quot;;          # can be also &quot;rad&quot;</span>
<span class="tok-s">     U      = [1.0, 1.0, 0.0]; # target velocity in transformed space</span>
<span class="tok-s">     log_freq    = 500;</span>
<span class="tok-s">     adjust_freq = 500;</span>
<span class="tok-s">     sample_freq = 1;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inflow">2. Inflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mass rate inflow</p>
</div>
<div class="sect2">
<h3 id="_interface_2">2.1. interface</h3>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini</span><span class="tok-p">(</span><span class="tok-n">int2</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">**</span><span class="tok-n">i</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_fin</span><span class="tok-p">(</span><span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the inflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_velocity</span><span class="tok-p">(</span><span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_plate</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">o</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">L1</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">L2</span><span class="tok-p">,</span>
                             <span class="tok-n">float3</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">upoiseuille</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">vpoiseuille</span><span class="tok-p">,</span>
                             <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_circle</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">o</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">R</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">H</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">poiseuille</span><span class="tok-p">,</span>
                              <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the type of inflow, call the appropriate
<code>ini_params_xxx</code>.
<code>ini_velocity</code> must be called after initializing the parameters.
it is used to setup the inlet velocity from parameters.</p>
</div>
<div class="paragraph">
<p>initialize from config parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>create particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_create_pp</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_create_pp_cc</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">newcolor</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">);</span> <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add particles to the array <code>pp</code> and increase <code>n</code> accordingly</p>
</li>
<li>
<p>same as above, with colors <code>cc</code> set to <code>color</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2">2.2. configuration</h3>
<div class="sect3">
<h4 id="_plate">2.2.1. plate</h4>
<div class="paragraph">
<p>syntax for a <code>8.0 x 16.0</code> plate perpendicular to the x axis passing by
the point <code>(1, 2, 3)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">inflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active      = true;</span>
<span class="tok-s">    type        = &quot;plate&quot;;</span>
<span class="tok-s">    L1          = 1.0;</span>
<span class="tok-s">    L2          = 16.0;</span>
<span class="tok-s">    direction   = 0;                # [0,1,2] = [X,Y,Z]</span>
<span class="tok-s">    origin      = [1.0, 2.0, 3.0];</span>
<span class="tok-s">    upoiseuille = false;            # true for parabolic profile along L1</span>
<span class="tok-s">    vpoiseuille = false;            # true for parabolic profile along L2</span>
<span class="tok-s">    u           = [10.0, 0.0, 0.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_circle">2.2.2. circle</h4>
<div class="paragraph">
<p>syntax for cylinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">inflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active = true;</span>
<span class="tok-s">    type   = &quot;circle&quot;;</span>
<span class="tok-s">    R      = 1.0;              # radius</span>
<span class="tok-s">    H      = 16.0;             # hight of the cylinder</span>
<span class="tok-s">    U      = 1.0;              # maximum velocity</span>
<span class="tok-s">    center = [8.0, 8.0, 8.0];</span>
<span class="tok-s">    poiseuille = false;        # parabolic profile along H if true</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_outflow">3. Outflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Delete particles satisfying a predicate</p>
</div>
<div class="sect2">
<h3 id="_interface_3">3.1. interface</h3>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">**</span><span class="tok-n">o</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the outflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ini_params_circle</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">R</span><span class="tok-p">,</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">ini_params_plate</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">r0</span><span class="tok-p">,</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the geometry of outflow, call the appropriate
<code>ini_params_xxx</code>.</p>
</div>
<div class="paragraph">
<p>filter and mark particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">filter_particles</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span> <b class="conum">(1)</b>

<span class="tok-kt">void</span> <span class="tok-nf">download_ndead</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                   <b class="conum">(2)</b>

<span class="tok-kt">int</span><span class="tok-o">*</span> <span class="tok-nf">get_deathlist</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                    <b class="conum">(3)</b>
<span class="tok-kt">int</span>  <span class="tok-nf">get_ndead</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                        <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>store dying particles infos inside Outflow struct</p>
</li>
<li>
<p>copy from device to host number of dead particles</p>
</li>
<li>
<p>return the list of dead marks (dead=1, alive=0)</p>
</li>
<li>
<p>return the number of dead particles</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_3">3.2. configuration</h3>
<div class="sect3">
<h4 id="_plate_2">3.2.1. plate</h4>
<div class="paragraph">
<p>will delete particles crossing a plate along the positive direction.
syntax for the plate <code>y=4</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">outflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active     = true;</span>
<span class="tok-s">    type       = &quot;plate&quot;;</span>
<span class="tok-s">    direction  = 1;      # [0,1,2] = [X,Y,Z]</span>
<span class="tok-s">    position   = 4.0;    # position along &quot;direction&quot;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_circle_2">3.2.2. circle</h4>
<div class="paragraph">
<p>delete particles going out of the cylinder.
syntax for a cylinder of radius 8 centered at <code>(8, 8, 8)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">outflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active = true;</span>
<span class="tok-s">    type   = &quot;circle&quot;;</span>
<span class="tok-s">    R      = 8.0;</span>
<span class="tok-s">    center = [8.0, 8.0, 8.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_density_controller">4. Density controller</h2>
<div class="sectionbody">

</div>
</div>
</div>
</body>
</html>