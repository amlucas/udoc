<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>distr</title>
<link rel="stylesheet" href="/udoc/css/main.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>distr</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_map">map</a>
<ul class="sectlevel2">
<li><a href="#_data_structure">data structure</a></li>
<li><a href="#_interface">interface</a></li>
</ul>
</li>
<li><a href="#_flu">flu</a>
<ul class="sectlevel2">
<li><a href="#_data_structures">data structures</a></li>
<li><a href="#_interface_2">interface</a></li>
</ul>
</li>
<li><a href="#_rbc">rbc</a>
<ul class="sectlevel2">
<li><a href="#_data_structures_2">data structures</a></li>
<li><a href="#_interface_3">interface</a></li>
</ul>
</li>
<li><a href="#_rig">rig</a>
<ul class="sectlevel2">
<li><a href="#_data_structures_3">data structures</a></li>
<li><a href="#_interface_4">interface</a></li>
</ul>
</li>
<li><a href="#_common">common</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Redistribution of quantities across nodes.
Each node has a local coordinate system. The origin is the center of a
"subdomain" of size <code>Sx</code>, <code>Sy</code>, <code>Sz</code>.</p>
</div>
<div class="paragraph">
<p>A quantity is sent to a neighboring rank if its position is outside of
the subdomain.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to redistribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_map">map</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all quantities.</p>
</div>
<div class="sect2">
<h3 id="_data_structure">data structure</h3>
<div class="paragraph">
<p>The structure to map local data from an array to packed data in 27
arrays is implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* [D]istr Map */</span>
<span style="color:#080;font-weight:bold">struct</span> DMap {
    <span style="color:#0a8;font-weight:bold">int</span> *counts;  <span style="color:#777">/* number of entities leaving in each fragment */</span>
    <span style="color:#0a8;font-weight:bold">int</span> *starts;  <span style="color:#777">/* cumulative sum of the above                 */</span>
    <span style="color:#0a8;font-weight:bold">int</span> *ids[<span style="color:#00D">27</span>]; <span style="color:#777">/* indices of leaving objects                  */</span>

    <span style="color:#0a8;font-weight:bold">int</span> *hcounts; <span style="color:#777">/* counts on host (pinned) */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be allocated on device or on host memory (see interface).</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface">interface</h3>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> dmap_ini(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> capacity[], <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_fin(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_reini(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap m);
<span style="color:#088;font-weight:bold">void</span> dmap_download_counts(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_ini_host(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> capacity[], <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_fin_host(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap *m);
<span style="color:#088;font-weight:bold">void</span> dmap_reini_host(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#777">/**/</span> DMap m);
<span style="color:#088;font-weight:bold">void</span> dmap_D2H(<span style="color:#0a8;font-weight:bold">int</span> nfrags, <span style="color:#088;font-weight:bold">const</span> DMap *d, <span style="color:#777">/**/</span> DMap *h);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* exclusive scan */</span>
<span style="color:#080;font-weight:bold">template</span> &lt;<span style="color:#0a8;font-weight:bold">int</span> NCOUNTS&gt;
<span style="color:#088;font-weight:bold">static</span> __global__ <span style="color:#088;font-weight:bold">void</span> dmap_scan(<span style="color:#777">/**/</span> DMap m)              <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#0a8;font-weight:bold">int</span> dmap_get_fid(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">float</span> r[<span style="color:#00D">3</span>])       <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">static</span> __device__ <span style="color:#088;font-weight:bold">void</span> dmap_add(<span style="color:#0a8;font-weight:bold">int</span> pid, <span style="color:#0a8;font-weight:bold">int</span> fid, DMap m)  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>prefix sum on counts to obtain starts</p>
</li>
<li>
<p>get fragment id from position</p>
</li>
<li>
<p>add a quantity to the map</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flu">flu</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribute solvent particles accross nodes.</p>
</div>
<div class="sect2">
<h3 id="_data_structures">data structures</h3>
<div class="paragraph">
<p>Solvent distribution follow the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> DFluPack {
    DMap map;
    dBags dpp, dii, dcc;
    hBags hpp, hii, hcc;
    <span style="color:#0a8;font-weight:bold">int</span> nhalo; <span style="color:#777">/* number of sent particles */</span>
};

<span style="color:#080;font-weight:bold">struct</span> DFluComm {
    Comm *pp, *ii, *cc;
};

<span style="color:#080;font-weight:bold">struct</span> DFluUnpack {
    hBags hpp, hii, hcc;
    Particle *ppre;
    <span style="color:#0a8;font-weight:bold">int</span> *iire, *ccre;
    <span style="color:#0a8;font-weight:bold">int</span> nhalo; <span style="color:#777">/* number of received particles */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>[d,h]xx</code> means quantities on <code>[device,host]</code> and <code>pp</code>
corresponds to particles, <code>cc</code> to colors and <code>ii</code> to global ids.
The <code>xxre</code> variables in <code>Unpack</code> are buffer for remote quantities.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_2">interface</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> dflu_pack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxdensity, DFluPack **p);
<span style="color:#088;font-weight:bold">void</span> dflu_comm_ini(MPI_Comm comm, <span style="color:#777">/**/</span> DFluComm **c);
<span style="color:#088;font-weight:bold">void</span> dflu_unpack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxdensity, DFluUnpack **u);

<span style="color:#088;font-weight:bold">void</span> dflu_pack_fin(DFluPack *p);
<span style="color:#088;font-weight:bold">void</span> dflu_comm_fin(DFluComm *c);
<span style="color:#088;font-weight:bold">void</span> dflu_unpack_fin(DFluUnpack *u);

<span style="color:#777">/* map */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_build_map(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> PartList lp, DFluPack *p);

<span style="color:#777">/* pack */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_pack(<span style="color:#088;font-weight:bold">const</span> FluQuants *q, <span style="color:#777">/**/</span> DFluPack *p);
<span style="color:#088;font-weight:bold">void</span> dflu_download(DFluPack *p, <span style="color:#777">/**/</span> DFluStatus *s);

<span style="color:#777">/* communication */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_post_recv(DFluComm *c, DFluUnpack *u);
<span style="color:#088;font-weight:bold">void</span> dflu_post_send(DFluPack *p, DFluComm   *c);
<span style="color:#088;font-weight:bold">void</span> dflu_wait_recv(DFluComm *c, DFluUnpack *u);
<span style="color:#088;font-weight:bold">void</span> dflu_wait_send(DFluComm *c);

<span style="color:#777">/* unpack */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_unpack(<span style="color:#777">/**/</span> DFluUnpack *u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The map is build from <a href="partlist.html">partlist</a>, allowing the
process to delete particles.</p>
</div>
<div class="paragraph">
<p>The solvent distribution also include cell list generation (see
<a href="clist.html">cell lists</a>).
It is done in two phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>subindices, independant for bulk and remote particles</p>
</li>
<li>
<p>gather, which needs the subindices to be computed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bulk subindices can be computed while comunicating remote particles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/* cell lists */</span>
<span style="color:#088;font-weight:bold">void</span> dflu_bulk(PartList lp, <span style="color:#777">/**/</span> FluQuants *q);
<span style="color:#088;font-weight:bold">void</span> dflu_halo(<span style="color:#088;font-weight:bold">const</span> DFluUnpack *u, <span style="color:#777">/**/</span> FluQuants *q);
<span style="color:#088;font-weight:bold">void</span> dflu_gather(<span style="color:#0a8;font-weight:bold">int</span> ndead, <span style="color:#088;font-weight:bold">const</span> DFluPack *p, <span style="color:#088;font-weight:bold">const</span> DFluUnpack *u, <span style="color:#777">/**/</span> FluQuants *q);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rbc">rbc</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribute red blood cells accross nodes according to the center of
mass of their bounding box (see <a href="algo/minmax.html">minmax</a>).</p>
</div>
<div class="sect2">
<h3 id="_data_structures_2">data structures</h3>
<div class="paragraph">
<p>RBC distribution follows the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#080;font-weight:bold">struct</span> DRbcPack {
    DMap map;
    float3 *minext, *maxext;
    dBags dpp;
    hBags hpp;

    <span style="color:#777">/* optional: ids */</span>
    DMap hmap;
    hBags hii;
};

<span style="color:#080;font-weight:bold">struct</span> DRbcComm {
    <span style="color:#777">/* optional: ids */</span>
    Comm *pp, *ii;
};

<span style="color:#080;font-weight:bold">struct</span> DRbcUnpack {
    hBags hpp;

    <span style="color:#777">/* optional: ids */</span>
    hBags hii;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>minext</code> and <code>maxext</code> contain the bounding box informations of
each RBC. Other variables have the same naming conventions than <code>distr::flu</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_3">interface</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> drbc_pack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxc, <span style="color:#0a8;font-weight:bold">int</span> nv, DRbcPack **p);
<span style="color:#088;font-weight:bold">void</span> drbc_comm_ini(MPI_Comm comm, <span style="color:#777">/**/</span> DRbcComm **c);
<span style="color:#088;font-weight:bold">void</span> drbc_unpack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxc, <span style="color:#0a8;font-weight:bold">int</span> nv, DRbcUnpack **u);

<span style="color:#088;font-weight:bold">void</span> drbc_pack_fin(DRbcPack *p);
<span style="color:#088;font-weight:bold">void</span> drbc_comm_fin(DRbcComm *c);
<span style="color:#088;font-weight:bold">void</span> drbc_unpack_fin(DRbcUnpack *u);

<span style="color:#088;font-weight:bold">void</span> drbc_build_map(<span style="color:#0a8;font-weight:bold">int</span> nc, <span style="color:#0a8;font-weight:bold">int</span> nv, <span style="color:#088;font-weight:bold">const</span> Particle *pp, DRbcPack *p);
<span style="color:#088;font-weight:bold">void</span> drbc_pack(<span style="color:#088;font-weight:bold">const</span> RbcQuants *q, <span style="color:#777">/**/</span> DRbcPack *p);
<span style="color:#088;font-weight:bold">void</span> drbc_download(DRbcPack *p);

<span style="color:#088;font-weight:bold">void</span> drbc_post_recv(DRbcComm *c, DRbcUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drbc_post_send(DRbcPack *p, DRbcComm *c);
<span style="color:#088;font-weight:bold">void</span> drbc_wait_recv(DRbcComm *c, DRbcUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drbc_wait_send(DRbcComm *c);

<span style="color:#088;font-weight:bold">void</span> drbc_unpack_bulk(<span style="color:#088;font-weight:bold">const</span> DRbcPack *p, <span style="color:#777">/**/</span> RbcQuants *q);
<span style="color:#088;font-weight:bold">void</span> drbc_unpack_halo(<span style="color:#088;font-weight:bold">const</span> DRbcUnpack *u, <span style="color:#777">/**/</span> RbcQuants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rig">rig</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribute rigid objects accross nodes according to their center of
mass.</p>
</div>
<div class="sect2">
<h3 id="_data_structures_3">data structures</h3>
<div class="paragraph">
<p>Rigid bodies distribution is very similar to the above. The <em>hidden</em> data
structures fit again in the general workflow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#777">/*
 ipp: particles of the mesh
 ss:  &quot;Solid&quot; structures
*/</span>

<span style="color:#080;font-weight:bold">struct</span> DRigPack {
    DMap map;
    dBags dipp, dss;
    hBags hipp, hss;
};

<span style="color:#080;font-weight:bold">struct</span> DRigComm {
    Comm *ipp, *ss;
};

<span style="color:#080;font-weight:bold">struct</span> DRigUnpack {
    hBags hipp, hss;
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_4">interface</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> drig_pack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxns, <span style="color:#0a8;font-weight:bold">int</span> nv, DRigPack **p);
<span style="color:#088;font-weight:bold">void</span> drig_comm_ini(MPI_Comm comm, <span style="color:#777">/**/</span> DRigComm **c);
<span style="color:#088;font-weight:bold">void</span> drig_unpack_ini(<span style="color:#0a8;font-weight:bold">int</span> maxns, <span style="color:#0a8;font-weight:bold">int</span> nv, DRigUnpack **u);

<span style="color:#088;font-weight:bold">void</span> drig_pack_fin(DRigPack *p);
<span style="color:#088;font-weight:bold">void</span> drig_comm_fin(DRigComm *c);
<span style="color:#088;font-weight:bold">void</span> drig_unpack_fin(DRigUnpack *u);

<span style="color:#088;font-weight:bold">void</span> drig_build_map(<span style="color:#0a8;font-weight:bold">int</span> ns, <span style="color:#088;font-weight:bold">const</span> Solid *ss, <span style="color:#777">/**/</span> DRigPack *p);
<span style="color:#088;font-weight:bold">void</span> drig_pack(<span style="color:#0a8;font-weight:bold">int</span> ns, <span style="color:#0a8;font-weight:bold">int</span> nv, <span style="color:#088;font-weight:bold">const</span> Solid *ss, <span style="color:#088;font-weight:bold">const</span> Particle *ipp, <span style="color:#777">/**/</span> DRigPack *p);
<span style="color:#088;font-weight:bold">void</span> drig_download(DRigPack *p);

<span style="color:#088;font-weight:bold">void</span> drig_post_recv(DRigComm *c, DRigUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drig_post_send(DRigPack *p, DRigComm *c);
<span style="color:#088;font-weight:bold">void</span> drig_wait_recv(DRigComm *c, DRigUnpack *u);
<span style="color:#088;font-weight:bold">void</span> drig_wait_send(DRigComm *c);

<span style="color:#088;font-weight:bold">using</span> <span style="color:#080;font-weight:bold">namespace</span> rig;
<span style="color:#088;font-weight:bold">void</span> drig_unpack_bulk(<span style="color:#088;font-weight:bold">const</span> DRigPack *p, <span style="color:#777">/**/</span> rig::Quants *q);
<span style="color:#088;font-weight:bold">void</span> drig_unpack_halo(<span style="color:#088;font-weight:bold">const</span> DRigUnpack *u, <span style="color:#777">/**/</span> rig::Quants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common">common</h2>
<div class="sectionbody">
<div class="paragraph">
<p>helpers: common kernels</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span style="color:#088;font-weight:bold">void</span> dcommon_pack_pp_packets(<span style="color:#0a8;font-weight:bold">int</span> nc, <span style="color:#0a8;font-weight:bold">int</span> nv, <span style="color:#088;font-weight:bold">const</span> Particle *pp, DMap m, <span style="color:#777">/**/</span> Sarray&lt;Particle*, <span style="color:#00D">27</span>&gt; buf); <b class="conum">(1)</b>
<span style="color:#088;font-weight:bold">void</span> dcommon_shift_one_frag(<span style="color:#0a8;font-weight:bold">int</span> n, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">int</span> fid, <span style="color:#777">/**/</span> Particle *pp); <b class="conum">(2)</b>
<span style="color:#088;font-weight:bold">void</span> dcommon_shift_halo(<span style="color:#0a8;font-weight:bold">int</span> nhalo, <span style="color:#088;font-weight:bold">const</span> Sarray&lt;<span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#00D">27</span>&gt; starts, <span style="color:#777">/**/</span> Particle *pp); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>pack <code>nc</code>  packets of <code>nv</code> particles into 27 buffers <code>buf</code> according to map</p>
</li>
<li>
<p>shift particles in the fragment direction</p>
</li>
<li>
<p>shift all particles according to the fragment direction</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</body>
</html>