<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>distr</title>
<link rel="stylesheet" href="/udoc/css/main.css">
<link rel="stylesheet" href="./pygments-colorful.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>distr</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_map">1. map</a>
<ul class="sectlevel2">
<li><a href="#_data_structure">1.1. data structure</a></li>
<li><a href="#_interface">1.2. interface</a></li>
</ul>
</li>
<li><a href="#_flu">2. flu</a>
<ul class="sectlevel2">
<li><a href="#_data_structures">2.1. data structures</a></li>
<li><a href="#_interface_2">2.2. interface</a></li>
</ul>
</li>
<li><a href="#_rbc">3. rbc</a>
<ul class="sectlevel2">
<li><a href="#_data_structures_2">3.1. data structures</a></li>
<li><a href="#_interface_3">3.2. interface</a></li>
</ul>
</li>
<li><a href="#_rig">4. rig</a>
<ul class="sectlevel2">
<li><a href="#_data_structures_3">4.1. data structures</a></li>
<li><a href="#_interface_4">4.2. interface</a></li>
</ul>
</li>
<li><a href="#_common">5. common</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Redistribution of quantities across nodes.
Each node has a local coordinate system. The origin is the center of a
"subdomain" of size <code>Sx</code>, <code>Sy</code>, <code>Sz</code>.</p>
</div>
<div class="paragraph">
<p>A quantity is sent to a neighboring rank if its position is outside of
the subdomain.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to redistribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_map">1. map</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all quantities.</p>
</div>
<div class="sect2">
<h3 id="_data_structure">1.1. data structure</h3>
<div class="paragraph">
<p>The structure to map local data from an array to packed data in 27
arrays is implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* [D]istr Map */</span>
<span class="tok-k">struct</span> <span class="tok-n">DMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span>  <span class="tok-cm">/* number of entities leaving in each fragment */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">;</span>  <span class="tok-cm">/* cumulative sum of the above                 */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">ids</span><span class="tok-p">[</span><span class="tok-mi">27</span><span class="tok-p">];</span> <span class="tok-cm">/* indices of leaving objects                  */</span>

    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hcounts</span><span class="tok-p">;</span> <span class="tok-cm">/* counts on host (pinned) */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be allocated on device or on host memory (see interface).</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface">1.2. interface</h3>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dmap_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_fin</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_reini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_download_counts</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_ini_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_fin_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_reini_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_D2H</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">h</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* exclusive scan */</span>
<span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">NCOUNTS</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__global__</span> <span class="tok-kt">void</span> <span class="tok-n">dmap_scan</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">)</span>              <b class="conum">(1)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">dmap_get_fid</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">])</span>       <b class="conum">(2)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">dmap_add</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">pid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">)</span>  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>prefix sum on counts to obtain starts</p>
</li>
<li>
<p>get fragment id from position</p>
</li>
<li>
<p>add a quantity to the map</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flu">2. flu</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribute solvent particles accross nodes.</p>
</div>
<div class="sect2">
<h3 id="_data_structures">2.1. data structures</h3>
<div class="paragraph">
<p>Solvent distribution follow the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">DFluPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dpp</span><span class="tok-p">,</span> <span class="tok-n">dii</span><span class="tok-p">,</span> <span class="tok-n">dcc</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">,</span> <span class="tok-n">hii</span><span class="tok-p">,</span> <span class="tok-n">hcc</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">;</span> <span class="tok-cm">/* number of sent particles */</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluComm</span> <span class="tok-p">{</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">,</span> <span class="tok-n">hii</span><span class="tok-p">,</span> <span class="tok-n">hcc</span><span class="tok-p">;</span>
    <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppre</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iire</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ccre</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">;</span> <span class="tok-cm">/* number of received particles */</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>[d,h]xx</code> means quantities on <code>[device,host]</code> and <code>pp</code>
corresponds to particles, <code>cc</code> to colors and <code>ii</code> to global ids.
The <code>xxre</code> variables in <code>Unpack</code> are buffer for remote quantities.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_2">2.2. interface</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dflu_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxdensity</span><span class="tok-p">,</span> <span class="tok-n">DFluPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxdensity</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">dflu_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-cm">/* map */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-cm">/* pack */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_download</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluStatus</span> <span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">);</span>

<span class="tok-cm">/* communication */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_post_recv</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_post_send</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DFluComm</span>   <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_wait_send</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-cm">/* unpack */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The map is build from <a href="partlist.html">partlist</a>, allowing the
process to delete particles.</p>
</div>
<div class="paragraph">
<p>The solvent distribution also include cell list generation (see
<a href="clist.html">cell lists</a>).
It is done in two phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>subindices, independant for bulk and remote particles</p>
</li>
<li>
<p>gather, which needs the subindices to be computed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bulk subindices can be computed while comunicating remote particles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* cell lists */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_bulk</span><span class="tok-p">(</span><span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_gather</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ndead</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rbc">3. rbc</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribute red blood cells accross nodes according to the center of
mass of their bounding box (see <a href="algo/minmax.html">minmax</a>).</p>
</div>
<div class="sect2">
<h3 id="_data_structures_2">3.1. data structures</h3>
<div class="paragraph">
<p>RBC distribution follows the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">DRbcPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">minext</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">maxext</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dpp</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">;</span>

    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-n">DMap</span> <span class="tok-n">hmap</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hii</span><span class="tok-p">;</span>

    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRbcComm</span> <span class="tok-p">{</span>
    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">;</span>

    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hii</span><span class="tok-p">;</span>

    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>minext</code> and <code>maxext</code> contain the bounding box informations of
each RBC. Other variables have the same naming conventions than <code>distr::flu</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_3">3.2. interface</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">drbc_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRbcComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_download</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_post_recv</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_post_send</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_wait_send</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rig">4. rig</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribute rigid objects accross nodes according to their center of
mass.</p>
</div>
<div class="sect2">
<h3 id="_data_structures_3">4.1. data structures</h3>
<div class="paragraph">
<p>Rigid bodies distribution is very similar to the above. The <em>hidden</em> data
structures fit again in the general workflow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/*</span>
<span class="tok-cm"> ipp: particles of the mesh</span>
<span class="tok-cm"> ss:  &quot;Solid&quot; structures</span>
<span class="tok-cm">*/</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dipp</span><span class="tok-p">,</span> <span class="tok-n">dss</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hipp</span><span class="tok-p">,</span> <span class="tok-n">hss</span><span class="tok-p">;</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span>  <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigComm</span> <span class="tok-p">{</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">ipp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hipp</span><span class="tok-p">,</span> <span class="tok-n">hss</span><span class="tok-p">;</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span>  <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_4">4.2. interface</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">drig_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRigPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_pack</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ipp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_download</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_post_recv</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_post_send</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_wait_send</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common">5. common</h2>
<div class="sectionbody">
<div class="paragraph">
<p>helpers: common kernels</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dcommon_pack_pp_packets</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Sarray</span><span class="tok-o">&lt;</span><span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-mi">27</span><span class="tok-o">&gt;</span> <span class="tok-n">buf</span><span class="tok-p">);</span> <b class="conum">(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dcommon_shift_one_frag</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dcommon_shift_halo</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Sarray</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-p">,</span> <span class="tok-mi">27</span><span class="tok-o">&gt;</span> <span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>pack <code>nc</code>  packets of <code>nv</code> particles into 27 buffers <code>buf</code> according to map</p>
</li>
<li>
<p>shift particles in the fragment direction</p>
</li>
<li>
<p>shift all particles according to the fragment direction</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</body>
</html>