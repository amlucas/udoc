<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>uDeviceX Developer Documentaion</title>
<link rel="stylesheet" href="/udoc/css/main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<link rel="stylesheet" href="./pygments-colorful.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1><em>uDeviceX</em> Developer Documentaion</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_build">1. build</a>
<ul class="sectlevel2">
<li><a href="#_verbosity">1.1. verbosity</a></li>
<li><a href="#_arch_linux">1.2. Arch Linux</a></li>
<li><a href="#_dependencies">1.3. dependencies</a></li>
</ul>
</li>
<li><a href="#_coding_conventions">2. coding conventions</a>
<ul class="sectlevel2">
<li><a href="#_modules">2.1. modules</a></li>
<li><a href="#_naming">2.2. naming</a></li>
<li><a href="#_file_structure">2.3. file structure</a></li>
<li><a href="#_style">2.4. style</a></li>
</ul>
</li>
<li><a href="#_documentation">3. Documentation</a>
<ul class="sectlevel2">
<li><a href="#_installation">3.1. installation</a></li>
<li><a href="#_build_2">3.2. build</a></li>
<li><a href="#_deploy">3.3. Deploy</a></li>
</ul>
</li>
<li><a href="#_gource_commands">4. gource commands</a></li>
<li><a href="#_mesh_edge_data">5. mesh edge data</a></li>
<li><a href="#_minmax">6. minmax</a>
<ul class="sectlevel2">
<li><a href="#_example">6.1. example</a></li>
<li><a href="#_interface">6.2. interface</a></li>
</ul>
</li>
<li><a href="#_scan">7. scan</a>
<ul class="sectlevel2">
<li><a href="#_interface_2">7.1. interface</a></li>
</ul>
</li>
<li><a href="#_kahan_summation">8. Kahan summation</a></li>
<li><a href="#_body_forces">9. body forces</a>
<ul class="sectlevel2">
<li><a href="#_data_structures">9.1. data structures</a></li>
<li><a href="#_interface_3">9.2. interface</a></li>
<li><a href="#_configuration">9.3. configuration</a></li>
</ul>
</li>
<li><a href="#_clist">10. clist</a>
<ul class="sectlevel2">
<li><a href="#_example_2">10.1. example</a></li>
<li><a href="#_data_structures_2">10.2. data structures</a></li>
<li><a href="#_interface_4">10.3. interface</a></li>
<li><a href="#_algorithm">10.4. algorithm</a></li>
</ul>
</li>
<li><a href="#_cnt">11. cnt</a>
<ul class="sectlevel2">
<li><a href="#_interface_5">11.1. interface</a></li>
</ul>
</li>
<li><a href="#_color">12. color</a>
<ul class="sectlevel2">
<li><a href="#_purpose">12.1. purpose</a></li>
<li><a href="#_modules_2">12.2. modules</a></li>
</ul>
</li>
<li><a href="#_comm">13. comm</a>
<ul class="sectlevel2">
<li><a href="#_purpose_2">13.1. purpose</a></li>
<li><a href="#_data_structures_3">13.2. data structures</a></li>
<li><a href="#_allocation_mod">13.3. allocation mod</a></li>
<li><a href="#_interface_6">13.4. interface</a></li>
</ul>
</li>
<li><a href="#_control">14. Control</a>
<ul class="sectlevel2">
<li><a href="#_velocity_controller">14.1. Velocity controller</a></li>
<li><a href="#_inflow">14.2. Inflow</a></li>
<li><a href="#_outflow">14.3. Outflow</a></li>
<li><a href="#_density_controller">14.4. Density controller</a></li>
</ul>
</li>
<li><a href="#_coords">15. coords</a>
<ul class="sectlevel2">
<li><a href="#_data_structures_4">15.1. data structures</a></li>
<li><a href="#_host_interface">15.2. Host interface</a></li>
<li><a href="#_configuration_5">15.3. Configuration</a></li>
</ul>
</li>
<li><a href="#_generic_d_evice_api">16. generic [d]evice API</a></li>
<li><a href="#_debug">17. debug</a>
<ul class="sectlevel2">
<li><a href="#_interface_10">17.1. interface</a></li>
<li><a href="#_configuration_6">17.2. configuration</a></li>
</ul>
</li>
<li><a href="#_distr">18. distr</a>
<ul class="sectlevel2">
<li><a href="#_map_2">18.1. map</a></li>
<li><a href="#_flu">18.2. flu</a></li>
<li><a href="#_rbc">18.3. rbc</a></li>
<li><a href="#_rig">18.4. rig</a></li>
<li><a href="#_common">18.5. common</a></li>
</ul>
</li>
<li><a href="#_exch">19. exch</a>
<ul class="sectlevel2">
<li><a href="#_map_3">19.1. map</a></li>
<li><a href="#_flu_2">19.2. flu</a></li>
<li><a href="#_obj">19.3. obj</a></li>
<li><a href="#_mesh">19.4. mesh</a></li>
<li><a href="#_common_2">19.5. common</a></li>
</ul>
</li>
<li><a href="#_fluforces">20. fluforces</a>
<ul class="sectlevel2">
<li><a href="#_interface_17">20.1. interface</a></li>
<li><a href="#_data_structures_8">20.2. data structures</a></li>
<li><a href="#_submodules">20.3. submodules</a></li>
</ul>
</li>
<li><a href="#_frag">21. frag</a>
<ul class="sectlevel2">
<li><a href="#_purpose_3">21.1. purpose</a></li>
<li><a href="#_interface_18">21.2. interface</a></li>
</ul>
</li>
<li><a href="#_fsi">22. fsi</a>
<ul class="sectlevel2">
<li><a href="#_interface_19">22.1. interface</a></li>
</ul>
</li>
<li><a href="#_io">23. IO</a>
<ul class="sectlevel2">
<li><a href="#_text">23.1. Text</a></li>
<li><a href="#_mesh_2">23.2. Mesh</a></li>
<li><a href="#_diagnostics">23.3. Diagnostics</a></li>
<li><a href="#_point">23.4. Point</a></li>
</ul>
</li>
<li><a href="#_math">24. Math</a>
<ul class="sectlevel2">
<li><a href="#_linal">24.1. linal</a></li>
<li><a href="#_host_random_number_generation">24.2. Host random number generation</a></li>
<li><a href="#_linar_coordinate_transformation_for_3d_vector">24.3. linar coordinate transformation for 3D vector</a></li>
<li><a href="#_functions_for_a_triangle">24.4. functions for a triangle</a></li>
</ul>
</li>
<li><a href="#_scheme_move">25. scheme/move</a>
<ul class="sectlevel2">
<li><a href="#_interface_21">25.1. interface</a></li>
</ul>
</li>
<li><a href="#_pair">26. pair</a>
<ul class="sectlevel2">
<li><a href="#_dpd_interactions">26.1. dpd interactions</a></li>
<li><a href="#_repulsive_lj">26.2. repulsive LJ</a></li>
<li><a href="#_host_interface_2">26.3. Host interface</a></li>
<li><a href="#_device_interface">26.4. device interface</a></li>
<li><a href="#_configuration_7">26.5. Configuration</a></li>
</ul>
</li>
<li><a href="#_parray">27. parray</a>
<ul class="sectlevel2">
<li><a href="#_host_interface_3">27.1. host interface</a></li>
<li><a href="#_device_interface_2">27.2. device interface</a></li>
</ul>
</li>
<li><a href="#_farray">28. farray</a>
<ul class="sectlevel2">
<li><a href="#_host_interface_4">28.1. host interface</a></li>
<li><a href="#_device_interface_3">28.2. device interface</a></li>
</ul>
</li>
<li><a href="#_configuration_file_reader">29. configuration file reader</a>
<ul class="sectlevel2">
<li><a href="#_purpose_4">29.1. purpose</a></li>
<li><a href="#_data_structure_3">29.2. data structure</a></li>
<li><a href="#_interface_22">29.3. interface</a></li>
</ul>
</li>
<li><a href="#_partlist">30. partlist</a>
<ul class="sectlevel2">
<li><a href="#_data_structure_4">30.1. data structure</a></li>
<li><a href="#_interface_23">30.2. interface</a></li>
</ul>
</li>
<li><a href="#_triangles">31. Triangles</a></li>
<li><a href="#_compute_volume_of_a_mesh">32. compute volume of a mesh</a></li>
<li><a href="#_compute_volume_of_a_mesh_2">33. compute volume of a mesh</a></li>
<li><a href="#_compute_volume_of_a_mesh_3">34. compute volume of a mesh</a></li>
<li><a href="#_positions">35. Positions</a></li>
<li><a href="#_meshbb">36. meshbb</a>
<ul class="sectlevel2">
<li><a href="#_interface_24">36.1. interface</a></li>
</ul>
</li>
<li><a href="#_affine_transformation_matrices">37. affine transformation matrices</a></li>
<li><a href="#_mesh_adjacency_structure">38. mesh adjacency structure</a></li>
<li><a href="#_rbc_center_of_mass">39. RBC center of mass</a></li>
<li><a href="#_rbc_area_and_volume">40. RBC area and volume</a></li>
<li><a href="#_elastic_energies">41. Elastic energies</a>
<ul class="sectlevel2">
<li><a href="#_spring">41.1. spring</a></li>
<li><a href="#_local_area_constrain">41.2. local area constrain</a></li>
<li><a href="#_total_area_constrain">41.3. total area constrain</a></li>
<li><a href="#_total_volume_constrain">41.4. total volume constrain</a></li>
<li><a href="#_bending">41.5. bending</a></li>
</ul>
</li>
<li><a href="#_forces">42. Forces</a>
<ul class="sectlevel2">
<li><a href="#_spring_2">42.1. spring</a></li>
<li><a href="#_other_forces_todo">42.2. Other forces (TODO)</a></li>
</ul>
</li>
<li><a href="#_red_blood_cell">43. Red blood cell</a>
<ul class="sectlevel2">
<li><a href="#_components">43.1. components</a></li>
<li><a href="#_cell_templates">43.2. cell templates</a></li>
</ul>
</li>
<li><a href="#_random_force">44. random force</a></li>
<li><a href="#_shape_rbc">45. shape RBC</a></li>
<li><a href="#_stretch_rbc">46. stretch RBC</a></li>
<li><a href="#_scheme_restrain">47. scheme/restrain</a>
<ul class="sectlevel2">
<li><a href="#_interface_25">47.1. interface</a></li>
<li><a href="#_configuration_8">47.2. configuration</a></li>
</ul>
</li>
<li><a href="#_rigid">48. Rigid</a>
<ul class="sectlevel2">
<li><a href="#_quantities">48.1. Quantities</a></li>
<li><a href="#_update">48.2. update</a></li>
</ul>
</li>
<li><a href="#_signed_distance_function_sdf">49. signed distance function (sdf)</a>
<ul class="sectlevel2">
<li><a href="#_purpose_5">49.1. purpose</a></li>
<li><a href="#_implementation">49.2. implementation</a></li>
<li><a href="#_components_2">49.3. components</a></li>
</ul>
</li>
<li><a href="#_time">50. Time</a></li>
<li><a href="#_time_step">51. Time step</a></li>
<li><a href="#_utils">52. Utils</a>
<ul class="sectlevel2">
<li><a href="#_error">52.1. error</a></li>
<li><a href="#_cc">52.2. cc</a></li>
<li><a href="#_mc">52.3. mc</a></li>
<li><a href="#_kernel_launch_macros">52.4. kernel launch macros</a></li>
</ul>
</li>
<li><a href="#_wvel">53. wvel</a>
<ul class="sectlevel2">
<li><a href="#_purpose_6">53.1. purpose</a></li>
<li><a href="#_data_structures_9">53.2. data structures</a></li>
<li><a href="#_interface_28">53.3. interface</a></li>
<li><a href="#_configuration_9">53.4. Configuration</a></li>
</ul>
</li>
<li><a href="#_third_party_dependencies">54. third party dependencies</a>
<ul class="sectlevel2">
<li><a href="#_cuda_compiler">54.1. cuda compiler</a></li>
<li><a href="#_mpi_library">54.2. MPI library</a></li>
<li><a href="#_libconfig">54.3. libconfig</a></li>
<li><a href="#_hdf5">54.4. hdf5</a></li>
<li><a href="#_bop">54.5. bop</a></li>
</ul>
</li>
<li><a href="#wrappers">55. wrappers</a>
<ul class="sectlevel2">
<li><a href="#intro">55.1. intro</a></li>
<li><a href="#mem">55.2. MEM</a></li>
<li><a href="#val">55.3. VAL</a></li>
<li><a href="#prof">55.4. PROF</a></li>
<li><a href="#tim">55.5. TIM</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_build">1. build</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>uDeviceX</code> uses a wrapper <code>u.make</code> for building the source.
This allows to load modules when needed.</p>
</div>
<div class="sect2">
<h3 id="_verbosity">1.1. verbosity</h3>
<div class="paragraph">
<p>The verbosity can be controlled during the compilation process:</p>
</div>
<div class="paragraph">
<p>Shows full compilation and linking commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>u.make <span class="tok-nv">LOG</span><span class="tok-o">=</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Profile compilation time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>u.make <span class="tok-nv">LOG</span><span class="tok-o">=</span><span class="tok-s1">&#39;@time -f &quot;%e $&lt;&quot;&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hide compilation messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>u.make <span class="tok-nv">LOG</span><span class="tok-o">=</span>@</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_arch_linux">1.2. Arch Linux</h3>
<div class="listingblock">
<div class="content">
<pre>u.make MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>MAKEFLAGS="MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64" \
				u.test test/compile</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dependencies">1.3. dependencies</h3>
<div class="paragraph">
<p>Dependencies must be generated after adding a file or changing includes.
Run from <code>src/</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>../tools/deps</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coding_conventions">2. coding conventions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_modules">2.1. modules</h3>
<div class="paragraph">
<p><em>uDeviceX</em> consists of modules.
Modules are as independant as possible.
They consist of a folder with one or more compilation units, and an
interface.
Whenever it is possible, the structures are hidden from the client of
the module.</p>
</div>
</div>
<div class="sect2">
<h3 id="_naming">2.2. naming</h3>
<div class="sect3">
<h4 id="_variables">2.2.1. variables</h4>
<div class="ulist">
<ul>
<li>
<p>names of local variables are short and understandable from the context</p>
</li>
<li>
<p>names of global variables are as descriptive as possible</p>
</li>
<li>
<p>arrays of simple structures <code>x</code> have names <code>xx</code>, eg. <code>pp</code> is an
array of particles, <code>cc</code> is an array of colors, <code>ii</code> is an array of
indices * array of small dimentionality may use an enum type for
readability, e.g.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span><span class="tok-n">X</span><span class="tok-p">,</span> <span class="tok-n">Y</span><span class="tok-p">,</span> <span class="tok-n">Z</span><span class="tok-p">};</span>
<span class="tok-kt">int</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">];</span>
<span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">X</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">rx</span><span class="tok-p">;</span>
<span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">Y</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">ry</span><span class="tok-p">;</span>
<span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">Z</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">rz</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functions">2.2.2. functions</h4>
<div class="ulist">
<ul>
<li>
<p>a function name is descriptive on its own or inside a module.</p>
</li>
<li>
<p>arguments are ordered as follow:</p>
<div class="ulist">
<ul>
<li>
<p>input is at the beginning</p>
</li>
<li>
<p>input/output come after input and start with a commented <code>io</code></p>
</li>
<li>
<p>output comes after input/output and start with a comment or <code>o</code> depending on the context</p>
</li>
<li>
<p>sizes have higher priority than arrays</p>
</li>
<li>
<p>workspace comes at the end ans starts with a commented <code>w</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>do <strong>not</strong> use references, use pointers instead</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example of valid function declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">read_int_from_file</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">fname</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">forward_euler</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-cm">/* io */</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Function names part of a module interface start with the module name.
Functions private to a module do not need to contain the module name
if the context make it clear. Use the <code>static</code> qualifier for functions
with compilation-unit scope.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_structure">2.3. file structure</h3>
<div class="ulist">
<ul>
<li>
<p>no include guards; no "headers in headers" if easily avoidable</p>
</li>
<li>
<p>all cuda kernels are in a separate header <code>.h</code> file</p>
</li>
<li>
<p>a module is implemented inside its own directory <code>A</code></p>
<div class="ulist">
<ul>
<li>
<p>it has its own object <code>A/imp.cu</code> or <code>A/imp.cpp</code> (<code>.cpp</code> prefered if possible)</p>
</li>
<li>
<p>interface <code>A/imp.h</code></p>
</li>
<li>
<p>implementation can be done in separate files inside <code>A/imp/</code> directory</p>
</li>
<li>
<p>internal cuda (private to module) code are inside <code>A/dev/</code> directory</p>
</li>
<li>
<p>cuda interface inside <code>A/dev.h</code> (for client use)</p>
</li>
</ul>
</div>
</li>
<li>
<p>modules can have submodules, which follow the same structure as above, e.g. submodule <code>B</code> inside module <code>A</code> belongs to <code>A/B/</code> directory</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_style">2.4. style</h3>
<div class="paragraph">
<p>for emacs: the following c++ mode is used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><span></span><span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">u/c-indent-common</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-k">setq</span> <span class="tok-nv">c-basic-offset</span> <span class="tok-mi">4</span>
	<span class="tok-nv">indent-tabs-mode</span> <span class="tok-no">nil</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">u/c++-indent</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-nv">u/c-indent-common</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">c-set-offset</span> <span class="tok-ss">&#39;innamespace</span> <span class="tok-nv">[0]</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">u/c-indent</span> <span class="tok-p">()</span> <span class="tok-p">(</span><span class="tok-nv">u/c-indent-common</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nv">add-hook</span> <span class="tok-ss">&#39;c-mode-hook</span>   <span class="tok-ss">&#39;u/c-indent</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-nv">add-hook</span> <span class="tok-ss">&#39;c++-mode-hook</span> <span class="tok-ss">&#39;u/c++-indent</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">setq</span> <span class="tok-nv">c-default-style</span>
      <span class="tok-o">&#39;</span><span class="tok-p">((</span><span class="tok-nv">java-mode</span> <span class="tok-o">.</span> <span class="tok-s">&quot;java&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">awk-mode</span>  <span class="tok-o">.</span> <span class="tok-s">&quot;awk&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">c-mode</span>    <span class="tok-o">.</span> <span class="tok-s">&quot;k&amp;r&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">cc-mode</span>   <span class="tok-o">.</span> <span class="tok-s">&quot;k&amp;r&quot;</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nv">add-to-list</span> <span class="tok-ss">&#39;auto-mode-alist</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;\\.cu\\&#39;&quot;</span> <span class="tok-o">.</span> <span class="tok-nv">c++-mode</span><span class="tok-p">))</span>
<span class="tok-p">(</span><span class="tok-nv">add-to-list</span> <span class="tok-ss">&#39;auto-mode-alist</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;\\.h\\&#39;&quot;</span>  <span class="tok-o">.</span> <span class="tok-nv">c++-mode</span><span class="tok-p">))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_documentation">3. Documentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>uDeviceX</code> documentation is written in <code>Asciidoc</code> format and converted to <code>html</code>.
This operation requires <a href="https://asciidoctor.org/">asciidoctor</a> (converter to html) and
<a href="http://pygments.org/">pygments.rb</a> (for code highlighting).</p>
</div>
<div class="sect2">
<h3 id="_installation">3.1. installation</h3>
<div class="sect3">
<h4 id="_mac_os_x">3.1.1. Mac OS X</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>gem install asciidoctor
gem install pygments.rb</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arch_linux_2">3.1.2. Arch linux</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>sudo pacman -S asciidoctor
gem install pygments.rb</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_2">3.2. build</h3>
<div class="paragraph">
<p>When writing documentation, it is useful to build it and view it on a
local server.</p>
</div>
<div class="paragraph">
<p>From <code>doc/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>./tools/start <i class="conum" data-value="1"></i><b>(1)</b>
./tools/view  <i class="conum" data-value="2"></i><b>(2)</b>
./tools/stop  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>start a local server (to be done only once)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>open the main page in browser from local server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>stop the local server</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>./configure <i class="conum" data-value="1"></i><b>(1)</b>
make -j     <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>make dependencies (to be run after adding a file to documentation)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>build documentation for local server</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deploy">3.3. Deploy</h3>
<div class="paragraph">
<p>The deploy command cleans, builds and pushes the documentation on
github pages <a href="https://github.com/amlucas/udoc" class="bare">https://github.com/amlucas/udoc</a>.
The commit message on the udoc repository points on the current
<code>uDeviceX</code> commit. It is preferable to have a clean local repository
before deploying:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>git clean -xdf
./tools/deploy</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gource_commands">4. gource commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Display git history of <em>uDeviceX</em> as animated tree.</p>
</div>
<div class="paragraph">
<p>Dump</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nv">o</span><span class="tok-o">=</span>g.ppm
gource -s <span class="tok-m">0</span>.1 --file-filter <span class="tok-s1">&#39;test_data/&#39;</span> <span class="tok-se">\</span>
	      --file-filter <span class="tok-s1">&#39;poc/&#39;</span>  <span class="tok-se">\</span>
	      --file-filter <span class="tok-s1">&#39;tcdf/&#39;</span> <span class="tok-se">\</span>
	      --file-filter <span class="tok-s1">&#39;cmd/&#39;</span>  <span class="tok-se">\</span>
	      --highlight-users   <span class="tok-se">\</span>
	      --highlight-colour FFFFFF <span class="tok-se">\</span>
	      --date-format <span class="tok-s1">&#39;%d %b %Y&#39;</span> -o <span class="tok-nv">$o</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert to mp4</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span><span class="tok-nv">i</span><span class="tok-o">=</span>g.ppm
<span class="tok-nv">o</span><span class="tok-o">=</span>g.mp4
ffmpeg -y -r <span class="tok-m">60</span> -f image2pipe -vcodec ppm -i <span class="tok-nv">$i</span> -vcodec libx264 <span class="tok-se">\</span>
    -preset ultrafast -pix_fmt yuv420p -crf <span class="tok-m">1</span> -threads <span class="tok-m">0</span> -bf <span class="tok-m">0</span> <span class="tok-nv">$o</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>$ ffmpeg -version
ffmpeg version <span class="tok-m">2</span>.8.11-0ubuntu0.16.04.1 Copyright <span class="tok-o">(</span>c<span class="tok-o">)</span> <span class="tok-m">2000</span>-2017 the FFmpeg developers</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="http://gource.io" class="bare">http://gource.io</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mesh_edge_data">5. mesh edge data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Set and get <code>val</code> on edges of the mesh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">edg_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">md</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span>                     <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hx</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">edg_set</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">md</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">val</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hx</span><span class="tok-p">,</span>       <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hy</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">int</span>  <span class="tok-nf">edg_get</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">md</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">j</span><span class="tok-p">,</span>         <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hx</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hy</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">int</span>  <span class="tok-nf">edg_valid</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">md</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">j</span><span class="tok-p">,</span>         <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hx</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-c1">// end::interface</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>set <code>val</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>get <code>val</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>md</code> is a maximum degree, <code>nv</code> number of vertices, <code>h[xy]</code> storage of
size <code>nv*md</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_minmax">6. minmax</h2>
<div class="sectionbody">
<div class="paragraph">
<p>compute extends of chunks of particles</p>
</div>
<div class="ulist">
<ul>
<li>
<p>input is an array of particles, the number of chunks and the number of particles per chunk.</p>
</li>
<li>
<p>output is the bounding box in for each chunk of particles.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_example">6.1. example</h3>
<div class="paragraph">
<p>Consider the simple case on 1D:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:
	particles positions:
	0.1 0.5 0.2   0.3 1.2 1.0
	number of chunks: 2
	number of particles per chunk: 3

output:
	min:
	0.1 0.3
	max:
	0.5 1.0</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface">6.2. interface</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">minmax</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-k">const</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">no</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">min</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">max</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scan">7. scan</h2>
<div class="sectionbody">
<div class="paragraph">
<p>exclusive prefix sum implementation for integer data</p>
</div>
<div class="paragraph">
<p>input is of size <code>n</code>, output is of size <code>n + 1</code> as in the following
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:  4 5 1  2  3  -
output: 0 4 9 10 12 15</pre>
</div>
</div>
<div class="sect2">
<h3 id="_interface_2">7.1. interface</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scan_apply</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">input</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">output</span><span class="tok-p">,</span> <span class="tok-cm">/*w*/</span> <span class="tok-n">Scan</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-kt">void</span> <span class="tok-nf">scan_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">size</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Scan</span> <span class="tok-o">**</span><span class="tok-n">w</span><span class="tok-p">);</span>                                  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scan_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Scan</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">);</span>                                             <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>perform scan operation on <code>input</code> of size <code>size</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>allocate workspace for performing scan of size <code>size</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>free workspace</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kahan_summation">8. Kahan summation</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Kahan_summation_algorithm">Summation</a>
stable to numerical error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">kahan_sum_ini</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">KahanSum</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">kahan_sum_fin</span><span class="tok-p">(</span><span class="tok-n">KahanSum</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">kahan_sum_add</span><span class="tok-p">(</span><span class="tok-n">KahanSum</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">double</span> <span class="tok-n">input</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">double</span> <span class="tok-nf">kahan_sum_get</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">KahanSum</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">double</span> <span class="tok-nf">kahan_sum_compensation</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">KahanSum</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>add <code>input</code> to the sum</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>return current sum</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>return current value of <code>compensation</code> for diagnostic</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">kahan_sum</span> <span class="tok-o">*</span><span class="tok-n">k</span><span class="tok-p">;</span>
<span class="tok-n">kahan_sum_ini</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">k</span><span class="tok-p">);</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">n</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">++</span><span class="tok-p">)</span>
    <span class="tok-n">kahan_sum_add</span><span class="tok-p">(</span><span class="tok-n">kahan_sum</span><span class="tok-p">,</span> <span class="tok-n">a</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]);</span>
<span class="tok-n">sum</span> <span class="tok-o">=</span> <span class="tok-n">kahan_sum_get</span><span class="tok-p">(</span><span class="tok-n">kahan_sum</span><span class="tok-p">);</span>
<span class="tok-n">kahan_sum_fin</span><span class="tok-p">(</span><span class="tok-n">k</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_body_forces">9. body forces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>force applied to every particles</p>
</div>
<div class="sect2">
<h3 id="_data_structures">9.1. data structures</h3>
<div class="paragraph">
<p>Defined by two structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BForce</code>, contains all informations needed for the  force
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>BForce_v</code> (<em>BForce view</em>), containing only the information needed at
a specific time. It is passed to device kernels.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_interface_3">9.2. interface</h3>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_ini</span><span class="tok-p">(</span><span class="tok-n">BForce</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_fin</span><span class="tok-p">(</span><span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize to a given force function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_none</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>            <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_cste</span><span class="tok-p">(</span><span class="tok-n">float3</span> <span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_dp</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>     <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_shear</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_rol</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>    <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_rad</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>    <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>no force</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>constant force <code>f</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>double poiseuille</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>shear</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>4 roller mill</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>radial force</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_ini_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">bf</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">bforce_adjust</span><span class="tok-p">(</span><span class="tok-n">float3</span> <span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">fpar</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">bforce_apply</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">mass</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">BForce</span> <span class="tok-o">*</span><span class="tok-n">bf</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>change value of the force</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>apply body force to particles</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_configuration">9.3. configuration</h3>
<div class="sect3">
<h4 id="_none">9.3.1. none</h4>
<div class="paragraph">
<p>no body force (default value)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;none&quot;;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_constant">9.3.2. constant</h4>
<div class="paragraph">
<p>constant force</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;constant&quot;;</span>
<span class="tok-s">    f    = [1.0, 0.0, 0.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_double_poiseuille">9.3.3. double poiseuille</h4>
<div class="paragraph">
<p><code>fx = y &gt; yc ? a : -a</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;double_poiseuille&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_shear">9.3.4. shear</h4>
<div class="paragraph">
<p><code>fx = a * (y - yc)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;shear&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_4_roller_mill">9.3.5. 4 roller mill</h4>
<div class="listingblock">
<div class="content">
<pre>    f.x =  2*sin(x)*cos(y) * a;
    f.y = -2*cos(x)*sin(y) * a;</pre>
</div>
</div>
<div class="paragraph">
<p>while <code>x</code> and <code>y</code> are coordinates relative to the domain center and
normalized to have <code>x = Pi</code> and <code>x = -Pi</code> at the domain edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;four_roller&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_radial">9.3.6. radial</h4>
<div class="paragraph">
<p><code>fr = a * er / r</code>, where <code>fr</code> is radial force, <code>er</code> is unit radial
vector at position <code>r</code> and <code>r</code> is radial position.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">bforce {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;rad&quot;;</span>
<span class="tok-s">    a    = 1.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clist">10. clist</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helpers to find which particles are in a given cell.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reorder data according to particle positions into cells</p>
</li>
<li>
<p>access particles within a given cell</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_example_2">10.1. example</h3>
<div class="paragraph">
<p>consider a 1D example of particles with positions in domain <code>[0, 4)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 2.5 0.1 1.1 0.5 1.6</pre>
</div>
</div>
<div class="paragraph">
<p>After cell list building (we take 1 as cell size), the above data becomes</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 0.1 0.5 1.1 1.6 2.5  -
cc: 2       2       1    0
ss: 0       2       4    5</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>pp</code> is the particle array, <code>cc</code> (counts) is the number of particles per
cell and <code>ss</code> (starts) is the prefix sum of <code>cc</code>.</p>
</div>
<div class="paragraph">
<p>Accessing all particles in cell <code>i=1</code> (<code>[1,2)</code>) can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>loop: j = 0, ..., cc[i]
      id = ss[i] + j
      p = pp[id]
      work(p)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above can be easily extended in 3D, only ordering changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_structures_2">10.2. data structures</h3>
<div class="sect3">
<h4 id="_clist_2">10.2.1. Clist</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">Clist</span> <span class="tok-p">{</span>
    <span class="tok-n">int3</span> <span class="tok-n">dims</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">ncells</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dims</code> dimesnsions of the grid</p>
</li>
<li>
<p><code>ncells</code> number of cells</p>
</li>
<li>
<p><code>counts</code> number of particles per cell</p>
</li>
<li>
<p><code>starts</code> exclusive prefic scan of the above</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_map">10.2.2. Map</h4>
<div class="paragraph">
<p>Helper to build the cell lists (hidden from client)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">ClistMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">nA</span><span class="tok-p">;</span>              <span class="tok-cm">/* number of source arrays to build the cell lists, e.g remote+bulk -&gt; 2 */</span>
    <span class="tok-n">uchar4</span> <span class="tok-o">*</span><span class="tok-n">ee</span><span class="tok-p">[</span><span class="tok-n">MAXA</span><span class="tok-p">];</span>    <span class="tok-cm">/* cell entries */</span>
    <span class="tok-n">uint</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">;</span>            <span class="tok-cm">/* codes containing: indices of data to fetch and array id from which to fetch */</span>
    <span class="tok-n">Scan</span> <span class="tok-o">*</span><span class="tok-n">scan</span><span class="tok-p">;</span>      <span class="tok-cm">/* scan workspace */</span>
    <span class="tok-kt">long</span> <span class="tok-n">maxp</span><span class="tok-p">;</span>           <span class="tok-cm">/* maximum number of particles per input vector */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nA</code> number of source arrays</p>
</li>
<li>
<p><code>ee</code> cell entries: one array per source array, containing a list of
<code>uchar4</code> with entries (<code>xcid</code>, <code>ycid</code>, <code>zcid</code>, <code>sid</code>)</p>
<div class="ulist">
<ul>
<li>
<p><code>xcid</code>: x cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.x</code></p>
</li>
<li>
<p><code>ycid</code>: y cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.y</code></p>
</li>
<li>
<p><code>zcid</code>: z cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.z</code></p>
</li>
<li>
<p><code>sid</code>: source array id, in 0, &#8230;&#8203;, <code>nA</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ii</code> indices of particles to fetch. can be decoded into the source
array id and the particle id inside this array</p>
</li>
<li>
<p><code>scan</code> scan workspace, see <a href="algo/scan.html">scan</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ids can be accessed from</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">const</span> <span class="tok-n">uint</span><span class="tok-o">*</span> <span class="tok-nf">clist_get_ids</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_4">10.3. interface</h3>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">clist_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">LX</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">LY</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">LZ</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">clist_ini_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nA</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">ClistMap</span> <span class="tok-o">**</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_fin_map</span><span class="tok-p">(</span><span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>build interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">clist_ini_counts</span><span class="tok-p">(</span><span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_subindex</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">project</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">aid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_build_map</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">nn</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>

<span class="tok-cm">/* special for fluid distribution */</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_subindex_local</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_subindex_remote</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">clist_gather_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pplo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppre</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-kt">long</span> <span class="tok-n">nout</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppout</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_gather_ii</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iilo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iire</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-kt">long</span> <span class="tok-n">nout</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iiout</span><span class="tok-p">);</span>

<span class="tok-cm">/* quick cell build for single array */</span>
<span class="tok-kt">void</span> <span class="tok-nf">clist_build</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nlo</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nout</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pplo</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppout</span><span class="tok-p">,</span> <span class="tok-n">Clist</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">ClistMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface: code/decode map ids</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">_I_</span> <span class="tok-n">uint</span> <span class="tok-n">clist_encode_id</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">pid</span><span class="tok-p">)</span>
<span class="tok-n">_I_</span> <span class="tok-kt">void</span> <span class="tok-n">clist_decode_id</span><span class="tok-p">(</span><span class="tok-n">uint</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">pid</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_algorithm">10.4. algorithm</h3>
<div class="paragraph">
<p>The cell build process is linear in number of particles <code>np</code> and <code>n log(n)</code>
in number of cells <code>n</code>.
The process to build cell lists is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>- build ee and counts: O(np)
  - set counts[i] = 0 for all i
  - for each particle, compute its cell id cid
  - get unique subindex k within the cell by updating cc[cid]
- scan counts to get starts O(nlog n)
- construct ii: O(np)
  - for each particle with id i, compute new index j = ss[cid] + k[i]
  - set ii[j] = i
- Gather data: O(np)
  - new particle vector pp1 from pp: pp1[i] = pp[ii[i]]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cnt">11. cnt</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>contact</em> interactions between objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect2">
<h3 id="_interface_5">11.1. interface</h3>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">cnt_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">rank</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Contact</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">cnt_fin</span><span class="tok-p">(</span><span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">cnt_build_cells</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">cnt_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-n">FoWrap</span> <span class="tok-o">*</span><span class="tok-n">fw</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">cnt_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Contact</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-n">FoWrap</span> <span class="tok-o">*</span><span class="tok-n">fw</span><span class="tok-p">,</span> <span class="tok-n">Pap26</span> <span class="tok-n">PP</span><span class="tok-p">,</span> <span class="tok-n">Fop26</span> <span class="tok-n">FF</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[</span><span class="tok-mi">26</span><span class="tok-p">]);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>build cell lists for local objects</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>compute the interactions between local objects particles</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>compute the interactions between local and remote objects particles</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_color">12. color</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_purpose">12.1. purpose</h3>
<div class="paragraph">
<p>Each particle of the solvent has an assigned color when the
<code>multi_solvent</code> flag is enabled.
It is helpful for modeling different solvent with different
viscosities, surface tensions etc.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modules_2">12.2. modules</h3>
<div class="paragraph">
<p>Some utility modules are implemeted in <code>/src/color</code>.</p>
</div>
<div class="sect3">
<h4 id="_flux">12.2.1. flux</h4>
<div class="paragraph">
<p>recolor particles crossing the face of the periodic domain in the
positive direction x, y or z</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">int3</span><span class="tok-p">;</span>
<span class="tok-k">struct</span> <span class="tok-n">Particle</span><span class="tok-p">;</span>
<span class="tok-k">struct</span> <span class="tok-n">Coords</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">color_linear_flux</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">color</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span>
                       <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dir</code> is the direction x, y or z</p>
</li>
<li>
<p><code>color</code> is the new color</p>
</li>
<li>
<p><code>pp</code> are input particles of size <code>n</code></p>
</li>
<li>
<p><code>cc</code> are output colors (stay the same if does not cross the face)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comm">13. comm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>generic communicator with "halo".</p>
</div>
<div class="sect2">
<h3 id="_purpose_2">13.1. purpose</h3>
<div class="paragraph">
<p>Communicate data with the neighboring ranks</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_structures_3">13.2. data structures</h3>
<div class="paragraph">
<p><code>hBags</code>: buffers on the host, contains all necessary information of the data to communicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">hBags</span> <span class="tok-p">{</span>
    <span class="tok-n">data_t</span> <span class="tok-o">*</span><span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* data on the host                    */</span>
    <span class="tok-kt">int</span>         <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span> <span class="tok-cm">/* size of the data                    */</span>
    <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* capacity of each frag (elem number) */</span>
    <span class="tok-kt">size_t</span> <span class="tok-n">bsize</span><span class="tok-p">;</span>        <span class="tok-cm">/* size of one datum in bytes          */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>dBags</code>: buffers on the device</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">dBags</span> <span class="tok-p">{</span>
    <span class="tok-n">data_t</span> <span class="tok-o">*</span><span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* data on the device         */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Comm</code>: contains the communication related variables. It is hidden
from user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_allocation_mod">13.3. allocation mod</h3>
<div class="paragraph">
<p>User can choose how the buffers are allocated with the enum type <code>AllocMod</code>.
This is used in the funcion <code>ini</code> and <code>fin</code>. allocation mode and free mode are assumed to be the same</p>
</div>
<div class="paragraph">
<p>currently supported allocation modes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>    <span class="tok-n">HST_ONLY</span><span class="tok-p">,</span>   <span class="tok-cm">/* only host bags allocated                 */</span>
    <span class="tok-n">DEV_ONLY</span><span class="tok-p">,</span>   <span class="tok-cm">/* only device bags allocated               */</span>
    <span class="tok-n">PINNED</span><span class="tok-p">,</span>     <span class="tok-cm">/* both host and device pinned              */</span>
    <span class="tok-n">PINNED_HST</span><span class="tok-p">,</span> <span class="tok-cm">/* host pinned; no device memory            */</span>
    <span class="tok-n">PINNED_DEV</span><span class="tok-p">,</span> <span class="tok-cm">/* host pinned; device global memory on gpu */</span>
    <span class="tok-n">NONE</span>        <span class="tok-cm">/* no allocation                            */</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_6">13.4. interface</h3>
<div class="sect3">
<h4 id="_memory_management">13.4.1. memory management</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">comm_bags_ini</span><span class="tok-p">(</span><span class="tok-n">AllocMod</span> <span class="tok-n">fmod</span><span class="tok-p">,</span> <span class="tok-n">AllocMod</span> <span class="tok-n">bmod</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">bsize</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[</span><span class="tok-n">NBAGS</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">hb</span><span class="tok-p">,</span> <span class="tok-n">dBags</span> <span class="tok-o">*</span><span class="tok-n">db</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">comm_bags_fin</span><span class="tok-p">(</span><span class="tok-n">AllocMod</span> <span class="tok-n">fmod</span><span class="tok-p">,</span> <span class="tok-n">AllocMod</span> <span class="tok-n">bmod</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">hb</span><span class="tok-p">,</span> <span class="tok-n">dBags</span> <span class="tok-o">*</span><span class="tok-n">db</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">cart</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Comm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">comm_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bags alloc:</strong> Given two structures <code>hBags</code> and <code>dBags</code>, <code>ini</code> allocates the buffers on host and device. <code>ini</code> expects 2 allocation modes:</p>
<div class="ulist">
<ul>
<li>
<p><code>fmod</code>: allocation mode for fragment buffers</p>
</li>
<li>
<p><code>bmod</code>: allocation mode for bulk buffer</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>comm alloc</strong>: initialize <code>Comm</code> structure</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_communication">13.4.2. communication</h4>
<div class="paragraph">
<p>Communication happens between host bags (see <code>hBags</code> structure).
It needs 3 entities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>receiver bags</p>
</li>
<li>
<p>sender bags</p>
</li>
<li>
<p>a <code>Comm</code> for communicating through MPI</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interface is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">comm_post_recv</span><span class="tok-p">(</span><span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>           <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">comm_post_send</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>     <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-kt">int</span> <span class="tok-nf">comm_wait_recv</span><span class="tok-p">(</span><span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">hBags</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">);</span>      <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">int</span> <span class="tok-nf">comm_wait_send</span><span class="tok-p">(</span><span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>                     <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>call MPI asynchroneous recv and store requests in <code>s</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>call MPI asynchroneous send and store requests in <code>s</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>wait for recv requests</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>wait for send requests</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_control">14. Control</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>velocity controller</p>
</li>
<li>
<p>open boundary conditions</p>
</li>
<li>
<p>density controller</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_velocity_controller">14.1. Velocity controller</h3>
<div class="paragraph">
<p>control velocity by modifying the imposed hydrostatic force
the force is modified using a PID controller <a href="https://en.wikipedia.org/wiki/PID_controller" class="bare">https://en.wikipedia.org/wiki/PID_controller</a>.</p>
</div>
<div class="sect3">
<h4 id="_controlled_variables">14.1.1. Controlled variables</h4>
<div class="paragraph">
<p>The controlled variable is the (global) body force value.
The state of the system is represented by</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{U} = \frac 1 n \sum\limits_{i=1}^n \mathbf{f} \left( \mathbf{r_i}, \mathbf{v_i} \right)\]
</div>
</div>
<div class="paragraph">
<p>where \(( \mathbf{r_i}, \mathbf{v_i})\) are the \(i^{th}\)
particle position and velocity, \(n\) is the number of particles
and \(\mathbf{f}\) is a given transformation.</p>
</div>
<div class="paragraph">
<p>There is therefore 3 (independant) controlled variables.</p>
</div>
<div class="paragraph">
<p>the transformation is the way of averaging the velocity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cartesian transformation keeps the velocity and does not depends on position.</p>
</li>
<li>
<p>radial transformation returns the velocity in polar coordinates
scaled by the radial position. the <code>z</code> component corresponds to
cartesian transformation</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_interface_7">14.1.2. interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vcont_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vcont_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">cont</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>set the parameters (to be done only once, before any other calls):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vcont_set_params</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">factor</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">Kp</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">Ki</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">Kd</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">vcont_set_target</span><span class="tok-p">(</span><span class="tok-n">float3</span> <span class="tok-n">vtarget</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">vcont_set_cart</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">vcont_set_radial</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>set the PID control variables. <code>factor</code> scales variables <code>Kp</code>, Ki`
and <code>Kd</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>set the target velocity (in transformed space)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>set the transformation mode to cartesian</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>set the transformation mode to radial</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The parameters can also be set through the configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vcont_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Control operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span>   <span class="tok-nf">vcont_sample</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">float3</span> <span class="tok-nf">vcont_adjustF</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span>   <span class="tok-nf">vcont_log</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PidVCont</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>get average velocity according to transformation and store it</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>reduce sampled quantities and update the controller. return the force</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>logging informations; dumped into the file <code>vcon.txt</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_2">14.1.3. configuration</h4>
<div class="paragraph">
<p>syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">vcon</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">     active = true;</span>
<span class="tok-s">     type   = &quot;cart&quot;;          # can be also &quot;rad&quot;</span>
<span class="tok-s">     U      = [1.0, 1.0, 0.0]; # target velocity in transformed space</span>
<span class="tok-s">     factor = 0.08</span>
<span class="tok-s">     Kp = 2.0</span>
<span class="tok-s">     Ki = 1.0</span>
<span class="tok-s">     Kd = 8.0</span>
<span class="tok-s">     log_freq    = 500;</span>
<span class="tok-s">     adjust_freq = 500;</span>
<span class="tok-s">     sample_freq = 1;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inflow">14.2. Inflow</h3>
<div class="paragraph">
<p>Mass rate inflow</p>
</div>
<div class="sect3">
<h4 id="_interface_8">14.2.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini</span><span class="tok-p">(</span><span class="tok-n">int2</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">**</span><span class="tok-n">i</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_fin</span><span class="tok-p">(</span><span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the inflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_velocity</span><span class="tok-p">(</span><span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_plate</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">o</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">L1</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">L2</span><span class="tok-p">,</span>
                             <span class="tok-n">float3</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">upoiseuille</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">vpoiseuille</span><span class="tok-p">,</span>
                             <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_circle</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">o</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">R</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">H</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">poiseuille</span><span class="tok-p">,</span>
                              <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the type of inflow, call the appropriate
<code>ini_params_xxx</code>.
<code>ini_velocity</code> must be called after initializing the parameters.
it is used to setup the inlet velocity from parameters.</p>
</div>
<div class="paragraph">
<p>initialize from config parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_ini_params_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>create particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">inflow_create_pp</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">kBT</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">numdensity</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">inflow_create_pp_cc</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">kBT</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">numdensity</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">newcolor</span><span class="tok-p">,</span> <span class="tok-n">Inflow</span> <span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>add particles to the array <code>pp</code> and increase <code>n</code> accordingly</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>same as above, with colors <code>cc</code> set to <code>color</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_3">14.2.2. configuration</h4>
<div class="sect4">
<h5 id="_plate">plate</h5>
<div class="paragraph">
<p>syntax for a <code>8.0 x 16.0</code> plate perpendicular to the x axis passing by
the point <code>(1, 2, 3)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">inflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active      = true;</span>
<span class="tok-s">    type        = &quot;plate&quot;;</span>
<span class="tok-s">    L1          = 1.0;</span>
<span class="tok-s">    L2          = 16.0;</span>
<span class="tok-s">    direction   = 0;                # [0,1,2] = [X,Y,Z]</span>
<span class="tok-s">    origin      = [1.0, 2.0, 3.0];</span>
<span class="tok-s">    upoiseuille = false;            # true for parabolic profile along L1</span>
<span class="tok-s">    vpoiseuille = false;            # true for parabolic profile along L2</span>
<span class="tok-s">    u           = [10.0, 0.0, 0.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_circle">circle</h5>
<div class="paragraph">
<p>syntax for cylinder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">inflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active = true;</span>
<span class="tok-s">    type   = &quot;circle&quot;;</span>
<span class="tok-s">    R      = 1.0;              # radius</span>
<span class="tok-s">    H      = 16.0;             # hight of the cylinder</span>
<span class="tok-s">    U      = 1.0;              # maximum velocity</span>
<span class="tok-s">    center = [8.0, 8.0, 8.0];</span>
<span class="tok-s">    poiseuille = false;        # parabolic profile along H if true</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_outflow">14.3. Outflow</h3>
<div class="paragraph">
<p>Delete particles satisfying a predicate</p>
</div>
<div class="sect3">
<h4 id="_interface_9">14.3.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">**</span><span class="tok-n">o</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the outflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ini_params_circle</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">R</span><span class="tok-p">,</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">ini_params_plate</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">r0</span><span class="tok-p">,</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the geometry of outflow, call the appropriate
<code>ini_params_xxx</code>.</p>
</div>
<div class="paragraph">
<p>filter and mark particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">filter_particles</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-kt">void</span> <span class="tok-nf">download_ndead</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                   <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-kt">int</span><span class="tok-o">*</span> <span class="tok-nf">get_deathlist</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                    <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">int</span>  <span class="tok-nf">get_ndead</span><span class="tok-p">(</span><span class="tok-n">Outflow</span> <span class="tok-o">*</span><span class="tok-n">o</span><span class="tok-p">);</span>                                        <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>store dying particles infos inside Outflow struct</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>copy from device to host number of dead particles</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>return the list of dead marks (dead=1, alive=0)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>return the number of dead particles</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_4">14.3.2. configuration</h4>
<div class="sect4">
<h5 id="_plate_2">plate</h5>
<div class="paragraph">
<p>will delete particles crossing a plate along the positive direction.
syntax for the plate <code>y=4</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">outflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active     = true;</span>
<span class="tok-s">    type       = &quot;plate&quot;;</span>
<span class="tok-s">    direction  = 1;      # [0,1,2] = [X,Y,Z]</span>
<span class="tok-s">    position   = 4.0;    # position along &quot;direction&quot;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_circle_2">circle</h5>
<div class="paragraph">
<p>delete particles going out of the cylinder.
syntax for a cylinder of radius 8 centered at <code>(8, 8, 8)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">outflow</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    active = true;</span>
<span class="tok-s">    type   = &quot;circle&quot;;</span>
<span class="tok-s">    R      = 8.0;</span>
<span class="tok-s">    center = [8.0, 8.0, 8.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_density_controller">14.4. Density controller</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_coords">15. coords</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Coordinate transforms utility.</p>
</div>
<div class="paragraph">
<p>In <em>uDeviceX</em>, the simulation domain is decomposed into a grid of
subdomains of equal sizes.
Computations are performed in <em>local</em> coordinates and all objects are
relative to these coordinates.
Operations, such as initialisation of the data, io, etc., need
<em>global</em> coordinates informations.</p>
</div>
<div class="paragraph">
<p>For convenience, we consider the three coordinate systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Global</em>: Relative to the lower corner of the full domain of size
\((G_x, G_y, G_z)\)</p>
</li>
<li>
<p><em>Local</em>: Relative to the center of the subdomain of size
\((L_x, L_y, L_z)\)</p>
</li>
<li>
<p><em>Center</em>: Relative to the center of the full domain: \((C_x,
C_y, C_z) = (G_x/2, G_y/2, G_z/2)\)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_data_structures_4">15.1. data structures</h3>
<div class="paragraph">
<p>All the needed information is stored in the hidden structure <code>Coords</code>.
A <em>view</em> structure <code>Coords_v</code> is public to device code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">Coords_v</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">xc</span><span class="tok-p">,</span> <span class="tok-n">yc</span><span class="tok-p">,</span> <span class="tok-n">zc</span><span class="tok-p">;</span> <span class="tok-cm">/* rank coordinates        */</span>
    <span class="tok-kt">int</span> <span class="tok-n">xd</span><span class="tok-p">,</span> <span class="tok-n">yd</span><span class="tok-p">,</span> <span class="tok-n">zd</span><span class="tok-p">;</span> <span class="tok-cm">/* rank sizes              */</span>
    <span class="tok-kt">int</span> <span class="tok-n">Lx</span><span class="tok-p">,</span> <span class="tok-n">Ly</span><span class="tok-p">,</span> <span class="tok-n">Lz</span><span class="tok-p">;</span> <span class="tok-cm">/* [L]ocal: subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_host_interface">15.2. Host interface</h3>
<div class="sect3">
<h4 id="_memory_management_2">15.2.1. Memory management</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">coords_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">cart</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">Lx</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">Ly</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">Lz</span><span class="tok-p">,</span> <span class="tok-n">Coords</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">coords_fin</span><span class="tok-p">(</span><span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>allocate and set the data according to the cartesian communicator</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>deallocate the structure</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The resources can also be allocated using configuration informations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">coords_ini_conf</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">cart</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-n">Coords</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getters">15.2.2. Getters</h4>
<div class="paragraph">
<p>Obtain a view structure from <code>Coords</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">coords_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((G_x, G_y, G_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">xdomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">ydomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zdomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((L_x, L_y, L_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">xs</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">ys</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zs</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-n">int3</span> <span class="tok-nf">subdomain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get (from <em>local</em> coordinates) \((-L_x/2, -L_y/2, -L_z/2)\) and
\((L_x/2, L_y/2, L_z/2)\) in <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">xlo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">ylo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zlo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">int</span> <span class="tok-nf">xhi</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">yhi</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">zhi</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coordinate_transforms">15.2.3. Coordinate transforms</h4>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>center</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xl2xc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yl2yc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zl2zc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zl</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">local2center</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rl</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rc</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>center</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xc2xl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xc</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yc2yl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yc</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zc2zl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zc</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">center2local</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rc</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rl</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xl2xg</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yl2yg</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yl</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zl2zg</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zl</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">local2global</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rl</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>global</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-nf">xg2xl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">xg</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">yg2yl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">yg</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">zg2zl</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">zg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">global2local</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rg</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">rl</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_helpers">15.2.4. helpers</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* rank predicates */</span>
<span class="tok-kt">bool</span> <span class="tok-nf">is_end</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">dir</span><span class="tok-p">);</span>

<span class="tok-cm">/* a string unique for a rank */</span>
<span class="tok-kt">void</span> <span class="tok-nf">coord_stamp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">);</span>

<span class="tok-cm">/* number of subdomains */</span>
<span class="tok-kt">int</span> <span class="tok-nf">coords_size</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_5">15.3. Configuration</h3>
<div class="paragraph">
<p>Set subdomain sizes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">glb</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    L = [16, 12, 24]</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generic_d_evice_api">16. generic [d]evice API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal is to make cuda API and kernel functions generic. Meaning
they can be replaced by CPU calls.</p>
</div>
<div class="paragraph">
<p>There are two groups: functions which "mirror" cuda API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">int</span> <span class="tok-nf">Malloc</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemcpyToSymbol</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">symbol</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">offset</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-o">=</span><span class="tok-n">MemcpyHostToDevice</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemcpyFromSymbol</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">dst</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">symbol</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">offset</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-o">=</span><span class="tok-n">MemcpyDeviceToHost</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">HostGetDevicePointer</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">**</span><span class="tok-n">pDevice</span><span class="tok-p">,</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">pHost</span><span class="tok-p">,</span> <span class="tok-kt">unsigned</span> <span class="tok-kt">int</span> <span class="tok-n">flags</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">Memcpy</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">dst</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemsetAsync</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">devPtr</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">value</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-n">Stream_t</span> <span class="tok-n">stream</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">Memset</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">devPtr</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">value</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">MemcpyAsync</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span> <span class="tok-n">dst</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span> <span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">,</span> <span class="tok-n">Stream_t</span> <span class="tok-n">stream</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">Free</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">devPtr</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">FreeHost</span> <span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">hstPtr</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">DeviceSynchronize</span> <span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">PeekAtLastError</span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>functions unique for <em>uDeviceX</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-nf">emsg</span><span class="tok-p">();</span>
<span class="tok-kt">int</span> <span class="tok-nf">alloc_pinned</span><span class="tok-p">(</span><span class="tok-kt">void</span> <span class="tok-o">**</span><span class="tok-n">pHost</span><span class="tok-p">,</span> <span class="tok-kt">size_t</span> <span class="tok-n">size</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">is_device_pointer</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">void</span> <span class="tok-o">*</span><span class="tok-n">ptr</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>files of the interface
- <code>d/api.h</code> API calls
- <code>d/q.h</code> function and variable type qualifiers
- <code>d/ker.h</code></p>
</div>
<div class="paragraph">
<p>if <code>DEV_CUDA</code> is defined interfaces is implimented by cuda, if
<code>DEV_CPU</code> is defined it is implimented by host calls.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debug">17. debug</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helper to check the particle positions, velocities, forces and
cell-lists from device arrays</p>
</div>
<div class="paragraph">
<p>The hidden structure <code>Dbg</code> holds the debugging configuration.
Configuration is encoded using the following enum values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span>
    <span class="tok-n">DBG_POS</span><span class="tok-p">,</span>      <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">DBG_POS_SOFT</span><span class="tok-p">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">DBG_VEL</span><span class="tok-p">,</span>      <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">DBG_FORCES</span><span class="tok-p">,</span>   <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-n">DBG_COLORS</span><span class="tok-p">,</span>   <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-n">DBG_CLIST</span><span class="tok-p">,</span>    <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-n">DBG_NKIND_</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>positions are inside subdomain</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>positions are inside subdomain plus a margin</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>velocities</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>forces</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>colors</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>cell lists</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consider subdomain of dimensions \((L_x, Ly, Lz)\).
A position \((r_x, r_y, r_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[-\frac{L_\alpha - M} {2}  \leq r_\alpha &lt; \frac{L_\alpha + M} 2,\]
</div>
</div>
<div class="paragraph">
<p>where \(M\) is the margin. It is \(M = 0\) for <code>DBG_POS</code> and
\(M = 3\) for <code>DBG_POS_SOFT</code>.</p>
</div>
<div class="paragraph">
<p>For a given timestep \(dt\), the velocity \((v_x, v_y, v_z)\) is
valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |v_\alpha| dt \leq L_\alpha.\]
</div>
</div>
<div class="paragraph">
<p>The force \((f_x, f_y, f_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |f_\alpha| dt^2 \leq L_\alpha.\]
</div>
</div>
<div class="sect2">
<h3 id="_interface_10">17.1. interface</h3>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_ini</span><span class="tok-p">(</span><span class="tok-n">Dbg</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_fin</span><span class="tok-p">(</span><span class="tok-n">Dbg</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>set debugging modes and verbosity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_enable</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_disable</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">kind</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_set_verbose</span><span class="tok-p">(</span><span class="tok-kt">bool</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_set_dump</span><span class="tok-p">(</span><span class="tok-kt">bool</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Dbg</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dbg_check_pos</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_pos_soft</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_vel</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_forces</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">base</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_colors</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dbg_check_clist</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Dbg</span> <span class="tok-o">*</span><span class="tok-n">dbg</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_6">17.2. configuration</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">dbg</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    verbose  = true;</span>
<span class="tok-s">    pos      = false;</span>
<span class="tok-s">    pos_soft = false;</span>
<span class="tok-s">    vel      = false;</span>
<span class="tok-s">    forces   = false;</span>
<span class="tok-s">    colors   = false;</span>
<span class="tok-s">    clist    = false;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_distr">18. distr</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribution of quantities across nodes.
Each node has a local coordinate system. The origin is the center of a
"subdomain" of size <code>Sx</code>, <code>Sy</code>, <code>Sz</code>.</p>
</div>
<div class="paragraph">
<p>A quantity is sent to a neighboring rank if its position is outside of
the subdomain.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to redistribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_map_2">18.1. map</h3>
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all quantities.</p>
</div>
<div class="sect3">
<h4 id="_data_structure">18.1.1. data structure</h4>
<div class="paragraph">
<p>The structure to map local data from an array to packed data in 27
arrays is implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* [D]istr Map */</span>
<span class="tok-k">struct</span> <span class="tok-n">DMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span>  <span class="tok-cm">/* number of entities leaving in each fragment */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">;</span>  <span class="tok-cm">/* cumulative sum of the above                 */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">ids</span><span class="tok-p">[</span><span class="tok-mi">27</span><span class="tok-p">];</span> <span class="tok-cm">/* indices of leaving objects                  */</span>

    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">hcounts</span><span class="tok-p">;</span> <span class="tok-cm">/* counts on host (pinned) */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be allocated on device or on host memory (see interface).</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_11">18.1.2. interface</h4>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dmap_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_fin</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_reini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_download_counts</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_ini_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">capacity</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_fin_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_reini_host</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dmap_D2H</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-o">*</span><span class="tok-n">h</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* exclusive scan */</span>
<span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">NCOUNTS</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__global__</span> <span class="tok-kt">void</span> <span class="tok-n">dmap_scan</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">)</span>              <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">dmap_get_fid</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">])</span>       <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">dmap_add</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">pid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>prefix sum on counts to obtain starts</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>get fragment id from position</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>add a quantity to the map</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flu">18.2. flu</h3>
<div class="paragraph">
<p>Redistribute solvent particles accross nodes.</p>
</div>
<div class="sect3">
<h4 id="_data_structures_5">18.2.1. data structures</h4>
<div class="paragraph">
<p>Solvent distribution follow the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">Opt</span> <span class="tok-p">{</span>
    <span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">ids</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dpp</span><span class="tok-p">,</span> <span class="tok-n">dii</span><span class="tok-p">,</span> <span class="tok-n">dcc</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">,</span> <span class="tok-n">hii</span><span class="tok-p">,</span> <span class="tok-n">hcc</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">;</span> <span class="tok-cm">/* number of sent particles */</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
    <span class="tok-n">Opt</span> <span class="tok-n">opt</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluComm</span> <span class="tok-p">{</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">;</span>
    <span class="tok-n">Opt</span> <span class="tok-n">opt</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DFluUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">,</span> <span class="tok-n">hii</span><span class="tok-p">,</span> <span class="tok-n">hcc</span><span class="tok-p">;</span>
    <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ppre</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">iire</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ccre</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">;</span> <span class="tok-cm">/* number of received particles */</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
    <span class="tok-n">Opt</span> <span class="tok-n">opt</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>[d,h]xx</code> means quantities on <code>[device,host]</code> and <code>pp</code>
corresponds to particles, <code>cc</code> to colors and <code>ii</code> to global ids.
The <code>xxre</code> variables in <code>Unpack</code> are buffer for remote quantities.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_12">18.2.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dflu_pack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxdensity</span><span class="tok-p">,</span> <span class="tok-n">DFluPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_comm_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxdensity</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">dflu_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-cm">/* map */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-cm">/* pack */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_download</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DFluStatus</span> <span class="tok-o">*</span><span class="tok-n">s</span><span class="tok-p">);</span>

<span class="tok-cm">/* communication */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_post_recv</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_post_send</span><span class="tok-p">(</span><span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DFluComm</span>   <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_wait_send</span><span class="tok-p">(</span><span class="tok-n">DFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-cm">/* unpack */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_unpack</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The map is build from <a href="partlist.html">partlist</a>, allowing the
process to delete particles.</p>
</div>
<div class="paragraph">
<p>The solvent distribution also include cell list generation (see
<a href="clist.html">cell lists</a>).
It is done in two phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>subindices, independant for bulk and remote particles</p>
</li>
<li>
<p>gather, which needs the subindices to be computed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bulk subindices can be computed while comunicating remote particles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/* cell lists */</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_bulk</span><span class="tok-p">(</span><span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">dflu_gather</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ndead</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">DFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FluQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rbc">18.3. rbc</h3>
<div class="paragraph">
<p>Redistribute red blood cells accross nodes according to the center of
mass of their bounding box (see <a href="algo/minmax.html">minmax</a>).</p>
</div>
<div class="sect3">
<h4 id="_data_structures_6">18.3.1. data structures</h4>
<div class="paragraph">
<p>RBC distribution follows the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">DRbcPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">minext</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">maxext</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dpp</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">;</span>

    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">;</span>
    <span class="tok-n">DMap</span> <span class="tok-n">hmap</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hii</span><span class="tok-p">;</span>

    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRbcComm</span> <span class="tok-p">{</span>
    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ii</span><span class="tok-p">;</span>
    <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hpp</span><span class="tok-p">;</span>

    <span class="tok-cm">/* optional: ids */</span>
    <span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hii</span><span class="tok-p">;</span>

    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span> <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>minext</code> and <code>maxext</code> contain the bounding box informations of
each RBC. Other variables have the same naming conventions than <code>distr::flu</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_13">18.3.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">drbc_pack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_comm_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRbcComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">ids</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_download</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_post_recv</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_post_send</span><span class="tok-p">(</span><span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_wait_send</span><span class="tok-p">(</span><span class="tok-n">DRbcComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRbcPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drbc_unpack_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRbcUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rig">18.4. rig</h3>
<div class="paragraph">
<p>Redistribute rigid objects accross nodes according to their center of
mass.</p>
</div>
<div class="sect3">
<h4 id="_data_structures_7">18.4.1. data structures</h4>
<div class="paragraph">
<p>Rigid bodies distribution is very similar to the above. The <em>hidden</em> data
structures fit again in the general workflow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-cm">/*</span>
<span class="tok-cm"> ipp: particles of the mesh</span>
<span class="tok-cm"> ss:  &quot;Solid&quot; structures</span>
<span class="tok-cm">*/</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigPack</span> <span class="tok-p">{</span>
    <span class="tok-n">DMap</span> <span class="tok-n">map</span><span class="tok-p">;</span>
    <span class="tok-n">dBags</span> <span class="tok-n">dipp</span><span class="tok-p">,</span> <span class="tok-n">dss</span><span class="tok-p">;</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hipp</span><span class="tok-p">,</span> <span class="tok-n">hss</span><span class="tok-p">;</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span>  <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigComm</span> <span class="tok-p">{</span>
    <span class="tok-n">Comm</span> <span class="tok-o">*</span><span class="tok-n">ipp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">;</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">DRigUnpack</span> <span class="tok-p">{</span>
    <span class="tok-n">hBags</span> <span class="tok-n">hipp</span><span class="tok-p">,</span> <span class="tok-n">hss</span><span class="tok-p">;</span>
    <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">;</span>  <span class="tok-cm">/* subdomain size */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_14">18.4.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">drig_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRigPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_pack_fin</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_comm_fin</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_pack</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">ipp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_download</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_post_recv</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_post_send</span><span class="tok-p">(</span><span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_wait_recv</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_wait_send</span><span class="tok-p">(</span><span class="tok-n">DRigComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRigPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">drig_unpack_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">DRigUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_common">18.5. common</h3>
<div class="paragraph">
<p>helpers: common kernels</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">dcommon_pack_pp_packets</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">DMap</span> <span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Sarray</span><span class="tok-o">&lt;</span><span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-mi">27</span><span class="tok-o">&gt;</span> <span class="tok-n">buf</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dcommon_shift_one_frag</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dcommon_shift_halo</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nhalo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Sarray</span><span class="tok-o">&lt;</span><span class="tok-kt">int</span><span class="tok-p">,</span> <span class="tok-mi">27</span><span class="tok-o">&gt;</span> <span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>pack <code>nc</code>  packets of <code>nv</code> particles into 27 buffers <code>buf</code> according to map</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>shift particles in the fragment direction</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>shift all particles according to the fragment direction</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exch">19. exch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Exchange quantities across nodes for "ghost particles".</p>
</div>
<div class="paragraph">
<p>A quantity is exchanged with a neighboring node if its position is
within a given distance from the subdomain boundaries.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to exchange:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optionally, other quantities can be exchanged back, e.g. forces.</p>
</div>
<div class="sect2">
<h3 id="_map_3">19.1. map</h3>
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all
quantities.
As opposed to the <em>distr</em> module, the mapping is not <em>one to one</em>.
A single quantity can be exchanged with up to 7 neighboring nodes if
it is in a corner.</p>
</div>
<div class="sect3">
<h4 id="_data_structure_2">19.1.1. data structure</h4>
<div class="paragraph">
<p>A single structure is able to build a map for up to <code>nw</code> objects
(e.g. rbc and rigid give <code>nw = 2</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">EMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">;</span>      <span class="tok-cm">/* number of entities leaving in each fragment */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">;</span>      <span class="tok-cm">/* cumulative sum of the above                 */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">offsets</span><span class="tok-p">;</span>     <span class="tok-cm">/* offsets per fragment for each solute        */</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">ids</span><span class="tok-p">[</span><span class="tok-n">NFRAGS</span><span class="tok-p">];</span> <span class="tok-cm">/* indices of leaving objects                  */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_15">19.1.2. interface</h4>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emap_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">cap</span><span class="tok-p">[],</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMap</span> <span class="tok-o">*</span><span class="tok-n">map</span><span class="tok-p">);</span>               <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_fin</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-n">EMap</span> <span class="tok-o">*</span><span class="tok-n">map</span><span class="tok-p">);</span>                                       <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_reini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMap</span> <span class="tok-n">map</span><span class="tok-p">);</span>                         <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_scan</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMap</span> <span class="tok-n">map</span><span class="tok-p">);</span>                          <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-kt">void</span> <span class="tok-nf">emap_download_counts</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-n">EMap</span> <span class="tok-n">map</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[]);</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>allocate the map structure on device</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>deallocate the map structure</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>reset the map structure</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>scan the map structure to get starts</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>copy counts from device to host</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">emap_code</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">])</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">emap_code_box</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">lo</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">hi</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">emap_add</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">soluteid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">pid</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-n">EMap</span> <span class="tok-n">m</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-n">emap_decode</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">code</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-n">fids</span><span class="tok-p">[</span><span class="tok-n">MAX_DSTS</span><span class="tok-p">])</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>get code (local fragment id) from position</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>get code (local fragment id) from box position</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>add a quantity to the map</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>get destination fragments from code</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flu_2">19.2. flu</h3>
<div class="paragraph">
<p>Exchange solvent particles within a cutoff radius from the neighboring
nodes.</p>
</div>
<div class="sect3">
<h4 id="_interface_16">19.2.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate the structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_pack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-n">EFluPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_comm_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EFluComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack_ini</span><span class="tok-p">(</span><span class="tok-kt">bool</span> <span class="tok-n">colors</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_pack_fin</span><span class="tok-p">(</span><span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_comm_fin</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>build the map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_compute_map</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">start</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">count</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_download_cell_starts</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>pack and copy data on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_pack</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">parray</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_download_data</span><span class="tok-p">(</span><span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate the packed data with neighbors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_post_recv</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_post_send</span><span class="tok-p">(</span><span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_wait_recv</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_wait_send</span><span class="tok-p">(</span><span class="tok-n">EFluComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack</span><span class="tok-p">(</span><span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">LFrag26</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">RFrag26</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_local_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">LFrag26</span> <span class="tok-o">*</span><span class="tok-n">lfrags</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_remote_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RFrag26</span> <span class="tok-o">*</span><span class="tok-n">rfrags</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack and get data informations needed by the <em>fluforces</em> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eflu_unpack</span><span class="tok-p">(</span><span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">LFrag26</span><span class="tok-p">;</span>
<span class="tok-k">using</span> <span class="tok-n">flu</span><span class="tok-o">::</span><span class="tok-n">RFrag26</span><span class="tok-p">;</span>

<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_local_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">LFrag26</span> <span class="tok-o">*</span><span class="tok-n">lfrags</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eflu_get_remote_frags</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EFluUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RFrag26</span> <span class="tok-o">*</span><span class="tok-n">rfrags</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_obj">19.3. obj</h3>
<div class="paragraph">
<p>Object exchanger is used to exchange particles from objects (<em>rbc</em> or
<em>rig</em>) with neighboring nodes for computing their interactions with
the solvent (<em>fsi</em>) or with other objects (<em>contact forces</em>).
It sends the remote forces back to the local node.</p>
</div>
<div class="paragraph">
<p>Sending back the forces is optional.</p>
</div>
<div class="sect3">
<h4 id="_particle_exchange_interface">19.3.1. particle exchange interface</h4>
<div class="paragraph">
<p>allocate, deallocate the structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxpsolid</span><span class="tok-p">,</span> <span class="tok-n">EObjPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">cart</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EObjComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxpsolid</span><span class="tok-p">,</span> <span class="tok-n">EObjUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_packf_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxpsolid</span><span class="tok-p">,</span> <span class="tok-n">EObjPackF</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_unpackf_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">maxpsolid</span><span class="tok-p">,</span> <span class="tok-n">EObjUnpackF</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>build the map from array of wrappers <code>PaWrap</code> containing array of particles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">ww</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EObjPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>pack the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_pack</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">ww</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EObjPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_download</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-n">EObjPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate the packed data with neighboring nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_post_recv</span><span class="tok-p">(</span><span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EObjUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_post_send</span><span class="tok-p">(</span><span class="tok-n">EObjPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_wait_recv</span><span class="tok-p">(</span><span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EObjUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_wait_send</span><span class="tok-p">(</span><span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>retrieve information about the received data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">int26</span> <span class="tok-nf">eobj_get_counts</span><span class="tok-p">(</span><span class="tok-n">EObjUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">Pap26</span> <span class="tok-nf">eobj_upload_shift</span><span class="tok-p">(</span><span class="tok-n">EObjUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-n">Fop26</span> <span class="tok-nf">eobj_reini_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EObjUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-n">EObjPackF</span> <span class="tok-o">*</span><span class="tok-n">pf</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>get the number of particles inside each fragment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>upload particles on device, shift them in local coordinates and
return device pointers</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>set forces on device to 0 and return device pointers</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_force_back_sender_interface">19.3.2. force back sender interface</h4>
<div class="paragraph">
<p>allocate, deallocate the optional structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_pack_fin</span><span class="tok-p">(</span><span class="tok-n">EObjPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_comm_fin</span><span class="tok-p">(</span><span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">EObjUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_packf_fin</span><span class="tok-p">(</span><span class="tok-n">EObjPackF</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_unpackf_fin</span><span class="tok-p">(</span><span class="tok-n">EObjUnpackF</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>download the forces on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_download_ff</span><span class="tok-p">(</span><span class="tok-n">EObjPackF</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate back the forces to neighbours:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_post_recv_ff</span><span class="tok-p">(</span><span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EObjUnpackF</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_post_send_ff</span><span class="tok-p">(</span><span class="tok-n">EObjPackF</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_wait_recv_ff</span><span class="tok-p">(</span><span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EObjUnpackF</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">eobj_wait_send_ff</span><span class="tok-p">(</span><span class="tok-n">EObjComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack forces arrays inside wrappers <code>FoWrap</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">eobj_unpack_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EObjUnpackF</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">EObjPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoWrap</span> <span class="tok-o">*</span><span class="tok-n">ww</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mesh">19.4. mesh</h3>
<div class="paragraph">
<p>exchange full mesh particles with neighbouring nodes when bounding box
of the mesh crosses or is close enough to the subdomain boundaries.
This is used for mesh bounce back or solvent recoloring.</p>
</div>
<div class="paragraph">
<p>It can optionally send back momentum data per triangles to original node.</p>
</div>
<div class="sect3">
<h4 id="_mesh_exchanger_interface">19.4.1. mesh exchanger interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_pack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">max_mesh_num</span><span class="tok-p">,</span> <span class="tok-n">EMeshPack</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_comm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMeshComm</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_unpack_ini</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">max_mesh_num</span><span class="tok-p">,</span> <span class="tok-n">EMeshUnpack</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">emesh_pack_fin</span><span class="tok-p">(</span><span class="tok-n">EMeshPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_comm_fin</span><span class="tok-p">(</span><span class="tok-n">EMeshComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_unpack_fin</span><span class="tok-p">(</span><span class="tok-n">EMeshUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>build map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_build_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMeshPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>pack data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_pack</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMeshPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_download</span><span class="tok-p">(</span><span class="tok-n">EMeshPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate data with neigbours:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_post_recv</span><span class="tok-p">(</span><span class="tok-n">EMeshComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EMeshUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_post_send</span><span class="tok-p">(</span><span class="tok-n">EMeshPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">EMeshComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_wait_recv</span><span class="tok-p">(</span><span class="tok-n">EMeshComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EMeshUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_wait_send</span><span class="tok-p">(</span><span class="tok-n">EMeshComm</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack the data to a single particle array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_unpack</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">EMeshUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">nmhalo</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the returned value <code>nmhalo</code> is the number of
received meshes</p>
</div>
<div class="paragraph">
<p>get number of mesh per fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_get_num_frag_mesh</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">EMeshUnpack</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-n">cc</span><span class="tok-p">[</span><span class="tok-n">NFRAGS</span><span class="tok-p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_back_momentum_sender_interface">19.4.2. back momentum sender interface</h4>
<div class="paragraph">
<p>allocate, deallocate the optional structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_packm_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">num_mom_per_mesh</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">max_mesh_num</span><span class="tok-p">,</span> <span class="tok-n">EMeshPackM</span> <span class="tok-o">**</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_commm_ini</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMeshCommM</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_unpackm_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">num_mom_per_mesh</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">max_mesh_num</span><span class="tok-p">,</span> <span class="tok-n">EMeshUnpackM</span> <span class="tok-o">**</span><span class="tok-n">u</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">emesh_packm_fin</span><span class="tok-p">(</span><span class="tok-n">EMeshPackM</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_commm_fin</span><span class="tok-p">(</span><span class="tok-n">EMeshCommM</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_unpackm_fin</span><span class="tok-p">(</span><span class="tok-n">EMeshUnpackM</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>pack the momentum infos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_packM</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nt</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[</span><span class="tok-n">NFRAGS</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-n">Momentum</span> <span class="tok-o">*</span><span class="tok-n">mm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">EMeshPackM</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_downloadM</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[</span><span class="tok-n">NFRAGS</span><span class="tok-p">],</span> <span class="tok-n">EMeshPackM</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate back the momentum infos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_post_recv</span><span class="tok-p">(</span><span class="tok-n">EMeshCommM</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EMeshUnpackM</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_post_send</span><span class="tok-p">(</span><span class="tok-n">EMeshPackM</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">EMeshCommM</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_wait_recv</span><span class="tok-p">(</span><span class="tok-n">EMeshCommM</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">EMeshUnpackM</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_wait_send</span><span class="tok-p">(</span><span class="tok-n">EMeshCommM</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack the momentum infos to a single array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">emesh_upload</span><span class="tok-p">(</span><span class="tok-n">EMeshUnpackM</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">emesh_unpack_mom</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nt</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">EMeshPack</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">EMeshUnpackM</span> <span class="tok-o">*</span><span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Momentum</span> <span class="tok-o">*</span><span class="tok-n">mm</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_common_2">19.5. common</h3>
<div class="paragraph">
<p>helper for common exchange operations</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">ecommon_pack_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">PackHelper</span> <span class="tok-n">ph</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Pap26</span> <span class="tok-n">buf</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">ecommon_shift_one_frag</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">fid</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>pack particles <code>pp</code> into 27 buffers <code>buf</code> according to the local map <code>ph</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>shift particles in the fragment direction</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The local map is defined through the structure</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">PackHelper</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">offsets</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">indices</span><span class="tok-p">[</span><span class="tok-n">NFRAGS</span><span class="tok-p">];</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which is a map for a single set of quantities.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fluforces">20. fluforces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>solvent forces</p>
</div>
<div class="sect2">
<h3 id="_interface_17">20.1. interface</h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_structures_8">20.2. data structures</h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_submodules">20.3. submodules</h3>
<div class="sect3">
<h4 id="_bulk">20.3.1. bulk</h4>
<div class="paragraph">
<p>compute local interactions of solvent particles, given cell starts,
cell counts (see <a href="clist.html">clist</a>) and particles array</p>
</div>
<div class="paragraph">
<p>The algorithm is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>each particle of the array has one thread assigned.</p>
</li>
<li>
<p>the thread runs over half of the 27 cell lists overlapping one cutoff radius
(this makes 13 cells + the "self cell")</p>
</li>
<li>
<p>in each cell, the particle ids are fetched from the cell starts
array</p>
</li>
<li>
<p>run over particles, atomic add the forces to them and gather forces
on the main particle</p>
</li>
<li>
<p>atomic add main forces to force array</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Performance is strongly related to the pattern used to run over the
particles.
Better performance is achieved by grouping as much as possible
consecutive particles (row), meaning that the <code>x</code> cell index runs
fastest.</p>
</div>
<div class="paragraph">
<p>The cell run order is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+----&gt; x   plane dz = -1:    plane dz =  0:    plane dz = +1:
|
|            00 01 02          09 10 11          xx xx xx
v y          03 04 05          12 13 xx          xx xx xx
             06 07 08          xx xx xx          xx xx xx</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>xx</code> denotes that the cell is not used by the current thread.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fluforces_halo">20.3.2. fluforces: halo</h4>
<div class="paragraph">
<p>solvent forces with remote particles (fragments)</p>
</div>
<div class="sect4">
<h5 id="_internals">Internals</h5>
<div class="paragraph">
<p>main kernel is <code>dev::forces</code> and performs all interactions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>dispatch threads along fragments</p>
</li>
<li>
<p>fetch generalized particle</p>
</li>
<li>
<p>build map (how to access neighboring particles?)</p>
</li>
<li>
<p>loop over neighboring particles according to map</p>
</li>
<li>
<p>compute pairwise interactions</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_frag">21. frag</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fragment functions on host and device</p>
</div>
<div class="sect2">
<h3 id="_purpose_3">21.1. purpose</h3>
<div class="paragraph">
<p>A <em>fragment</em> designates one of the 27 directions \((dx, dy, dz)\),
where \(dx, dy, dz \in \{-1, 0, 1\}\).</p>
</div>
<div class="paragraph">
<p>The fragment \((0, 0, 0)\) is called <em>bulk</em> and has the id <code>frag_bulk</code>.</p>
</div>
<div class="paragraph">
<p>The purpose of this module is to encode and decode the <em>fragments</em>
between <em>fragment ids</em> (numbered from 0 to 26) and <em>directions</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_18">21.2. interface</h3>
<div class="paragraph">
<p>The major part of the functions are available to both device and host,
within the namespaces <code>fragdev</code> and <code>fraghst</code>, respectively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">i2dx</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                 <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">i2dy</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                 <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">int</span> <span class="tok-nf">i2dz</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                 <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">i2d3</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-n">d</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>get \(dx\) from fragment id</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>get \(dy\) from fragment id</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>get \(dz\) from fragment id</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>get \((dx, dy, dz)\) from fragment id</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">d2i</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">z</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">d32i</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">d</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span>     <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>get fragment id from \((dx, dy, dz)\)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>idem with array as input</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">ncell</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>given sub-domain sizes <code>L</code>, returns number of neighboring cells to
fragment with id <code>i</code></td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">antid2i</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">z</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">int</span> <span class="tok-nf">anti</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">);</span>                  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>given \((dx, dy, dz)\), return the id of the <em>anti</em> fragment (i.e. with direction \((-dx, -dy, -dz)\))</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>given a fragment id, returns the id of the <em>anti</em> fragment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Only on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">estimates</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nfrags</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">maxd</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cap</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>given a maximum number density <code>maxp</code>, return an estimate of the
number of particles in each fragment layer.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fsi">22. fsi</h2>
<div class="sectionbody">
<div class="paragraph">
<p>flow-structure interactions between solvent and objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect2">
<h3 id="_interface_19">22.1. interface</h3>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">fsi_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">rank</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Fsi</span> <span class="tok-o">**</span><span class="tok-n">fsi</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">fsi_fin</span><span class="tok-p">(</span><span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">fsi_bind_solvent</span><span class="tok-p">(</span><span class="tok-n">PaArray</span> <span class="tok-n">pa</span><span class="tok-p">,</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">fsi_bulk</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nw</span><span class="tok-p">,</span> <span class="tok-n">PaWrap</span> <span class="tok-o">*</span><span class="tok-n">pw</span><span class="tok-p">,</span> <span class="tok-n">FoWrap</span> <span class="tok-o">*</span><span class="tok-n">fw</span><span class="tok-p">);</span>      <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">fsi_halo</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Fsi</span> <span class="tok-o">*</span><span class="tok-n">fsi</span><span class="tok-p">,</span> <span class="tok-n">Pap26</span> <span class="tok-n">PP</span><span class="tok-p">,</span> <span class="tok-n">Fop26</span> <span class="tok-n">FF</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">counts</span><span class="tok-p">[</span><span class="tok-mi">26</span><span class="tok-p">]);</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>store solvent interactions inside hidden structure <code>Fsi</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>compute the interactions between local objects and local solvent</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>compute the interactions between remote objects and local solvent</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_io">23. IO</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_text">23.1. Text</h3>
<div class="paragraph">
<p>Write one row per particle in a text file <code>path</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">txt_write_pp</span><span class="tok-p">(</span><span class="tok-kt">long</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_write_pp_ff</span><span class="tok-p">(</span><span class="tok-kt">long</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Read particles to a structure <code>TxtRead</code>. The <code>TxtRead</code> API returns the
number of particles and pointers to the data. <code>txt_read_fin</code> frees the
memory and invalidated pointers returned by <code>txt_read_get_pp</code> or
<code>txt_read_get_pp_ff</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">txt_read_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">TxtRead</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_read_pp_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">TxtRead</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_read_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">TxtRead</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">txt_read_fin</span><span class="tok-p">(</span><span class="tok-n">TxtRead</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">int</span> <span class="tok-nf">txt_read_get_n</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">TxtRead</span> <span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span> <span class="tok-nf">txt_read_get_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">TxtRead</span> <span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-k">const</span> <span class="tok-n">Force</span><span class="tok-o">*</span>    <span class="tok-nf">txt_read_get_ff</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">TxtRead</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Text format is a as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x y z vx vy vz [fx fy fz]
...
x y z vx vy vz [fx fy fz]</pre>
</div>
</div>
<div class="paragraph">
<p>where every row corresponds to a particle.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mesh_2">23.2. Mesh</h3>
<div class="paragraph">
<p>Read triangulated mesh from ascii
<a href="https://en.wikipedia.org/wiki/OFF_(file_format)">off</a>
or
<a href="https://en.wikipedia.org/wiki/PLY_(file_format)">ply</a>
files.
Vertices coordinates are packed into array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x0 y0 z0 x1 y1 z1 ... x[nv-1] y[nv-1] z[nv-1]</pre>
</div>
</div>
<div class="paragraph">
<p>Triangles are packed in array of <code>int4</code> with fields <code>w</code> left
unused. For example, traingle <code>i</code> is</p>
</div>
<div class="listingblock">
<div class="content">
<pre>tt[i].x tt[i].y tt[i].z</pre>
</div>
</div>
<div class="paragraph">
<p><code>mesh_get_nt</code>, <code>mesh_get_nv</code>, <code>mesh_get_ne</code>, and <code>mesh_get_md</code> return
the number of triangles, number of vertices, number of edges, and
maximum degree.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">mesh_read_ini_off</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">MeshRead</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">mesh_read_ini_ply</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">MeshRead</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">mesh_read_fin</span><span class="tok-p">(</span><span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">int</span> <span class="tok-nf">mesh_read_get_nt</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">mesh_read_get_nv</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">mesh_read_get_ne</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span> <span class="tok-nf">mesh_read_get_md</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-k">const</span> <span class="tok-n">int4</span>  <span class="tok-o">*</span><span class="tok-nf">mesh_read_get_tri</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-nf">mesh_read_get_vert</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_diagnostics">23.3. Diagnostics</h3>
<div class="sect3">
<h4 id="_particle">23.3.1. Particle</h4>
<div class="paragraph">
<p>Uses only particles values. Dumps output to log files and to file
<code>path</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">diag_part_ini</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">DiagPart</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">diag_part_fin</span><span class="tok-p">(</span><span class="tok-n">DiagPart</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">diag_part_apply</span><span class="tok-p">(</span><span class="tok-n">DiagPart</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">time</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mesh_3">23.3.2. Mesh</h4>
<div class="paragraph">
<p>Uses particle values and mesh.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_point">23.4. Point</h3>
<div class="paragraph">
<p>Write point data to <code>bop</code> files.</p>
</div>
<div class="paragraph">
<p>A configuration structure</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">io_point_conf_ini</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">IOPointConf</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">io_point_conf_fin</span><span class="tok-p">(</span><span class="tok-n">IOPointConf</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">io_point_conf_push</span><span class="tok-p">(</span><span class="tok-n">IOPointConf</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">keys</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Push data</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">io_point_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxn</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">IOPointConf</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">IOPoint</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">io_point_fin</span><span class="tok-p">(</span><span class="tok-n">IOPoint</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">io_point_push</span><span class="tok-p">(</span><span class="tok-n">IOPoint</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-o">*</span><span class="tok-n">data</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">keys</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">io_point_write</span><span class="tok-p">(</span><span class="tok-n">IOPoint</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span>    <span class="tok-k">enum</span> <span class="tok-p">{</span><span class="tok-n">X</span><span class="tok-p">,</span> <span class="tok-n">Y</span><span class="tok-p">,</span> <span class="tok-n">Z</span><span class="tok-p">};</span>
    <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">id</span><span class="tok-p">;</span>
    <span class="tok-kt">double</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-n">rr</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-o">*</span><span class="tok-n">MAX_N</span><span class="tok-p">],</span> <span class="tok-n">density</span><span class="tok-p">[</span><span class="tok-n">MAX_N</span><span class="tok-p">];</span>
    <span class="tok-n">IOPointConf</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">;</span>
    <span class="tok-n">IOPoint</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">;</span>
    <span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">MAX_N</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
        <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-o">&amp;</span><span class="tok-n">rr</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">];</span>
        <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">X</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">i</span><span class="tok-p">;</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">Y</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">10</span><span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">;</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-n">Z</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-mi">100</span><span class="tok-o">*</span><span class="tok-n">i</span><span class="tok-p">;</span>
        <span class="tok-n">density</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-o">-</span><span class="tok-n">i</span><span class="tok-p">;</span>
    <span class="tok-p">}</span>
    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_conf_ini</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">c</span><span class="tok-p">));</span>
    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_conf_push</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-s">&quot;x y z&quot;</span><span class="tok-p">));</span>
    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_conf_push</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-s">&quot;density&quot;</span><span class="tok-p">));</span>
    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_ini</span><span class="tok-p">(</span><span class="tok-n">MAX_N</span><span class="tok-p">,</span> <span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">p</span><span class="tok-p">));</span>
    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_conf_fin</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">));</span>

    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_push</span><span class="tok-p">(</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">MAX_N</span><span class="tok-p">,</span> <span class="tok-n">rr</span><span class="tok-p">,</span> <span class="tok-s">&quot;x y z&quot;</span><span class="tok-p">));</span>
    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_push</span><span class="tok-p">(</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">MAX_N</span><span class="tok-p">,</span> <span class="tok-n">density</span><span class="tok-p">,</span> <span class="tok-s">&quot;density&quot;</span><span class="tok-p">));</span>
    <span class="tok-n">id</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span>
    <span class="tok-n">UC</span><span class="tok-p">(</span><span class="tok-n">io_point_write</span><span class="tok-p">(</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">id</span><span class="tok-p">));</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_math">24. Math</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helpers for math operations and random number generation</p>
</div>
<div class="sect2">
<h3 id="_linal">24.1. linal</h3>
<div class="paragraph">
<p>Linear algebra functions</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">linal_inv3x3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">m0</span><span class="tok-p">[</span><span class="tok-mi">6</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span> <span class="tok-n">minv0</span><span class="tok-p">[</span><span class="tok-mi">6</span><span class="tok-p">]);</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>inverse symmetric 3 by 3 matrix; fails for singular matrices with
determinant smaller than epsilon (hardcoded to <code>1e-8</code>).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>structure of the matrix is <code>xx, xy, yy, yz, zz</code>, where</p>
</div>
<div class="listingblock">
<div class="content">
<pre>     ( xx xy xz)
A =  ( xy yy yz)
     ( xz yz zz)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_host_random_number_generation">24.2. Host random number generation</h3>
<div class="paragraph">
<p>Generate uniform random numbers on host in floating point precision. Uses
<a href="https://en.wikipedia.org/wiki/KISS_(algorithm)">KISS algorithm</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">RNDunif</span><span class="tok-p">;</span>                                             <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rnd_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">y</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">z</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RNDunif</span> <span class="tok-o">**</span><span class="tok-n">r</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rnd_fin</span><span class="tok-p">(</span><span class="tok-n">RNDunif</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">);</span>                                   <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">float</span> <span class="tok-nf">rnd_get</span><span class="tok-p">(</span><span class="tok-n">RNDunif</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">);</span>                                  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>hidden structure containing state of the rng</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>allocate and initialize the rng (<code>x</code>, <code>y</code>, <code>z</code> and <code>c</code> are states of the rng)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>deallocate rng states</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>generate a random number in single precision; modify the state</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_linar_coordinate_transformation_for_3d_vector">24.3. linar coordinate transformation for 3D vector</h3>
<div class="paragraph">
<p>Transform vector <code>a[3]</code> to <code>b[3]</code> using</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    b[X] = s[X]*a[X] + o[X]
    b[Y] = s[Y]*a[Y] + o[Y]
    b[Z] = s[Z]*a[Z] + o[Z]</pre>
</div>
</div>
<div class="paragraph">
<p>Coefficient <code>s</code> and <code>o</code> are defined implicitly by API calls.</p>
</div>
<div class="sect3">
<h4 id="_interface_20">24.3.1. interface</h4>
<div class="sect4">
<h5 id="_allocate_deallocate">Allocate/Deallocate</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_ini</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">tform_fin</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters of the transformation, some transfroms are for grids
which are cell centered and defined by low and high boundaries and the
number of cell.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_vector</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a1</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span>   <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">b0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">b1</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">tform_chain</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Tform</span> <span class="tok-o">*</span><span class="tok-n">A</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Tform</span> <span class="tok-o">*</span><span class="tok-n">B</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span> <span class="tok-o">*</span><span class="tok-n">C</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">tform_to_grid</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">lo</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">hi</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">tform_from_grid</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">b0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-kt">void</span> <span class="tok-nf">tform_grid2grid</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">f_lo</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">f_hi</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">f_n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span>
                     <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">t_lo</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">t_hi</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">t_n</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span>
                     <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>converts vectors <code>a0</code> to <code>a1</code> and <code>b0</code> to <code>b1</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a chain of two transforms: C(x) is equivalent to 'B(A(x))'</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>transfrom to a grid: for example, it transfroms <code>lo</code> to <code>-1/2</code> and <code>hi</code> to <code>n - 1/2</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>transfrom from a grid: for example, it transfroms <code>-1/2</code> to <code>lo</code> and <code>n - 1/2</code> to <code>hi</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>grid to grid transform</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_convert_vector">Convert vector</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_convert</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a0</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span> <span class="tok-n">a1</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_convert_to_view">convert to view</h6>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_to_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Tform_v</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_log">log</h6>
<div class="paragraph">
<p>Log or dump the state of 'Tform'</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">tform_log</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">tform_dump</span><span class="tok-p">(</span><span class="tok-n">Tform</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">FILE</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions_for_a_triangle">24.4. functions for a triangle</h3>
<div class="paragraph">
<p>Host and device functions for a triangle. For
area computation
<a href="https://people.eecs.berkeley.edu/~wkahan/Triangle.pdf">a formula</a>
stable to numerical error is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">double</span> <span class="tok-nf">kahan_area0</span><span class="tok-p">(</span><span class="tok-kt">double</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">double</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-kt">double</span> <span class="tok-n">c</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">double</span> <span class="tok-nf">kahan_area</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">a</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">b</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span>   <span class="tok-nf">ac_bc_cross</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">a</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">b</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-cm">/**/</span> <span class="tok-kt">double</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">double</span> <span class="tok-nf">shewchuk_area</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">a</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">b</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-kt">double</span> <span class="tok-nf">orient3d</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">a</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">b</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">d</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dihedral_xy</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">a</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">b</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">d</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span>
                   <span class="tok-kt">double</span> <span class="tok-o">*</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">double</span> <span class="tok-o">*</span><span class="tok-n">y</span><span class="tok-p">);</span> <i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-kt">void</span> <span class="tok-nf">dihedral_xy0</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">a</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">b</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span> <span class="tok-k">const</span> <span class="tok-kt">double</span> <span class="tok-n">d</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">],</span>
                   <span class="tok-kt">double</span> <span class="tok-o">*</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-kt">double</span> <span class="tok-o">*</span><span class="tok-n">y</span><span class="tok-p">);</span> <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>returns area of a triangle given sides</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>returns area of a triangle given coordinate of the vertices</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scheme_move">25. scheme/move</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Time scheme update</p>
</div>
<div class="paragraph">
<p>Currently implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Forward Euler</p>
</li>
<li>
<p>Velocity-Verlet</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_interface_21">25.1. interface</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_move_apply</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">mass</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_move_clear_vel</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>apply one step of the time scheme to the particles</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>set velocity of particles to 0</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pair">26. pair</h2>
<div class="sectionbody">
<div class="paragraph">
<p>pairwise forces.
manages the parameters for dpd and repulsive Lennard-Jones parameters.</p>
</div>
<div class="sect2">
<h3 id="_dpd_interactions">26.1. dpd interactions</h3>
<div class="paragraph">
<p>DPD particles interact via the following force:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{F}_{ij} = \left( F_{ij}^C + F_{ij}^R + F_{ij}^D \right) \mathbf{e}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^C = \alpha \max \left( 1 - \frac{r_{ij}} {r_c}, 0 \right)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^R = \sigma w(r_{ij}) W_{ij}\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^D = -\gamma w(r_{ij})^2 \mathbf{v}_{ij} \cdot \mathbf{r}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{r}_{ij} = \mathbf{r}_i - \mathbf{r}_j, \\
r_{ij} = | \mathbf{r}_{ij} |, \\
\mathbf{v}_{ij} = \mathbf{v}_i - \mathbf{v}_j.\]
</div>
</div>
<div class="paragraph">
<p>The viscous kernel is given by</p>
</div>
<div class="stemblock">
<div class="content">
\[w(r) = r^{\frac{1}{2^s}},\]
</div>
</div>
<div class="paragraph">
<p>where \(s\) is the <code>S_LEVEL</code> compile time option set to <code>2</code> by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="_repulsive_lj">26.2. repulsive LJ</h3>
<div class="paragraph">
<p>Repulsive forces for contact are implemented using the repulsive LJ
potential. It is given by</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{F}_{ij} = F_{ij}^{rLJ} \mathbf{e}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^{rLJ} = \max \left( 0, F^{LJ}(r_{ij})\right)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F^{LJ}(r) = 24 \epsilon \frac{1}{r} \left( 2 \left[\frac \sigma r
\right]^12 - \left[\frac \sigma r \right]^6 \right)\]
</div>
</div>
<div class="paragraph">
<p>for numerical reasons, the magnitude is limited to \(10^4\).</p>
</div>
</div>
<div class="sect2">
<h3 id="_host_interface_2">26.3. Host interface</h3>
<div class="paragraph">
<p>allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_ini</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_fin</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>set parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_set_dpd</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ncol</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[],</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">g</span><span class="tok-p">[],</span> <span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">pair_set_lj</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">sigma</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">eps</span><span class="tok-p">,</span> <span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>set the DPD parameters. <code>ncol</code> is the number of colors. This is
mandatory for any view</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>set the Lennard-Jones parameters \(\sigma\) and
\(\epsilon\). This may be called only when the LJ parameters are needed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>set parameters from configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">name_space</span><span class="tok-p">,</span> <span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the argument <code>name_space</code> denotes the namespace where to look for the
parameters (see below).</p>
</div>
<div class="paragraph">
<p>Compute the \(\sigma\) parameter for a given temperature and timestep:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_ini</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_fin</span><span class="tok-p">(</span><span class="tok-n">PairParams</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get the different views:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPD</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd_color</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPDC</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd_mirrored</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPDCM</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">pair_get_view_dpd_lj</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairParams</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">PairDPDLJ</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_device_interface">26.4. device interface</h3>
<div class="paragraph">
<p>Inside a CUDA kernel, the pairwise force can be called by the generic function</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-k">typename</span> <span class="tok-n">Param</span><span class="tok-p">,</span> <span class="tok-k">typename</span> <span class="tok-n">Fo</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">pair_force</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Param</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">PairPa</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">PairPa</span> <span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">rnd</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Fo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>PairPa</code> structure is a generic particle with color.
This should be used with the <em>parray</em> module.
The <code>Fo</code> structure is a generic force and can be either <code>PairFo</code> or
<code>PairSFo</code>, respectively, for force or force and stress computation.
This should be used with the <em>farray</em> module.
The input parameter <code>Param p</code> is a view for pair parameters.</p>
</div>
<div class="paragraph">
<p>The above function behaves differently given different types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PairDPD</code>: standard DPD interaction</p>
</li>
<li>
<p><code>PairDPDLJ</code>: standard DPD and repulsive LJ interaction</p>
</li>
<li>
<p><code>PairDPDC</code>: <em>colored</em> DPD interaction: pick up parameters as a function
of the particle colors</p>
</li>
<li>
<p><code>PairDPDCM</code>: <em>mirrored</em> DPD: same as <em>colored</em> DPD considering that
particle <code>b</code> has the same color as particle <code>a</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Inside a kernel, the generic force can be added by using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">pair_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">)</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">pair_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">b</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_7">26.5. Configuration</h3>
<div class="paragraph">
<p>parameters are configured through 3 namespaces: <code>flu</code>, <code>fsi</code> and
<code>cnt</code>.</p>
</div>
<div class="paragraph">
<p>example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">flu</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    dpd = true</span>
<span class="tok-s">    a = [10.0, 80.0, 10.0]</span>
<span class="tok-s">    g = [1.0, 8.0, 15.0]</span>
<span class="tok-s">    lj = false</span>
<span class="tok-na">}</span>

<span class="tok-na">fsi</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    dpd = true</span>
<span class="tok-s">    a = [10.0, 80.0, 10.0]</span>
<span class="tok-s">    g = [1.0, 8.0, 15.0]</span>
<span class="tok-s">    lj = false</span>
<span class="tok-na">}</span>

<span class="tok-na">cnt</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    dpd = true</span>
<span class="tok-s">    a = [0.0]</span>
<span class="tok-s">    g = [16.0]</span>
<span class="tok-s">    lj = true</span>
<span class="tok-s">    ljs = 0.3</span>
<span class="tok-s">    lje = 0.44</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The DPD parameters can be different when many colors are set.
User provides parameters in an array following the packed symmetric
matrix convention. For example the interaction table for 3 colors</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    x_{11} &amp; x_{12} &amp; x_{13} \\
    x_{12} &amp; x_{22} &amp; x_{23} \\
    x_{13} &amp; x_{23} &amp; x_{33}
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>becomes</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    x_{11} &amp; x_{12} &amp; x_{13} &amp; x_{22} &amp; x_{23} &amp; x_{33}
\end{bmatrix}.\]
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parray">27. parray</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Generic particle array to be passed to interaction kernels.</p>
</div>
<div class="sect2">
<h3 id="_host_interface_3">27.1. host interface</h3>
<div class="paragraph">
<p>A <code>PaArray</code> structure can be configured by pushing particles and,
optionally, colors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">parray_push_pp</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">parray_push_cc</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">,</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Particles must be pushed before colors
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Client can check if the colors has been pushed by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">bool</span> <span class="tok-nf">parray_is_colored</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The particle array data are meant to be passed to kernels.
In order to inline the fetching mode (see device interface), different
views can be generated from the <code>PaArray</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">parray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">PaArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">parray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PaArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">PaCArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a view to fetch particles without colors</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a view to fetch particles with colors</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_device_interface_2">27.2. device interface</h3>
<div class="paragraph">
<p>Generic particle (see <em>pair</em> module)  can be fetched depending on the view:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">_I_</span> <span class="tok-kt">void</span> <span class="tok-n">parray_get</span><span class="tok-p">(</span><span class="tok-n">PaArray_v</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairPa</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">_I_</span> <span class="tok-kt">void</span> <span class="tok-n">parray_get</span><span class="tok-p">(</span><span class="tok-n">PaCArray_v</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">PairPa</span> <span class="tok-o">*</span><span class="tok-n">p</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>fetch position and velocity only</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>fetch position, velocity and color</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_farray">28. farray</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Generic force array to be passed to interaction kernels.
Implemented versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>forces only</p>
</li>
<li>
<p>forces and stresses</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_host_interface_4">28.1. host interface</h3>
<div class="paragraph">
<p>A <code>FoArray</code> structure can be configured by pushing forces and,
optionally, stresses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">farray_push_ff</span><span class="tok-p">(</span><span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">farray_push_ss</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Forces must be pushed before stresses
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Client can check if the stresses has been pushed by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">bool</span> <span class="tok-nf">farray_has_stress</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The force array data are meant to be passed to kernels.
In order to inline the forces computations mode (see device interface), different
views can be generated from the <code>FoArray</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">farray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">FoArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">farray_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">FoArray</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">FoSArray_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get a view to compute forces only</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get a view to compute forces and stresses</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_device_interface_3">28.2. device interface</h3>
<div class="paragraph">
<p>Generic forces (see <em>pair</em> module) can be added to the generic force
array depending on the view type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-n">_I_</span> <span class="tok-kt">void</span> <span class="tok-n">farray_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-n">_I_</span> <span class="tok-kt">void</span> <span class="tok-n">farray_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoSArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>add forces only to the array</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>add forces and stresse to the array</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The template parameter <code>S</code> is the sign, must be either <code>-1</code> or <code>1</code>.
Note that it only affects the forces, stresses are always added with
positive sign, as opposed to forces.</p>
</div>
<div class="paragraph">
<p>For equivalent atomic operations, the following functions can be called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-n">_I_</span> <span class="tok-kt">void</span> <span class="tok-n">farray_atomic_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span>
<span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-kt">int</span> <span class="tok-n">S</span><span class="tok-o">&gt;</span>
<span class="tok-n">_I_</span> <span class="tok-kt">void</span> <span class="tok-n">farray_atomic_add</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">PairSFo</span> <span class="tok-o">*</span><span class="tok-n">f</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">FoSArray_v</span> <span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The generic Force structure can be initialised to 0 based on the type
of the Generic array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">_I_</span> <span class="tok-n">PairFo</span> <span class="tok-n">farray_fo0</span><span class="tok-p">(</span><span class="tok-n">FoArray_v</span><span class="tok-p">)</span>
<span class="tok-n">_I_</span> <span class="tok-n">PairSFo</span> <span class="tok-n">farray_fo0</span><span class="tok-p">(</span><span class="tok-n">FoSArray_v</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_file_reader">29. configuration file reader</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_purpose_4">29.1. purpose</h3>
<div class="ulist">
<ul>
<li>
<p>wrapper for the <code>libconfig</code> library</p>
</li>
<li>
<p>holds configurations from 4 sources:</p>
<div class="ulist">
<ul>
<li>
<p>set by program (priority 4)</p>
</li>
<li>
<p>arguments (priority 3)</p>
</li>
<li>
<p>configuration file (priority 2)</p>
</li>
<li>
<p>default parameters (priority 1)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When retrieving a value, the source with higher priority is used.
If not found in a source, the value is retrieved from the next highest
priority.
If no source contains the parmeter, an error is raised.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_structure_3">29.2. data structure</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span>
    <span class="tok-n">EXE</span><span class="tok-p">,</span> <span class="tok-cm">/* from program setters */</span>
    <span class="tok-n">ARG</span><span class="tok-p">,</span> <span class="tok-cm">/* from arguments       */</span>
    <span class="tok-n">OPT</span><span class="tok-p">,</span> <span class="tok-cm">/* from additional file */</span>
    <span class="tok-n">DEF</span><span class="tok-p">,</span> <span class="tok-cm">/* from default file    */</span>
    <span class="tok-n">NCFG</span>
<span class="tok-p">};</span>

<span class="tok-k">struct</span> <span class="tok-n">Config</span> <span class="tok-p">{</span>
    <span class="tok-n">config_t</span> <span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-n">NCFG</span><span class="tok-p">];</span>
    <span class="tok-n">config_t</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">;</span> <span class="tok-cm">/* what have been read */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Consists of an array of <code>config_t</code> descriptors, ordered by priority.
Indices correspond to the <code>enum</code> keys.
The first key has the highest priority, second key has second highest
priority etc.</p>
</div>
<div class="paragraph">
<p>The <code>r</code> field is the configuration history, i.e what is read by the program.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_22">29.3. interface</h3>
<div class="paragraph">
<p>Allocate and free the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_ini</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Config</span> <span class="tok-o">**</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Read data from the default, optional and command line config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_read</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">argc</span><span class="tok-p">,</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">argv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_int</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_float</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_bool</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_string</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_vint</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_int3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_vfloat</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_lookup_float3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the program raises an error if the argument is not found or
if an error occured (e.g. wrong type).</p>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_int</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_float</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_bool</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_string</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">**</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_vint</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_int3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_vfloat</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[]);</span>
<span class="tok-kt">bool</span> <span class="tok-nf">conf_opt_float3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The program does not raise error if the variable is not found.
The return value is <code>true</code> if the variable has been found and <code>false</code>
otherwise.</p>
</div>
<div class="paragraph">
<p>The client may overwrite variables in the config object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_set_int</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">c</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_vint</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nelem</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">[],</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_int3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_float</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_vfloat</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nelem</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-n">a</span><span class="tok-p">[],</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_float3</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_bool</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">conf_set_string</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>desc</code> contains the names of the nested groups. separated by a <code>.</code> or
a <code>/</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">desc</span> <span class="tok-o">=</span> <span class="tok-s">&quot;main.sub.a&quot;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>will correspond to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-n">main</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-n">sub</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-p">...</span>
    <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration can be dumped by using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">conf_write_exe</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-kt">FILE</span> <span class="tok-o">*</span><span class="tok-n">stream</span><span class="tok-p">);</span>     <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">conf_write_history</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-kt">FILE</span> <span class="tok-o">*</span><span class="tok-n">stream</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>dump the fields set by the program to a stream</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>dump the fields read by the program to a stream</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_partlist">30. partlist</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Part list: a structure to handle a list of dead or alive particles
Purpose: kill particles during redistribution or cell lists build</p>
</div>
<div class="sect2">
<h3 id="_data_structure_4">30.1. data structure</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">PartList</span> <span class="tok-p">{</span>
    <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">;</span>   <span class="tok-cm">/* particles array          */</span>
    <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">deathlist</span><span class="tok-p">;</span> <span class="tok-cm">/* what pp is dead or alive */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_23">30.2. interface</h3>
<div class="paragraph">
<p>contains only device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">bool</span> <span class="tok-nf">is_dead</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">lp</span><span class="tok-p">.</span><span class="tok-n">deathlist</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">lp</span><span class="tok-p">.</span><span class="tok-n">deathlist</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">DEAD</span><span class="tok-p">;</span>
    <span class="tok-k">return</span> <span class="tok-nb">false</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">bool</span> <span class="tok-nf">is_alive</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">PartList</span> <span class="tok-n">lp</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-k">return</span> <span class="tok-o">!</span><span class="tok-n">is_dead</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">lp</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_triangles">31. Triangles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Triangles on device. It is created from <code>MeshRead*</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">triangles_ini</span><span class="tok-p">(</span><span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Triangles</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">triangles_fin</span><span class="tok-p">(</span><span class="tok-n">Triangles</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>a client should include <code>type.h</code> add access fields directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">Triangles</span> <span class="tok-p">{</span>
    <span class="tok-n">int4</span> <span class="tok-o">*</span><span class="tok-n">tt</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">nt</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>nt</code> is a number of triangles.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compute_volume_of_a_mesh">32. compute volume of a mesh</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compute an area of a triangulated mesh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">mesh_volume_ini</span><span class="tok-p">(</span><span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">MeshVolume</span><span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">mesh_volume_fin</span><span class="tok-p">(</span><span class="tok-n">MeshVolume</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">double</span> <span class="tok-nf">mesh_volume_apply0</span><span class="tok-p">(</span><span class="tok-n">MeshVolume</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Vectors</span><span class="tok-o">*</span><span class="tok-p">);</span>                      <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span>  <span class="tok-nf">mesh_volume_apply</span><span class="tok-p">(</span><span class="tok-n">MeshVolume</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-n">Vectors</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">double</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>in initialization triangles are stored</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>compute an area for one object</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>compute an area for <code>nm</code> objects</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compute_volume_of_a_mesh_2">33. compute volume of a mesh</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compute a volume enclosed by a triangulated mesh on host.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">mesh_volume_ini</span><span class="tok-p">(</span><span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">MeshVolume</span><span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">mesh_volume_fin</span><span class="tok-p">(</span><span class="tok-n">MeshVolume</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">double</span> <span class="tok-nf">mesh_volume_apply0</span><span class="tok-p">(</span><span class="tok-n">MeshVolume</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Vectors</span><span class="tok-o">*</span><span class="tok-p">);</span>                      <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span>  <span class="tok-nf">mesh_volume_apply</span><span class="tok-p">(</span><span class="tok-n">MeshVolume</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-n">Vectors</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">double</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>in initialization triangles are stored</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>compute volume for one object</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>compute volume for <code>nm</code> objects</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compute_volume_of_a_mesh_3">34. compute volume of a mesh</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compute a an area for every triangle of the mesh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">mesh_tri_area_ini</span><span class="tok-p">(</span><span class="tok-n">MeshRead</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">MeshTriArea</span><span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">mesh_tri_area_fin</span><span class="tok-p">(</span><span class="tok-n">MeshTriArea</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">void</span>  <span class="tok-nf">mesh_tri_area_apply</span><span class="tok-p">(</span><span class="tok-n">MeshTriArea</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-n">Vectors</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">double</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>in initialization triangles are stored</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>compute areas</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>nm</code> is a number of meshes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_positions">35. Positions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Host array of vectors for size three.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">vectors_float_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Vectors</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vectors_postions_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Vectors</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vectors_postions_edge_ini</span>  <span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Vectors</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vectors_postions_center_ini</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Vectors</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vectors_velocities_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Vectors</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vectors_zero_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Vectors</span><span class="tok-o">**</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">vectors_fin</span><span class="tok-p">(</span><span class="tok-n">Vectors</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">vectors_get</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Vectors</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_meshbb">36. meshbb</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bounce back particles on a moving mesh</p>
</div>
<div class="paragraph">
<p>Let define the following quantities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(\mathbf{r}_0, \mathbf{v}_0\) : particle at time \(0\)</p>
</li>
<li>
<p>\(\mathbf{r}_1, \mathbf{v}_1\) : particle at time \(dt\) if
there is no collision</p>
</li>
<li>
<p>\(\mathbf{r}_n, \mathbf{v}_n\) : particle at time \(dt\) after
bounce back</p>
</li>
<li>
<p>\(h \in [0, dt\)] : collision time</p>
</li>
<li>
<p>\(\mathbf{r}_w, \mathbf{v}_w\) : collision position and velocity
of the surface</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A particle colliding with a surface is bounced back as:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{v}_n = 2 \mathbf{v}_w - \mathbf{v}_0, \\
\mathbf{r}_n = \mathbf{r}_w + (dt - h) \mathbf{v}_n.\]
</div>
</div>
<div class="paragraph">
<p>This module computes the collision time, position and velocity for a
moving triangle.
The motion of the triangle points are assumed to be linear:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{a}(t) = (1 - t) \mathbf{a}_0 + t \mathbf{a}_1, \\
\mathbf{b}(t) = (1 - t) \mathbf{b}_0 + t \mathbf{b}_1, \\
\mathbf{c}(t) = (1 - t) \mathbf{c}_0 + t \mathbf{c}_1.\]
</div>
</div>
<div class="sect2">
<h3 id="_interface_24">36.1. interface</h3>
<div class="paragraph">
<p>Allocate and deallocate <code>MeshBB</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">meshbb_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxpp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">MeshBB</span> <span class="tok-o">**</span><span class="tok-n">d</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">meshbb_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">MeshBB</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bouncing particles on a set of mesh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">meshbb_reini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">MeshBB</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">meshbb_find_collisions</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-n">MeshInfo</span> <span class="tok-n">meshinfo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">i_pp</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">L</span><span class="tok-p">,</span>
                            <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">starts</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">MeshBB</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">);</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">meshbb_select_collisions</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">MeshBB</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">);</span>  <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">meshbb_bounce</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">mass</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">MeshBB</span> <span class="tok-o">*</span><span class="tok-n">d</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-n">MeshInfo</span> <span class="tok-n">meshinfo</span><span class="tok-p">,</span>
                   <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">i_pp</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">Momentum</span> <span class="tok-o">*</span><span class="tok-n">mm</span><span class="tok-p">);</span>  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>reinitialise the structure (must be done before a new time step)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>store collision informations inside the structure with a set of
mesh. This can be done for multiple mesh sets.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For each bouncing particle, select the collision with minimum
time. Must be called after finding all collisions.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>bounce particles and store the momentum changes per triangle</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The momentum changes computed above can be collected to rigid objects
or to membrane mesh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">meshbb_collect_rig_momentum</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-n">MeshInfo</span> <span class="tok-n">meshinfo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Momentum</span> <span class="tok-o">*</span><span class="tok-n">mm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">meshbb_collect_rbc_momentum</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nc</span><span class="tok-p">,</span> <span class="tok-n">MeshInfo</span> <span class="tok-n">meshinfo</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Momentum</span> <span class="tok-o">*</span><span class="tok-n">mm</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Reduce <code>Momentum</code> array into one force and torque per rigid
object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Convert momentum information into forces for membrane particles.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_affine_transformation_matrices">37. affine transformation matrices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An array of <code>4 x 4</code> affine transformation matrices.</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    \vec{y} \\ 1
\end{bmatrix}
=
\left[
    \begin{array}{ccc|c}
        \, &amp; A &amp; &amp; \vec{b} \ \\ 0 &amp; \ldots &amp; 0 &amp; 1
    \end{array}
\right]
\begin{bmatrix}
    \vec{x} \\ 1
\end{bmatrix}\]
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">matrices_read</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Matrices</span><span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">matrices_read_filter</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Coords</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Matrices</span><span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-kt">void</span> <span class="tok-nf">matrices_get</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Matrices</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">double</span><span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">matrices_get_r</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Matrices</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">double</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">]);</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-kt">int</span>  <span class="tok-nf">matrices_get_n</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Matrices</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-kt">void</span> <span class="tok-nf">matrices_log</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Matrices</span><span class="tok-o">*</span><span class="tok-p">);</span>   <i class="conum" data-value="6"></i><b>(6)</b>

<span class="tok-kt">void</span> <span class="tok-nf">matrices_fin</span><span class="tok-p">(</span><span class="tok-n">Matrices</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>read from input file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>read from input file and keep only matrices which "belong" to this
MPI rank</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>return matrix as <code>double[16]</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>return a shift of a matrix as <code>double[3]</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>return a number of matrices</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>log an array of matrices to <code>stderr</code> using <code>msg_print</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mesh_adjacency_structure">38. mesh adjacency structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider closed triangulated mesh with <code>nv</code> vertices. Degree of a
vertex is the number of edges incident to the vertex. Let <code>md</code> is a
maximum degree of the vertices. There are three types of forces: edge
forces which depend on two vertices, triangle forces which depend on
three vertices, and dihedral forces which depend of four vertices
(edge and two adjusting triangles). To compute forces in one membrane
<em>uDeviceX</em> launches <code>nv * md</code> threads, each thread adds forces to only
one vertices.  <code>Adj_v</code> has an API call which allows for a given thread
ID to find which vertices should be used in forces computation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">int</span> <span class="tok-nf">adj_get_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">Adj_v</span> <span class="tok-o">*</span><span class="tok-n">adj</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">AdjMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">)</span> <span class="tok-p">{</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>md * nv</code> is bigger than the number of edges in the membrane and
some threads are not needed. The function returns 0 in this case.
<code>AdjMap</code> is a structure which contains five indices and an ID of the
mesh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-k">struct</span> <span class="tok-n">AdjMap</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">i0</span><span class="tok-p">,</span> <span class="tok-n">i1</span><span class="tok-p">,</span> <span class="tok-n">i2</span><span class="tok-p">,</span> <span class="tok-n">i3</span><span class="tok-p">,</span> <span class="tok-n">i4</span><span class="tok-p">;</span>
    <span class="tok-kt">int</span> <span class="tok-n">rbc</span><span class="tok-p">;</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each thread adds force to a vertices with index <code>0</code>. It considers edge
<code>01</code>, triangle <code>012</code>, and two dihedrals <code>0124</code> and <code>1203</code>. For
example, a contribution of edge force <code>01</code> to vertex <code>1</code> is added by
another thread.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/udoc/include/dih.png" alt="dih">
</div>
</div>
<div class="paragraph">
<p><code>Adj_v</code> is initilized from a host structure <code>Adj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">adj_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">md</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">int4</span> <span class="tok-o">*</span><span class="tok-n">tt</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Adj</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">adj_fin</span><span class="tok-p">(</span><span class="tok-n">Adj</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">int</span>  <span class="tok-nf">adj_get_map</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Adj</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">AdjMap</span> <span class="tok-o">*</span><span class="tok-n">m</span><span class="tok-p">);</span>
<span class="tok-kt">int</span>  <span class="tok-nf">adj_get_max</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Adj</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">adj_get_anti</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Adj</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">anti</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">adj_view_ini</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Adj</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Adj_v</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">adj_view_fin</span><span class="tok-p">(</span><span class="tok-n">Adj_v</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Adj</code> can be used to pack data which can be asseced on device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">A</span><span class="tok-p">;</span>
<span class="tok-n">n</span> <span class="tok-o">=</span> <span class="tok-n">adj_get_max</span><span class="tok-p">(</span><span class="tok-n">adj</span><span class="tok-p">);</span>
<span class="tok-n">EMALLOC</span><span class="tok-p">(</span><span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-o">&amp;</span><span class="tok-n">A</span><span class="tok-p">);</span>
<span class="tok-k">for</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">;</span> <span class="tok-n">i</span> <span class="tok-o">&lt;</span> <span class="tok-n">n</span><span class="tok-p">;</span> <span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span> <span class="tok-p">{</span>
   <span class="tok-n">valid</span> <span class="tok-o">=</span> <span class="tok-n">adj_get_map</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">adj</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-o">&amp;</span><span class="tok-n">m</span><span class="tok-p">);</span>
   <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">valid</span><span class="tok-p">)</span> <span class="tok-k">continue</span><span class="tok-p">;</span>
   <span class="tok-n">i0</span> <span class="tok-o">=</span> <span class="tok-n">m</span><span class="tok-p">.</span><span class="tok-n">i0</span><span class="tok-p">;</span> <span class="tok-n">i1</span> <span class="tok-o">=</span> <span class="tok-n">m</span><span class="tok-p">.</span><span class="tok-n">i1</span><span class="tok-p">;</span> <span class="tok-n">i2</span> <span class="tok-o">=</span> <span class="tok-n">m</span><span class="tok-p">.</span><span class="tok-n">i2</span><span class="tok-p">;</span>
   <span class="tok-n">A</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">some_function_of</span><span class="tok-p">(</span><span class="tok-n">i0</span><span class="tok-p">,</span> <span class="tok-n">i1</span><span class="tok-p">,</span> <span class="tok-n">i2</span><span class="tok-p">)</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rbc_center_of_mass">39. RBC center of mass</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compute position and velocity of each mesh of the membrane.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rbc_com_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nm_max</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcCom</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_com_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">RbcCom</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_com_apply</span><span class="tok-p">(</span><span class="tok-n">RbcCom</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">**</span><span class="tok-n">rr</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-o">**</span><span class="tok-n">vv</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>max_nm</code> is a maximum allowed number of meshes. It is a runtime error
if <code>nm</code> exceeds <code>nm_max</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rbc_area_and_volume">40. RBC area and volume</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compute area and volume for every object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">area_volume_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nt</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">int4</span> <span class="tok-o">*</span><span class="tok-n">tt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">max_cell</span><span class="tok-p">,</span> <span class="tok-n">AreaVolume</span><span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">area_volume_fin</span><span class="tok-p">(</span><span class="tok-n">AreaVolume</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">area_volume_compute</span><span class="tok-p">(</span><span class="tok-n">AreaVolume</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Particle</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span> <span class="tok-o">**</span><span class="tok-n">av</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">area_volume_host</span><span class="tok-p">(</span><span class="tok-n">AreaVolume</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span> <span class="tok-o">**</span><span class="tok-n">av</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>initialization, <code>nv</code>, <code>nt</code>, <code>tt</code>: number of vertices, number of
triangles, a triangle structure <strong>on host</strong>, <code>max_nm</code> is a maximum
allowed number of meshes</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>compute area and volume for every mesh, <code>nm</code> is a number of meshes,
output <code>av</code> is a devices array and is as follow
----
area[0] volume[0] &#8230;&#8203; area[nc-1] volume[nc-1]
----</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>after <code>area_volume_compute</code> call, <code>area_volume_host</code> returns a
host version of <code>av</code> array</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_elastic_energies">41. Elastic energies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_spring">41.1. spring</h3>
<div class="paragraph">
<p>Spring energy is a function of distance between connected beads \(r\)</p>
</div>
<div class="stemblock">
<div class="content">
\[U_{spring}(r) = U_{wlc}(r) + U_{pow}(r)\]
</div>
</div>
<div class="paragraph">
<p>where worm-like chain energy:</p>
</div>
<div class="stemblock">
<div class="content">
\[U_{wlc}(r) =
\frac{k_s}{4 l_{max}}
\frac{3 x^2 - 2 x^3}{1 - x}, \quad x = \frac{r}{l_{max}}\]
</div>
</div>
<div class="paragraph">
<p>and power-law energy:</p>
</div>
<div class="stemblock">
<div class="content">
\[U_{wlc}(r) =
\frac{k_p}{r^{m - 1}}\]
</div>
</div>
<div class="paragraph">
<p>\(l_0\) is an equilibrium lenght, \(l_{max}\) is a maximum
lenght \(l_{max} = l_{0} / x_{0}\), and \(k_p\) is defined from
condition that \(U_{spring}\) has a maximum at \(r = l_0\).</p>
</div>
</div>
<div class="sect2">
<h3 id="_local_area_constrain">41.2. local area constrain</h3>
<div class="paragraph">
<p>For every triangle with area \(A^{loc}\) and an equilibrium area
\(A_0^{loc}\)</p>
</div>
<div class="stemblock">
<div class="content">
\[E^{loc}_{area} =
k_d
\frac
{
  \left(
    A^{loc} - A_0^{loc}
  \right)^2
}
{2 A_0^{loc}}\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_total_area_constrain">41.3. total area constrain</h3>
<div class="paragraph">
<p>For whole mesh with area \(A^{tot}\) and an equilibrium area
\(A_0^{tot}\)</p>
</div>
<div class="stemblock">
<div class="content">
\[E^{tot}_{area} =
k_a
\frac
{\left( A^{tot} - A_0^{tot} \right)^2}
{2 A_0^{tot} }\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_total_volume_constrain">41.4. total volume constrain</h3>
<div class="paragraph">
<p>For whole mesh with volume \(V\) and an equilibrium volume
\(V_0\)</p>
</div>
<div class="stemblock">
<div class="content">
\[E_{vol} =
k_v
\frac
{\left( V - V_0 \right)^2}
{2 V_0}\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bending">41.5. bending</h3>
<div class="stemblock">
<div class="content">
\[E_{bnd} = k_b
\left[
  1 - \cos
  \left(
    \theta - \theta_0
  \right)
\right]\]
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forces">42. Forces</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_spring_2">42.1. spring</h3>
<div class="paragraph">
<p>A force between two connected beads. \(l_0\) is an equilibrium
spring lenght, \(l_{max}\) is a maximum spring lenght \(l_0 =
l_0 / x_0\).</p>
</div>
<div class="paragraph">
<p>A force between neighboring consissts of repulsive worm-like-chain part</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{wlc}(r) = \frac{k_{s}}
		  {l_{max}}
	     \frac{4 r^2 - 9 r + 6}
		  {4 (r - 1)^2}\]
</div>
</div>
<div class="paragraph">
<p>and attractive power law part</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{pow}(r) = \frac{k_{pow}}
		  {r^{m + 1}}\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_forces_todo">42.2. Other forces (TODO)</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_red_blood_cell">43. Red blood cell</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Red blood cell. <a href="type.h">src/rbc/type.h</a> defines <code>struct rbc::Quants</code></p>
</div>
<div class="sect2">
<h3 id="_components">43.1. components</h3>
<div class="ulist">
<ul>
<li>
<p>adj adjacency list: a structure to pack mesh to read on device</p>
</li>
<li>
<p>com compute center of mass</p>
</li>
<li>
<p>edg store information for every edge (host)</p>
</li>
<li>
<p>internal forces: <a href="forces.html">forces</a></p>
</li>
<li>
<p>gen generate <code>pp</code> from cell template (<code>rbc.off</code>) and initial condition
files (<code>rbcs-ic.txt</code>)</p>
</li>
<li>
<p><a href="com">main</a> initialization, restart</p>
</li>
<li>
<p>rnd random numbers for internal forces</p>
</li>
<li>
<p>rnd/api low level api for random number generator</p>
</li>
<li>
<p>force/area_volume compute area and volume</p>
</li>
<li>
<p>stretch apply a force to every vertex of every cell, force is set from
a file <code>rbc.stretch</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See also <code>src/u/rbc</code>, <code>src/test/rbccom</code>, <code>src/test/rbc</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_cell_templates">43.2. cell templates</h3>
<div class="paragraph">
<p>See <code>src/data/cells</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_random_force">44. random force</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Activate by <code>RBC_RND</code> in <code>conf.h</code>. If environment variable <code>RBC_RNC</code>
is set it is used as seed. Magnitude of the force is</p>
</div>
<div class="listingblock">
<div class="content">
<pre>g = gammaC; T = kBT0
f0  = sqrtf(2*g*T/dt)*rnd</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shape_rbc">45. shape RBC</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compute membrane quantities on host. <code>rbc_shape_edg</code> and
<code>rbc_shape_area</code> return the output in the way accessible with <code>Adj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_ini</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Adj</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">rr</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcShape</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_fin</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_edg</span> <span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_area</span><span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">**</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_total_area</span><span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_shape_total_volume</span><span class="tok-p">(</span><span class="tok-n">RbcShape</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-kt">float</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stretch_rbc">46. stretch RBC</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apply force to every vertex of an every cell constant force. Force is
configured from a file <code>path</code>. The format of the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>fx0 fy0 fz0
fx1 fy1 fz1
...
fx_nv fy_nv fz_nv</pre>
</div>
</div>
<div class="paragraph">
<p><code>nv</code> is the number of vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rbc_stretch_ini</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">char</span> <span class="tok-o">*</span><span class="tok-n">path</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">RbcStretch</span><span class="tok-o">**</span><span class="tok-p">);</span> <span class="tok-cm">/* `nv` is for error check */</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_stretch_fin</span><span class="tok-p">(</span><span class="tok-n">RbcStretch</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rbc_stretch_apply</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">nm</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RbcStretch</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scheme_restrain">47. scheme/restrain</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Restrain the movement of drop or rbc membrane by shifting center of
mass velocity.</p>
</div>
<div class="paragraph">
<p>Consider a subset of particles \(P\) with indices \(I \subset \{i\}_{i = 1}^{n}\).
The <code>Restrain</code> module  shifts the center of mass velocity of \(P\) such that</p>
</div>
<div class="stemblock">
<div class="content">
\[\sum\limits_{i \in I} \mathbf{v}_i = 0.\]
</div>
</div>
<div class="paragraph">
<p>The subset \(I\) depends on the colors of the solvent in case of a
single drop.</p>
</div>
<div class="sect2">
<h3 id="_interface_25">47.1. interface</h3>
<div class="paragraph">
<p>allocate and free host structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_ini</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_fin</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_red</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_rbc</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_none</span><span class="tok-p">(</span><span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_freq</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">freq</span><span class="tok-p">,</span> <span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set to restrain the "red" solvent only</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set to restrain the rbc membrane only</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set for no restrain</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the diagnosis frequency (0 for no diagnosis)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Set parameters from configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">Restrain</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply restrain (note: this calls collective mpi operation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">scheme_restrain_apply</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">cc</span><span class="tok-p">,</span> <span class="tok-kt">long</span> <span class="tok-n">it</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Restrain</span> <span class="tok-o">*</span><span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-n">SchemeQQ</span> <span class="tok-n">qq</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_8">47.2. configuration</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">restrain</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    kind = [&quot;none&quot;, &quot;red&quot;, &quot;rbc&quot;]</span>
<span class="tok-s">    freq = 1000;</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rigid">48. Rigid</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rigid objects consist of frozen particles moving in a rigid fashion.
Interactions with other objects are modeled via pairwise interactions
with the frozen particles.</p>
</div>
<div class="paragraph">
<p>Rigid objects also contain a surface representation on which other
particles may bounce back.</p>
</div>
<div class="sect2">
<h3 id="_quantities">48.1. Quantities</h3>
<div class="sect3">
<h4 id="_data_structure_5">48.1.1. data structure</h4>
<div class="paragraph">
<p><code>RigidQuants</code> structure contains particles of rigid objects as well as
mesh particles.
<code>Solid</code> structures contain center of mass, orientation, angular and
linear velocity of the rigid object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">struct</span> <span class="tok-n">RigQuants</span> <span class="tok-p">{</span>
    <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-n">nps</span><span class="tok-p">;</span>              <span class="tok-cm">/* number of particles (total), solid, particle per solid        */</span>
    <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">;</span>       <span class="tok-cm">/* particles on hst and device                                   */</span>
    <span class="tok-n">Solid</span>    <span class="tok-o">*</span><span class="tok-n">ss_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">;</span>       <span class="tok-cm">/* rigid strutures                                               */</span>
    <span class="tok-kt">float</span>   <span class="tok-o">*</span><span class="tok-n">rr0_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">rr0</span><span class="tok-p">;</span>      <span class="tok-cm">/* frozen particle templates                                     */</span>

    <span class="tok-cm">/* mesh related quantities */</span>
    <span class="tok-kt">int</span> <span class="tok-n">nt</span><span class="tok-p">,</span> <span class="tok-n">nv</span><span class="tok-p">;</span>                   <span class="tok-cm">/* number of [t]riangles and [v]ertices                          */</span>
    <span class="tok-n">int4</span> <span class="tok-o">*</span><span class="tok-n">htt</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">dtt</span><span class="tok-p">;</span>              <span class="tok-cm">/* triangle indices of [h]ost and [d]evice                       */</span>
    <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">hvv</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">dvv</span><span class="tok-p">;</span>             <span class="tok-cm">/* vertices of [h]ost and [d]evice (template)                    */</span>
    <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">i_pp_hst</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">i_pp</span><span class="tok-p">;</span>    <span class="tok-cm">/* particles representing all meshes of all solids of that node  */</span>

    <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss_dmp</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">ss_dmp_bb</span><span class="tok-p">;</span>

    <span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">;</span> <span class="tok-cm">/* maximum particle number */</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_26">48.1.2. Interface</h4>
<div class="paragraph">
<p>allocate and deallocate the quantities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_ini</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">maxp</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rig_fin</span><span class="tok-p">(</span><span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>maxp</code> is the maximum particle number per node.</p>
</div>
<div class="paragraph">
<p>generate the quantities from solvent particles or from restart files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_gen_quants</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-kt">bool</span> <span class="tok-n">empty_pp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">numdensity</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">rig_mass</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-n">pi</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">opp</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-o">*</span><span class="tok-n">on</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">rig_strt_quants</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rigid objects are numbered and need a unique id for dump.
This is initialised using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_set_ids</span><span class="tok-p">(</span><span class="tok-n">MPI_Comm</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart files are dumped using the following functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_strt_dump_templ</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span>         <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_strt_dump</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Coords</span> <span class="tok-o">*</span><span class="tok-n">coords</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">RigQuants</span> <span class="tok-o">*</span><span class="tok-n">q</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>to be called only once: dump the frozen particle in local referential (common to every rigid objects)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>dump <code>Solid</code> structures, describing position, orientation and velocity of the rigid objects</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update">48.2. update</h3>
<div class="paragraph">
<p>Position and velocities of rigid objects are updated from forces
exerted on the particles.</p>
</div>
<div class="sect3">
<h4 id="_pin_info">48.2.1. pin info</h4>
<div class="paragraph">
<p>The hidden structure <code>RigPinInfo</code> is used to store information about
constrained rigid motion.
This can be used to disable the movement of the center of mass of the rigid object along
\(x, y\) or \(z\) axis (see <code>com</code> parameter).
User can also block the rotation along one of the axes  (see <code>axis</code>
parameter).</p>
</div>
<div class="paragraph">
<p>example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>rigid object can rotate but is only able to  move along the \(x\) axis:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>com = {0, 1, 1}
axis = {0, 0, 0}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>rigid object can only rotate along the \(z\) axis and its center
of mass is not able to move:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>com = {1, 1, 1}
axis = {1, 1, 0}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_ini_pininfo</span><span class="tok-p">(</span><span class="tok-n">RigPinInfo</span> <span class="tok-o">**</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_fin_pininfo</span><span class="tok-p">(</span><span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_set_pininfo</span><span class="tok-p">(</span><span class="tok-n">int3</span> <span class="tok-n">com</span><span class="tok-p">,</span> <span class="tok-n">int3</span> <span class="tok-n">axis</span><span class="tok-p">,</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_set_pdir</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">pdir</span><span class="tok-p">,</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_set_pininfo_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="5"></i><b>(5)</b>

<span class="tok-kt">int</span> <span class="tok-nf">rig_get_pdir</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-p">);</span> <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>allocate the hidden structure</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>deallocate the hidden structure</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>set the motion constrains</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>for periodic objects, set the direction of periodicity
(e.g. cylinder)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>set the above parameters from configuration file</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>get the perioid direction</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The periodic direction can be 0, 1 or 2 for the \(x, y\) or
\(z\) axis, respectively.
Default value for no periodicty is set via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span><span class="tok-n">NOT_PERIODIC</span> <span class="tok-o">=</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration has the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">rig</span> <span class="tok-o">=</span> <span class="tok-s">{</span>
<span class="tok-s">    pin_com = [0, 0, 0]</span>
<span class="tok-s">    pin_axis = [0, 0, 0]</span>
<span class="tok-s">    pdir = -1</span>
<span class="tok-na">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_27">48.2.2. interface</h4>
<div class="paragraph">
<p>naming:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ns</code>: number of rigid objects</p>
</li>
<li>
<p><code>ss</code>: array of rigid structures <code>Solid</code></p>
</li>
<li>
<p><code>rr0</code>: positions of the rigid particles in the rigid object
reference frame</p>
</li>
<li>
<p><code>nps</code>: number of rigid particle per rigid object</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">rig_reinit_ft</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_update</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">RigPinInfo</span> <span class="tok-o">*</span><span class="tok-n">pi</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Force</span> <span class="tok-o">*</span><span class="tok-n">ff</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">rr0</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">,</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_generate</span><span class="tok-p">(</span><span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nps</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">rr0</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-kt">void</span> <span class="tok-nf">rig_update_mesh</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">ns</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Solid</span> <span class="tok-o">*</span><span class="tok-n">ss</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">nv</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-kt">float</span> <span class="tok-o">*</span><span class="tok-n">vv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Particle</span> <span class="tok-o">*</span><span class="tok-n">pp</span><span class="tok-p">);</span> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>set the force and torque to 0</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>update particle and rigid objects positions and velocity</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>generate rigid particles from template positions and rigid
structures</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>update the mesh position</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_signed_distance_function_sdf">49. signed distance function (sdf)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_purpose_5">49.1. purpose</h3>
<div class="paragraph">
<p>Signed distance function is interpolated from a uniform grid.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementation">49.2. implementation</h3>

</div>
<div class="sect2">
<h3 id="_components_2">49.3. components</h3>
<div class="ulist">
<ul>
<li>
<p><code>field</code>: read sdf field from a file</p>
</li>
<li>
<p><code>bounce</code>: bounce back particles</p>
</li>
<li>
<p><code>label</code>: label which particle stays in bulk, turns into wall, or
deleted</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_time">50. Time</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keeps current simulation time.</p>
</div>
<div class="paragraph">
<p><code>time_next(Time*, float dt)</code> is called every time step and updates the state of Time*.</p>
</div>
<div class="paragraph">
<p><code>time_cross(Time*, float interval)</code> true if <code>n*interval</code> is in between
current and previus timestep. In other wards did simulation "just
crossed" <code>n*interval</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">time_ini</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">start</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">Time</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_fin</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">time_next</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">);</span>
<span class="tok-kt">int</span>  <span class="tok-nf">time_cross</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">interval</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_current</span> <span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">long</span>  <span class="tok-nf">time_iteration</span><span class="tok-p">(</span><span class="tok-n">Time</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_time_step">51. Time step</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Return time step based on the current state of the simulation. If
<code>type=const</code> always return the same timestep. If <code>type=disp</code> return
timestep based on the maximum accelaration. <code>TimeStepAccel</code> is
constructed using <code>time_step_accel_push</code>.</p>
</div>
<div class="paragraph">
<p><code>float time_step_dt(TimeStep*, MPI_Comm, TimeStepAccel*);</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">time_step_accel_ini</span><span class="tok-p">(</span><span class="tok-cm">/**/</span> <span class="tok-n">TimeStepAccel</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_accel_fin</span><span class="tok-p">(</span><span class="tok-n">TimeStepAccel</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_accel_push</span><span class="tok-p">(</span><span class="tok-n">TimeStepAccel</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">n</span><span class="tok-p">,</span> <span class="tok-n">Force</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_accel_reset</span><span class="tok-p">(</span><span class="tok-n">TimeStepAccel</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-kt">void</span> <span class="tok-nf">time_step_ini</span><span class="tok-p">(</span><span class="tok-n">Config</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">TimeStep</span><span class="tok-o">**</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_fin</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_step_dt</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">,</span> <span class="tok-n">MPI_Comm</span><span class="tok-p">,</span> <span class="tok-n">TimeStepAccel</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">float</span> <span class="tok-nf">time_step_dt0</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">time_step_log</span><span class="tok-p">(</span><span class="tok-n">TimeStep</span><span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_utils">52. Utils</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_error">52.1. error</h3>
<div class="paragraph">
<p><em>uDeviceX</em> has a primitive error handling mechanism. Error is raised if</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ERR(fmt, &#8230;&#8203;)</code> is called. Syntax of ERR is the same as one of
<code>printf(3)</code>.</p>
</li>
<li>
<p>a function wrapped with <code>CC</code> returns a error code</p>
</li>
<li>
<p>a function wrapped with <code>MC</code> returns a error code</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If error is raised the <em>uDeviceX</em> aborts and prints a error message
with a function call trace. Only the function calls wrapped with <code>UC</code>
go into trace. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>void c() { ERR("c failed"); }
void b() { UC(c()); }
void a() { UC(b()); }
void main () {
    a();
}</pre>
</div>
</div>
<div class="paragraph">
<p>produces a log with source file name and line number of two <code>UC</code> calls
and <code>ERR</code> call.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cc">52.2. cc</h3>
<div class="paragraph">
<p>[C]uda [C]heck.</p>
</div>
<div class="paragraph">
<p>Error handling for cuda API calls.</p>
</div>
<div class="sect3">
<h4 id="_usage">52.2.1. Usage</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">CC</span><span class="tok-p">(</span><span class="tok-n">my_cuda_api_call</span><span class="tok-p">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">[error]</a>).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mc">52.3. mc</h3>
<div class="paragraph">
<p>[M]PI [C]heck.</p>
</div>
<div class="paragraph">
<p>Error handling for MPI API calls.</p>
</div>
<div class="sect3">
<h4 id="_usage_2">52.3.1. Usage</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">MC</span><span class="tok-p">(</span><span class="tok-n">my_mpi_api_call</span><span class="tok-p">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">[error]</a>).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kernel_launch_macros">52.4. kernel launch macros</h3>
<div class="paragraph">
<p>[K]ernel [L]aunch.</p>
</div>
<div class="paragraph">
<p>a macro for cuds kernel launches</p>
</div>
<div class="paragraph">
<p>All but <code>unsafe</code> skip kernels with zero thread number.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cpp"><span></span><span class="tok-n">KL</span><span class="tok-p">(</span><span class="tok-n">fun</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">),</span> <span class="tok-p">())</span>     <span class="tok-o">-&gt;</span> <span class="tok-n">fun</span><span class="tok-o">&lt;&lt;&lt;</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-o">&gt;&gt;&gt;</span><span class="tok-p">()</span>
<span class="tok-n">KL</span><span class="tok-p">(</span><span class="tok-n">fun</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">))</span> <span class="tok-o">-&gt;</span> <span class="tok-n">fun</span><span class="tok-o">&lt;&lt;&lt;</span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">j</span><span class="tok-p">,</span> <span class="tok-n">k</span><span class="tok-o">&gt;&gt;&gt;</span><span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wvel">53. wvel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>wall velocity field</p>
</div>
<div class="sect2">
<h3 id="_purpose_6">53.1. purpose</h3>
<div class="ulist">
<ul>
<li>
<p>set velocity to wall particles for wall interactions</p>
</li>
<li>
<p>get wall velocity for bounce back on walls</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_data_structures_9">53.2. data structures</h3>
<div class="paragraph">
<p>data structures are separated into 3 kinds of data structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Wvel</code> (hidden), which contains all informations needed for the velocity
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>WvelStep</code> (hidden), containing only the information needed for one
specific time step. It is generated from <code>Wvel</code> structure.</p>
</li>
<li>
<p>Views, passed to kernels. They are generated from the <code>WvelStep</code> structure.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_interface_28">53.3. interface</h3>
<div class="paragraph">
<p>Interface is splitted between host and device</p>
</div>
<div class="sect3">
<h4 id="_host">53.3.1. Host</h4>
<div class="paragraph">
<p>Host code is responsible for initialisation of <code>Wvel</code> and convert
<code>Wvel</code> to a view at a given timestep.</p>
</div>
<div class="paragraph">
<p>alloc, free structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_ini</span><span class="tok-p">(</span><span class="tok-n">Wvel</span> <span class="tok-o">**</span><span class="tok-n">wv</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_fin</span><span class="tok-p">(</span><span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">wv</span><span class="tok-p">);</span>

<span class="tok-kt">void</span> <span class="tok-nf">wvel_step_ini</span><span class="tok-p">(</span><span class="tok-n">WvelStep</span> <span class="tok-o">**</span><span class="tok-n">wv</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_step_fin</span><span class="tok-p">(</span><span class="tok-n">WvelStep</span> <span class="tok-o">*</span><span class="tok-n">wv</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_set_cste</span><span class="tok-p">(</span><span class="tok-n">float3</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_shear</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">gdot</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">vdir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">gdir</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_shear_sin</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">gdot</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">vdir</span><span class="tok-p">,</span> <span class="tok-kt">int</span> <span class="tok-n">gdir</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">w</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_hs</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">u</span><span class="tok-p">,</span> <span class="tok-kt">float</span> <span class="tok-n">h</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_set_timestep</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">dt</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_set_conf</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">Config</span> <span class="tok-o">*</span><span class="tok-n">cfg</span><span class="tok-p">,</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">vw</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get <em>step</em> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_get_step</span><span class="tok-p">(</span><span class="tok-kt">float</span> <span class="tok-n">t</span><span class="tok-p">,</span> <span class="tok-k">const</span> <span class="tok-n">Wvel</span> <span class="tok-o">*</span><span class="tok-n">wv</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">WvelStep</span> <span class="tok-o">*</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Get <em>view</em> structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">void</span> <span class="tok-nf">wvel_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">WvelStep</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">WvelCste_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">WvelStep</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">WvelShear_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span>
<span class="tok-kt">void</span> <span class="tok-nf">wvel_get_view</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">WvelStep</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">WvelHS_v</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The convertion to <em>view</em> structures can be dispatch using the type of
the parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">enum</span> <span class="tok-p">{</span>
    <span class="tok-n">WALL_VEL_V_CSTE</span><span class="tok-p">,</span>
    <span class="tok-n">WALL_VEL_V_SHEAR</span><span class="tok-p">,</span>
    <span class="tok-n">WALL_VEL_V_HS</span><span class="tok-p">,</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>which can be retrieved from the <em>Step</em> structure using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-kt">int</span> <span class="tok-nf">wvel_get_type</span><span class="tok-p">(</span><span class="tok-k">const</span> <span class="tok-n">WvelStep</span> <span class="tok-o">*</span><span class="tok-n">w</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_device">53.3.2. Device</h4>
<div class="paragraph">
<p>Velocity field can be retrieved, depending on the view structure, using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">wvel</span><span class="tok-p">(</span><span class="tok-n">WvelCste_v</span> <span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">wvel</span><span class="tok-p">(</span><span class="tok-n">WvelShear_v</span> <span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">)</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">wvel</span><span class="tok-p">(</span><span class="tok-n">WvelHS_v</span> <span class="tok-n">p</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">r</span><span class="tok-p">,</span> <span class="tok-cm">/**/</span> <span class="tok-n">float3</span> <span class="tok-o">*</span><span class="tok-n">v</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bounce function: gives bounced-back velocity from
position and velocity of particle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="c++"><span></span><span class="tok-k">template</span> <span class="tok-o">&lt;</span><span class="tok-k">typename</span> <span class="tok-n">Wvel_v</span><span class="tok-o">&gt;</span>
<span class="tok-k">static</span> <span class="tok-n">__device__</span> <span class="tok-kt">void</span> <span class="tok-n">bounce_vel</span><span class="tok-p">(</span><span class="tok-n">Wvel_v</span> <span class="tok-n">wv</span><span class="tok-p">,</span> <span class="tok-n">Coords_v</span> <span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">float3</span> <span class="tok-n">rw</span><span class="tok-p">,</span> <span class="tok-cm">/* io */</span> <span class="tok-n">float3</span><span class="tok-o">*</span> <span class="tok-n">v</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_9">53.4. Configuration</h3>
<div class="sect3">
<h4 id="_constant_2">53.4.1. constant</h4>
<div class="paragraph">
<p>constant velocity \(u = (1, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;constant&quot;;</span>
<span class="tok-s">    u    = [1.0, 0.0, 0.0];</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_shear_2">53.4.2. shear</h4>
<div class="paragraph">
<p>shear velocity \(u = (3 y, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;shear&quot;;</span>
<span class="tok-s">    gdot = 3.0;</span>
<span class="tok-s">    vdir = 0;</span>
<span class="tok-s">    gdir = 1;</span>
<span class="tok-s">    half = 0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sinusoidal_shear">53.4.3. sinusoidal shear</h4>
<div class="paragraph">
<p>shear velocity \(u(t) = (3 y \sin(5 t), 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;shear sin&quot;;</span>
<span class="tok-s">    gdot = 3.0;</span>
<span class="tok-s">    vdir = 0;</span>
<span class="tok-s">    gdir = 1;</span>
<span class="tok-s">    w = 5.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hele_shaw">53.4.4. Hele Shaw</h4>
<div class="paragraph">
<p>velocity \(u_r = \frac u r \left(1 - \frac {4 z^2}{h^2}\right)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="cfg"><span></span><span class="tok-na">wvel {</span>
    <span class="tok-na">type</span> <span class="tok-o">=</span> <span class="tok-s">&quot;hele shaw&quot;;</span>
<span class="tok-s">    u = 1.0;</span>
<span class="tok-s">    h = 8.0;</span>
<span class="tok-na">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_third_party_dependencies">54. third party dependencies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_cuda_compiler">54.1. cuda compiler</h3>
<div class="paragraph">
<p><a href="http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc" class="bare">http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_mpi_library">54.2. MPI library</h3>
<div class="paragraph">
<p>To get the flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mpicxx -show</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pkg-config --libs mpich</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_libconfig">54.3. libconfig</h3>
<div class="paragraph">
<p>a library for processing structured configuration files</p>
</div>
<div class="paragraph">
<p>link:http://hyperrealm.com/libconfig/libconfig.html</p>
</div>
<div class="sect3">
<h4 id="_from_source">54.3.1. from source</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nv">v</span><span class="tok-o">=</span><span class="tok-m">1</span>.7.1
wget https://hyperrealm.github.io/libconfig/dist/libconfig-<span class="tok-nv">$v</span>.tar.gz
tar zxvf libconfig-<span class="tok-nv">$v</span>.tar.gz
<span class="tok-nb">cd</span> libconfig-<span class="tok-nv">$v</span>
./configure --prefix<span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">HOME</span><span class="tok-si">}</span>/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_from_git">54.3.2. from git</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>git clone git@github.com:hyperrealm/libconfig.git
<span class="tok-nb">cd</span> libconfig
autoreconf
./configure --prefix<span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">HOME</span><span class="tok-si">}</span>/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_from_apt">54.3.3. from apt</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>sudo apt install libconfig-dev</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pkgconfig">54.3.4. pkgconfig</h4>
<div class="paragraph">
<p>add path for pkg config</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-nb">export</span> <span class="tok-nv">PKG_CONFIG_PATH</span><span class="tok-o">=</span><span class="tok-nv">$PKG_CONFIG_PATH</span>:<span class="tok-nv">$HOME</span>/prefix/libconfig/lib/pkgconfig</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hdf5">54.4. hdf5</h3>
<div class="paragraph">
<p>a data model, library, and file format for storing and managing data</p>
</div>
<div class="paragraph">
<p>To get the compilation and linking flag the following commands flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>h5c++ -show</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>pkg-config hdf5-mpich --libs</code></pre>
</div>
</div>
<div class="paragraph">
<p>To build from the
<a href="https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.17/src/hdf5-1.8.17.tar.gz">source</a></p>
</div>
<div class="paragraph">
<p>Configuration options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>      --prefix<span class="tok-o">=</span><span class="tok-nv">$HOME</span>/prefix/hdf5 --enable-parallel <span class="tok-nv">CXX</span><span class="tok-o">=</span>mpic++ <span class="tok-nv">CC</span><span class="tok-o">=</span>mpicc</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bop">54.5. bop</h3>
<div class="paragraph">
<p>a simple format for particle data, see
<a href="https://gitlab.ethz.ch/mavt-cse/bop">bop</a>.</p>
</div>
<div class="paragraph">
<p>installation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>git clone git@gitlab.ethz.ch:mavt-cse/bop.git
<span class="tok-nb">cd</span> bop
./configure <span class="tok-o">[</span>OPTIONS<span class="tok-o">]</span> <i class="conum" data-value="1"></i><b>(1)</b>
make
make -s <span class="tok-nb">test</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>see <code>./configure --help</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wrappers">55. wrappers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="intro">55.1. intro</h3>
<div class="paragraph">
<p><code>u.run</code> respects several environment variables to modify the way <code>udx</code>
is run</p>
</div>
</div>
<div class="sect2">
<h3 id="mem">55.2. MEM</h3>
<div class="paragraph">
<p>if <code>MEM</code> is set <code>udx</code> is ran with <code>cuda-memcheck</code> and <code>MEM</code> is used as a
list of parameters</p>
</div>
<div class="listingblock">
<div class="content">
<pre>MEM= u.test test/*
MEM='--leakcheck --blocking'              u.test test/*
MEM='--tool initcheck'                    u.test test/*</pre>
</div>
</div>
<div class="paragraph">
<p>see also <a href="poc/memcheck">poc/memcheck</a></p>
</div>
</div>
<div class="sect2">
<h3 id="val">55.3. VAL</h3>
<div class="paragraph">
<p>if <code>VAL</code> is set <code>udx</code> is ran with valgrind and <code>VAL</code> is used as a list
of parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>VAL= u.test test/*
VAL="--leak-check=full --show-leak-kinds=all"  u.test test/*</pre>
</div>
</div>
<div class="paragraph">
<p><code>u.run</code> respect <code>DRYRUN</code> : only show the commands do not execute them</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DRYRUN= VAL=--option u.run ./udx

module: load cray-hdf5-parallel cudatoolkit daint-gpu
cmd: srun -n 1 -u valgrind --option ./udx</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="prof">55.4. PROF</h3>
<div class="paragraph">
<p>if <code>PROF</code> is set is ran with <code>nvprof</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>PROF="--export-profile main.prof" u.run ./udx
nvprof -i main.prof</pre>
</div>
</div>
<div class="paragraph">
<p>See also <a href="poc/prof/ppbandwidth">poc/ppbandwidth</a></p>
</div>
</div>
<div class="sect2">
<h3 id="tim">55.5. TIM</h3>
<div class="paragraph">
<p>if <code>TIM</code> is set is ran with <code>time</code></p>
</div>
</div>
</div>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>