<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>uDeviceX Developer Documentaion</title>
<link rel="stylesheet" href="/udoc/css/main.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1><em>uDeviceX</em> Developer Documentaion</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_build">1. build</a>
<ul class="sectlevel2">
<li><a href="#_verbosity">1.1. verbosity</a></li>
<li><a href="#_arch_linux">1.2. Arch Linux</a></li>
<li><a href="#_dependencies">1.3. dependencies</a></li>
</ul>
</li>
<li><a href="#_coding_conventions">2. coding conventions</a>
<ul class="sectlevel2">
<li><a href="#_modules">2.1. modules</a></li>
<li><a href="#_naming">2.2. naming</a></li>
<li><a href="#_file_structure">2.3. file structure</a></li>
<li><a href="#_style">2.4. style</a></li>
</ul>
</li>
<li><a href="#_documentation">3. Documentation</a>
<ul class="sectlevel2">
<li><a href="#_installation">3.1. installation</a></li>
<li><a href="#_build_2">3.2. build</a></li>
<li><a href="#_deploy">3.3. Deploy</a></li>
</ul>
</li>
<li><a href="#_gource_commands">4. gource commands</a></li>
<li><a href="#_algo_algorithm_helpers">5. algo: algorithm helpers</a>
<ul class="sectlevel2">
<li><a href="#algo_edg">5.1. edg: mesh edge data</a></li>
<li><a href="#_kahan_summation">5.2. Kahan summation</a></li>
<li><a href="#_minmax">5.3. minmax</a></li>
<li><a href="#algo_scan">5.4. scan: prefix sum</a></li>
<li><a href="#algo_scalars">5.5. Scalars</a></li>
<li><a href="#algo_vectors">5.6. Vectors</a></li>
<li><a href="#_utils">5.7. utils</a></li>
</ul>
</li>
<li><a href="#_clist">6. clist</a>
<ul class="sectlevel2">
<li><a href="#_example_2">6.1. example</a></li>
<li><a href="#_data_structures">6.2. data structures</a></li>
<li><a href="#_interface_3">6.3. interface</a></li>
<li><a href="#_algorithm">6.4. algorithm</a></li>
</ul>
</li>
<li><a href="#cnt">7. cnt: contact forces</a>
<ul class="sectlevel2">
<li><a href="#_interface_4">7.1. interface</a></li>
</ul>
</li>
<li><a href="#_color">8. color</a>
<ul class="sectlevel2">
<li><a href="#_purpose">8.1. purpose</a></li>
<li><a href="#_modules_2">8.2. modules</a></li>
</ul>
</li>
<li><a href="#_comm">9. comm</a>
<ul class="sectlevel2">
<li><a href="#_purpose_2">9.1. purpose</a></li>
<li><a href="#_data_structures_2">9.2. data structures</a></li>
<li><a href="#_allocation_mod">9.3. allocation mod</a></li>
<li><a href="#_interface_5">9.4. interface</a></li>
</ul>
</li>
<li><a href="#conf">10. conf: runtime configuration</a>
<ul class="sectlevel2">
<li><a href="#_purpose_3">10.1. purpose</a></li>
<li><a href="#_data_structure">10.2. data structure</a></li>
<li><a href="#_interface_6">10.3. interface</a></li>
</ul>
</li>
<li><a href="#_control">11. Control</a>
<ul class="sectlevel2">
<li><a href="#_velocity_controller">11.1. Velocity controller</a></li>
<li><a href="#_inflow">11.2. Inflow</a></li>
<li><a href="#_outflow">11.3. Outflow</a></li>
<li><a href="#_den_density_controller">11.4. den: Density controller</a></li>
</ul>
</li>
<li><a href="#_coords">12. coords</a>
<ul class="sectlevel2">
<li><a href="#_data_structures_3">12.1. data structures</a></li>
<li><a href="#_host_interface">12.2. Host interface</a></li>
<li><a href="#_configuration_5">12.3. Configuration</a></li>
</ul>
</li>
<li><a href="#_generic_d_evice_api">13. generic [d]evice API</a></li>
<li><a href="#_debug">14. debug</a>
<ul class="sectlevel2">
<li><a href="#_interface_11">14.1. interface</a></li>
<li><a href="#_configuration_6">14.2. configuration</a></li>
</ul>
</li>
<li><a href="#_distr">15. distr</a>
<ul class="sectlevel2">
<li><a href="#_map_2">15.1. map</a></li>
<li><a href="#_flu">15.2. flu</a></li>
<li><a href="#_rbc">15.3. rbc</a></li>
<li><a href="#_rig">15.4. rig</a></li>
<li><a href="#_common">15.5. common</a></li>
</ul>
</li>
<li><a href="#_exch">16. exch</a>
<ul class="sectlevel2">
<li><a href="#_map_3">16.1. map</a></li>
<li><a href="#_flu_2">16.2. flu</a></li>
<li><a href="#_obj">16.3. obj</a></li>
<li><a href="#_mesh">16.4. mesh</a></li>
<li><a href="#_common_2">16.5. common</a></li>
</ul>
</li>
<li><a href="#_flu_solvent_particles">17. flu: solvent particles</a>
<ul class="sectlevel2">
<li><a href="#_data_structure_4">17.1. data structure</a></li>
<li><a href="#_interface_18">17.2. interface</a></li>
</ul>
</li>
<li><a href="#_fluforces">18. fluforces</a>
<ul class="sectlevel2">
<li><a href="#_interface_19">18.1. interface</a></li>
<li><a href="#_submodules">18.2. submodules</a></li>
</ul>
</li>
<li><a href="#_frag">19. frag</a>
<ul class="sectlevel2">
<li><a href="#_purpose_4">19.1. purpose</a></li>
<li><a href="#_interface_20">19.2. interface</a></li>
</ul>
</li>
<li><a href="#fsi">20. fsi : flow structure interactions</a>
<ul class="sectlevel2">
<li><a href="#_interface_21">20.1. interface</a></li>
</ul>
</li>
<li><a href="#grid_sampler">21. grid_sampler: particle to grid average</a>
<ul class="sectlevel2">
<li><a href="#_quantities">21.1. quantities</a></li>
<li><a href="#_interface_22">21.2. interface</a></li>
<li><a href="#grid_sampler_data">21.3. grid sampler data</a></li>
</ul>
</li>
<li><a href="#_io">22. IO</a>
<ul class="sectlevel2">
<li><a href="#io_grid">22.1. grid</a></li>
<li><a href="#_low_level_mpi_file_write">22.2. Low level MPI file write</a></li>
<li><a href="#_text">22.3. Text</a></li>
<li><a href="#_mesh_2">22.4. Mesh</a></li>
<li><a href="#_diagnostics">22.5. Diagnostics</a></li>
<li><a href="#_point">22.6. Point</a></li>
<li><a href="#_vtk">22.7. VTK</a></li>
<li><a href="#io_restart">22.8. restart</a></li>
</ul>
</li>
<li><a href="#_inter_interprocessing_tools">23. inter: interprocessing tools</a>
<ul class="sectlevel2">
<li><a href="#inter_color">23.1. color</a></li>
<li><a href="#inter_freeze">23.2. freeze</a></li>
</ul>
</li>
<li><a href="#_math">24. Math</a>
<ul class="sectlevel2">
<li><a href="#_linal">24.1. linal</a></li>
<li><a href="#_host_random_number_generation">24.2. Host random number generation</a></li>
<li><a href="#math_tform">24.3. tform: linar coordinate transformation for 3D vector</a></li>
<li><a href="#_triangle_functions">24.4. triangle functions</a></li>
</ul>
</li>
<li><a href="#_mesh_4">25. Mesh</a>
<ul class="sectlevel2">
<li><a href="#mesh_area">25.1. area: compute area of a mesh</a></li>
<li><a href="#mesh_tri_area">25.2. tri_area: compute area of triangles in a mesh</a></li>
<li><a href="#mesh_angle">25.3. angle: compute angles between triangles with a common edge</a></li>
<li><a href="#edg_len_angle">25.4. edges length: compute length of the edges</a></li>
<li><a href="#_gen_generate_mesh">25.5. gen: generate mesh</a></li>
<li><a href="#mesh_matrices">25.6. matrices: affine transformation</a></li>
<li><a href="#mesh_scatter">25.7. "scatter": distribute scalar values between different elements of the mesh</a></li>
<li><a href="#mesh_triangles">25.8. Triangles</a></li>
<li><a href="#mesh_vert_area">25.9. vertices' area</a></li>
<li><a href="#mesh_volume">25.10. volume: compute volume of a mesh</a></li>
</ul>
</li>
<li><a href="#_pair_pairwise_interactions">26. pair: pairwise interactions</a>
<ul class="sectlevel2">
<li><a href="#_dpd_interactions">26.1. dpd interactions</a></li>
<li><a href="#_repulsive_lj">26.2. repulsive LJ</a></li>
<li><a href="#_host_interface_3">26.3. Host interface</a></li>
<li><a href="#_device_interface_2">26.4. device interface</a></li>
<li><a href="#_configuration_7">26.5. Configuration</a></li>
</ul>
</li>
<li><a href="#_meshbb">27. meshbb</a>
<ul class="sectlevel2">
<li><a href="#_interface_26">27.1. interface</a></li>
</ul>
</li>
<li><a href="#_red_blood_cell">28. Red blood cell</a>
<ul class="sectlevel2">
<li><a href="#rbc_energy">28.1. Elastic energies</a></li>
<li><a href="#_quantities_2">28.2. Quantities</a></li>
<li><a href="#_submodules_3">28.3. Submodules</a></li>
</ul>
</li>
<li><a href="#_rig_rigid_objects">29. rig: rigid objects</a>
<ul class="sectlevel2">
<li><a href="#_quantities_3">29.1. Quantities</a></li>
<li><a href="#_update">29.2. update</a></li>
<li><a href="#_submodules_4">29.3. Submodules</a></li>
</ul>
</li>
<li><a href="#_scheme">30. scheme</a>
<ul class="sectlevel2">
<li><a href="#_body_forces">30.1. body forces</a></li>
<li><a href="#_move">30.2. move</a></li>
<li><a href="#_restrain">30.3. restrain</a></li>
<li><a href="#_time_line">30.4. Time line</a></li>
<li><a href="#scheme_time_step">30.5. Time step</a></li>
</ul>
</li>
<li><a href="#_sim_simulation">31. sim: simulation</a>
<ul class="sectlevel2">
<li><a href="#_interface_33">31.1. interface</a></li>
<li><a href="#_submodules_5">31.2. submodules</a></li>
</ul>
</li>
<li><a href="#sdf">32. sdf: signed distance function</a>
<ul class="sectlevel2">
<li><a href="#_interface_35">32.1. interface</a></li>
<li><a href="#_submodules_6">32.2. submodules</a></li>
</ul>
</li>
<li><a href="#_struct_helper_structures">33. Struct: helper structures</a>
<ul class="sectlevel2">
<li><a href="#_partlist">33.1. partlist</a></li>
<li><a href="#_parray">33.2. parray</a></li>
<li><a href="#_farray">33.3. farray</a></li>
</ul>
</li>
<li><a href="#_utils_2">34. utils</a>
<ul class="sectlevel2">
<li><a href="#_utility_functions">34.1. utility functions</a></li>
<li><a href="#_error_handling">34.2. error handling</a></li>
<li><a href="#_cc_cuda_check">34.3. cc: cuda check</a></li>
<li><a href="#_mc_mpi_check">34.4. mc: mpi check</a></li>
<li><a href="#_kl_kernel_launch">34.5. kl: kernel launch</a></li>
<li><a href="#_texo_texture_object">34.6. texo: texture object</a></li>
</ul>
</li>
<li><a href="#_wall">35. wall</a>
<ul class="sectlevel2">
<li><a href="#_data_structure_8">35.1. data structure</a></li>
<li><a href="#_interface_41">35.2. interface</a></li>
<li><a href="#_submodules_7">35.3. submodules</a></li>
</ul>
</li>
<li><a href="#_third_party_dependencies">36. third party dependencies</a>
<ul class="sectlevel2">
<li><a href="#_nvcc">36.1. nvcc</a></li>
<li><a href="#_mpi_library">36.2. MPI library</a></li>
<li><a href="#_libconfig">36.3. libconfig</a></li>
<li><a href="#third_h5">36.4. hdf5</a></li>
<li><a href="#third_bop">36.5. bop</a></li>
</ul>
</li>
<li><a href="#wrappers">37. wrappers</a>
<ul class="sectlevel2">
<li><a href="#intro">37.1. intro</a></li>
<li><a href="#mem">37.2. MEM</a></li>
<li><a href="#val">37.3. VAL</a></li>
<li><a href="#prof">37.4. PROF</a></li>
<li><a href="#tim">37.5. TIM</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_build">1. build</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>uDeviceX</code> uses a wrapper <code>u.make</code> for building the source.
This allows to load modules when needed.</p>
</div>
<div class="sect2">
<h3 id="_verbosity">1.1. verbosity</h3>
<div class="paragraph">
<p>The verbosity can be controlled during the compilation process:</p>
</div>
<div class="paragraph">
<p>Shows full compilation and linking commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">u.make LOG=</code></pre>
</div>
</div>
<div class="paragraph">
<p>Profile compilation time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">u.make LOG='@time -f &quot;%e $&lt;&quot;'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hide compilation messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">u.make LOG=@</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_arch_linux">1.2. Arch Linux</h3>
<div class="listingblock">
<div class="content">
<pre>u.make MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>MAKEFLAGS="MPI_VARIANT=ompi-cxx HDF5_CXXFLAGS= HDF5_LIBS=-lhdf5 NVCC_LIBS=-L/opt/cuda/lib64" \
				u.test test/compile</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dependencies">1.3. dependencies</h3>
<div class="paragraph">
<p>Dependencies must be generated after adding a file or changing includes.
Run from <code>src/</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>../tools/deps</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coding_conventions">2. coding conventions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_modules">2.1. modules</h3>
<div class="paragraph">
<p><em>uDeviceX</em> consists of modules.
Modules are as independant as possible.
They consist of a folder with one or more compilation units, and an
interface.
Whenever it is possible, the structures are hidden from the client of
the module.</p>
</div>
</div>
<div class="sect2">
<h3 id="_naming">2.2. naming</h3>
<div class="sect3">
<h4 id="_variables">2.2.1. variables</h4>
<div class="ulist">
<ul>
<li>
<p>names of local variables are short and understandable from the context</p>
</li>
<li>
<p>names of global variables are as descriptive as possible</p>
</li>
<li>
<p>arrays of simple structures <code>x</code> have names <code>xx</code>, eg. <code>pp</code> is an
array of particles, <code>cc</code> is an array of colors, <code>ii</code> is an array of
indices * array of small dimentionality may use an enum type for
readability, e.g.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">enum</span> {X, Y, Z};
<span class="predefined-type">int</span> r[<span class="integer">3</span>];
r[X] = rx;
r[Y] = ry;
r[Z] = rz;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functions">2.2.2. functions</h4>
<div class="ulist">
<ul>
<li>
<p>a function name is descriptive on its own or inside a module.</p>
</li>
<li>
<p>arguments are ordered as follow:</p>
<div class="ulist">
<ul>
<li>
<p>input is at the beginning</p>
</li>
<li>
<p>input/output come after input and start with a commented <code>io</code></p>
</li>
<li>
<p>output comes after input/output and start with a comment or <code>o</code> depending on the context</p>
</li>
<li>
<p>sizes have higher priority than arrays</p>
</li>
<li>
<p>workspace comes at the end ans starts with a commented <code>w</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>do <strong>not</strong> use references, use pointers instead</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example of valid function declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> read_int_from_file(<span class="directive">const</span> <span class="predefined-type">char</span> *fname, <span class="comment">/**/</span> <span class="predefined-type">int</span> *n, <span class="predefined-type">int</span> *ii);
<span class="directive">void</span> forward_euler(<span class="predefined-type">int</span> n, <span class="directive">const</span> Force *ff, <span class="comment">/* io */</span> Particle *pp);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Function names part of a module interface start with the module name.
Functions private to a module do not need to contain the module name
if the context make it clear. Use the <code>static</code> qualifier for functions
with compilation-unit scope.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_file_structure">2.3. file structure</h3>
<div class="ulist">
<ul>
<li>
<p>no include guards; no "headers in headers" if easily avoidable</p>
</li>
<li>
<p>all cuda kernels are in a separate header <code>.h</code> file</p>
</li>
<li>
<p>a module is implemented inside its own directory <code>A</code></p>
<div class="ulist">
<ul>
<li>
<p>it has its own object <code>A/imp.cu</code> or <code>A/imp.cpp</code> (<code>.cpp</code> prefered if possible)</p>
</li>
<li>
<p>interface <code>A/imp.h</code></p>
</li>
<li>
<p>implementation can be done in separate files inside <code>A/imp/</code> directory</p>
</li>
<li>
<p>internal cuda (private to module) code are inside <code>A/dev/</code> directory</p>
</li>
<li>
<p>cuda interface inside <code>A/dev.h</code> (for client use)</p>
</li>
</ul>
</div>
</li>
<li>
<p>modules can have submodules, which follow the same structure as above, e.g. submodule <code>B</code> inside module <code>A</code> belongs to <code>A/B/</code> directory</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_style">2.4. style</h3>
<div class="paragraph">
<p>for emacs: the following c++ mode is used</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="lisp">(defun u/c-indent-common ()
  (setq c-basic-offset 4
        indent-tabs-mode nil))

(defun u/c++-indent ()
  (u/c-indent-common)
  (c-set-offset 'innamespace [0]))

(defun u/c-indent () (u/c-indent-common))

(add-hook 'c-mode-hook   'u/c-indent)
(add-hook 'c++-mode-hook 'u/c++-indent)

(setq c-default-style
      '((java-mode . &quot;java&quot;)
        (awk-mode  . &quot;awk&quot;)
        (c-mode    . &quot;k&amp;r&quot;)
        (cc-mode   . &quot;k&amp;r&quot;)))

(add-to-list 'auto-mode-alist '(&quot;\\.cu\\'&quot; . c++-mode))
(add-to-list 'auto-mode-alist '(&quot;\\.h\\'&quot;  . c++-mode))</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_documentation">3. Documentation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>uDeviceX</code> documentation is written in <code>Asciidoc</code> format and converted to <code>html</code>.
This operation requires <a href="https://asciidoctor.org/">asciidoctor</a> (converter to html) and
<a href="http://pygments.org/">pygments.rb</a> (for code highlighting).</p>
</div>
<div class="sect2">
<h3 id="_installation">3.1. installation</h3>
<div class="sect3">
<h4 id="_mac_os_x">3.1.1. Mac OS X</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">gem install asciidoctor
gem install pygments.rb</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arch_linux_2">3.1.2. Arch linux</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo pacman -S asciidoctor
gem install pygments.rb</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_2">3.2. build</h3>
<div class="paragraph">
<p>When writing documentation, it is useful to build it and view it on a
local server.</p>
</div>
<div class="paragraph">
<p>From <code>doc/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./tools/start <b class="conum">(1)</b>
./tools/view  <b class="conum">(2)</b>
./tools/stop  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>start a local server (to be done only once)</p>
</li>
<li>
<p>open the main page in browser from local server</p>
</li>
<li>
<p>stop the local server</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./configure <b class="conum">(1)</b>
make -j     <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>make dependencies (to be run after adding a file to documentation)</p>
</li>
<li>
<p>build documentation for local server</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploy">3.3. Deploy</h3>
<div class="paragraph">
<p>The deploy command cleans, builds and pushes the documentation on
github pages <a href="https://github.com/amlucas/udoc" class="bare">https://github.com/amlucas/udoc</a>.
The commit message on the udoc repository points on the current
<code>uDeviceX</code> commit. It is preferable to have a clean local repository
before deploying:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">git clean -xdf
./tools/deploy</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gource_commands">4. gource commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Display git history of <em>uDeviceX</em> as animated tree.</p>
</div>
<div class="paragraph">
<p>Dump</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">o=g.ppm
gource -s 0.1 --file-filter 'test_data/' \
              --file-filter 'poc/'  \
              --file-filter 'tcdf/' \
              --file-filter 'cmd/'  \
              --highlight-users   \
              --highlight-colour FFFFFF \
              --date-format '%d %b %Y' -o $o</code></pre>
</div>
</div>
<div class="paragraph">
<p>Convert to mp4</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">i=g.ppm
o=g.mp4
ffmpeg -y -r 60 -f image2pipe -vcodec ppm -i $i -vcodec libx264 \
    -preset ultrafast -pix_fmt yuv420p -crf 1 -threads 0 -bf 0 $o</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ ffmpeg -version
ffmpeg version 2.8.11-0ubuntu0.16.04.1 Copyright (c) 2000-2017 the FFmpeg developers</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="http://gource.io" class="bare">http://gource.io</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_algo_algorithm_helpers">5. algo: algorithm helpers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="algo_edg">5.1. edg: mesh edge data</h3>
<div class="paragraph">
<p>Set and get <code>val</code> on edges of the mesh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> edg_ini(<span class="predefined-type">int</span> md, <span class="predefined-type">int</span> nv,                     <span class="predefined-type">int</span> *hx);
<span class="directive">void</span> edg_set(<span class="predefined-type">int</span> md, <span class="predefined-type">int</span> i, <span class="predefined-type">int</span> j, <span class="predefined-type">int</span> val, <span class="comment">/**/</span> <span class="predefined-type">int</span> *hx,       <span class="predefined-type">int</span> *hy); <b class="conum">(1)</b>
<span class="predefined-type">int</span>  edg_get(<span class="predefined-type">int</span> md, <span class="predefined-type">int</span> i, <span class="predefined-type">int</span> j,         <span class="directive">const</span> <span class="predefined-type">int</span> *hx, <span class="directive">const</span> <span class="predefined-type">int</span> *hy); <b class="conum">(2)</b>
<span class="predefined-type">int</span>  edg_valid(<span class="predefined-type">int</span> md, <span class="predefined-type">int</span> i, <span class="predefined-type">int</span> j,         <span class="directive">const</span> <span class="predefined-type">int</span> *hx); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set <code>val</code></p>
</li>
<li>
<p>get <code>val</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>md</code> is a maximum degree, <code>nv</code> number of vertices, <code>h[xy]</code> storage of
size <code>nv*md</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kahan_summation">5.2. Kahan summation</h3>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Kahan_summation_algorithm">Summation</a>
stable to numerical error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> kahan_sum_ini(<span class="comment">/**/</span> KahanSum**);
<span class="directive">void</span> kahan_sum_fin(KahanSum*);

<span class="directive">void</span> kahan_sum_add(KahanSum*, <span class="predefined-type">double</span> input); <b class="conum">(1)</b>
<span class="predefined-type">double</span> kahan_sum_get(<span class="directive">const</span> KahanSum*); <b class="conum">(2)</b>
<span class="predefined-type">double</span> kahan_sum_compensation(<span class="directive">const</span> KahanSum*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add <code>input</code> to the sum</p>
</li>
<li>
<p>return current sum</p>
</li>
<li>
<p>return current value of <code>compensation</code> for diagnostic</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">kahan_sum *k;
kahan_sum_ini(&amp;k);
<span class="keyword">for</span> (i = <span class="integer">0</span>; i &lt; n; i ++)
    kahan_sum_add(kahan_sum, a[i]);
sum = kahan_sum_get(kahan_sum);
kahan_sum_fin(k);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_minmax">5.3. minmax</h3>
<div class="paragraph">
<p>compute extends of chunks of particles</p>
</div>
<div class="ulist">
<ul>
<li>
<p>input is an array of particles, the number of chunks and the number of particles per chunk.</p>
</li>
<li>
<p>output is the bounding box in for each chunk of particles.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_example">5.3.1. example</h4>
<div class="paragraph">
<p>Consider the simple case on 1D:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:
	particles positions:
	0.1 0.5 0.2   0.3 1.2 1.0
	number of chunks: 2
	number of particles per chunk: 3

output:
	min:
	0.1 0.3
	max:
	0.5 1.0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface">5.3.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> minmax(<span class="directive">const</span> Particle *<span class="directive">const</span>, <span class="predefined-type">int</span> nv, <span class="predefined-type">int</span> no, <span class="comment">/**/</span> float3 *min, float3 *max);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="algo_scan">5.4. scan: prefix sum</h3>
<div class="paragraph">
<p>exclusive prefix sum implementation for integer data</p>
</div>
<div class="paragraph">
<p>input is of size <code>n</code>, output is of size <code>n + 1</code> as in the following
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>input:  4 5 1  2  3  -
output: 0 4 9 10 12 15</pre>
</div>
</div>
<div class="sect3">
<h4 id="_interface_2">5.4.1. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> scan_apply(<span class="directive">const</span> <span class="predefined-type">int</span> *input, <span class="predefined-type">int</span> size, <span class="comment">/**/</span> <span class="predefined-type">int</span> *output, <span class="comment">/*w*/</span> Scan*); <b class="conum">(1)</b>
<span class="directive">void</span> scan_ini(<span class="predefined-type">int</span> size, <span class="comment">/**/</span> Scan**);                                       <b class="conum">(2)</b>
<span class="directive">void</span> scan_fin(Scan*);                                                       <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>perform scan operation on <code>input</code> of size <code>size</code></p>
</li>
<li>
<p>allocate workspace for performing scan of size <code>size</code></p>
</li>
<li>
<p>free workspace</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="algo_scalars">5.5. Scalars</h3>
<div class="paragraph">
<p>A read-only wrapper to provide uniform accsses to an array <code>n</code>
scalars.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> scalars_float_ini(<span class="predefined-type">int</span> n, <span class="directive">const</span> <span class="predefined-type">float</span>*, <span class="comment">/**/</span> Scalars**);
<span class="directive">void</span> scalars_double_ini(<span class="predefined-type">int</span> n, <span class="directive">const</span> <span class="predefined-type">double</span>*, <span class="comment">/**/</span> Scalars**);
<span class="directive">void</span> scalars_vectors_ini(<span class="predefined-type">int</span> n, <span class="directive">const</span> Vectors*, <span class="predefined-type">int</span> dim, <span class="comment">/**/</span> Scalars**);

<span class="directive">void</span> scalars_zero_ini(<span class="predefined-type">int</span> n, <span class="comment">/**/</span> Scalars**);
<span class="directive">void</span> scalars_one_ini(<span class="predefined-type">int</span> n, <span class="comment">/**/</span> Scalars**);

<span class="directive">void</span> scalars_fin(Scalars*);
<span class="predefined-type">double</span> scalars_get(<span class="directive">const</span> Scalars*, <span class="predefined-type">int</span> i);</code></pre>
</div>
</div>
<div class="paragraph">
<p>See also <a href="#algo_vector">Vectors</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="algo_vectors">5.6. Vectors</h3>
<div class="paragraph">
<p>A read-only wrapper to provide uniform accsses to an array <code>n</code> vectors
of size three. The module does not copy data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> vectors_float_ini(<span class="predefined-type">int</span> n, <span class="directive">const</span> <span class="predefined-type">float</span>*, <span class="comment">/**/</span> Vectors**); <b class="conum">(1)</b>
<span class="directive">void</span> vectors_postions_ini(<span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> Vectors**); <b class="conum">(2)</b>
<span class="directive">void</span> vectors_postions_edge_ini  (<span class="directive">const</span> Coords*, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> Vectors**); <b class="conum">(3)</b>
<span class="directive">void</span> vectors_postions_center_ini(<span class="directive">const</span> Coords*, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> Vectors**); <b class="conum">(4)</b>
<span class="directive">void</span> vectors_velocities_ini(<span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> Vectors**); <b class="conum">(5)</b>
<span class="directive">void</span> vectors_zero_ini(<span class="predefined-type">int</span> n, <span class="comment">/**/</span> Vectors**); <b class="conum">(6)</b>

<span class="directive">void</span> vectors_fin(Vectors*);
<span class="directive">void</span> vectors_get(<span class="directive">const</span> Vectors*, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> <span class="predefined-type">float</span> r[<span class="integer">3</span>]); <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>array of float packed as <code>x0 y0 z0   x1 y1 z1</code></p>
</li>
<li>
<p>particle positions</p>
</li>
<li>
<p>particle positions relative to domain edge</p>
</li>
<li>
<p>particle positions relative to domain center</p>
</li>
<li>
<p>particle velocity</p>
</li>
<li>
<p>array of zeros</p>
</li>
<li>
<p>return a vector <code>i</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="preprocessor">#define</span> n <span class="integer">2</span>
Vectors  *pos;
<span class="predefined-type">float</span> r[<span class="integer">3</span>], data[<span class="integer">3</span>*n] = {<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>,   <span class="integer">4</span>, <span class="integer">5</span>, <span class="integer">6</span>};
vectors_float_ini(n, data, &amp;pos);
vectors_get(pos, <span class="integer">1</span>, <span class="comment">/**/</span> r);
vectors_fin(pos);</code></pre>
</div>
</div>
<div class="paragraph">
<p>See also <a href="#algo_scalars">Scalars</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_utils">5.7. utils</h3>
<div class="paragraph">
<p>helper device functions</p>
</div>
<div class="paragraph">
<p>Warp reduction: sum  all elements within a warp.
This is a collective operation, all threads of the warp must execute it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
_I_ T warpReduceSum(T v)  <b class="conum">(1)</b>
_I_ float2 warpReduceSum(float2 val)  <b class="conum">(2)</b>
_I_ float3 warpReduceSum(float3 val)  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>generic warp reduction. thread 0 of the warp gets the result.</p>
</li>
<li>
<p>specific implementation for <code>float2</code></p>
</li>
<li>
<p>specific implementation for <code>float3</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clist">6. clist</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helpers to find which particles are in a given cell.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reorder data according to particle positions into cells</p>
</li>
<li>
<p>access particles within a given cell</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_example_2">6.1. example</h3>
<div class="paragraph">
<p>consider a 1D example of particles with positions in domain <code>[0, 4)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 2.5 0.1 1.1 0.5 1.6</pre>
</div>
</div>
<div class="paragraph">
<p>After cell list building (we take 1 as cell size), the above data becomes</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pp: 0.1 0.5 1.1 1.6 2.5  -
cc: 2       2       1    0
ss: 0       2       4    5</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>pp</code> is the particle array, <code>cc</code> (counts) is the number of particles per
cell and <code>ss</code> (starts) is the prefix sum of <code>cc</code>.</p>
</div>
<div class="paragraph">
<p>Accessing all particles in cell <code>i=1</code> (<code>[1,2)</code>) can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>loop: j = 0, ..., cc[i]
      id = ss[i] + j
      p = pp[id]
      work(p)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above can be easily extended in 3D, only ordering changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_structures">6.2. data structures</h3>
<div class="sect3">
<h4 id="_clist_2">6.2.1. Clist</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> Clist {
    int3 dims;
    <span class="predefined-type">int</span> ncells;
    <span class="predefined-type">int</span> *starts, *counts;
};</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dims</code> dimesnsions of the grid</p>
</li>
<li>
<p><code>ncells</code> number of cells</p>
</li>
<li>
<p><code>counts</code> number of particles per cell</p>
</li>
<li>
<p><code>starts</code> exclusive prefic scan of the above</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_map">6.2.2. Map</h4>
<div class="paragraph">
<p>Helper to build the cell lists (hidden from client)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> ClistMap {
    <span class="predefined-type">int</span> nA;              <span class="comment">/* number of source arrays to build the cell lists, e.g remote+bulk -&gt; 2 */</span>
    uchar4 *ee[MAXA];    <span class="comment">/* cell entries */</span>
    uint *ii;            <span class="comment">/* codes containing: indices of data to fetch and array id from which to fetch */</span>
    Scan *scan;      <span class="comment">/* scan workspace */</span>
    <span class="predefined-type">long</span> maxp;           <span class="comment">/* maximum number of particles per input vector */</span>
};</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nA</code> number of source arrays</p>
</li>
<li>
<p><code>ee</code> cell entries: one array per source array, containing a list of
<code>uchar4</code> with entries (<code>xcid</code>, <code>ycid</code>, <code>zcid</code>, <code>sid</code>)</p>
<div class="ulist">
<ul>
<li>
<p><code>xcid</code>: x cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.x</code></p>
</li>
<li>
<p><code>ycid</code>: y cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.y</code></p>
</li>
<li>
<p><code>zcid</code>: z cordinate of the cell, in 0, &#8230;&#8203;, <code>dims.z</code></p>
</li>
<li>
<p><code>sid</code>: source array id, in 0, &#8230;&#8203;, <code>nA</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>ii</code> indices of particles to fetch. can be decoded into the source
array id and the particle id inside this array</p>
</li>
<li>
<p><code>scan</code> scan workspace, see <a href="algo/scan.html">scan</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The ids can be accessed from</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">const</span> uint* clist_get_ids(<span class="directive">const</span> ClistMap *m);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_3">6.3. interface</h3>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> clist_ini(<span class="predefined-type">int</span> LX, <span class="predefined-type">int</span> LY, <span class="predefined-type">int</span> LZ, <span class="comment">/**/</span> Clist *c);
<span class="directive">void</span> clist_fin(<span class="comment">/**/</span> Clist *c);

<span class="directive">void</span> clist_ini_map(<span class="predefined-type">int</span> maxp, <span class="predefined-type">int</span> nA, <span class="directive">const</span> Clist *c, <span class="comment">/**/</span> ClistMap **m);
<span class="directive">void</span> clist_fin_map(ClistMap *m);</code></pre>
</div>
</div>
<div class="paragraph">
<p>build interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> clist_ini_counts(Clist *c);
<span class="directive">void</span> clist_subindex(<span class="predefined-type">bool</span> project, <span class="predefined-type">int</span> aid, <span class="predefined-type">int</span> n, <span class="directive">const</span> PartList lp, <span class="comment">/**/</span> Clist *c, ClistMap *m);
<span class="directive">void</span> clist_build_map(<span class="directive">const</span> <span class="predefined-type">int</span> nn[], <span class="comment">/**/</span> Clist *c, ClistMap *m);

<span class="comment">/* special for fluid distribution */</span>
<span class="directive">void</span> clist_subindex_local(<span class="predefined-type">int</span> n, <span class="directive">const</span> PartList lp, <span class="comment">/**/</span> Clist *c, ClistMap *m);
<span class="directive">void</span> clist_subindex_remote(<span class="predefined-type">int</span> n, <span class="directive">const</span> PartList lp, <span class="comment">/**/</span> Clist *c, ClistMap *m);

<span class="directive">void</span> clist_gather_pp(<span class="directive">const</span> Particle *pplo, <span class="directive">const</span> Particle *ppre, <span class="directive">const</span> ClistMap *m, <span class="predefined-type">long</span> nout, <span class="comment">/**/</span> Particle *ppout);
<span class="directive">void</span> clist_gather_ii(<span class="directive">const</span> <span class="predefined-type">int</span> *iilo, <span class="directive">const</span> <span class="predefined-type">int</span> *iire, <span class="directive">const</span> ClistMap *m, <span class="predefined-type">long</span> nout, <span class="comment">/**/</span> <span class="predefined-type">int</span> *iiout);

<span class="comment">/* quick cell build for single array */</span>
<span class="directive">void</span> clist_build(<span class="predefined-type">int</span> nlo, <span class="predefined-type">int</span> nout, <span class="directive">const</span> Particle *pplo, <span class="comment">/**/</span> Particle *ppout, Clist *c, ClistMap *m);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface: code/decode map ids</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">_I_ uint clist_encode_id(<span class="predefined-type">int</span> s, <span class="predefined-type">int</span> pid)
_I_ <span class="directive">void</span> clist_decode_id(uint c, <span class="comment">/**/</span> <span class="predefined-type">int</span> *s, <span class="predefined-type">int</span> *pid)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_algorithm">6.4. algorithm</h3>
<div class="paragraph">
<p>The cell build process is linear in number of particles <code>np</code> and <code>n log(n)</code>
in number of cells <code>n</code>.
The process to build cell lists is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>- build ee and counts: O(np)
  - set counts[i] = 0 for all i
  - for each particle, compute its cell id cid
  - get unique subindex k within the cell by updating cc[cid]
- scan counts to get starts O(nlog n)
- construct ii: O(np)
  - for each particle with id i, compute new index j = ss[cid] + k[i]
  - set ii[j] = i
- Gather data: O(np)
  - new particle vector pp1 from pp: pp1[i] = pp[ii[i]]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cnt">7. cnt: contact forces</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>contact</em> interactions between objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect2">
<h3 id="_interface_4">7.1. interface</h3>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> cnt_ini(<span class="predefined-type">int</span> maxp, <span class="predefined-type">int</span> rank, int3 L, <span class="comment">/**/</span> Contact **c);
<span class="directive">void</span> cnt_fin(Contact *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> cnt_build_cells(<span class="predefined-type">int</span> nw, <span class="directive">const</span> PaWrap *pw, <span class="comment">/**/</span> Contact *c); <b class="conum">(1)</b>
<span class="directive">void</span> cnt_bulk(<span class="directive">const</span> PairParams*, <span class="directive">const</span> Contact *c, <span class="predefined-type">int</span> nw, PaWrap *pw, FoWrap *fw); <b class="conum">(2)</b>
<span class="directive">void</span> cnt_halo(<span class="directive">const</span> PairParams*, <span class="directive">const</span> Contact *c, <span class="predefined-type">int</span> nw, PaWrap *pw, FoWrap *fw, Pap26 PP, Fop26 FF, <span class="predefined-type">int</span> counts[<span class="integer">26</span>]); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>build cell lists for local objects</p>
</li>
<li>
<p>compute the interactions between local objects particles</p>
</li>
<li>
<p>compute the interactions between local and remote objects particles</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_color">8. color</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_purpose">8.1. purpose</h3>
<div class="paragraph">
<p>Each particle of the solvent has an assigned color when the
<code>multi_solvent</code> flag is enabled.
It is helpful for modeling different solvent with different
viscosities, surface tensions etc.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modules_2">8.2. modules</h3>
<div class="paragraph">
<p>Some utility modules are implemeted in <code>/src/color</code>.</p>
</div>
<div class="sect3">
<h4 id="_flux">8.2.1. flux</h4>
<div class="paragraph">
<p>recolor particles crossing the face of the periodic domain in the
positive direction x, y or z</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> int3;
<span class="keyword">struct</span> Particle;
<span class="keyword">struct</span> Coords;

<span class="directive">void</span> color_linear_flux(<span class="directive">const</span> Coords*, int3 L, <span class="predefined-type">int</span> dir, <span class="predefined-type">int</span> color, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span>
                       <span class="predefined-type">int</span> *cc);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dir</code> is the direction x, y or z</p>
</li>
<li>
<p><code>color</code> is the new color</p>
</li>
<li>
<p><code>pp</code> are input particles of size <code>n</code></p>
</li>
<li>
<p><code>cc</code> are output colors (stay the same if does not cross the face)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comm">9. comm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>generic communicator with "halo".</p>
</div>
<div class="sect2">
<h3 id="_purpose_2">9.1. purpose</h3>
<div class="paragraph">
<p>Communicate data with the neighboring ranks</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_structures_2">9.2. data structures</h3>
<div class="paragraph">
<p><code>hBags</code>: buffers on the host, contains all necessary information of the data to communicate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> hBags {
    data_t *data[NBAGS]; <span class="comment">/* data on the host                    */</span>
    <span class="predefined-type">int</span>         *counts; <span class="comment">/* size of the data                    */</span>
    <span class="predefined-type">int</span> capacity[NBAGS]; <span class="comment">/* capacity of each frag (elem number) */</span>
    size_t bsize;        <span class="comment">/* size of one datum in bytes          */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>dBags</code>: buffers on the device</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> dBags {
    data_t *data[NBAGS]; <span class="comment">/* data on the device         */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Comm</code>: contains the communication related variables. It is hidden
from user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_allocation_mod">9.3. allocation mod</h3>
<div class="paragraph">
<p>User can choose how the buffers are allocated with the enum type <code>AllocMod</code>.
This is used in the funcion <code>ini</code> and <code>fin</code>. allocation mode and free mode are assumed to be the same</p>
</div>
<div class="paragraph">
<p>currently supported allocation modes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">    HST_ONLY,   <span class="comment">/* only host bags allocated                 */</span>
    DEV_ONLY,   <span class="comment">/* only device bags allocated               */</span>
    PINNED,     <span class="comment">/* both host and device pinned              */</span>
    PINNED_HST, <span class="comment">/* host pinned; no device memory            */</span>
    PINNED_DEV, <span class="comment">/* host pinned; device global memory on gpu */</span>
    NONE        <span class="comment">/* no allocation                            */</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_5">9.4. interface</h3>
<div class="sect3">
<h4 id="_memory_management">9.4.1. memory management</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">int</span> comm_bags_ini(AllocMod fmod, AllocMod bmod, size_t bsize, <span class="directive">const</span> <span class="predefined-type">int</span> capacity[NBAGS], <span class="comment">/**/</span> hBags *hb, dBags *db);
<span class="predefined-type">int</span> comm_bags_fin(AllocMod fmod, AllocMod bmod, <span class="comment">/**/</span> hBags *hb, dBags *db);
<span class="predefined-type">int</span> comm_ini(MPI_Comm cart, <span class="comment">/**/</span> Comm **c);
<span class="predefined-type">int</span> comm_fin(<span class="comment">/**/</span> Comm *c);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bags alloc:</strong> Given two structures <code>hBags</code> and <code>dBags</code>, <code>ini</code> allocates the buffers on host and device. <code>ini</code> expects 2 allocation modes:</p>
<div class="ulist">
<ul>
<li>
<p><code>fmod</code>: allocation mode for fragment buffers</p>
</li>
<li>
<p><code>bmod</code>: allocation mode for bulk buffer</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>comm alloc</strong>: initialize <code>Comm</code> structure</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_communication">9.4.2. communication</h4>
<div class="paragraph">
<p>Communication happens between host bags (see <code>hBags</code> structure).
It needs 3 entities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>receiver bags</p>
</li>
<li>
<p>sender bags</p>
</li>
<li>
<p>a <code>Comm</code> for communicating through MPI</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The interface is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">int</span> comm_post_recv(hBags *b, Comm *c);           <b class="conum">(1)</b>
<span class="predefined-type">int</span> comm_post_send(<span class="directive">const</span> hBags *b, Comm *c);     <b class="conum">(2)</b>

<span class="predefined-type">int</span> comm_wait_recv(Comm *c, <span class="comment">/**/</span> hBags *b);      <b class="conum">(3)</b>
<span class="predefined-type">int</span> comm_wait_send(Comm *c);                     <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>call MPI asynchroneous recv and store requests in <code>s</code></p>
</li>
<li>
<p>call MPI asynchroneous send and store requests in <code>s</code></p>
</li>
<li>
<p>wait for recv requests</p>
</li>
<li>
<p>wait for send requests</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conf">10. conf: runtime configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_purpose_3">10.1. purpose</h3>
<div class="ulist">
<ul>
<li>
<p>wrapper for the <code>libconfig</code> library</p>
</li>
<li>
<p>holds configurations from 4 sources:</p>
<div class="ulist">
<ul>
<li>
<p>set by program (priority 4)</p>
</li>
<li>
<p>arguments (priority 3)</p>
</li>
<li>
<p>configuration file (priority 2)</p>
</li>
<li>
<p>default parameters (priority 1)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When retrieving a value, the source with higher priority is used.
If not found in a source, the value is retrieved from the next highest
priority.
If no source contains the parmeter, an error is raised.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_structure">10.2. data structure</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="keyword">enum</span> {
    EXE, <span class="comment">/* from program setters */</span>
    ARG, <span class="comment">/* from arguments       */</span>
    OPT, <span class="comment">/* from additional file */</span>
    DEF, <span class="comment">/* from default file    */</span>
    NCFG
};

<span class="keyword">struct</span> Config {
    config_t c[NCFG];
    config_t *r; <span class="comment">/* what have been read */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Consists of an array of <code>config_t</code> descriptors, ordered by priority.
Indices correspond to the <code>enum</code> keys.
The first key has the highest priority, second key has second highest
priority etc.</p>
</div>
<div class="paragraph">
<p>The <code>r</code> field is the configuration history, i.e what is read by the program.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_6">10.3. interface</h3>
<div class="paragraph">
<p>Allocate and free the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> conf_ini(<span class="comment">/**/</span> Config **c);
<span class="directive">void</span> conf_fin(<span class="comment">/**/</span> Config *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read data from the default, optional and command line config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> conf_read(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span> **argv, <span class="comment">/**/</span> Config *cfg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> conf_lookup_int(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *a);
<span class="directive">void</span> conf_lookup_float(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">float</span> *a);
<span class="directive">void</span> conf_lookup_bool(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *a);
<span class="directive">void</span> conf_lookup_string(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="directive">const</span> <span class="predefined-type">char</span> **a);
<span class="directive">void</span> conf_lookup_vint(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *n, <span class="predefined-type">int</span> a[]);
<span class="directive">void</span> conf_lookup_int3(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, int3 *a);
<span class="directive">void</span> conf_lookup_vfloat(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *n, <span class="predefined-type">float</span> a[]);
<span class="directive">void</span> conf_lookup_float3(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, float3 *a);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the program raises an error if the argument is not found or
if an error occured (e.g. wrong type).</p>
</div>
<div class="paragraph">
<p>Lookup variables from the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">bool</span> conf_opt_int(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *a);
<span class="predefined-type">bool</span> conf_opt_float(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">float</span> *a);
<span class="predefined-type">bool</span> conf_opt_bool(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *a);
<span class="predefined-type">bool</span> conf_opt_string(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="directive">const</span> <span class="predefined-type">char</span> **a);
<span class="predefined-type">bool</span> conf_opt_vint(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *n, <span class="predefined-type">int</span> a[]);
<span class="predefined-type">bool</span> conf_opt_int3(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, int3 *a);
<span class="predefined-type">bool</span> conf_opt_vfloat(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> *n, <span class="predefined-type">float</span> a[]);
<span class="predefined-type">bool</span> conf_opt_float3(<span class="directive">const</span> Config *c, <span class="directive">const</span> <span class="predefined-type">char</span> *desc, float3 *a);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The program does not raise error if the variable is not found.
The return value is <code>true</code> if the variable has been found and <code>false</code>
otherwise.</p>
</div>
<div class="paragraph">
<p>The client may overwrite variables in the config object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> conf_set_int(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> a, Config *c);
<span class="directive">void</span> conf_set_vint(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> nelem, <span class="directive">const</span> <span class="predefined-type">int</span> a[], Config *cfg);
<span class="directive">void</span> conf_set_int3(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, int3 a, Config *cfg);
<span class="directive">void</span> conf_set_float(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">float</span> a, Config *cfg);
<span class="directive">void</span> conf_set_vfloat(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> nelem, <span class="directive">const</span> <span class="predefined-type">float</span> a[], Config *cfg);
<span class="directive">void</span> conf_set_float3(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, float3 a, Config *cfg);
<span class="directive">void</span> conf_set_bool(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="predefined-type">int</span> a, Config *cfg);
<span class="directive">void</span> conf_set_string(<span class="directive">const</span> <span class="predefined-type">char</span> *desc, <span class="directive">const</span> <span class="predefined-type">char</span> *a, Config *cfg);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>desc</code> contains the names of the nested groups. separated by a <code>.</code> or
a <code>/</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">const</span> <span class="predefined-type">char</span> *desc = <span class="string"><span class="delimiter">&quot;</span><span class="content">main.sub.a</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>will correspond to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++">main = {
    sub = {
        a = ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration can be dumped by using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> conf_write_exe(<span class="directive">const</span> Config *cfg, FILE *stream);     <b class="conum">(1)</b>
<span class="directive">void</span> conf_write_history(<span class="directive">const</span> Config *cfg, FILE *stream); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>dump the fields set by the program to a stream</p>
</li>
<li>
<p>dump the fields read by the program to a stream</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_control">11. Control</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>velocity controller</p>
</li>
<li>
<p>open boundary conditions</p>
</li>
<li>
<p>density controller</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_velocity_controller">11.1. Velocity controller</h3>
<div class="paragraph">
<p>control velocity by modifying the imposed hydrostatic force
the force is modified using a PID controller <a href="https://en.wikipedia.org/wiki/PID_controller" class="bare">https://en.wikipedia.org/wiki/PID_controller</a>.</p>
</div>
<div class="sect3">
<h4 id="_controlled_variables">11.1.1. Controlled variables</h4>
<div class="paragraph">
<p>The controlled variable is the (global) body force value.
The state of the system is represented by</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{U} = \frac 1 n \sum\limits_{i=1}^n \mathbf{f} \left( \mathbf{r_i}, \mathbf{v_i} \right)\]
</div>
</div>
<div class="paragraph">
<p>where \(( \mathbf{r_i}, \mathbf{v_i})\) are the \(i^{th}\)
particle position and velocity, \(n\) is the number of particles
and \(\mathbf{f}\) is a given transformation.</p>
</div>
<div class="paragraph">
<p>There is therefore 3 (independant) controlled variables.</p>
</div>
<div class="paragraph">
<p>the transformation is the way of averaging the velocity:</p>
</div>
<div class="paragraph">
<p>cartesian transformation keeps the velocity and does not depends on
position:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{f} \left( \mathbf{r}, \mathbf{v} \right) = \mathbf{v}\]
</div>
</div>
<div class="paragraph">
<p>radial transformation returns the velocity in polar coordinates
scaled by the radial position. the <code>z</code> component corresponds to
cartesian transformation:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{f} \left( \mathbf{r}, \mathbf{v} \right) = \left(
r [v_x \cos(\theta) + v_y \sin(\theta)],
r[- v_x \sin(\theta) + v_y \cos(\theta)],
v_z \right),\]
</div>
</div>
<div class="paragraph">
<p>with \(r = \sqrt{x^2 + y^2}\) and \(\theta = \arctan(y/x)\).
\(x\) and \(y\) are particle position with respect to the center of the domain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_7">11.1.2. interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> vcont_ini(MPI_Comm comm, int3 L, <span class="comment">/**/</span> PidVCont **c);
<span class="directive">void</span> vcont_fin(<span class="comment">/**/</span> PidVCont *cont);</code></pre>
</div>
</div>
<div class="paragraph">
<p>set the parameters (to be done only once, before any other calls):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> vcont_set_params(<span class="predefined-type">float</span> factor, <span class="predefined-type">float</span> Kp, <span class="predefined-type">float</span> Ki, <span class="predefined-type">float</span> Kd, <span class="comment">/**/</span> PidVCont *c); <b class="conum">(1)</b>
<span class="directive">void</span> vcont_set_target(float3 vtarget, <span class="comment">/**/</span> PidVCont *c);  <b class="conum">(2)</b>
<span class="directive">void</span> vcont_set_cart(<span class="comment">/**/</span> PidVCont *c);  <b class="conum">(3)</b>
<span class="directive">void</span> vcont_set_radial(<span class="comment">/**/</span> PidVCont *c);  <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set the PID control variables. <code>factor</code> scales variables <code>Kp</code>, Ki`
and <code>Kd</code></p>
</li>
<li>
<p>set the target velocity (in transformed space)</p>
</li>
<li>
<p>set the transformation mode to cartesian</p>
</li>
<li>
<p>set the transformation mode to radial</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The parameters can also be set through the configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> vcont_set_conf(<span class="directive">const</span> Config *cfg, <span class="comment">/**/</span> PidVCont *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the state of the controller is set to zero current
velocity.
It can also be set throught the <a href="#io_restart">restart</a> mechanism:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> vcont_strt_dump(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="predefined-type">int</span> id, <span class="directive">const</span> PidVCont*); <b class="conum">(1)</b>
<span class="directive">void</span> vcont_strt_read(          <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="predefined-type">int</span> id, PidVCont*);       <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>dump the state of the controller to a text file</p>
</li>
<li>
<p>read the state from a text file</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Control operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span>   vcont_sample(<span class="directive">const</span> Coords *coords, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="directive">const</span> <span class="predefined-type">int</span> *starts, <span class="directive">const</span> <span class="predefined-type">int</span> *counts, <span class="comment">/**/</span> PidVCont *c); <b class="conum">(1)</b>
float3 vcont_adjustF(<span class="comment">/**/</span> PidVCont *c); <b class="conum">(2)</b>
<span class="directive">void</span>   vcont_log(<span class="directive">const</span> PidVCont *c);    <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get average velocity according to transformation and store it</p>
</li>
<li>
<p>reduce sampled quantities and update the controller. return the force</p>
</li>
<li>
<p>logging informations; dumped into the file <code>vcon.txt</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">11.1.3. configuration</h4>
<div class="paragraph">
<p>syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">vcon = {
     active = true
     type   = &quot;cart&quot;          # can be also &quot;rad&quot;
     U      = [1.0, 1.0, 0.0] # target velocity in transformed space
     factor = 0.08
     Kp = 2.0
     Ki = 1.0
     Kd = 8.0
     log_freq    = 500
     adjust_freq = 500
     sample_freq = 1
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inflow">11.2. Inflow</h3>
<div class="paragraph">
<p>Mass rate inflow.</p>
</div>
<div class="paragraph">
<p>Create particles given a surface \(S(u, v)\), with a velocity profile
\(\mathbf{U}(u,v)\) with \((u,v) \in (0,1) \times (0,1)\).</p>
</div>
<div class="sect3">
<h4 id="_method">11.2.1. Method</h4>
<div class="paragraph">
<p>Define "cumulative inflow" \(\phi(u, v)\) in a bin of area \(dA
\in S\).</p>
</div>
<div class="paragraph">
<p>Updated as follow:</p>
</div>
<div class="stemblock">
<div class="content">
\[\phi^{n+1} = \phi^n + dt \rho dA \mathbf{u} \cdot \mathbf{n}\]
</div>
</div>
<div class="paragraph">
<p>where \(\rho\) is the number density.</p>
</div>
<div class="paragraph">
<p>When \(\phi \geq 1\), a particle is released at the bin position
with random velocity \(\mathcal{N} (\mathbf{u}, k_BT)\).
We also set \(\phi \leftarrow \phi - 1\).</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_8">11.2.2. interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inflow_ini(int2 nc, Inflow **i);
<span class="directive">void</span> inflow_fin(Inflow *i);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize the inflow structure (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inflow_ini_velocity(Inflow *i);

<span class="directive">void</span> inflow_ini_params_plate(<span class="directive">const</span> Coords *c, float3 o, <span class="predefined-type">int</span> dir, <span class="predefined-type">float</span> L1, <span class="predefined-type">float</span> L2,
                             float3 u, <span class="predefined-type">bool</span> upoiseuille, <span class="predefined-type">bool</span> vpoiseuille,
                             <span class="comment">/**/</span> Inflow *i);
<span class="directive">void</span> inflow_ini_params_circle(<span class="directive">const</span> Coords *c, float3 o, <span class="predefined-type">float</span> R, <span class="predefined-type">float</span> H, <span class="predefined-type">float</span> u, <span class="predefined-type">bool</span> poiseuille,
                              <span class="comment">/**/</span> Inflow *i);</code></pre>
</div>
</div>
<div class="paragraph">
<p>depending on the type of inflow, call the appropriate
<code>ini_params_xxx</code>.
<code>ini_velocity</code> must be called after initializing the parameters.
it is used to setup the inlet velocity from parameters.</p>
</div>
<div class="paragraph">
<p>initialize from config parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inflow_ini_params_conf(<span class="directive">const</span> Coords *coords, <span class="directive">const</span> Config *cfg, <span class="comment">/**/</span> Inflow *i);</code></pre>
</div>
</div>
<div class="paragraph">
<p>create particles (at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inflow_create_pp(<span class="predefined-type">float</span> kBT, <span class="predefined-type">int</span> numdensity, <span class="predefined-type">float</span> dt, Inflow *i, <span class="predefined-type">int</span> *n, Particle *pp); <b class="conum">(1)</b>
<span class="directive">void</span> inflow_create_pp_cc(<span class="predefined-type">float</span> kBT, <span class="predefined-type">int</span> numdensity, <span class="predefined-type">float</span> dt, <span class="predefined-type">int</span> newcolor, Inflow *i, <span class="predefined-type">int</span> *n, Particle *pp, <span class="predefined-type">int</span> *cc); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add particles to the array <code>pp</code> and increase <code>n</code> accordingly</p>
</li>
<li>
<p>same as above, with colors <code>cc</code> set to <code>color</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_2">11.2.3. configuration</h4>
<div class="sect4">
<h5 id="_plate">plate</h5>
<div class="paragraph">
<p>syntax for a <code>8.0 x 16.0</code> plate perpendicular to the x axis passing by
the point <code>(1, 2, 3)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">inflow = {
    active      = true
    type        = &quot;plate&quot;
    L1          = 1.0
    L2          = 16.0
    direction   = 0                # [0,1,2] = [X,Y,Z]
    origin      = [1.0, 2.0, 3.0]
    upoiseuille = false            # true for parabolic profile along L1
    vpoiseuille = false            # true for parabolic profile along L2
    u           = [10.0, 0.0, 0.0]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_circle">circle</h5>
<div class="paragraph">
<p>syntax for cylindrical surface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">inflow = {
    active = true
    type   = &quot;circle&quot;
    R      = 1.0              # radius
    H      = 16.0             # hight of the cylinder
    U      = 1.0              # maximum velocity
    center = [8.0, 8.0, 8.0]
    poiseuille = false        # parabolic profile along H if true
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_outflow">11.3. Outflow</h3>
<div class="paragraph">
<p>Delete particles satisfying a predicate</p>
</div>
<div class="sect3">
<h4 id="_interface_9">11.3.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> outflow_ini(<span class="predefined-type">int</span> maxp, <span class="comment">/**/</span> Outflow **o);
<span class="directive">void</span> outflow_fin(<span class="comment">/**/</span> Outflow *o);</code></pre>
</div>
</div>
<div class="paragraph">
<p>set the outflow geometry type (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> outflow_set_params_circle(<span class="directive">const</span> Coords*, float3 c, <span class="predefined-type">float</span> R, Outflow *o);
<span class="directive">void</span> outflow_set_params_plate(<span class="directive">const</span> Coords*, <span class="predefined-type">int</span> dir, <span class="predefined-type">float</span> r0, Outflow *o);</code></pre>
</div>
</div>
<div class="paragraph">
<p>this can be done via <a href="#conf">configuration</a> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> outflow_set_conf(<span class="directive">const</span> Config *cfg, <span class="directive">const</span> Coords*, Outflow *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>filter and mark particles (to be called at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> outflow_filter_particles(<span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> Outflow *o); <b class="conum">(1)</b>

<span class="directive">void</span> outflow_download_ndead(Outflow *o);                                   <b class="conum">(2)</b>

<span class="predefined-type">int</span>* outflow_get_deathlist(Outflow *o);                                    <b class="conum">(3)</b>
<span class="predefined-type">int</span>  outflow_get_ndead(Outflow *o);                                        <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>store dying particles infos inside Outflow struct</p>
</li>
<li>
<p>copy from device to host number of dead particles</p>
</li>
<li>
<p>return the list of dead marks (dead=1, alive=0)</p>
</li>
<li>
<p>return the number of dead particles</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_3">11.3.2. configuration</h4>
<div class="sect4">
<h5 id="_plate_2">plate</h5>
<div class="paragraph">
<p>will delete particles crossing a plate along the positive direction.
syntax for the plate <code>y=4</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">outflow = {
    active     = true
    type       = &quot;plate&quot;
    direction  = 1      # [0,1,2] = [X,Y,Z]
    position   = 4.0    # position along &quot;direction&quot;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_circle_2">circle</h5>
<div class="paragraph">
<p>delete particles going out of the cylinder.
syntax for a cylinder of radius 8 centered at <code>(8, 8, 8)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">outflow = {
    active = true
    type   = &quot;circle&quot;
    R      = 8.0
    center = [8.0, 8.0, 8.0]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_den_density_controller">11.4. den: Density controller</h3>
<div class="paragraph">
<p>Delete particles in high density regions</p>
</div>
<div class="sect3">
<h4 id="_interface_10">11.4.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> den_ini(<span class="predefined-type">int</span> maxp, <span class="comment">/**/</span> DCont**);
<span class="directive">void</span> den_map_ini(DContMap**);

<span class="directive">void</span> den_fin(DCont*);
<span class="directive">void</span> den_map_fin(DContMap*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>set the geometry type (to be done only once):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> den_map_set_none(<span class="directive">const</span> Coords*, DContMap*);
<span class="directive">void</span> den_map_set_circle(<span class="directive">const</span> Coords*, <span class="predefined-type">float</span> R, DContMap*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>this can be done via <a href="#conf">configuration</a> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> den_map_set_conf(<span class="directive">const</span> Config*, <span class="directive">const</span> Coords*, DContMap*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>filter and mark particles (to be called at every time step):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> outflow_filter_particles(<span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> Outflow *o); <b class="conum">(1)</b>

<span class="directive">void</span> outflow_download_ndead(Outflow *o);                                   <b class="conum">(2)</b>

<span class="predefined-type">int</span>* outflow_get_deathlist(Outflow *o);                                    <b class="conum">(3)</b>
<span class="predefined-type">int</span>  outflow_get_ndead(Outflow *o);                                        <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>reset the structure</p>
</li>
<li>
<p>internally mark particles in the regions with density higher than <code>macdensity</code></p>
</li>
<li>
<p>internally download the number of dead particles</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The above functions only compute and store the results internally. The
computed quantities can be accessed via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> outflow_filter_particles(<span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> Outflow *o); <b class="conum">(1)</b>

<span class="directive">void</span> outflow_download_ndead(Outflow *o);                                   <b class="conum">(2)</b>

<span class="predefined-type">int</span>* outflow_get_deathlist(Outflow *o);                                    <b class="conum">(3)</b>
<span class="predefined-type">int</span>  outflow_get_ndead(Outflow *o);                                        <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>return a pointer to internal buffer with the "death list"</p>
</li>
<li>
<p>return the number of particles killed by the filter operation</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_4">11.4.2. configuration</h4>
<div class="sect4">
<h5 id="_none">none</h5>
<div class="paragraph">
<p>disabled density control everywhere</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">denoutflow = {
    active = true
    type = &quot;none&quot;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_circle_3">circle</h5>
<div class="paragraph">
<p>delete particles going out of a cylinder centered at the center of the
domain.
syntax for a cylinder of radius 8:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">denoutflow = {
    active = true
    type   = &quot;circle&quot;
    R      = 8.0
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coords">12. coords</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Coordinate transforms utility.</p>
</div>
<div class="paragraph">
<p>In <em>uDeviceX</em>, the simulation domain is decomposed into a grid of
subdomains of equal sizes.
Computations are performed in <em>local</em> coordinates and all objects are
relative to these coordinates.
Operations, such as initialisation of the data, io, etc., need
<em>global</em> coordinates informations.</p>
</div>
<div class="paragraph">
<p>For convenience, we consider the three coordinate systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Global</em>: Relative to the lower corner of the full domain of size
\((G_x, G_y, G_z)\)</p>
</li>
<li>
<p><em>Local</em>: Relative to the center of the subdomain of size
\((L_x, L_y, L_z)\)</p>
</li>
<li>
<p><em>Center</em>: Relative to the center of the full domain: \((C_x,
C_y, C_z) = (G_x/2, G_y/2, G_z/2)\)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_data_structures_3">12.1. data structures</h3>
<div class="paragraph">
<p>All the needed information is stored in the hidden structure <code>Coords</code>.
A <em>view</em> structure <code>Coords_v</code> is public to device code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> Coords_v {
    <span class="predefined-type">int</span> xc, yc, zc; <span class="comment">/* rank coordinates        */</span>
    <span class="predefined-type">int</span> xd, yd, zd; <span class="comment">/* rank sizes              */</span>
    <span class="predefined-type">int</span> Lx, Ly, Lz; <span class="comment">/* [L]ocal: subdomain size */</span>
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_host_interface">12.2. Host interface</h3>
<div class="sect3">
<h4 id="_memory_management_2">12.2.1. Memory management</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> coords_ini(MPI_Comm cart, <span class="predefined-type">int</span> Lx, <span class="predefined-type">int</span> Ly, <span class="predefined-type">int</span> Lz, Coords **c); <b class="conum">(1)</b>
<span class="directive">void</span> coords_fin(Coords *c); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate and set the data according to the cartesian communicator</p>
</li>
<li>
<p>deallocate the structure</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The resources can also be allocated using configuration informations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> coords_ini_conf(MPI_Comm cart, <span class="directive">const</span> Config *cfg, Coords **c);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getters">12.2.2. Getters</h4>
<div class="paragraph">
<p>Obtain a view structure from <code>Coords</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> coords_get_view(<span class="directive">const</span> Coords *c, Coords_v *v);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((G_x, G_y, G_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">int</span> xdomain(<span class="directive">const</span> Coords *c);
<span class="predefined-type">int</span> ydomain(<span class="directive">const</span> Coords *c);
<span class="predefined-type">int</span> zdomain(<span class="directive">const</span> Coords *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get \((L_x, L_y, L_z)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">int</span> xs(<span class="directive">const</span> Coords*);
<span class="predefined-type">int</span> ys(<span class="directive">const</span> Coords*);
<span class="predefined-type">int</span> zs(<span class="directive">const</span> Coords*);
int3 subdomain(<span class="directive">const</span> Coords*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get (from <em>local</em> coordinates) \((-L_x/2, -L_y/2, -L_z/2)\) and
\((L_x/2, L_y/2, L_z/2)\) in <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">int</span> xlo(<span class="directive">const</span> Coords*);
<span class="predefined-type">int</span> ylo(<span class="directive">const</span> Coords*);
<span class="predefined-type">int</span> zlo(<span class="directive">const</span> Coords*);

<span class="predefined-type">int</span> xhi(<span class="directive">const</span> Coords*);
<span class="predefined-type">int</span> yhi(<span class="directive">const</span> Coords*);
<span class="predefined-type">int</span> zhi(<span class="directive">const</span> Coords*);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coordinate_transforms">12.2.3. Coordinate transforms</h4>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>center</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">float</span> xl2xc(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> xl);
<span class="predefined-type">float</span> yl2yc(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> yl);
<span class="predefined-type">float</span> zl2zc(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> zl);
<span class="directive">void</span> local2center(<span class="directive">const</span> Coords *c, float3 rl, <span class="comment">/**/</span> float3 *rc);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>center</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">float</span> xc2xl(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> xc);
<span class="predefined-type">float</span> yc2yl(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> yc);
<span class="predefined-type">float</span> zc2zl(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> zc);
<span class="directive">void</span> center2local(<span class="directive">const</span> Coords *c, float3 rc, <span class="comment">/**/</span> float3 *rl);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>local</em> coordinates to <em>global</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">float</span> xl2xg(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> xl);
<span class="predefined-type">float</span> yl2yg(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> yl);
<span class="predefined-type">float</span> zl2zg(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> zl);
<span class="directive">void</span> local2global(<span class="directive">const</span> Coords *c, float3 rl, <span class="comment">/**/</span> float3 *rg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>From <em>global</em> coordinates to <em>local</em> coordinates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">float</span> xg2xl(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> xg);
<span class="predefined-type">float</span> yg2yl(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> yg);
<span class="predefined-type">float</span> zg2zl(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> zg);
<span class="directive">void</span> global2local(<span class="directive">const</span> Coords *c, float3 rg, <span class="comment">/**/</span> float3 *rl);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_helpers">12.2.4. helpers</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="comment">/* rank predicates */</span>
<span class="predefined-type">bool</span> is_end(<span class="directive">const</span> Coords *c, <span class="predefined-type">int</span> dir);

<span class="comment">/* a string unique for a rank */</span>
<span class="directive">void</span> coord_stamp(<span class="directive">const</span> Coords *c, <span class="comment">/**/</span> <span class="predefined-type">char</span> *s);

<span class="comment">/* number of subdomains */</span>
<span class="predefined-type">int</span> coords_size(<span class="directive">const</span> Coords *c);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_5">12.3. Configuration</h3>
<div class="paragraph">
<p>Set subdomain sizes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">glb = {
    L = [16, 12, 24]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generic_d_evice_api">13. generic [d]evice API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal is to make cuda API and kernel functions generic. Meaning
they can be replaced by CPU calls.</p>
</div>
<div class="paragraph">
<p>There are two groups: functions which "mirror" cuda API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">int</span> Malloc(<span class="directive">void</span> **p, size_t);
<span class="predefined-type">int</span> MemcpyToSymbol(<span class="directive">const</span> <span class="directive">void</span> *symbol, <span class="directive">const</span> <span class="directive">void</span> *src, size_t count, size_t offset=<span class="integer">0</span>, <span class="predefined-type">int</span> kind=MemcpyHostToDevice);
<span class="predefined-type">int</span> MemcpyFromSymbol(<span class="directive">void</span> *dst, <span class="directive">const</span> <span class="directive">void</span> *symbol, size_t count, size_t offset=<span class="integer">0</span>, <span class="predefined-type">int</span> kind=MemcpyDeviceToHost);
<span class="predefined-type">int</span> HostGetDevicePointer(<span class="directive">void</span> **pDevice, <span class="directive">void</span> *pHost, <span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> flags);
<span class="predefined-type">int</span> Memcpy (<span class="directive">void</span> *dst, <span class="directive">const</span> <span class="directive">void</span> *src, size_t count, <span class="predefined-type">int</span> kind);
<span class="predefined-type">int</span> MemsetAsync (<span class="directive">void</span> *devPtr, <span class="predefined-type">int</span> value, size_t count, Stream_t stream=<span class="integer">0</span>);
<span class="predefined-type">int</span> Memset (<span class="directive">void</span> *devPtr, <span class="predefined-type">int</span> value, size_t count);
<span class="predefined-type">int</span> MemcpyAsync (<span class="directive">void</span> * dst, <span class="directive">const</span> <span class="directive">void</span> * src, size_t count, <span class="predefined-type">int</span> kind, Stream_t stream = <span class="integer">0</span>);
<span class="predefined-type">int</span> Free (<span class="directive">void</span> *devPtr);
<span class="predefined-type">int</span> FreeHost (<span class="directive">void</span> *hstPtr);
<span class="predefined-type">int</span> DeviceSynchronize (<span class="directive">void</span>);
<span class="predefined-type">int</span> PeekAtLastError(<span class="directive">void</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>functions unique for <em>uDeviceX</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">const</span> <span class="predefined-type">char</span> *emsg();
<span class="predefined-type">int</span> alloc_pinned(<span class="directive">void</span> **pHost, size_t size);
<span class="predefined-type">int</span> is_device_pointer(<span class="directive">const</span> <span class="directive">void</span> *ptr);</code></pre>
</div>
</div>
<div class="paragraph">
<p>files of the interface
- <code>d/api.h</code> API calls
- <code>d/q.h</code> function and variable type qualifiers
- <code>d/ker.h</code></p>
</div>
<div class="paragraph">
<p>if <code>DEV_CUDA</code> is defined interfaces is implimented by cuda, if
<code>DEV_CPU</code> is defined it is implimented by host calls.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debug">14. debug</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helper to check the particle positions, velocities, forces and
cell-lists from device arrays</p>
</div>
<div class="paragraph">
<p>The hidden structure <code>Dbg</code> holds the debugging configuration.
Configuration is encoded using the following enum values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="keyword">enum</span> {
    DBG_POS,      <b class="conum">(1)</b>
    DBG_POS_SOFT, <b class="conum">(2)</b>
    DBG_VEL,      <b class="conum">(3)</b>
    DBG_FORCES,   <b class="conum">(4)</b>
    DBG_COLORS,   <b class="conum">(5)</b>
    DBG_CLIST,    <b class="conum">(6)</b>
    DBG_NKIND_
};</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>positions are inside subdomain</p>
</li>
<li>
<p>positions are inside subdomain plus a margin</p>
</li>
<li>
<p>velocities</p>
</li>
<li>
<p>forces</p>
</li>
<li>
<p>colors</p>
</li>
<li>
<p>cell lists</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Consider subdomain of dimensions \((L_x, Ly, Lz)\).
A position \((r_x, r_y, r_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[-\frac{L_\alpha - M} {2}  \leq r_\alpha &lt; \frac{L_\alpha + M} 2,\]
</div>
</div>
<div class="paragraph">
<p>where \(M\) is the margin. It is \(M = 0\) for <code>DBG_POS</code> and
\(M = 3\) for <code>DBG_POS_SOFT</code>.</p>
</div>
<div class="paragraph">
<p>For a given timestep \(dt\), the velocity \((v_x, v_y, v_z)\) is
valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |v_\alpha| dt \leq L_\alpha.\]
</div>
</div>
<div class="paragraph">
<p>The force \((f_x, f_y, f_z)\) is valid if</p>
</div>
<div class="stemblock">
<div class="content">
\[2 |f_\alpha| dt^2 \leq L_\alpha.\]
</div>
</div>
<div class="sect2">
<h3 id="_interface_11">14.1. interface</h3>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> dbg_ini(Dbg**);
<span class="directive">void</span> dbg_fin(Dbg*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>set debugging modes and verbosity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> dbg_enable(<span class="predefined-type">int</span> kind, Dbg *dbg);
<span class="directive">void</span> dbg_disable(<span class="predefined-type">int</span> kind, Dbg *dbg);
<span class="directive">void</span> dbg_set_verbose(<span class="predefined-type">bool</span>, Dbg *dbg);
<span class="directive">void</span> dbg_set_dump(<span class="predefined-type">bool</span>, Dbg *dbg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> dbg_set_conf(<span class="directive">const</span> Config*, Dbg*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> dbg_check_pos(<span class="directive">const</span> Coords *c, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> Dbg *dbg, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp);
<span class="directive">void</span> dbg_check_pos_soft(<span class="directive">const</span> Coords *c, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> Dbg *dbg, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp);
<span class="directive">void</span> dbg_check_vel(<span class="predefined-type">float</span> dt, <span class="directive">const</span> Coords *c, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> Dbg *dbg, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp);
<span class="directive">void</span> dbg_check_forces(<span class="predefined-type">float</span> dt, <span class="directive">const</span> Coords *c, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> Dbg *dbg, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="directive">const</span> Force *ff);
<span class="directive">void</span> dbg_check_colors(<span class="directive">const</span> Coords *c, <span class="directive">const</span> Dbg *dbg, <span class="predefined-type">int</span> n, <span class="directive">const</span> <span class="predefined-type">int</span> *cc);
<span class="directive">void</span> dbg_check_clist(<span class="directive">const</span> Coords *c, <span class="directive">const</span> Dbg *dbg, int3 L, <span class="directive">const</span> <span class="predefined-type">int</span> *starts, <span class="directive">const</span> <span class="predefined-type">int</span> *counts, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_6">14.2. configuration</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">dbg = {
    verbose  = true;
    pos      = false;
    pos_soft = false;
    vel      = false;
    forces   = false;
    colors   = false;
    clist    = false;
};</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_distr">15. distr</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redistribution of quantities across nodes.
Each node has a local coordinate system. The origin is the center of a
"subdomain" of size <code>Sx</code>, <code>Sy</code>, <code>Sz</code>.</p>
</div>
<div class="paragraph">
<p>A quantity is sent to a neighboring rank if its position is outside of
the subdomain.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to redistribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_map_2">15.1. map</h3>
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all quantities.</p>
</div>
<div class="sect3">
<h4 id="_data_structure_2">15.1.1. data structure</h4>
<div class="paragraph">
<p>The structure to map local data from an array to packed data in 27
arrays is implemented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="comment">/* [D]istr Map */</span>
<span class="keyword">struct</span> DMap {
    <span class="predefined-type">int</span> *counts;  <span class="comment">/* number of entities leaving in each fragment */</span>
    <span class="predefined-type">int</span> *starts;  <span class="comment">/* cumulative sum of the above                 */</span>
    <span class="predefined-type">int</span> *ids[<span class="integer">27</span>]; <span class="comment">/* indices of leaving objects                  */</span>

    <span class="predefined-type">int</span> *hcounts; <span class="comment">/* counts on host (pinned) */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be allocated on device or on host memory (see interface).</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_12">15.1.2. interface</h4>
<div class="paragraph">
<p>Host interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> dmap_ini(<span class="predefined-type">int</span> nfrags, <span class="directive">const</span> <span class="predefined-type">int</span> capacity[], <span class="comment">/**/</span> DMap *m);
<span class="directive">void</span> dmap_fin(<span class="predefined-type">int</span> nfrags, <span class="comment">/**/</span> DMap *m);
<span class="directive">void</span> dmap_reini(<span class="predefined-type">int</span> nfrags, <span class="comment">/**/</span> DMap m);
<span class="directive">void</span> dmap_download_counts(<span class="predefined-type">int</span> nfrags, <span class="comment">/**/</span> DMap *m);
<span class="directive">void</span> dmap_ini_host(<span class="predefined-type">int</span> nfrags, <span class="directive">const</span> <span class="predefined-type">int</span> capacity[], <span class="comment">/**/</span> DMap *m);
<span class="directive">void</span> dmap_fin_host(<span class="predefined-type">int</span> nfrags, <span class="comment">/**/</span> DMap *m);
<span class="directive">void</span> dmap_reini_host(<span class="predefined-type">int</span> nfrags, <span class="comment">/**/</span> DMap m);
<span class="directive">void</span> dmap_D2H(<span class="predefined-type">int</span> nfrags, <span class="directive">const</span> DMap *d, <span class="comment">/**/</span> DMap *h);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="comment">/* exclusive scan */</span>
<span class="keyword">template</span> &lt;<span class="predefined-type">int</span> NCOUNTS&gt;
<span class="directive">static</span> __global__ <span class="directive">void</span> dmap_scan(<span class="comment">/**/</span> DMap m)              <b class="conum">(1)</b>
<span class="directive">static</span> __device__ <span class="predefined-type">int</span> dmap_get_fid(int3 L, <span class="directive">const</span> <span class="predefined-type">float</span> r[<span class="integer">3</span>])       <b class="conum">(2)</b>
<span class="directive">static</span> __device__ <span class="directive">void</span> dmap_add(<span class="predefined-type">int</span> pid, <span class="predefined-type">int</span> fid, DMap m)  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>prefix sum on counts to obtain starts</p>
</li>
<li>
<p>get fragment id from position</p>
</li>
<li>
<p>add a quantity to the map</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flu">15.2. flu</h3>
<div class="paragraph">
<p>Redistribute solvent particles accross nodes.</p>
</div>
<div class="sect3">
<h4 id="_data_structures_4">15.2.1. data structures</h4>
<div class="paragraph">
<p>Solvent distribution follow the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> Opt {
    <span class="predefined-type">bool</span> colors, ids;
};

<span class="keyword">struct</span> DFluPack {
    DMap map;
    dBags dpp, dii, dcc;
    hBags hpp, hii, hcc;
    <span class="predefined-type">int</span> nhalo; <span class="comment">/* number of sent particles */</span>
    int3 L; <span class="comment">/* subdomain size */</span>
    Opt opt;
};

<span class="keyword">struct</span> DFluComm {
    Comm *pp, *ii, *cc;
    Opt opt;
};

<span class="keyword">struct</span> DFluUnpack {
    hBags hpp, hii, hcc;
    Particle *ppre;
    <span class="predefined-type">int</span> *iire, *ccre;
    <span class="predefined-type">int</span> nhalo; <span class="comment">/* number of received particles */</span>
    int3 L; <span class="comment">/* subdomain size */</span>
    Opt opt;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>[d,h]xx</code> means quantities on <code>[device,host]</code> and <code>pp</code>
corresponds to particles, <code>cc</code> to colors and <code>ii</code> to global ids.
The <code>xxre</code> variables in <code>Unpack</code> are buffer for remote quantities.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_13">15.2.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> dflu_pack_ini(<span class="predefined-type">bool</span> colors, <span class="predefined-type">bool</span> ids, int3 L, <span class="predefined-type">int</span> maxdensity, DFluPack **p);
<span class="directive">void</span> dflu_comm_ini(<span class="predefined-type">bool</span> colors, <span class="predefined-type">bool</span> ids, MPI_Comm comm, <span class="comment">/**/</span> DFluComm **c);
<span class="directive">void</span> dflu_unpack_ini(<span class="predefined-type">bool</span> colors, <span class="predefined-type">bool</span> ids, int3 L, <span class="predefined-type">int</span> maxdensity, DFluUnpack **u);

<span class="directive">void</span> dflu_pack_fin(DFluPack *p);
<span class="directive">void</span> dflu_comm_fin(DFluComm *c);
<span class="directive">void</span> dflu_unpack_fin(DFluUnpack *u);

<span class="comment">/* map */</span>
<span class="directive">void</span> dflu_build_map(<span class="predefined-type">int</span> n, <span class="directive">const</span> PartList lp, DFluPack *p);

<span class="comment">/* pack */</span>
<span class="directive">void</span> dflu_pack(<span class="directive">const</span> FluQuants *q, <span class="comment">/**/</span> DFluPack *p);
<span class="directive">void</span> dflu_download(DFluPack *p, <span class="comment">/**/</span> DFluStatus *s);

<span class="comment">/* communication */</span>
<span class="directive">void</span> dflu_post_recv(DFluComm *c, DFluUnpack *u);
<span class="directive">void</span> dflu_post_send(DFluPack *p, DFluComm   *c);
<span class="directive">void</span> dflu_wait_recv(DFluComm *c, DFluUnpack *u);
<span class="directive">void</span> dflu_wait_send(DFluComm *c);

<span class="comment">/* unpack */</span>
<span class="directive">void</span> dflu_unpack(<span class="comment">/**/</span> DFluUnpack *u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The map is build from <a href="partlist.html">partlist</a>, allowing the
process to delete particles.</p>
</div>
<div class="paragraph">
<p>The solvent distribution also include cell list generation (see
<a href="clist.html">cell lists</a>).
It is done in two phases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>subindices, independant for bulk and remote particles</p>
</li>
<li>
<p>gather, which needs the subindices to be computed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bulk subindices can be computed while comunicating remote particles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="comment">/* cell lists */</span>
<span class="directive">void</span> dflu_bulk(PartList lp, <span class="comment">/**/</span> FluQuants *q);
<span class="directive">void</span> dflu_halo(<span class="directive">const</span> DFluUnpack *u, <span class="comment">/**/</span> FluQuants *q);
<span class="directive">void</span> dflu_gather(<span class="predefined-type">int</span> ndead, <span class="directive">const</span> DFluPack *p, <span class="directive">const</span> DFluUnpack *u, <span class="comment">/**/</span> FluQuants *q);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rbc">15.3. rbc</h3>
<div class="paragraph">
<p>Redistribute red blood cells accross nodes according to the center of
mass of their bounding box (see <a href="algo/minmax.html">minmax</a>).</p>
</div>
<div class="sect3">
<h4 id="_data_structures_5">15.3.1. data structures</h4>
<div class="paragraph">
<p>RBC distribution follows the common workflow described above and
contains the three <em>hidden</em> generic data structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> DRbcPack {
    DMap map;
    float3 *minext, *maxext;
    dBags dpp;
    hBags hpp;

    <span class="comment">/* optional: ids */</span>
    <span class="predefined-type">bool</span> ids;
    DMap hmap;
    hBags hii;

    int3 L; <span class="comment">/* subdomain size */</span>
};

<span class="keyword">struct</span> DRbcComm {
    <span class="comment">/* optional: ids */</span>
    Comm *pp, *ii;
    <span class="predefined-type">bool</span> ids;
};

<span class="keyword">struct</span> DRbcUnpack {
    hBags hpp;

    <span class="comment">/* optional: ids */</span>
    <span class="predefined-type">bool</span> ids;
    hBags hii;

    int3 L; <span class="comment">/* subdomain size */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>minext</code> and <code>maxext</code> contain the bounding box informations of
each RBC. Other variables have the same naming conventions than <code>distr::flu</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_14">15.3.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> drbc_pack_ini(<span class="predefined-type">bool</span> ids, int3 L, <span class="predefined-type">int</span> maxc, <span class="predefined-type">int</span> nv, DRbcPack **p);
<span class="directive">void</span> drbc_comm_ini(<span class="predefined-type">bool</span> ids, MPI_Comm comm, <span class="comment">/**/</span> DRbcComm **c);
<span class="directive">void</span> drbc_unpack_ini(<span class="predefined-type">bool</span> ids, int3 L, <span class="predefined-type">int</span> maxc, <span class="predefined-type">int</span> nv, DRbcUnpack **u);

<span class="directive">void</span> drbc_pack_fin(DRbcPack *p);
<span class="directive">void</span> drbc_comm_fin(DRbcComm *c);
<span class="directive">void</span> drbc_unpack_fin(DRbcUnpack *u);

<span class="directive">void</span> drbc_build_map(<span class="predefined-type">int</span> nc, <span class="predefined-type">int</span> nv, <span class="directive">const</span> Particle *pp, DRbcPack *p);
<span class="directive">void</span> drbc_pack(<span class="directive">const</span> RbcQuants *q, <span class="comment">/**/</span> DRbcPack *p);
<span class="directive">void</span> drbc_download(DRbcPack *p);

<span class="directive">void</span> drbc_post_recv(DRbcComm *c, DRbcUnpack *u);
<span class="directive">void</span> drbc_post_send(DRbcPack *p, DRbcComm *c);
<span class="directive">void</span> drbc_wait_recv(DRbcComm *c, DRbcUnpack *u);
<span class="directive">void</span> drbc_wait_send(DRbcComm *c);

<span class="directive">void</span> drbc_unpack_bulk(<span class="directive">const</span> DRbcPack *p, <span class="comment">/**/</span> RbcQuants *q);
<span class="directive">void</span> drbc_unpack_halo(<span class="directive">const</span> DRbcUnpack *u, <span class="comment">/**/</span> RbcQuants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rig">15.4. rig</h3>
<div class="paragraph">
<p>Redistribute rigid objects accross nodes according to their center of
mass.</p>
</div>
<div class="sect3">
<h4 id="_data_structures_6">15.4.1. data structures</h4>
<div class="paragraph">
<p>Rigid bodies distribution is very similar to the above. The <em>hidden</em> data
structures fit again in the general workflow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="comment">/*
 ipp: particles of the mesh
 ss:  &quot;Solid&quot; structures
*/</span>

<span class="keyword">struct</span> DRigPack {
    DMap map;
    dBags dipp, dss;
    hBags hipp, hss;
    int3 L;  <span class="comment">/* subdomain size */</span>
};

<span class="keyword">struct</span> DRigComm {
    Comm *ipp, *ss;
};

<span class="keyword">struct</span> DRigUnpack {
    hBags hipp, hss;
    int3 L;  <span class="comment">/* subdomain size */</span>
};</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_15">15.4.2. interface</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> drig_pack_ini(int3 L, <span class="predefined-type">int</span> maxns, <span class="predefined-type">int</span> nv, DRigPack **p);
<span class="directive">void</span> drig_comm_ini(MPI_Comm comm, <span class="comment">/**/</span> DRigComm **c);
<span class="directive">void</span> drig_unpack_ini(int3 L, <span class="predefined-type">int</span> maxns, <span class="predefined-type">int</span> nv, DRigUnpack **u);

<span class="directive">void</span> drig_pack_fin(DRigPack *p);
<span class="directive">void</span> drig_comm_fin(DRigComm *c);
<span class="directive">void</span> drig_unpack_fin(DRigUnpack *u);

<span class="directive">void</span> drig_build_map(<span class="predefined-type">int</span> ns, <span class="directive">const</span> Solid *ss, <span class="comment">/**/</span> DRigPack *p);
<span class="directive">void</span> drig_pack(<span class="predefined-type">int</span> ns, <span class="predefined-type">int</span> nv, <span class="directive">const</span> Solid *ss, <span class="directive">const</span> Particle *ipp, <span class="comment">/**/</span> DRigPack *p);
<span class="directive">void</span> drig_download(DRigPack *p);

<span class="directive">void</span> drig_post_recv(DRigComm *c, DRigUnpack *u);
<span class="directive">void</span> drig_post_send(DRigPack *p, DRigComm *c);
<span class="directive">void</span> drig_wait_recv(DRigComm *c, DRigUnpack *u);
<span class="directive">void</span> drig_wait_send(DRigComm *c);

<span class="directive">void</span> drig_unpack_bulk(<span class="directive">const</span> DRigPack *p, <span class="comment">/**/</span> RigQuants *q);
<span class="directive">void</span> drig_unpack_halo(<span class="directive">const</span> DRigUnpack *u, <span class="comment">/**/</span> RigQuants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>unpack_bulk</code> can be done before unpacking halo quantities.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_common">15.5. common</h3>
<div class="paragraph">
<p>helpers: common kernels</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> dcommon_pack_pp_packets(<span class="predefined-type">int</span> nc, <span class="predefined-type">int</span> nv, <span class="directive">const</span> Particle *pp, DMap m, <span class="comment">/**/</span> Sarray&lt;Particle*, <span class="integer">27</span>&gt; buf); <b class="conum">(1)</b>
<span class="directive">void</span> dcommon_shift_one_frag(int3 L, <span class="predefined-type">int</span> n, <span class="directive">const</span> <span class="predefined-type">int</span> fid, <span class="comment">/**/</span> Particle *pp); <b class="conum">(2)</b>
<span class="directive">void</span> dcommon_shift_halo(int3 L, <span class="predefined-type">int</span> nhalo, <span class="directive">const</span> Sarray&lt;<span class="predefined-type">int</span>, <span class="integer">27</span>&gt; starts, <span class="comment">/**/</span> Particle *pp); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>pack <code>nc</code>  packets of <code>nv</code> particles into 27 buffers <code>buf</code> according to map</p>
</li>
<li>
<p>shift particles in the fragment direction</p>
</li>
<li>
<p>shift all particles according to the fragment direction</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exch">16. exch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Exchange quantities across nodes for "ghost particles".</p>
</div>
<div class="paragraph">
<p>A quantity is exchanged with a neighboring node if its position is
within a given distance from the subdomain boundaries.</p>
</div>
<div class="paragraph">
<p>The workflow is very similar for every quantity to exchange:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>build a map from the positions of the quatities and store it in a
<code>Map</code> structure.</p>
</li>
<li>
<p>pack the data using <code>Map</code> in a <code>Pack</code> structure</p>
</li>
<li>
<p>communicaion: exchange packed data with neighbors, receive data into
<code>Unpack</code> structure. This is done using the
<a href="comm.html">generic communicator</a>.</p>
</li>
<li>
<p>Unpack the data from <code>Unpack</code> to quantities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optionally, other quantities can be exchanged back, e.g. forces.</p>
</div>
<div class="sect2">
<h3 id="_map_3">16.1. map</h3>
<div class="paragraph">
<p>Helper for packing data to send buffers. This is common to all
quantities.
As opposed to the <em>distr</em> module, the mapping is not <em>one to one</em>.
A single quantity can be exchanged with up to 7 neighboring nodes if
it is in a corner (exchange with 3 faces, 3 edges and one corner).</p>
</div>
<div class="sect3">
<h4 id="_data_structure_3">16.1.1. data structure</h4>
<div class="paragraph">
<p>A single structure is able to build a map for up to <code>nw</code> objects
(e.g. rbc and rigid give <code>nw = 2</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">enum</span> {MAX_FRAGS=<span class="integer">26</span>};

<span class="keyword">struct</span> EMap {
    <span class="predefined-type">int</span> *counts;         <span class="comment">/* number of entities leaving in each fragment */</span>
    <span class="predefined-type">int</span> *starts;         <span class="comment">/* cumulative sum of the above                 */</span>
    <span class="predefined-type">int</span> *offsets;        <span class="comment">/* offsets per fragment for each solute        */</span>
    <span class="predefined-type">int</span> *ids[MAX_FRAGS]; <span class="comment">/* indices of leaving objects                  */</span>
    <span class="predefined-type">int</span> *cap;            <span class="comment">/* capacity of ids                             */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>for <code>nw</code> objects and <code>nfrags</code> fragments, the <code>counts</code>, <code>starts</code> and
<code>offsets</code> arrays all have the same size <code>n = (nw + 1) * (nfrags + 1)</code>
for convenience.</p>
</div>
<div class="paragraph">
<p>The <code>nfrags + 1</code> part is for the starts, which is exclusive scan of
counts in the fragment dimension. Therefore the last element is the sum of counts, i.e. number
of entities for a given object.</p>
</div>
<div class="paragraph">
<p>The <code>nw + 1</code> part is for offsets, which are an exclusive prefix sum of
counts in the object id dimension: the last row is the number of
entities of all objects leaving per fragment.</p>
</div>
<div class="paragraph">
<p><strong>example:</strong> Given <code>nw = 2</code> objects, with <code>nfrags = 5</code> fragments, with the following
 counts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>object 0: 0 2 2 1 4
object 1: 1 1 0 0 3
-&gt; counts = 0 2 2 1 4 _  1 1 0 0 3 _  _ _ _ _ _ _
-&gt; starts = 0 0 2 4 5 9  0 1 1 1 1 4  _ _ _ _ _ _</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>_</code> stands for "not set".</p>
</div>
<div class="paragraph">
<p>The offset array is then given by (we rewrite counts row by row for better understanding):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>counts  = 0 2 2 1 4 _
          1 1 0 0 3 _
          _ _ _ _ _ _

offsets = 0 0 0 0 0 _
          0 2 2 1 4 _
	  1 3 2 1 7 _</pre>
</div>
</div>
<div class="paragraph">
<p><code>starts</code> and <code>offsets</code> are results of the scan operation (see below).</p>
</div>
<div class="paragraph">
<p>The index <code>j</code> used to retrieve the ith entity of a given object in a
given fragment is then given by</p>
</div>
<div class="listingblock">
<div class="content">
<pre>j = offsets[oid][fid] + starts[oid][fid] + i</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>oid</code> is the object id, <code>fid</code> the fragment.
note that above, <code>[oid][fid]</code> is implemented as <code>[oid * (nfrags + 1) + fid]</code>.</p>
</div>
<div class="paragraph">
<p>The id is then <code>ids[fid][j]</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_interface_16">16.1.2. interface</h4>
<div class="sect4">
<h5 id="_host_interface_2">Host interface:</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emap_ini(<span class="predefined-type">int</span> nw, <span class="predefined-type">int</span> nfrags, <span class="predefined-type">int</span> cap[], <span class="comment">/**/</span> EMap *map);               <b class="conum">(1)</b>
<span class="directive">void</span> emap_fin(<span class="predefined-type">int</span> nfrags, EMap *map);                                       <b class="conum">(2)</b>
<span class="directive">void</span> emap_reini(<span class="predefined-type">int</span> nw, <span class="predefined-type">int</span> nfrags, <span class="comment">/**/</span> EMap map);                         <b class="conum">(3)</b>
<span class="directive">void</span> emap_scan(<span class="predefined-type">int</span> nw, <span class="predefined-type">int</span> nfrags, <span class="comment">/**/</span> EMap map);                          <b class="conum">(4)</b>
<span class="directive">void</span> emap_download_counts(<span class="predefined-type">int</span> nw, <span class="predefined-type">int</span> nfrags, EMap map, <span class="comment">/**/</span> <span class="predefined-type">int</span> counts[]); <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate the map structure on device</p>
</li>
<li>
<p>deallocate the map structure</p>
</li>
<li>
<p>reset the map structure</p>
</li>
<li>
<p>scan the map structure to get starts and offsets</p>
</li>
<li>
<p>copy counts (total number of entities per fragment) from device to host</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_device_interface">Device interface:</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">_I_ <span class="predefined-type">int</span> emap_code(int3 L, <span class="directive">const</span> <span class="predefined-type">float</span> r[<span class="integer">3</span>]) <b class="conum">(1)</b>
_I_ <span class="predefined-type">int</span> emap_code_box(int3 L, float3 lo, float3 hi)  <b class="conum">(2)</b>
_I_ <span class="directive">void</span> emap_add(<span class="predefined-type">int</span> nfrags, <span class="predefined-type">int</span> soluteid, <span class="predefined-type">int</span> pid, <span class="predefined-type">int</span> fid, EMap m) <b class="conum">(3)</b>
_I_ <span class="predefined-type">int</span> emap_decode(<span class="predefined-type">int</span> code, <span class="comment">/**/</span> <span class="predefined-type">int</span> fids[MAX_DSTS]) <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get code (local fragment id) from position</p>
</li>
<li>
<p>get code (local fragment id) from box positions</p>
</li>
<li>
<p>add an entity id <code>pid</code> to the map in fragment <code>fid</code> and object <code>soluteid</code>. Does not add if the capacity is exceeded</p>
</li>
<li>
<p>get destination fragments from code</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flu_2">16.2. flu</h3>
<div class="paragraph">
<p>Exchange solvent particles within a cutoff radius from the neighboring
nodes.</p>
</div>
<div class="sect3">
<h4 id="_interface_17">16.2.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate the structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eflu_pack_ini(<span class="predefined-type">bool</span> colors, int3 L, <span class="predefined-type">int</span> maxd, EFluPack **p);
<span class="directive">void</span> eflu_comm_ini(<span class="predefined-type">bool</span> colors, MPI_Comm comm, <span class="comment">/**/</span> EFluComm **c);
<span class="directive">void</span> eflu_unpack_ini(<span class="predefined-type">bool</span> colors, int3 L, <span class="predefined-type">int</span> maxd, EFluUnpack **u);

<span class="directive">void</span> eflu_pack_fin(EFluPack *p);
<span class="directive">void</span> eflu_comm_fin(EFluComm *c);
<span class="directive">void</span> eflu_unpack_fin(EFluUnpack *u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>build the map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eflu_compute_map(<span class="directive">const</span> <span class="predefined-type">int</span> *start, <span class="directive">const</span> <span class="predefined-type">int</span> *count, <span class="comment">/**/</span> EFluPack *p);
<span class="directive">void</span> eflu_download_cell_starts(<span class="comment">/**/</span> EFluPack *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>pack and copy data on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eflu_pack(<span class="directive">const</span> PaArray *parray, <span class="comment">/**/</span> EFluPack *p);
<span class="directive">void</span> eflu_download_data(EFluPack *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate the packed data with neighbors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eflu_post_recv(EFluComm *c, EFluUnpack *u);
<span class="directive">void</span> eflu_post_send(EFluPack *p, EFluComm *c);
<span class="directive">void</span> eflu_wait_recv(EFluComm *c, EFluUnpack *u);
<span class="directive">void</span> eflu_wait_send(EFluComm *c);

<span class="directive">void</span> eflu_unpack(EFluUnpack *u);

<span class="directive">using</span> flu::LFrag26;
<span class="directive">using</span> flu::RFrag26;

<span class="directive">void</span> eflu_get_local_frags(<span class="directive">const</span> EFluPack *p, <span class="comment">/**/</span> LFrag26 *lfrags);
<span class="directive">void</span> eflu_get_remote_frags(<span class="directive">const</span> EFluUnpack *u, <span class="comment">/**/</span> RFrag26 *rfrags);</code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack and get data informations needed by the <em>fluforces</em> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eflu_unpack(EFluUnpack *u);

<span class="directive">using</span> flu::LFrag26;
<span class="directive">using</span> flu::RFrag26;

<span class="directive">void</span> eflu_get_local_frags(<span class="directive">const</span> EFluPack *p, <span class="comment">/**/</span> LFrag26 *lfrags);
<span class="directive">void</span> eflu_get_remote_frags(<span class="directive">const</span> EFluUnpack *u, <span class="comment">/**/</span> RFrag26 *rfrags);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_obj">16.3. obj</h3>
<div class="paragraph">
<p>Object exchanger is used to exchange particles from objects (<em>rbc</em> or
<em>rig</em>) with neighboring nodes for computing their interactions with
the solvent (<em>fsi</em>) or with other objects (<em>contact forces</em>).
It sends the remote forces back to the local node.</p>
</div>
<div class="paragraph">
<p>Sending back the forces is optional.</p>
</div>
<div class="sect3">
<h4 id="_particle_exchange_interface">16.3.1. particle exchange interface</h4>
<div class="paragraph">
<p>allocate, deallocate the structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_pack_ini(int3 L, <span class="predefined-type">int</span> nw, <span class="predefined-type">int</span> maxd, <span class="predefined-type">int</span> maxpsolid, EObjPack **p);
<span class="directive">void</span> eobj_comm_ini(MPI_Comm cart, <span class="comment">/**/</span> EObjComm **c);
<span class="directive">void</span> eobj_unpack_ini(int3 L, <span class="predefined-type">int</span> maxd, <span class="predefined-type">int</span> maxpsolid, EObjUnpack **u);
<span class="directive">void</span> eobj_packf_ini(int3 L, <span class="predefined-type">int</span> maxd, <span class="predefined-type">int</span> maxpsolid, EObjPackF **p);
<span class="directive">void</span> eobj_unpackf_ini(int3 L, <span class="predefined-type">int</span> maxd, <span class="predefined-type">int</span> maxpsolid, EObjUnpackF **u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>build the map from array of wrappers <code>PaWrap</code> containing array of particles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_build_map(<span class="predefined-type">int</span> nw, <span class="directive">const</span> PaWrap *ww, <span class="comment">/**/</span> EObjPack *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>pack the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_pack(<span class="predefined-type">int</span> nw, <span class="directive">const</span> PaWrap *ww, <span class="comment">/**/</span> EObjPack *p);
<span class="directive">void</span> eobj_download(<span class="predefined-type">int</span> nw, EObjPack *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate the packed data with neighboring nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_post_recv(EObjComm *c, EObjUnpack *u);
<span class="directive">void</span> eobj_post_send(EObjPack *p, EObjComm *c);
<span class="directive">void</span> eobj_wait_recv(EObjComm *c, EObjUnpack *u);
<span class="directive">void</span> eobj_wait_send(EObjComm *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>retrieve information about the received data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">int26 eobj_get_counts(EObjUnpack *u); <b class="conum">(1)</b>
Pap26 eobj_upload_shift(EObjUnpack *u); <b class="conum">(2)</b>
Fop26 eobj_reini_ff(<span class="directive">const</span> EObjUnpack *u, EObjPackF *pf); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get the number of particles inside each fragment</p>
</li>
<li>
<p>upload particles on device, shift them in local coordinates and
return device pointers</p>
</li>
<li>
<p>set forces on device to 0 and return device pointers</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_force_back_sender_interface">16.3.2. force back sender interface</h4>
<div class="paragraph">
<p>allocate, deallocate the optional structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_pack_fin(EObjPack *p);
<span class="directive">void</span> eobj_comm_fin(EObjComm *c);
<span class="directive">void</span> eobj_unpack_fin(EObjUnpack *u);
<span class="directive">void</span> eobj_packf_fin(EObjPackF *p);
<span class="directive">void</span> eobj_unpackf_fin(EObjUnpackF *u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>download the forces on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_download_ff(EObjPackF *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate back the forces to neighbours:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_post_recv_ff(EObjComm *c, EObjUnpackF *u);
<span class="directive">void</span> eobj_post_send_ff(EObjPackF *p, EObjComm *c);
<span class="directive">void</span> eobj_wait_recv_ff(EObjComm *c, EObjUnpackF *u);
<span class="directive">void</span> eobj_wait_send_ff(EObjComm *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack forces arrays inside wrappers <code>FoWrap</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> eobj_unpack_ff(<span class="directive">const</span> EObjUnpackF *u, <span class="directive">const</span> EObjPack *p, <span class="predefined-type">int</span> nw, <span class="comment">/**/</span> FoWrap *ww);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mesh">16.4. mesh</h3>
<div class="paragraph">
<p>exchange full mesh particles with neighbouring nodes when bounding box
of the mesh crosses or is close enough to the subdomain boundaries.
This is used for mesh bounce back or solvent recoloring.</p>
</div>
<div class="paragraph">
<p>It can optionally send back momentum data per triangles to original node.</p>
</div>
<div class="sect3">
<h4 id="_mesh_exchanger_interface">16.4.1. mesh exchanger interface</h4>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_pack_ini(int3 L, <span class="predefined-type">int</span> nv, <span class="predefined-type">int</span> max_mesh_num, EMeshPack **p);
<span class="directive">void</span> emesh_comm_ini(MPI_Comm comm, <span class="comment">/**/</span> EMeshComm **c);
<span class="directive">void</span> emesh_unpack_ini(int3 L, <span class="predefined-type">int</span> nv, <span class="predefined-type">int</span> max_mesh_num, EMeshUnpack **u);

<span class="directive">void</span> emesh_pack_fin(EMeshPack *p);
<span class="directive">void</span> emesh_comm_fin(EMeshComm *c);
<span class="directive">void</span> emesh_unpack_fin(EMeshUnpack *u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>build map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_build_map(<span class="predefined-type">int</span> nm, <span class="predefined-type">int</span> nv, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> EMeshPack *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>pack data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_pack(<span class="predefined-type">int</span> nv, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> EMeshPack *p);
<span class="directive">void</span> emesh_download(EMeshPack *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate data with neigbours:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_post_recv(EMeshComm *c, EMeshUnpack *u);
<span class="directive">void</span> emesh_post_send(EMeshPack *p, EMeshComm *c);
<span class="directive">void</span> emesh_wait_recv(EMeshComm *c, EMeshUnpack *u);
<span class="directive">void</span> emesh_wait_send(EMeshComm *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack the data to a single particle array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_unpack(<span class="predefined-type">int</span> nv, <span class="directive">const</span> EMeshUnpack *u, <span class="comment">/**/</span> <span class="predefined-type">int</span> *nmhalo, Particle *pp);</code></pre>
</div>
</div>
<div class="paragraph">
<p>the returned value <code>nmhalo</code> is the number of
received meshes</p>
</div>
<div class="paragraph">
<p>get number of mesh per fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_get_num_frag_mesh(<span class="directive">const</span> EMeshUnpack *u, <span class="comment">/**/</span> <span class="predefined-type">int</span> cc[NFRAGS]);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_back_momentum_sender_interface">16.4.2. back momentum sender interface</h4>
<div class="paragraph">
<p>allocate, deallocate the optional structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_packm_ini(<span class="predefined-type">int</span> num_mom_per_mesh, <span class="predefined-type">int</span> max_mesh_num, EMeshPackM **p);
<span class="directive">void</span> emesh_commm_ini(MPI_Comm comm, <span class="comment">/**/</span> EMeshCommM **c);
<span class="directive">void</span> emesh_unpackm_ini(<span class="predefined-type">int</span> num_mom_per_mesh, <span class="predefined-type">int</span> max_mesh_num, EMeshUnpackM **u);

<span class="directive">void</span> emesh_packm_fin(EMeshPackM *p);
<span class="directive">void</span> emesh_commm_fin(EMeshCommM *c);
<span class="directive">void</span> emesh_unpackm_fin(EMeshUnpackM *u);</code></pre>
</div>
</div>
<div class="paragraph">
<p>pack the momentum infos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_packM(<span class="predefined-type">int</span> nt, <span class="directive">const</span> <span class="predefined-type">int</span> counts[NFRAGS], <span class="directive">const</span> Momentum *mm, <span class="comment">/**/</span> EMeshPackM *p);
<span class="directive">void</span> emesh_downloadM(<span class="directive">const</span> <span class="predefined-type">int</span> counts[NFRAGS], EMeshPackM *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>communicate back the momentum infos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_post_recv(EMeshCommM *c, EMeshUnpackM *u);
<span class="directive">void</span> emesh_post_send(EMeshPackM *p, EMeshCommM *c);
<span class="directive">void</span> emesh_wait_recv(EMeshCommM *c, EMeshUnpackM *u);
<span class="directive">void</span> emesh_wait_send(EMeshCommM *c);</code></pre>
</div>
</div>
<div class="paragraph">
<p>unpack the momentum infos to a single array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emesh_upload(EMeshUnpackM *u);
<span class="directive">void</span> emesh_unpack_mom(<span class="predefined-type">int</span> nt, <span class="directive">const</span> EMeshPack *p, <span class="directive">const</span> EMeshUnpackM *u, <span class="comment">/**/</span> Momentum *mm);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_common_2">16.5. common</h3>
<div class="paragraph">
<p>helper for common exchange operations</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> ecommon_pack_pp(<span class="directive">const</span> Particle *pp, PackHelper ph, <span class="comment">/**/</span> Pap26 buf); <b class="conum">(1)</b>
<span class="directive">void</span> ecommon_shift_one_frag(int3 L, <span class="predefined-type">int</span> n, <span class="directive">const</span> <span class="predefined-type">int</span> fid, <span class="comment">/**/</span> Particle *pp); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>pack particles <code>pp</code> into 27 buffers <code>buf</code> according to the local map <code>ph</code></p>
</li>
<li>
<p>shift particles in the fragment direction</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The local map is defined through the structure</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> PackHelper {
    <span class="predefined-type">int</span> *starts;
    <span class="predefined-type">int</span> *offsets;
    <span class="predefined-type">int</span> *indices[NFRAGS];
    <span class="predefined-type">int</span> *cap;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>which is a map for a single set of quantities.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_flu_solvent_particles">17. flu: solvent particles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Manages solvent particles data.</p>
</div>
<div class="sect2">
<h3 id="_data_structure_4">17.1. data structure</h3>
<div class="paragraph">
<p>The data is stored in a visible structure. The user can access
directly the fields.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> FluQuants {
    Particle *pp, *pp0;    <span class="comment">/* particles on device  */</span>
    <span class="predefined-type">int</span>       n;           <span class="comment">/* particle number      */</span>
    Clist      cells;      <span class="comment">/* cell lists           */</span>
    ClistMap *mcells;      <span class="comment">/* cell lists map       */</span>
    Particle *pp_hst;      <span class="comment">/* particles on host    */</span>

    <span class="comment">/* optional data */</span>

    <span class="predefined-type">bool</span> ids, colors;

    <span class="predefined-type">int</span> *ii, *ii0;  <span class="comment">/* global ids on device */</span>
    <span class="predefined-type">int</span> *ii_hst;    <span class="comment">/* global ids on host   */</span>

    <span class="predefined-type">int</span> *cc, *cc0;  <span class="comment">/* colors on device */</span>
    <span class="predefined-type">int</span> *cc_hst;    <span class="comment">/* colors on host   */</span>

    <span class="predefined-type">int</span> maxp; <span class="comment">/* maximum particle number */</span>
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_18">17.2. interface</h3>
<div class="paragraph">
<p>allocate and deallocate the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> flu_ini(<span class="predefined-type">bool</span> colors, <span class="predefined-type">bool</span> ids, int3 L, <span class="predefined-type">int</span> maxp, FluQuants *q);
<span class="directive">void</span> flu_fin(FluQuants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p>generate the quantities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> flu_gen_quants(<span class="directive">const</span> Coords*, <span class="predefined-type">int</span> numdensity, <span class="directive">const</span> GenColor *gc, FluQuants *q); <b class="conum">(1)</b>
<span class="directive">void</span> flu_gen_ids(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">int</span> n, FluQuants *q); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>generate <code>numberdensity</code> particles randomly distributed in every
cell with zero velocity. Colors are optionally set from <code>GenColor</code>
object (see <a href="#inter_color">color</a>).</p>
</li>
<li>
<p>generate unique global ids for each particle</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>restart interface (see <a href="#io_restart">restart</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> flu_strt_quants(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">int</span> id, FluQuants *q);     <b class="conum">(1)</b>
<span class="directive">void</span> flu_strt_dump(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">int</span> id, <span class="directive">const</span> FluQuants *q); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>read quantities from restart files</p>
</li>
<li>
<p>dump quantities to restart files</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>additional tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> flu_txt_dump(<span class="directive">const</span> Coords*, <span class="directive">const</span> FluQuants *q); <b class="conum">(1)</b>

<span class="comment">/* build cells only from one array of particles fully contained in the domain */</span>
<span class="comment">/* warning: this will delete particles which are outside                      */</span>
<span class="directive">void</span> flu_build_cells(<span class="comment">/**/</span> FluQuants *q); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>dump particles to text format, one file per MPI rank (debug purpose)</p>
</li>
<li>
<p>build cells lists, assume that particles are inside subdomain</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fluforces">18. fluforces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>solvent forces</p>
</div>
<div class="sect2">
<h3 id="_interface_19">18.1. interface</h3>
<div class="paragraph">
<p>allocate and free bulk structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> fluforces_bulk_ini(int3 L, <span class="predefined-type">int</span> maxp, <span class="comment">/**/</span> FluForcesBulk **b);
<span class="directive">void</span> fluforces_bulk_fin(<span class="comment">/**/</span> FluForcesBulk *b);</code></pre>
</div>
</div>
<div class="paragraph">
<p>compute bulk interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> fluforces_bulk_prepare(<span class="predefined-type">int</span> n, <span class="directive">const</span> PaArray *a, <span class="comment">/**/</span> FluForcesBulk *b);
<span class="directive">void</span> fluforces_bulk_apply(<span class="directive">const</span> PairParams*, <span class="predefined-type">int</span> n, <span class="directive">const</span> FluForcesBulk *b, <span class="directive">const</span> <span class="predefined-type">int</span> *start, <span class="directive">const</span> <span class="predefined-type">int</span> *count,
                          <span class="comment">/**/</span> <span class="directive">const</span> FoArray *ff);</code></pre>
</div>
</div>
<div class="paragraph">
<p>allocate and free halo structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> fluforces_halo_ini(MPI_Comm cart, int3 L, <span class="comment">/**/</span> FluForcesHalo **hd);
<span class="directive">void</span> fluforces_halo_fin(<span class="comment">/**/</span> FluForcesHalo *h);</code></pre>
</div>
</div>
<div class="paragraph">
<p>compute halo interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> fluforces_halo_prepare(flu::LFrag26 lfrags, flu::RFrag26 rfrags, <span class="comment">/**/</span> FluForcesHalo *h);
<span class="directive">void</span> fluforces_halo_apply(<span class="directive">const</span> PairParams*, <span class="directive">const</span> FluForcesHalo *h, <span class="comment">/**/</span> <span class="directive">const</span> FoArray *farray);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_submodules">18.2. submodules</h3>
<div class="sect3">
<h4 id="_bulk">18.2.1. bulk</h4>
<div class="paragraph">
<p>compute local interactions of solvent particles, given cell starts,
cell counts (see <a href="clist.html">clist</a>) and particles array</p>
</div>
<div class="paragraph">
<p>The algorithm is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>each particle of the array has one thread assigned.</p>
</li>
<li>
<p>the thread runs over half of the 27 cell lists overlapping one cutoff radius
(this makes 13 cells + the "self cell")</p>
</li>
<li>
<p>in each cell, the particle ids are fetched from the cell starts
array</p>
</li>
<li>
<p>run over particles, atomic add the forces to them and gather forces
on the main particle</p>
</li>
<li>
<p>atomic add main forces to force array</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Performance is strongly related to the pattern used to run over the
particles.
Better performance is achieved by grouping as much as possible
consecutive particles (row), meaning that the <code>x</code> cell index runs
fastest.</p>
</div>
<div class="paragraph">
<p>The cell run order is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>+----&gt; x   plane dz = -1:    plane dz =  0:    plane dz = +1:
|
|            00 01 02          09 10 11          xx xx xx
v y          03 04 05          12 13 xx          xx xx xx
             06 07 08          xx xx xx          xx xx xx</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>xx</code> denotes that the cell is not used by the current thread.</p>
</div>
</div>
<div class="sect3">
<h4 id="_halo">18.2.2. halo</h4>
<div class="paragraph">
<p>solvent forces with remote particles (fragments)</p>
</div>
<div class="paragraph">
<p>main kernel performs interactions for a given halo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>fetch generalized particle <code>a</code></p>
</li>
<li>
<p>build map (how to access neighboring particles?)</p>
</li>
<li>
<p>loop over neighboring particles according to map</p>
</li>
<li>
<p>compute pairwise interactions</p>
</li>
<li>
<p>accumulate to force <code>a</code> in output force array</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_frag">19. frag</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fragment functions on host and device</p>
</div>
<div class="sect2">
<h3 id="_purpose_4">19.1. purpose</h3>
<div class="paragraph">
<p>A <em>fragment</em> designates one of the 27 directions \((dx, dy, dz)\),
where \(dx, dy, dz \in \{-1, 0, 1\}\).</p>
</div>
<div class="paragraph">
<p>The fragment \((0, 0, 0)\) is called <em>bulk</em> and has the id <code>frag_bulk</code>.</p>
</div>
<div class="paragraph">
<p>The purpose of this module is to encode and decode the <em>fragments</em>
between <em>fragment ids</em> (numbered from 0 to 26) and <em>directions</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_20">19.2. interface</h3>
<div class="paragraph">
<p>The major part of the functions are available to both device and host,
within the namespaces <code>fragdev</code> and <code>fraghst</code>, respectively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> i2dx(<span class="predefined-type">int</span> i);                 <b class="conum">(1)</b>
<span class="predefined-type">int</span> i2dy(<span class="predefined-type">int</span> i);                 <b class="conum">(2)</b>
<span class="predefined-type">int</span> i2dz(<span class="predefined-type">int</span> i);                 <b class="conum">(3)</b>
<span class="directive">void</span> i2d3(<span class="predefined-type">int</span> i, <span class="comment">/**/</span> <span class="predefined-type">int</span> d[<span class="integer">3</span>]); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get \(dx\) from fragment id</p>
</li>
<li>
<p>get \(dy\) from fragment id</p>
</li>
<li>
<p>get \(dz\) from fragment id</p>
</li>
<li>
<p>get \((dx, dy, dz)\) from fragment id</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> d2i(<span class="predefined-type">int</span> x, <span class="predefined-type">int</span> y, <span class="predefined-type">int</span> z); <b class="conum">(1)</b>
<span class="predefined-type">int</span> d32i(<span class="directive">const</span> <span class="predefined-type">int</span> d[<span class="integer">3</span>]);     <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get fragment id from \((dx, dy, dz)\)</p>
</li>
<li>
<p>idem with array as input</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> ncell(int3 L, <span class="predefined-type">int</span> i); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>given sub-domain sizes <code>L</code>, returns number of neighboring cells to
fragment with id <code>i</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> antid2i(<span class="predefined-type">int</span> x, <span class="predefined-type">int</span> y, <span class="predefined-type">int</span> z); <b class="conum">(1)</b>
<span class="predefined-type">int</span> anti(<span class="predefined-type">int</span> i);                  <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>given \((dx, dy, dz)\), return the id of the <em>anti</em> fragment (i.e. with direction \((-dx, -dy, -dz)\))</p>
</li>
<li>
<p>given a fragment id, returns the id of the <em>anti</em> fragment</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Only on host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> estimates(int3 L, <span class="predefined-type">int</span> nfrags, <span class="predefined-type">float</span> maxd, <span class="comment">/**/</span> <span class="predefined-type">int</span> *cap); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>given a maximum number density <code>maxp</code>, return an estimate of the
number of particles in each fragment layer.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fsi">20. fsi : flow structure interactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>flow-structure interactions between solvent and objects (rigid objects, rbc membranes)</p>
</div>
<div class="sect2">
<h3 id="_interface_21">20.1. interface</h3>
<div class="paragraph">
<p>allocate/deallocate</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> fsi_ini(<span class="predefined-type">int</span> rank, int3 L, <span class="comment">/**/</span> Fsi **fsi);
<span class="directive">void</span> fsi_fin(Fsi *fsi);</code></pre>
</div>
</div>
<div class="paragraph">
<p>computing forces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> fsi_bind_solvent(PaArray pa, Force *ff, <span class="predefined-type">int</span> n, <span class="predefined-type">int</span> *starts, <span class="comment">/**/</span> Fsi *fsi); <b class="conum">(1)</b>
<span class="directive">void</span> fsi_bulk(<span class="directive">const</span> PairParams*, Fsi *fsi, <span class="predefined-type">int</span> nw, PaWrap *pw, FoWrap *fw);      <b class="conum">(2)</b>
<span class="directive">void</span> fsi_halo(<span class="directive">const</span> PairParams*, Fsi *fsi, Pap26 PP, Fop26 FF, <span class="predefined-type">int</span> counts[<span class="integer">26</span>]);  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>store solvent interactions inside hidden structure <code>Fsi</code></p>
</li>
<li>
<p>compute the interactions between local objects and local solvent</p>
</li>
<li>
<p>compute the interactions between remote objects and local solvent</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="grid_sampler">21. grid_sampler: particle to grid average</h2>
<div class="sectionbody">
<div class="paragraph">
<p>gather particle data on a grid and average in time.
The particle to grid process is simple binning.</p>
</div>
<div class="sect2">
<h3 id="_quantities">21.1. quantities</h3>
<div class="paragraph">
<p>The number density and velocity (3 components) are computed by
default.
Optionally, the stress tensor (6 components) and the color proportions
can be sampled as well.</p>
</div>
<div class="paragraph">
<p>All cell quantities computed at a given time \(t\) are averaged on time:</p>
</div>
<div class="stemblock">
<div class="content">
\[Q^i = \frac 1 T \sum\limits_{t = 1}^T Q^i_t\]
</div>
</div>
<div class="paragraph">
<p>The cell quantities \(Q^i_t\) are averaged on space, depending on
the quantity. Let \(j \in [1, n_i\)] denote the particle ids inside
cell \(i\), where \(n_i\) is the number of particles inside this
cell. \(V_i\) denotes the volume of the cell.</p>
</div>
<div class="paragraph">
<p>Velocity:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{u}^i_t = \frac{1}{n_i} \sum\limits_{j = 1}^{n_i} \mathbf{u}_j\]
</div>
</div>
<div class="paragraph">
<p>number density:</p>
</div>
<div class="stemblock">
<div class="content">
\[\rho^i_t = \frac{n_i}{V_i}\]
</div>
</div>
<div class="paragraph">
<p>stress:</p>
</div>
<div class="stemblock">
<div class="content">
\[S^i_{\alpha, \beta} = \frac{1}{V_i} \sum\limits_{j = 1}^{n_i} S_j^{\alpha, \beta}\]
</div>
</div>
<div class="paragraph">
<p>color proportion:</p>
</div>
<div class="stemblock">
<div class="content">
\[c^i_{\alpha} = \frac{1}{n_i} \sum\limits_{j = 1}^{n_i} \delta_{c_j, \alpha}\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_interface_22">21.2. interface</h3>
<div class="paragraph">
<p>Allocate and free the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> grid_sampler_ini(<span class="predefined-type">bool</span> colors, <span class="predefined-type">bool</span> stress, int3 L, int3 N, GridSampler**); <b class="conum">(1)</b>
<span class="directive">void</span> grid_sampler_fin(GridSampler*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>create a sampler for binning a subdomain of size <code>L</code>. <code>N</code> is the
number of bins. Allocate space for stress when <code>stress</code> is set to
true. Allocate space for the color proportions when <code>colors</code> is
set to true.</p>
</li>
<li>
<p>deallocate the structure</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The sampler object stores the grid data. All operations are performed
on device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> grid_sampler_reset(GridSampler*); <b class="conum">(1)</b>
<span class="directive">void</span> grid_sampler_add(<span class="directive">const</span> GridSampleData*, GridSampler*); <b class="conum">(2)</b>
<span class="directive">void</span> grid_sampler_dump(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *dir, <span class="predefined-type">long</span> id, GridSampler*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set all fields of the grids to 0</p>
</li>
<li>
<p>add contribution of the data (see <a href="#grid_sampler_data">grid sampler data</a>) to the
time averaged grid</p>
</li>
<li>
<p>perform time average of all gathered data, download grid on host
and dump to file (see <a href="#io_grid">grid</a>).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="grid_sampler_data">21.3. grid sampler data</h3>
<div class="paragraph">
<p>helper to pass data to the grid sampler.</p>
</div>
<div class="paragraph">
<p>allocate and deallocate the data structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> grid_sampler_data_ini(GridSampleData **);
<span class="directive">void</span> grid_sampler_data_fin(GridSampleData  *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>pass data to the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> grid_sampler_data_reset(GridSampleData *); <b class="conum">(1)</b>
<span class="directive">void</span> grid_sampler_data_push(<span class="predefined-type">long</span> n, <span class="directive">const</span> Particle *pp, <span class="directive">const</span> <span class="predefined-type">int</span> *cc,
                            <span class="directive">const</span> <span class="predefined-type">float</span> *ss, GridSampleData *); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>remove all previously pushed data</p>
</li>
<li>
<p>add data (pointers only, <strong>not</strong> a deep copy) to the structure. The
<code>pp</code> pointer is mandatory. The stress <code>ss</code> pointer is used only when
<code>stress</code> is activated in grid sampler. The colors <code>cc</code> pointer is
only used when <code>colors</code> is activated in the grid sampler.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_io">22. IO</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="io_grid">22.1. grid</h3>
<div class="paragraph">
<p>Parallel-IO grid data dump using the <a href="#third_h5">hdf5 library</a> and a
<a href="https://en.wikipedia.org/wiki/XDMF">xmf</a> file description.</p>
</div>
<div class="sect3">
<h4 id="_interface_23">22.1.1. interface</h4>
<div class="paragraph">
<p>The following function dumps grid data with <code>subGrid</code> points per node
mapped to the subdomain coordinates of size <code>subDomain</code>.
Two files <code>DUMP_BASE/dir/id.xmf</code> and  <code>DUMP_BASE/dir/id.h5</code> are dumped.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> grid_write(int3 subGrid, int3 subDomain, MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="predefined-type">int</span> ncmp, <span class="directive">const</span> <span class="predefined-type">float</span> **data, <span class="directive">const</span> <span class="predefined-type">char</span> **names);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ncmp</code>: number of variables</p>
</li>
<li>
<p><code>data</code>: data to dump (structure of array fashion)</p>
</li>
<li>
<p><code>names</code>: variable names</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_submodules_2">22.1.2. submodules</h4>
<div class="paragraph">
<p><code>xmf</code> writer, to be called by one rank only:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> xmf_write(int3 domainSize, int3 gridSize, <span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="predefined-type">int</span> ncomp, <span class="directive">const</span> <span class="predefined-type">char</span> **names);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>h5</code> writer, collective write operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> h5_write(int3 N, MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="predefined-type">int</span> ncomp, <span class="directive">const</span> <span class="predefined-type">float</span> **data, <span class="directive">const</span> <span class="predefined-type">char</span> **names);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>N</code> is the grid size.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_low_level_mpi_file_write">22.2. Low level MPI file write</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> write_file_open(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="comment">/**/</span> WriteFile**);
<span class="predefined-type">int</span> write_file_close(WriteFile*);

<span class="directive">void</span> write_all(MPI_Comm, <span class="directive">const</span> <span class="directive">void</span> *<span class="directive">const</span>, <span class="predefined-type">int</span> nbytes, WriteFile*); <b class="conum">(1)</b>
<span class="predefined-type">int</span> write_master(MPI_Comm, <span class="directive">const</span> <span class="directive">void</span> *<span class="directive">const</span>, <span class="predefined-type">int</span> nbytes, WriteFile*); <b class="conum">(2)</b>

<span class="predefined-type">int</span> write_shift_indices(MPI_Comm, <span class="predefined-type">int</span>, <span class="comment">/**/</span> <span class="predefined-type">int</span>*);
<span class="predefined-type">int</span> write_reduce(MPI_Comm, <span class="predefined-type">int</span>, <span class="comment">/**/</span> <span class="predefined-type">int</span>*);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>write <code>nbytes</code> from every prcesses</p>
</li>
<li>
<p>write <code>nbytes</code> onlye from master process (<code>rank = 0</code>)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_text">22.3. Text</h3>
<div class="paragraph">
<p>Write one row per particle in a text file <code>path</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> txt_write_pp(<span class="predefined-type">long</span> n, <span class="directive">const</span> Particle*, <span class="directive">const</span> <span class="predefined-type">char</span> *path);
<span class="directive">void</span> txt_write_pp_ff(<span class="predefined-type">long</span> n, <span class="directive">const</span> Particle*, <span class="directive">const</span> Force*, <span class="directive">const</span> <span class="predefined-type">char</span> *path);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read particles to a structure <code>TxtRead</code>. The <code>TxtRead</code> API returns the
number of particles and pointers to the data. <code>txt_read_fin</code> frees the
memory and invalidated pointers returned by <code>txt_read_get_pp</code> or
<code>txt_read_get_pp_ff</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> txt_read_pp(<span class="directive">const</span> <span class="predefined-type">char</span> *path, TxtRead **);
<span class="directive">void</span> txt_read_pp_ff(<span class="directive">const</span> <span class="predefined-type">char</span> *path, TxtRead **);
<span class="directive">void</span> txt_read_ff(<span class="directive">const</span> <span class="predefined-type">char</span> *path, TxtRead **);
<span class="directive">void</span> txt_read_fin(TxtRead*);

<span class="predefined-type">int</span> txt_read_get_n(<span class="directive">const</span> TxtRead *);
<span class="directive">const</span> Particle* txt_read_get_pp(<span class="directive">const</span> TxtRead *);
<span class="directive">const</span> Force*    txt_read_get_ff(<span class="directive">const</span> TxtRead *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Text format is a as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x y z vx vy vz [fx fy fz]
...
x y z vx vy vz [fx fy fz]</pre>
</div>
</div>
<div class="paragraph">
<p>where every row corresponds to a particle.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mesh_2">22.4. Mesh</h3>
<div class="paragraph">
<p>Read triangulated mesh from ascii
<a href="https://en.wikipedia.org/wiki/OFF_(file_format)">off</a>
or
<a href="https://en.wikipedia.org/wiki/PLY_(file_format)">ply</a>
files.
Vertices coordinates are packed into array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>x0 y0 z0 x1 y1 z1 ... x[nv-1] y[nv-1] z[nv-1]</pre>
</div>
</div>
<div class="paragraph">
<p>Triangles are packed in array of <code>int4</code> with fields <code>w</code> left
unused. For example, traingle <code>i</code> is</p>
</div>
<div class="listingblock">
<div class="content">
<pre>tt[i].x tt[i].y tt[i].z</pre>
</div>
</div>
<div class="paragraph">
<p><code>mesh_get_nt</code>, <code>mesh_get_nv</code>, <code>mesh_get_ne</code>, and <code>mesh_get_md</code> return
the number of triangles, number of vertices, number of edges, and
maximum degree.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_read_ini_off(<span class="directive">const</span> <span class="predefined-type">char</span> *path, MeshRead**);
<span class="directive">void</span> mesh_read_ini_ply(<span class="directive">const</span> <span class="predefined-type">char</span> *path, MeshRead**);
<span class="directive">void</span> mesh_read_fin(MeshRead*);

<span class="predefined-type">int</span> mesh_read_get_nt(<span class="directive">const</span> MeshRead*);
<span class="predefined-type">int</span> mesh_read_get_nv(<span class="directive">const</span> MeshRead*);
<span class="predefined-type">int</span> mesh_read_get_ne(<span class="directive">const</span> MeshRead*);
<span class="predefined-type">int</span> mesh_read_get_md(<span class="directive">const</span> MeshRead*);

<span class="directive">const</span> int4  *mesh_read_get_tri(<span class="directive">const</span> MeshRead*);
<span class="directive">const</span> <span class="predefined-type">float</span> *mesh_read_get_vert(<span class="directive">const</span> MeshRead*);
<span class="directive">const</span> int4  *mesh_read_get_dih(MeshRead*);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_diagnostics">22.5. Diagnostics</h3>
<div class="sect3">
<h4 id="_particle">22.5.1. Particle</h4>
<div class="paragraph">
<p>Uses only particles values. Dumps output to log files and to file
<code>path</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> diag_part_ini(<span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="comment">/**/</span> DiagPart**);
<span class="directive">void</span> diag_part_fin(DiagPart*);
<span class="directive">void</span> diag_part_apply(DiagPart*, MPI_Comm, <span class="predefined-type">float</span> time, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mesh_3">22.5.2. Mesh</h4>
<div class="paragraph">
<p>Uses particle values and mesh.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_point">22.6. Point</h3>
<div class="paragraph">
<p>Write point data to <code>bop</code> files.</p>
</div>
<div class="paragraph">
<p>A configuration structure</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> io_point_conf_ini(<span class="comment">/**/</span> IOPointConf**);
<span class="directive">void</span> io_point_conf_fin(IOPointConf*);
<span class="directive">void</span> io_point_conf_push(IOPointConf*, <span class="directive">const</span> <span class="predefined-type">char</span> *keys);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Push data</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> io_point_ini(<span class="predefined-type">int</span> maxn, <span class="directive">const</span> <span class="predefined-type">char</span> *path, IOPointConf*, <span class="comment">/**/</span> IOPoint**);
<span class="directive">void</span> io_point_fin(IOPoint*);
<span class="directive">void</span> io_point_push(IOPoint*, <span class="predefined-type">int</span> n, <span class="directive">const</span> <span class="predefined-type">double</span> *data, <span class="directive">const</span> <span class="predefined-type">char</span> *keys);
<span class="directive">void</span> io_point_write(IOPoint*, MPI_Comm comm, <span class="predefined-type">int</span> id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">    <span class="keyword">enum</span> {X, Y, Z};
    <span class="predefined-type">int</span> i, id;
    <span class="predefined-type">double</span> *r, rr[<span class="integer">3</span>*MAX_N], density[MAX_N];
    IOPointConf *c;
    IOPoint *p;
    <span class="keyword">for</span> (i = <span class="integer">0</span>; i &lt; MAX_N; i++) {
        r = &amp;rr[<span class="integer">3</span>*i];
        r[X] = i; r[Y] = <span class="integer">10</span>*i; r[Z] = <span class="integer">100</span>*i;
        density[i] = -i;
    }
    UC(io_point_conf_ini(&amp;c));
    UC(io_point_conf_push(c, <span class="string"><span class="delimiter">&quot;</span><span class="content">x y z</span><span class="delimiter">&quot;</span></span>));
    UC(io_point_conf_push(c, <span class="string"><span class="delimiter">&quot;</span><span class="content">density</span><span class="delimiter">&quot;</span></span>));
    UC(io_point_ini(MAX_N, path, c, &amp;p));
    UC(io_point_conf_fin(c));

    UC(io_point_push(p, MAX_N, rr, <span class="string"><span class="delimiter">&quot;</span><span class="content">x y z</span><span class="delimiter">&quot;</span></span>));
    UC(io_point_push(p, MAX_N, density, <span class="string"><span class="delimiter">&quot;</span><span class="content">density</span><span class="delimiter">&quot;</span></span>));
    id = <span class="integer">0</span>;
    UC(io_point_write(p, comm, id));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_vtk">22.7. VTK</h3>
<div class="paragraph">
<p>Write vertices and triangles data to legacy vtk files. <code>VTK</code> structure
uses <code>VTKConf</code> structure for initialization.</p>
</div>
<div class="paragraph">
<p>A configuration structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> vtk_conf_ini(MeshRead*, <span class="comment">/**/</span> VTKConf**); <b class="conum">(1)</b>
<span class="directive">void</span> vtk_conf_fin(VTKConf*);
<span class="directive">void</span> vtk_conf_vert(VTKConf*, <span class="directive">const</span> <span class="predefined-type">char</span> *keys); <b class="conum">(2)</b>
<span class="directive">void</span> vtk_conf_tri(VTKConf*, <span class="directive">const</span> <span class="predefined-type">char</span> *keys); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>initilize configuration structure</p>
</li>
<li>
<p>"register" a "key" for data on vertices</p>
</li>
<li>
<p>"register" a "key" for data on triangles</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Push data</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> vtk_ini(MPI_Comm, <span class="predefined-type">int</span> maxm, <span class="predefined-type">char</span> <span class="directive">const</span> *dir, VTKConf*, <span class="comment">/**/</span> VTK**); <b class="conum">(1)</b>
<span class="directive">void</span> vtk_points(VTK*, <span class="predefined-type">int</span> nm, <span class="directive">const</span> Vectors*); <b class="conum">(2)</b>

<span class="directive">void</span> vtk_vert(VTK*, <span class="predefined-type">int</span> nm, <span class="directive">const</span> Scalars*, <span class="directive">const</span> <span class="predefined-type">char</span> *keys); <b class="conum">(3)</b>
<span class="directive">void</span> vtk_tri(VTK*, <span class="predefined-type">int</span> nm, <span class="directive">const</span> Scalars*, <span class="directive">const</span> <span class="predefined-type">char</span> *keys);  <b class="conum">(4)</b>

<span class="directive">void</span> vtk_write(VTK*, MPI_Comm, <span class="predefined-type">int</span> id); <b class="conum">(5)</b>
<span class="directive">void</span> vtk_fin(VTK*);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>initilize the structure, create directory</p>
</li>
<li>
<p>"push" coordinates of the vertices</p>
</li>
<li>
<p>"push" vertices data</p>
</li>
<li>
<p>"push" triangle data</p>
</li>
<li>
<p>write a file</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="io_restart">22.8. restart</h3>
<div class="paragraph">
<p>Dump and read restart files to restart simulation at a given time.
Uses the <a href="#third_bop">bop</a> file format.</p>
</div>
<div class="sect3">
<h4 id="_naming_2">22.8.1. naming</h4>
<div class="paragraph">
<p>The restart files are named as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>BASE/CODE/ID.bop
BASE/CODE/ID.values</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BASE</code>: can be different for dump and read. Set to "strt" in <code>default.cfg</code>.</p>
</li>
<li>
<p><code>CODE</code>: specified by the user, see <code>code</code> parameter in the
<a href="#io_restart_int">interface</a>. By convention, it corresponds to the quantity name
followed by an additional specifier, such as "flu.pp" for particles
of the solvent.</p>
</li>
<li>
<p><code>ID</code>: a string specific to the time step. Common value is the dump
index starting from 0. Special values are described in  <a href="#io_restart_int">interface</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="io_restart_int">22.8.2. interface</h4>
<div class="paragraph">
<p>Writing a single file for all ranks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> restart_write_pp(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, <span class="predefined-type">long</span> n, <span class="directive">const</span> Particle *pp); <b class="conum">(1)</b>
<span class="directive">void</span> restart_write_ii(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, <span class="predefined-type">long</span> n, <span class="directive">const</span> <span class="predefined-type">int</span> *ii);      <b class="conum">(2)</b>
<span class="directive">void</span> restart_write_ss(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, <span class="predefined-type">long</span> n, <span class="directive">const</span> Solid *ss);    <b class="conum">(3)</b>
<span class="directive">void</span> restart_write_stream_one_node(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, <span class="directive">const</span> <span class="directive">void</span> *data, StreamWriter); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>write particle data</p>
</li>
<li>
<p>write integer data</p>
</li>
<li>
<p>write rigid data</p>
</li>
<li>
<p>the master rank only writes to a stream (text file)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The stream writer and reader make use of a function pointer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">typedef</span> <span class="directive">void</span> (*StreamWriter)(<span class="directive">const</span> <span class="directive">void</span>*, FILE*);
<span class="keyword">typedef</span> <span class="directive">void</span> (*StreamReader)(FILE*, <span class="directive">void</span>*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the data is passed through a <code>void</code> pointer.</p>
</div>
<div class="paragraph">
<p>The reader functions are symmetric to the writer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> restart_read_pp(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, <span class="predefined-type">int</span> *n, Particle *pp);
<span class="directive">void</span> restart_read_ii(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, <span class="predefined-type">int</span> *n, <span class="predefined-type">int</span> *ii);
<span class="directive">void</span> restart_read_ss(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, <span class="predefined-type">int</span> *n, Solid *ss);
<span class="directive">void</span> restart_read_stream_one_node(<span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">char</span> *code, <span class="predefined-type">int</span> id, StreamReader, <span class="directive">void</span> *data);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a communicator of all ranks dumping or reading the file</p>
</li>
<li>
<p><code>base</code>: a string representing the base directory name</p>
</li>
<li>
<p><code>code</code>: a string containing the directory name</p>
</li>
<li>
<p><code>id</code>: the index of dump (starting at 0). Special values can be
passed:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">enum</span> {RESTART_TEMPL=-<span class="integer">1</span>,
      RESTART_FINAL=-<span class="integer">2</span>};
<span class="keyword">enum</span> {RESTART_BEGIN=RESTART_FINAL};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>final</em> and <em>begin</em> special ids will replace the <code>id</code> part with the string
"final". It is used to dump the last restart file.
The <em>templ</em> special id will replace the <code>id</code> part with the string
"templ". It is used for special quantities which do not change during
the whole simulation, such as wall frozen particles or rigid frozen particles.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inter_interprocessing_tools">23. inter: interprocessing tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Interprocessing tools: not pre or post processing, happens inside
 simulation&#8230;&#8203;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>freeze particles into walls</p>
</li>
<li>
<p>generate initial solvent colors</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="inter_color">23.1. color</h3>
<div class="paragraph">
<p>Generate colors initial conditions</p>
</div>
<div class="sect3">
<h4 id="_interface_24">23.1.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate the helper structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inter_color_ini(GenColor**);
<span class="directive">void</span> inter_color_fin(GenColor*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>set the geometry type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inter_color_set_drop(<span class="predefined-type">float</span> R, GenColor*); <b class="conum">(1)</b>
<span class="directive">void</span> inter_color_set_uniform(GenColor*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>color with <code>RED</code> a ball of radius <code>R</code> in the center of the domain,
and the rest <code>BLUE</code></p>
</li>
<li>
<p>color all particles as <code>BLUE</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>this can also be set via <a href="#conf">configuration</a> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inter_color_set_conf(<span class="directive">const</span> Config*, GenColor*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply coloring to a set of particles host or device arrays:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inter_color_apply_hst(<span class="directive">const</span> Coords*, <span class="directive">const</span> GenColor*, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> <span class="predefined-type">int</span> *cc);
<span class="directive">void</span> inter_color_apply_dev(<span class="directive">const</span> Coords*, <span class="directive">const</span> GenColor*, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> <span class="predefined-type">int</span> *cc);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inter_freeze">23.2. freeze</h3>
<div class="paragraph">
<p>tools to generate quantities from solvent after equilibration.
also used to remove objects colliding with the newly created wall</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> inter_freeze(<span class="directive">const</span> Coords*, MPI_Comm, InterWalInfos, InterFluInfos, InterRbcInfos, InterRigInfos); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>create rigid bodies, remove rigid bodies and rbcs colliding with
the walls and remove solvent at rigid bodies locations</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To avoid long argument list, the data is packed in helper structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> InterWalInfos {
    <span class="predefined-type">bool</span> active;
    <span class="directive">const</span> Sdf *sdf;
};

<span class="keyword">struct</span> InterFluInfos {
    FluQuants *q;
};

<span class="keyword">struct</span> InterRbcInfos {
    <span class="predefined-type">bool</span> active;
    RbcQuants *q;
};

<span class="keyword">struct</span> InterRigInfos {
    <span class="predefined-type">bool</span> active;
    <span class="predefined-type">bool</span> empty_pp;
    RigQuants *q;
    <span class="directive">const</span> RigPinInfo *pi;
    <span class="directive">const</span> MeshRead *mesh;
    <span class="predefined-type">float</span> mass;
    <span class="predefined-type">int</span> numdensity;
};</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_math">24. Math</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helpers for math operations and random number generation</p>
</div>
<div class="sect2">
<h3 id="_linal">24.1. linal</h3>
<div class="paragraph">
<p>Linear algebra functions</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> linal_inv3x3(<span class="directive">const</span> <span class="predefined-type">float</span> m0[<span class="integer">6</span>], <span class="comment">/**/</span> <span class="predefined-type">float</span> minv0[<span class="integer">6</span>]); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>inverse symmetric 3 by 3 matrix; fails for singular matrices with
determinant smaller than epsilon (hardcoded to <code>1e-8</code>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>structure of the matrix is <code>xx, xy, yy, yz, zz</code>, where</p>
</div>
<div class="stemblock">
<div class="content">
\[A =
\begin{bmatrix}
    xx &amp; xy &amp; xz \\
    xy &amp; yy &amp; yz \\
    xz &amp; yz &amp; zz
\end{bmatrix}\]
</div>
</div>
</div>
<div class="sect2">
<h3 id="_host_random_number_generation">24.2. Host random number generation</h3>
<div class="paragraph">
<p>Generate uniform random numbers on host in floating point precision. Uses
<a href="https://en.wikipedia.org/wiki/KISS_(algorithm)">KISS algorithm</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> RNDunif;                                             <b class="conum">(1)</b>
<span class="directive">void</span> rnd_ini(<span class="predefined-type">int</span> x, <span class="predefined-type">int</span> y, <span class="predefined-type">int</span> z, <span class="predefined-type">int</span> c, <span class="comment">/**/</span> RNDunif **r); <b class="conum">(2)</b>
<span class="directive">void</span> rnd_fin(RNDunif *r);                                   <b class="conum">(3)</b>
<span class="predefined-type">float</span> rnd_get(RNDunif *r);                                  <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>hidden structure containing state of the rng</p>
</li>
<li>
<p>allocate and initialize the rng (<code>x</code>, <code>y</code>, <code>z</code> and <code>c</code> are states of the rng)</p>
</li>
<li>
<p>deallocate rng states</p>
</li>
<li>
<p>generate a random number in single precision; modify the state</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="math_tform">24.3. tform: linar coordinate transformation for 3D vector</h3>
<div class="paragraph">
<p>Transform vector <code>a[3]</code> to <code>b[3]</code> using</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    b[X] = s[X]*a[X] + o[X]
    b[Y] = s[Y]*a[Y] + o[Y]
    b[Z] = s[Z]*a[Z] + o[Z]</pre>
</div>
</div>
<div class="paragraph">
<p>Coefficient <code>s</code> and <code>o</code> are defined implicitly by API calls.</p>
</div>
<div class="sect3">
<h4 id="_interface_25">24.3.1. interface</h4>
<div class="sect4">
<h5 id="_allocate_deallocate">Allocate/Deallocate</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> tform_ini(Tform**);
<span class="directive">void</span> tform_fin(Tform*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters of the transformation, some transfroms are for grids
which are cell centered and defined by low and high boundaries and the
number of cell.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> tform_vector(<span class="directive">const</span> <span class="predefined-type">float</span> a0[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">float</span> a1[<span class="integer">3</span>],   <span class="directive">const</span> <span class="predefined-type">float</span> b0[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">float</span> b1[<span class="integer">3</span>], <span class="comment">/**/</span> Tform*); <b class="conum">(1)</b>
<span class="directive">void</span> tform_chain(<span class="directive">const</span> Tform *A, <span class="directive">const</span> Tform *B, <span class="comment">/**/</span> Tform *C); <b class="conum">(2)</b>
<span class="directive">void</span> tform_to_grid(<span class="directive">const</span> <span class="predefined-type">float</span> lo[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">float</span> hi[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">int</span> n[<span class="integer">3</span>], <span class="comment">/**/</span> Tform*); <b class="conum">(3)</b>
<span class="directive">void</span> tform_from_grid(<span class="directive">const</span> <span class="predefined-type">float</span> a0[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">float</span> b0[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">int</span> n[<span class="integer">3</span>], <span class="comment">/**/</span> Tform*); <b class="conum">(4)</b>
<span class="directive">void</span> tform_grid2grid(<span class="directive">const</span> <span class="predefined-type">float</span> f_lo[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">float</span> f_hi[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">int</span> f_n[<span class="integer">3</span>],
                     <span class="directive">const</span> <span class="predefined-type">float</span> t_lo[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">float</span> t_hi[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">int</span> t_n[<span class="integer">3</span>],
                     Tform*); <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>converts vectors <code>a0</code> to <code>a1</code> and <code>b0</code> to <code>b1</code></p>
</li>
<li>
<p>a chain of two transforms: C(x) is equivalent to 'B(A(x))'</p>
</li>
<li>
<p>transfrom to a grid: for example, it transfroms <code>lo</code> to <code>-1/2</code> and <code>hi</code> to <code>n - 1/2</code></p>
</li>
<li>
<p>transfrom from a grid: for example, it transfroms <code>-1/2</code> to <code>lo</code> and <code>n - 1/2</code> to <code>hi</code></p>
</li>
<li>
<p>grid to grid transform</p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="_convert_vector">Convert vector</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> tform_convert(<span class="directive">const</span> Tform*, <span class="directive">const</span> <span class="predefined-type">float</span> a0[<span class="integer">3</span>], <span class="comment">/**/</span> <span class="predefined-type">float</span> a1[<span class="integer">3</span>]);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_convert_to_view">convert to view</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> tform_to_view(<span class="directive">const</span> Tform*, <span class="comment">/**/</span> Tform_v*);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_log">log</h6>
<div class="paragraph">
<p>Log or dump the state of 'Tform'</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> tform_log(Tform*);
<span class="directive">void</span> tform_dump(Tform*, FILE*);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_triangle_functions">24.4. triangle functions</h3>
<div class="paragraph">
<p>Host and device functions for a given triangle. For
area computation
<a href="https://people.eecs.berkeley.edu/~wkahan/Triangle.pdf">a formula</a>
stable to numerical error is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">double</span> kahan_area0(<span class="predefined-type">double</span> a, <span class="predefined-type">double</span> b, <span class="predefined-type">double</span> c); <b class="conum">(1)</b>
<span class="predefined-type">double</span> kahan_area(<span class="directive">const</span> <span class="predefined-type">double</span> a[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> b[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> c[<span class="integer">3</span>]); <b class="conum">(2)</b>
<span class="directive">void</span>   ac_bc_cross(<span class="directive">const</span> <span class="predefined-type">double</span> a[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> b[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> c[<span class="integer">3</span>], <span class="comment">/**/</span> <span class="predefined-type">double</span> r[<span class="integer">3</span>]); <b class="conum">(3)</b>
<span class="predefined-type">double</span> shewchuk_area(<span class="directive">const</span> <span class="predefined-type">double</span> a[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> b[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> c[<span class="integer">3</span>]); <b class="conum">(4)</b>
<span class="predefined-type">double</span> orient3d(<span class="directive">const</span> <span class="predefined-type">double</span> a[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> b[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> c[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> d[<span class="integer">3</span>]); <b class="conum">(5)</b>
<span class="directive">void</span> dihedral_xy(<span class="directive">const</span> <span class="predefined-type">double</span> a[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> b[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> c[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">double</span> d[<span class="integer">3</span>],
                   <span class="predefined-type">double</span> *x, <span class="predefined-type">double</span> *y); <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>area of a triangle given sides</p>
</li>
<li>
<p>area of a triangle given coordinate of the vertices</p>
</li>
<li>
<p>\(\mathbf{a} - \mathbf{c} \times \mathbf{b} - \mathbf{c}\)</p>
</li>
<li>
<p>area of a triangle given coordinate of the vertices using "Shewchuk formula"</p>
</li>
<li>
<p><code>orient3d</code> from Shewchuk</p>
</li>
<li>
<p>dihedral angle</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mesh_4">25. Mesh</h2>
<div class="sectionbody">
<div class="paragraph">
<p>helpers for computation on triangle mesh.</p>
</div>
<div class="paragraph">
<p>Mesh are stored with an array of vertices (<code>vv</code>) or particles (<code>pp</code>) in an array of
structure fashion.
The connectivity is a set of vertices indices grouped by triangles.
For performance and convenience reasons, they are stored in a <code>int4</code>
array, each element storing ids of the three vertices of the triangle
(the last field is not used).</p>
</div>
<div class="paragraph">
<p>More complex connectivity structures are defined in appropriate
submodules, see <a href="#algo_edg">edg</a> or <a href="#rbc_adj">adj</a>.</p>
</div>
<div class="sect2">
<h3 id="mesh_area">25.1. area: compute area of a mesh</h3>
<div class="paragraph">
<p>Compute the area of a triangulated mesh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_area_ini(MeshRead*, <span class="comment">/**/</span> MeshArea**); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_area_fin(MeshArea*);

<span class="predefined-type">double</span> mesh_area_apply0(MeshArea*, Vectors*);                     <b class="conum">(2)</b>
<span class="directive">void</span>  mesh_area_apply(MeshArea*, <span class="predefined-type">int</span> nm, Vectors*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>in initialization triangles are stored</p>
</li>
<li>
<p>compute the area of one object</p>
</li>
<li>
<p>compute the areas of <code>nm</code> objects</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mesh_tri_area">25.2. tri_area: compute area of triangles in a mesh</h3>
<div class="paragraph">
<p>Compute the area of every triangle of the mesh.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_tri_area_ini(MeshRead*, <span class="comment">/**/</span> MeshTriArea**); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_tri_area_fin(MeshTriArea*);

<span class="directive">void</span>  mesh_tri_area_apply(MeshTriArea*, <span class="predefined-type">int</span> nm, Vectors*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>in initialization triangles are stored</p>
</li>
<li>
<p>compute areas</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>nm</code> is the number of meshes.</p>
</div>
</div>
<div class="sect2">
<h3 id="mesh_angle">25.3. angle: compute angles between triangles with a common edge</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_angle_ini(MeshRead*, <span class="comment">/**/</span> MeshAngle**); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_angle_fin(MeshAngle*);
<span class="directive">void</span>  mesh_angle_apply(MeshAngle*, <span class="predefined-type">int</span> nm, Vectors*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>in initialization triangles are stored</p>
</li>
<li>
<p>triangle for <code>nm</code> objects, the size of the output is <code>nm * ne</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="edg_len_angle">25.4. edges length: compute length of the edges</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_edg_len_ini(MeshRead*, MeshEdgLen**); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_edg_len_fin(MeshEdgLen*);
<span class="directive">void</span> mesh_edg_len_apply(MeshEdgLen*, <span class="predefined-type">int</span> nm, Vectors*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>in initialization triangles are stored</p>
</li>
<li>
<p>edges for <code>nm</code> objects, the size of the output is <code>nm * ne</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_gen_generate_mesh">25.5. gen: generate mesh</h3>
<div class="paragraph">
<p>Generate mesh vertices from template mesh and affine transform
matrices (see <a href="#mesh_matrices">matrices submodule</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="comment">/* vv : vertices of the mesh template : x y z x y z, ...   */</span>
<span class="predefined-type">int</span>  mesh_gen_from_file(<span class="directive">const</span> Coords*, <span class="directive">const</span> <span class="predefined-type">float</span> *vv, <span class="directive">const</span> <span class="predefined-type">char</span> *ic, <span class="predefined-type">int</span> nv, <span class="comment">/**/</span> Particle*); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_gen_from_matrices(<span class="predefined-type">int</span> nv, <span class="directive">const</span> <span class="predefined-type">float</span> *vv, <span class="directive">const</span> Matrices*, <span class="comment">/**/</span> <span class="predefined-type">int</span> *pn, Particle*);  <b class="conum">(2)</b>
<span class="directive">void</span> mesh_shift(<span class="directive">const</span> Coords*, <span class="predefined-type">int</span> n, <span class="comment">/**/</span> Particle*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>generate and filter meshes from file <code>ic</code>. Only those
belonging to subdomain are kept.</p>
</li>
<li>
<p>generate from a matrices array</p>
</li>
<li>
<p>shift a set of vertices particles from global to local coordinates</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mesh_matrices">25.6. matrices: affine transformation</h3>
<div class="paragraph">
<p>An array of <code>4 x 4</code> affine transformation matrices.</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    \vec{y} \\ 1
\end{bmatrix}
=
\left[
    \begin{array}{ccc|c}
        \, &amp; A &amp; &amp; \vec{b} \ \\ 0 &amp; \ldots &amp; 0 &amp; 1
    \end{array}
\right]
\begin{bmatrix}
    \vec{x} \\ 1
\end{bmatrix}\]
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> matrices_read(<span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="comment">/**/</span> Matrices**); <b class="conum">(1)</b>
<span class="directive">void</span> matrices_read_filter(<span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="directive">const</span> Coords*, <span class="comment">/**/</span> Matrices**); <b class="conum">(2)</b>

<span class="directive">void</span> matrices_get(<span class="directive">const</span> Matrices*, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> <span class="predefined-type">double</span>**); <b class="conum">(3)</b>
<span class="directive">void</span> matrices_get_r(<span class="directive">const</span> Matrices*, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> <span class="predefined-type">double</span> r[<span class="integer">3</span>]); <b class="conum">(4)</b>
<span class="predefined-type">int</span>  matrices_get_n(<span class="directive">const</span> Matrices*); <b class="conum">(5)</b>
<span class="directive">void</span> matrices_log(<span class="directive">const</span> Matrices*);   <b class="conum">(6)</b>

<span class="directive">void</span> matrices_fin(Matrices*);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>read from input file</p>
</li>
<li>
<p>read from input file and keep only matrices which "belong" to this
MPI rank</p>
</li>
<li>
<p>return matrix as <code>double[16]</code></p>
</li>
<li>
<p>return the shift of the ith matrix as <code>double[3]</code></p>
</li>
<li>
<p>return the number of matrices</p>
</li>
<li>
<p>print the array of matrices to <code>stderr</code> using <code>msg_print</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mesh_scatter">25.7. "scatter": distribute scalar values between different elements of the mesh</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_scatter_ini(MeshRead*, MeshScatter**); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_scatter_fin(MeshScatter*);
<span class="directive">void</span> mesh_scatter_edg2vert(MeshScatter*, <span class="predefined-type">int</span> nm, Scalars*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(2)</b>
<span class="directive">void</span> mesh_scatter_edg2vert_avg(MeshScatter*, <span class="predefined-type">int</span> nm, Scalars*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>in initialization triangles are stored</p>
</li>
<li>
<p>edge to vertices</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mesh_triangles">25.8. Triangles</h3>
<div class="paragraph">
<p>Triangles on device. It is created from <code>MeshRead*</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> triangles_ini(MeshRead*, <span class="comment">/**/</span> Triangles**);
<span class="directive">void</span> triangles_fin(Triangles*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>the client must include <code>type.h</code> and can access fields directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> Triangles {
    int4 *tt;
    <span class="predefined-type">int</span> nt;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>nt</code> is the number of triangles.</p>
</div>
</div>
<div class="sect2">
<h3 id="mesh_vert_area">25.9. vertices' area</h3>
<div class="paragraph">
<p>Compute area associated with every vertices. Assume every adjusting
triangle contributes one third it its area to a vertice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_vert_area_ini(MeshRead*, <span class="comment">/**/</span> MeshVertArea**); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_vert_area_fin(MeshVertArea*);

<span class="directive">void</span>  mesh_vert_area_apply(MeshVertArea*, <span class="predefined-type">int</span> nm, Vectors*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>in initialization triangles are stored</p>
</li>
<li>
<p>compute area</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mesh_volume">25.10. volume: compute volume of a mesh</h3>
<div class="paragraph">
<p>Compute the volume enclosed by a triangulated mesh on host.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> mesh_volume_ini(MeshRead*, <span class="comment">/**/</span> MeshVolume**); <b class="conum">(1)</b>
<span class="directive">void</span> mesh_volume_fin(MeshVolume*);

<span class="predefined-type">double</span> mesh_volume_apply0(MeshVolume*, Vectors*);                      <b class="conum">(2)</b>
<span class="directive">void</span>  mesh_volume_apply(MeshVolume*, <span class="predefined-type">int</span> nm, Vectors*, <span class="comment">/**/</span> <span class="predefined-type">double</span>*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>in initialization triangles are stored</p>
</li>
<li>
<p>compute volume for one object</p>
</li>
<li>
<p>compute volume for <code>nm</code> objects</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pair_pairwise_interactions">26. pair: pairwise interactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>pairwise forces.
manages the parameters for dpd and repulsive Lennard-Jones parameters.</p>
</div>
<div class="sect2">
<h3 id="_dpd_interactions">26.1. dpd interactions</h3>
<div class="paragraph">
<p>DPD particles interact via the following force:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{F}_{ij} = \left( F_{ij}^C + F_{ij}^R + F_{ij}^D \right) \mathbf{e}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^C = \alpha w(r), \\
w(r) = \max \left( 1 - \frac{r_{ij}} {r_c}, 0 \right)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^R = \sigma w^R(r_{ij}) W_{ij}\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^D = -\gamma w^R(r_{ij})^2 \mathbf{v}_{ij} \cdot \mathbf{r}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{r}_{ij} = \mathbf{r}_i - \mathbf{r}_j, \\
r_{ij} = | \mathbf{r}_{ij} |, \\
\mathbf{v}_{ij} = \mathbf{v}_i - \mathbf{v}_j.\]
</div>
</div>
<div class="paragraph">
<p>The kernel stem:{w^R} is given by</p>
</div>
<div class="stemblock">
<div class="content">
\[w^R(r) = (1-r)^{spow},\]
</div>
</div>
<div class="paragraph">
<p>where \(spow\) is a number between 0 and 1.
The default value is 0.25.</p>
</div>
</div>
<div class="sect2">
<h3 id="_repulsive_lj">26.2. repulsive LJ</h3>
<div class="paragraph">
<p>Repulsive forces for contact are implemented using the repulsive LJ
potential. It is given by</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{F}_{ij} = F_{ij}^{rLJ} \mathbf{e}_{ij}\]
</div>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{ij}^{rLJ} = \max \left( 0, F^{LJ}(r_{ij})\right)\]
</div>
</div>
<div class="stemblock">
<div class="content">
\[F^{LJ}(r) = 24 \epsilon \frac{1}{r} \left( 2 \left[\frac \sigma r
\right]^12 - \left[\frac \sigma r \right]^6 \right)\]
</div>
</div>
<div class="paragraph">
<p>for numerical reasons, the magnitude is limited to \(10^4\).</p>
</div>
</div>
<div class="sect2">
<h3 id="_host_interface_3">26.3. Host interface</h3>
<div class="paragraph">
<p>allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> pair_ini(PairParams **);
<span class="directive">void</span> pair_fin(PairParams *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>set parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> pair_set_dpd(<span class="predefined-type">int</span> ncol, <span class="directive">const</span> <span class="predefined-type">float</span> a[], <span class="directive">const</span> <span class="predefined-type">float</span> g[], <span class="predefined-type">float</span> spow, PairParams *p); <b class="conum">(1)</b>
<span class="directive">void</span> pair_set_lj(<span class="predefined-type">float</span> sigma, <span class="predefined-type">float</span> eps, PairParams *p); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set the DPD parameters. <code>ncol</code> is the number of colors. This is
mandatory for any view</p>
</li>
<li>
<p>set the Lennard-Jones parameters \(\sigma\) and
\(\epsilon\). This may be called only when the LJ parameters are needed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>set parameters from configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> pair_set_conf(<span class="directive">const</span> Config *, <span class="directive">const</span> <span class="predefined-type">char</span> *name_space, PairParams *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>the argument <code>name_space</code> denotes the namespace where to look for the
parameters (see below).</p>
</div>
<div class="paragraph">
<p>Compute the \(\sigma\) parameter for a given temperature and timestep:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> pair_ini(PairParams **);
<span class="directive">void</span> pair_fin(PairParams *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get the different views:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> pair_get_view_dpd(<span class="directive">const</span> PairParams*, PairDPD*);
<span class="directive">void</span> pair_get_view_dpd_color(<span class="directive">const</span> PairParams*, PairDPDC*);
<span class="directive">void</span> pair_get_view_dpd_mirrored(<span class="directive">const</span> PairParams*, PairDPDCM*);
<span class="directive">void</span> pair_get_view_dpd_lj(<span class="directive">const</span> PairParams*, PairDPDLJ*);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_device_interface_2">26.4. device interface</h3>
<div class="paragraph">
<p>Inside a CUDA kernel, the pairwise force can be called by the generic function</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Param, <span class="keyword">typename</span> Fo&gt;
_I_ <span class="directive">void</span> pair_force(<span class="directive">const</span> Param *p, PairPa a, PairPa b, <span class="predefined-type">float</span> rnd, <span class="comment">/**/</span> Fo *f)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>PairPa</code> structure is a generic particle with color.
This should be used with the <em>parray</em> module.
The <code>Fo</code> structure is a generic force and can be either <code>PairFo</code> or
<code>PairSFo</code>, respectively, for force or force and stress computation.
This should be used with the <em>farray</em> module.
The input parameter <code>Param p</code> is a view for pair parameters.</p>
</div>
<div class="paragraph">
<p>The above function behaves differently given different types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PairDPD</code>: standard DPD interaction</p>
</li>
<li>
<p><code>PairDPDLJ</code>: standard DPD and repulsive LJ interaction</p>
</li>
<li>
<p><code>PairDPDC</code>: <em>colored</em> DPD interaction: pick up parameters as a function
of the particle colors</p>
</li>
<li>
<p><code>PairDPDCM</code>: <em>mirrored</em> DPD: same as <em>colored</em> DPD considering that
particle <code>b</code> has the same color as particle <code>a</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Inside a kernel, the generic force can be added by using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">_I_ <span class="directive">void</span> pair_add(<span class="directive">const</span> PairFo *b, <span class="comment">/**/</span> PairFo *a)
_I_ <span class="directive">void</span> pair_add(<span class="directive">const</span> PairSFo *b, <span class="comment">/**/</span> PairSFo *a)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_7">26.5. Configuration</h3>
<div class="paragraph">
<p>parameters are configured through 3 namespaces: <code>flu</code>, <code>fsi</code> and
<code>cnt</code>.</p>
</div>
<div class="paragraph">
<p>example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">flu = {
    dpd = true
    a = [10.0, 80.0, 10.0]
    g = [1.0, 8.0, 15.0]
    spow = 0.25
    lj = false
}

fsi = {
    dpd = true
    a = [10.0, 80.0, 10.0]
    g = [1.0, 8.0, 15.0]
    spow = 0.25
    lj = false
}

cnt = {
    dpd = true
    a = [0.0]
    g = [16.0]
    spow = 0.25
    lj = true
    ljs = 0.3
    lje = 0.44
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DPD parameters can be different when many colors are set.
User provides parameters in an array following the packed symmetric
matrix convention. For example the interaction table for 3 colors</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    x_{11} &amp; x_{12} &amp; x_{13} \\
    x_{12} &amp; x_{22} &amp; x_{23} \\
    x_{13} &amp; x_{23} &amp; x_{33}
\end{bmatrix}\]
</div>
</div>
<div class="paragraph">
<p>becomes</p>
</div>
<div class="stemblock">
<div class="content">
\[\begin{bmatrix}
    x_{11} &amp; x_{12} &amp; x_{13} &amp; x_{22} &amp; x_{23} &amp; x_{33}
\end{bmatrix}.\]
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_meshbb">27. meshbb</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bounce back particles on a moving mesh</p>
</div>
<div class="paragraph">
<p>Let define the following quantities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(\mathbf{r}_0, \mathbf{v}_0\) : particle at time \(0\)</p>
</li>
<li>
<p>\(\mathbf{r}_1, \mathbf{v}_1\) : particle at time \(dt\) if
there is no collision</p>
</li>
<li>
<p>\(\mathbf{r}_n, \mathbf{v}_n\) : particle at time \(dt\) after
bounce back</p>
</li>
<li>
<p>\(h \in [0, dt\)] : collision time</p>
</li>
<li>
<p>\(\mathbf{r}_w, \mathbf{v}_w\) : collision position and velocity
of the surface</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A particle colliding with a surface is bounced back as:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{v}_n = 2 \mathbf{v}_w - \mathbf{v}_0, \\
\mathbf{r}_n = \mathbf{r}_w + (dt - h) \mathbf{v}_n.\]
</div>
</div>
<div class="paragraph">
<p>This module computes the collision time, position and velocity for a
moving triangle.
The motion of the triangle points are assumed to be linear:</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{a}(t) = (1 - t) \mathbf{a}_0 + t \mathbf{a}_1, \\
\mathbf{b}(t) = (1 - t) \mathbf{b}_0 + t \mathbf{b}_1, \\
\mathbf{c}(t) = (1 - t) \mathbf{c}_0 + t \mathbf{c}_1.\]
</div>
</div>
<div class="sect2">
<h3 id="_interface_26">27.1. interface</h3>
<div class="paragraph">
<p>Allocate and deallocate <code>MeshBB</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> meshbb_ini(<span class="predefined-type">int</span> maxpp, <span class="comment">/**/</span> MeshBB **d);
<span class="directive">void</span> meshbb_fin(<span class="comment">/**/</span> MeshBB *d);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bouncing particles on a set of mesh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> meshbb_reini(<span class="predefined-type">int</span> n, <span class="comment">/**/</span> MeshBB *d);  <b class="conum">(1)</b>
<span class="directive">void</span> meshbb_find_collisions(<span class="predefined-type">float</span> dt, <span class="predefined-type">int</span> nm, MeshInfo meshinfo, <span class="directive">const</span> Particle *i_pp, int3 L,
                            <span class="directive">const</span> <span class="predefined-type">int</span> *starts, <span class="directive">const</span> <span class="predefined-type">int</span> *counts, <span class="directive">const</span> Particle *pp, <span class="directive">const</span> Force *ff, <span class="comment">/**/</span> MeshBB *d);  <b class="conum">(2)</b>
<span class="directive">void</span> meshbb_select_collisions(<span class="predefined-type">int</span> n, <span class="comment">/**/</span> MeshBB *d);  <b class="conum">(3)</b>
<span class="directive">void</span> meshbb_bounce(<span class="predefined-type">float</span> dt, <span class="predefined-type">float</span> mass, <span class="predefined-type">int</span> n, <span class="directive">const</span> MeshBB *d, <span class="directive">const</span> Force *ff, MeshInfo meshinfo,
                   <span class="directive">const</span> Particle *i_pp, <span class="comment">/**/</span> Particle *pp, Momentum *mm);  <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>reinitialise the structure (must be done before a new time step)</p>
</li>
<li>
<p>store collision informations inside the structure with a set of
mesh. This can be done for multiple mesh sets.</p>
</li>
<li>
<p>For each bouncing particle, select the collision with minimum
time. Must be called after finding all collisions.</p>
</li>
<li>
<p>bounce particles and store the momentum changes per triangle</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The momentum changes computed above can be collected to rigid objects
or to membrane mesh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> meshbb_collect_rig_momentum(<span class="predefined-type">float</span> dt, <span class="predefined-type">int</span> ns, MeshInfo meshinfo, <span class="directive">const</span> Particle *pp, <span class="directive">const</span> Momentum *mm, <span class="comment">/**/</span> Solid *ss); <b class="conum">(1)</b>
<span class="directive">void</span> meshbb_collect_rbc_momentum(<span class="predefined-type">float</span> dt, <span class="predefined-type">int</span> nc, MeshInfo meshinfo, <span class="directive">const</span> Particle *pp, <span class="directive">const</span> Momentum *mm, <span class="comment">/**/</span> Force *ff); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Reduce <code>Momentum</code> array into one force and torque per rigid
object.</p>
</li>
<li>
<p>Convert momentum information into forces for membrane particles.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_red_blood_cell">28. Red blood cell</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Red blood cell membranes are represented via particles with
connectivity.</p>
</div>
<div class="paragraph">
<p>This module stores the required quantities and functions for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>initializing red blood cells positions and orientations</p>
</li>
<li>
<p>managing particles and connectivity</p>
</li>
<li>
<p>membrane force computations</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="rbc_energy">28.1. Elastic energies</h3>
<div class="sect3">
<h4 id="_spring">28.1.1. spring</h4>
<div class="paragraph">
<p>Spring energy is a function of distance between connected beads \(r\)</p>
</div>
<div class="stemblock">
<div class="content">
\[U_{spring}(r) = U_{wlc}(r) + U_{pow}(r)\]
</div>
</div>
<div class="paragraph">
<p>where worm-like chain energy:</p>
</div>
<div class="stemblock">
<div class="content">
\[U_{wlc}(r) =
\frac{k_s}{4 l_{max}}
\frac{3 x^2 - 2 x^3}{1 - x}, \quad x = \frac{r}{l_{max}}\]
</div>
</div>
<div class="paragraph">
<p>and power-law energy:</p>
</div>
<div class="stemblock">
<div class="content">
\[U_{wlc}(r) =
- \frac{k_p}{r^{m - 1}}\]
</div>
</div>
<div class="paragraph">
<p>\(l_0\) is an equilibrium lenght, \(l_{max}\) is a maximum
lenght \(l_{max} = l_{0} / x_{0}\), and \(k_p\) is defined from
condition that \(U_{spring}\) has a maximum at \(r = l_0\), and
\(m\) is a power factor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_local_area_constrain">28.1.2. local area constrain</h4>
<div class="paragraph">
<p>For every triangle with area \(A^{loc}\) and an equilibrium area
\(A_0^{loc}\)</p>
</div>
<div class="stemblock">
<div class="content">
\[E^{loc}_{area} =
k_d
\frac
{
  \left(
    A^{loc} - A_0^{loc}
  \right)^2
}
{2 A_0^{loc}}\]
</div>
</div>
</div>
<div class="sect3">
<h4 id="_total_area_constrain">28.1.3. total area constrain</h4>
<div class="paragraph">
<p>For whole mesh with area \(A^{tot}\) and an equilibrium area
\(A_0^{tot}\)</p>
</div>
<div class="stemblock">
<div class="content">
\[E^{tot}_{area} =
k_a
\frac
{\left( A^{tot} - A_0^{tot} \right)^2}
{2 A_0^{tot} }\]
</div>
</div>
</div>
<div class="sect3">
<h4 id="_total_volume_constrain">28.1.4. total volume constrain</h4>
<div class="paragraph">
<p>For whole mesh with volume \(V\) and an equilibrium volume
\(V_0\)</p>
</div>
<div class="stemblock">
<div class="content">
\[E_{vol} =
k_v
\frac
{\left( V - V_0 \right)^2}
{2 V_0}\]
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bending">28.1.5. bending</h4>
<div class="paragraph">
<p>\(\theta\) is an angle between triangles with common edge,
\(\theta_0\) is an equilibrium angle.</p>
</div>
<div class="stemblock">
<div class="content">
\[E_{bnd} = k_b
\left[
  1 - \cos
  \left(
    \theta - \theta_0
  \right)
\right]\]
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quantities_2">28.2. Quantities</h3>
<div class="paragraph">
<p><code>RbcQuants</code> structure contains particles of membrane and connectivity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="keyword">struct</span> RbcQuants {
    <span class="predefined-type">int</span> n, nc;             <span class="comment">/* number of particles, cells                */</span>
    <span class="predefined-type">int</span> nt, nv;            <span class="comment">/* number of triangles and vertices per mesh */</span>
    <span class="predefined-type">int</span> md;                <span class="comment">/* maximum valence of the mesh               */</span>
    Particle *pp, *pp_hst; <span class="comment">/* vertices particles on host and device     */</span>
    <span class="predefined-type">bool</span> ids;              <span class="comment">/* global ids active ?                       */</span>
    <span class="predefined-type">int</span> *ii;               <span class="comment">/* global ids on host                        */</span>
    AreaVolume *area_volume; <span class="comment">/* to compute area and volume */</span>
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above data structure is allocated and freed using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> rbc_ini(<span class="predefined-type">long</span> maxnc, <span class="predefined-type">bool</span> ids, <span class="directive">const</span> MeshRead*, RbcQuants*);
<span class="directive">void</span> rbc_fin(RbcQuants*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generation is made in two stages: mesh generations and other
quantities (global ids).
This allows to remove red blood cells colliding with other entities
before creating global ids.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> rbc_gen_mesh(<span class="directive">const</span> Coords*, MPI_Comm, <span class="directive">const</span> MeshRead*, <span class="directive">const</span> <span class="predefined-type">char</span> *ic, <span class="comment">/**/</span> RbcQuants*); <b class="conum">(1)</b>
<span class="directive">void</span> rbc_gen_freeze(MPI_Comm, <span class="comment">/**/</span> RbcQuants*);                                               <b class="conum">(2)</b>
<span class="directive">void</span> rbc_strt_quants(MPI_Comm, <span class="directive">const</span> MeshRead*, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">int</span> id, RbcQuants*);  <b class="conum">(3)</b>
<span class="directive">void</span> rbc_strt_dump(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="predefined-type">int</span> id, <span class="directive">const</span> RbcQuants *q);                   <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Generate mesh from file "ic" (see <a href="#mesh_gen">[mesh_gen]</a>)</p>
</li>
<li>
<p>Generate global ids of rbc</p>
</li>
<li>
<p>Generate quantities from <a href="#io_restart">restart</a></p>
</li>
<li>
<p>Dump a <a href="#io_restart">restart</a> state of the quantities</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Available mesh are stored in <code>src/data/cells</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_submodules_3">28.3. Submodules</h3>
<div class="sect3">
<h4 id="rbc_adj">28.3.1. adj: mesh adjacency structure</h4>
<div class="paragraph">
<p>Consider closed triangulated mesh with <code>nv</code> vertices. Degree of a
vertex is the number of edges incident to the vertex. Let <code>md</code> is a
maximum degree of the vertices. There are three types of forces: edge
forces which depend on two vertices, triangle forces which depend on
three vertices, and dihedral forces which depend of four vertices
(edge and two adjusting triangles). To compute forces in one membrane
<em>uDeviceX</em> launches <code>nv * md</code> threads, each thread adds forces to only
one vertices.  <code>Adj_v</code> has an API call which allows for a given thread
ID to find which vertices should be used in forces computation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">static</span> __device__ <span class="predefined-type">int</span> adj_get_map(<span class="predefined-type">int</span> i, Adj_v *adj, <span class="comment">/**/</span> AdjMap *m) {</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>md * nv</code> is bigger than the number of edges in the membrane and
some threads are not needed. The function returns 0 in this case.
<code>AdjMap</code> is a structure which contains five indices and an ID of the
mesh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> AdjMap {
    <span class="predefined-type">int</span> i0, i1, i2, i3, i4;
    <span class="predefined-type">int</span> rbc;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each thread adds force to a vertices with index <code>0</code>. It considers edge
<code>01</code>, triangle <code>012</code>, and two dihedrals <code>0124</code> and <code>1203</code>. For
example, a contribution of edge force <code>01</code> to vertex <code>1</code> is added by
another thread.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/udoc/include/dih.png" alt="dih" width="30%">
</div>
</div>
<div class="paragraph">
<p><code>Adj_v</code> is initilized from a host structure <code>Adj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> adj_ini(<span class="predefined-type">int</span> md, <span class="predefined-type">int</span> nt, <span class="predefined-type">int</span> nv, <span class="directive">const</span> int4 *tt, <span class="comment">/**/</span> Adj**);
<span class="directive">void</span> adj_fin(Adj*);
<span class="predefined-type">int</span>  adj_get_map(<span class="predefined-type">int</span> i, <span class="directive">const</span> Adj*, <span class="comment">/**/</span> AdjMap *m);
<span class="predefined-type">int</span>  adj_get_max(<span class="directive">const</span> Adj*);
<span class="directive">void</span> adj_get_anti(<span class="directive">const</span> Adj*, <span class="comment">/**/</span> <span class="predefined-type">int</span> *anti);

<span class="directive">void</span> adj_view_ini(<span class="directive">const</span> Adj*, Adj_v**);
<span class="directive">void</span> adj_view_fin(Adj_v*);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Adj</code> can be used to pack data which can be asseced on device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">float</span> *A;
n = adj_get_max(adj);
EMALLOC(n, &amp;A);
<span class="keyword">for</span> (i = <span class="integer">0</span>; i &lt; n; i++) {
   valid = adj_get_map(i, adj, <span class="comment">/**/</span> &amp;m);
   <span class="keyword">if</span> (!valid) <span class="keyword">continue</span>;
   i0 = m.i0; i1 = m.i1; i2 = m.i2;
   A[i] = some_function_of(i0, i1, i2)
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_com_center_of_mass">28.3.2. com: center of mass</h4>
<div class="paragraph">
<p>Compute position and velocity of each mesh of the membrane.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_com_ini(<span class="predefined-type">int</span> nv, <span class="predefined-type">int</span> nm_max, <span class="comment">/**/</span> RbcCom**);
<span class="directive">void</span> rbc_com_fin(<span class="comment">/**/</span> RbcCom*);
<span class="directive">void</span> rbc_com_apply(RbcCom*, <span class="predefined-type">int</span> nm, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> float3 **rr, float3 **vv);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>max_nm</code> is a maximum allowed number of meshes. It is a runtime error
if <code>nm</code> exceeds <code>nm_max</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_forces">28.3.3. Forces</h4>
<div class="sect4">
<h5 id="_model">Model</h5>
<div class="paragraph">
<p>The membrane forces are computed by differentiating the <a href="#rbc_energy">membrane energy</a> with respect to position:</p>
</div>
<div class="sect5">
<h6 id="_spring_2">spring</h6>
<div class="paragraph">
<p>A force between two connected beads. \(l_0\) is an equilibrium
spring lenght, \(l_{max}\) is a maximum spring lenght \(l_0 =
l_0 / x_0\).</p>
</div>
<div class="paragraph">
<p>A force between neighboring consissts of repulsive worm-like-chain part</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{wlc}(r) = \frac{k_{s}}
		  {l_{max}}
	     \frac{4 r^2 - 9 r + 6}
		  {4 (r - 1)^2}\]
</div>
</div>
<div class="paragraph">
<p>and attractive power law part</p>
</div>
<div class="stemblock">
<div class="content">
\[F_{pow}(r) = \frac{k_{pow}}
		  {r^{m + 1}}\]
</div>
</div>
</div>
<div class="sect5">
<h6 id="_other_forces">Other forces</h6>
<div class="paragraph">
<p>(from rnd)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>g = gammaC; T = kBT0
f0  = sqrtf(2*g*T/dt)*rnd</pre>
</div>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_27">interface</h5>
<div class="paragraph">
<p>Helpers are stored  in <code>RbcForce</code> structure.
Informations about stress free state and random forces are stored
inside.</p>
</div>
<div class="paragraph">
<p>Allocate, deallocate structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_force_ini(<span class="directive">const</span> MeshRead *cell, RbcForce**);
<span class="directive">void</span> rbc_force_fin(RbcForce*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following setters must be called before force computation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_force_set_stressful(<span class="predefined-type">int</span> nt, <span class="predefined-type">float</span> totArea, <span class="comment">/**/</span> RbcForce*); <b class="conum">(1)</b>
<span class="directive">void</span> rbc_force_set_stressfree(<span class="directive">const</span> <span class="predefined-type">char</span> *fname, <span class="comment">/**/</span> RbcForce*);    <b class="conum">(2)</b>

<span class="directive">void</span> rbc_force_set_rnd0(RbcForce *f);           <b class="conum">(3)</b>
<span class="directive">void</span> rbc_force_set_rnd1(<span class="predefined-type">int</span> seed, RbcForce *f); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set stressful state: (no stress free shape)</p>
</li>
<li>
<p>set stressfree shape from file <code>fname</code></p>
</li>
<li>
<p>disable random forces</p>
</li>
<li>
<p>enable random forces</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Alternatively, user can set the above options through configuration
file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_force_set_conf(<span class="directive">const</span> MeshRead *cell, <span class="directive">const</span> Config *cfg, RbcForce *f);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The forces are computed by calling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_force_apply(RbcForce*, <span class="directive">const</span> RbcParams*, <span class="predefined-type">float</span> dt, <span class="directive">const</span> RbcQuants*, <span class="comment">/**/</span> Force*); <b class="conum">(1)</b>
<span class="directive">void</span> rbc_force_stat(<span class="comment">/**/</span> <span class="predefined-type">float</span> *pArea, <span class="predefined-type">float</span> *pVolume); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>compute forces</p>
</li>
<li>
<p>report statistics</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_force_area_volume_area_and_volume">28.3.4. force/area_volume: area and volume</h4>
<div class="paragraph">
<p>Compute area and volume for every object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> area_volume_ini(<span class="predefined-type">int</span> nv, <span class="predefined-type">int</span> nt, <span class="directive">const</span> int4 *tt, <span class="predefined-type">int</span> max_cell, AreaVolume**); <b class="conum">(1)</b>
<span class="directive">void</span> area_volume_fin(AreaVolume*);

<span class="directive">void</span> area_volume_compute(AreaVolume*, <span class="predefined-type">int</span> nm, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> <span class="predefined-type">float</span> **av); <b class="conum">(2)</b>
<span class="directive">void</span> area_volume_host(AreaVolume*, <span class="comment">/**/</span> <span class="predefined-type">float</span> **av); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>initialization, <code>nv</code>, <code>nt</code>, <code>tt</code>: number of vertices, number of
triangles, a triangle structure <strong>on host</strong>, <code>max_nm</code> is a maximum
allowed number of meshes</p>
</li>
<li>
<p>compute area and volume for every mesh, <code>nm</code> is a number of meshes,
output <code>av</code> is a devices array in the form <code>area[0] volume[0] &#8230;&#8203; area[nc-1] volume[nc-1]</code></p>
</li>
<li>
<p>after <code>area_volume_compute</code> call, <code>area_volume_host</code> returns a
host version of <code>av</code> array</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_force_rnd_random_generator">28.3.5. force/rnd: random generator</h4>
<div class="paragraph">
<p>Device random number generator for random forces in rbc</p>
</div>
<div class="paragraph">
<p>allocate, deallocate structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_rnd_ini(<span class="predefined-type">int</span> n, <span class="predefined-type">long</span> seed, RbcRnd**);
<span class="directive">void</span> rbc_rnd_fin(RbcRnd*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The seed can be set from timeby passing the special value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">enum</span> {SEED_TIME = -<span class="integer">1</span>}; <span class="comment">/* magic seed: ini from &quot;time&quot; */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Random number generation is clled as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_rnd_gen(RbcRnd*, <span class="predefined-type">int</span> n, <span class="comment">/**/</span> <span class="predefined-type">float</span>**); <b class="conum">(1)</b>
<span class="predefined-type">float</span> rbc_rnd_get_hst(<span class="directive">const</span> RbcRnd*, <span class="predefined-type">int</span> i);    <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>generate <code>n</code> random numbers on device</p>
</li>
<li>
<p>get a single random number on host (debug purpose)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="rbc_params">28.3.6. params: rbc parameters</h4>
<div class="paragraph">
<p>Parameters for the membrane forces.
Consists of two structures: <code>RbcParams</code> (<em>hidden</em>, on host) and
<code>RbcParams_v</code> (<em>view</em>, to be passed to kernels).</p>
</div>
<div class="paragraph">
<p><code>RbcParams</code> are allocated and freed with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_params_ini(RbcParams **);
<span class="directive">void</span> rbc_params_fin(RbcParams *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameters can be set manually with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_params_set_fluct(<span class="predefined-type">float</span> gammaC, <span class="predefined-type">float</span> gammaT, <span class="predefined-type">float</span> kBT, RbcParams *);
<span class="directive">void</span> rbc_params_set_bending(<span class="predefined-type">float</span> kb, <span class="predefined-type">float</span> phi, RbcParams *);
<span class="directive">void</span> rbc_params_set_spring(<span class="predefined-type">float</span> ks, <span class="predefined-type">float</span> x0, <span class="predefined-type">float</span> mpow , RbcParams *);
<span class="directive">void</span> rbc_params_set_area_volume(<span class="predefined-type">float</span> ka, <span class="predefined-type">float</span> kd, <span class="predefined-type">float</span> kv, RbcParams *);
<span class="directive">void</span> rbc_params_set_tot_area_volume(<span class="predefined-type">float</span> totArea, <span class="predefined-type">float</span> totVolume, RbcParams *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>or via the configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_params_set_conf(<span class="directive">const</span> Config *c, RbcParams *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameters are accessible via getter functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">double</span> rbc_params_get_tot_volume(<span class="directive">const</span> RbcParams *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>view</em> structure can be created with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">RbcParams_v rbc_params_get_view(<span class="directive">const</span> RbcParams *);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_shape">28.3.7. shape</h4>
<div class="paragraph">
<p>Helper for stress free state.
Compute membrane quantities on host.</p>
</div>
<div class="paragraph">
<p>Allocate, deallocate structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_shape_ini(<span class="directive">const</span> Adj*, <span class="directive">const</span> <span class="predefined-type">float</span> *rr, <span class="comment">/**/</span> RbcShape**);
<span class="directive">void</span> rbc_shape_fin(<span class="comment">/**/</span> RbcShape*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the positions <code>rr</code> are stored in a AoS fashion <code>x0 y0 z0 x1 y1
z1 &#8230;&#8203;</code>. Also needs <a href="#rbc_adj">adjacency structure</a> as input.</p>
</div>
<div class="paragraph">
<p>Compute quantities (on host):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_shape_edg (RbcShape*, <span class="comment">/**/</span> <span class="predefined-type">float</span>**); <b class="conum">(1)</b>
<span class="directive">void</span> rbc_shape_area(RbcShape*, <span class="comment">/**/</span> <span class="predefined-type">float</span>**); <b class="conum">(2)</b>

<span class="directive">void</span> rbc_shape_total_area(RbcShape*, <span class="comment">/**/</span> <span class="predefined-type">float</span>*);    <b class="conum">(3)</b>
<span class="directive">void</span> rbc_shape_total_volume(RbcShape*, <span class="comment">/**/</span> <span class="predefined-type">float</span>*);  <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>compute edge lengths (order: see <code>Adj</code> module</p>
</li>
<li>
<p>compute area of triangles</p>
</li>
<li>
<p>compute total area</p>
</li>
<li>
<p>compute total volume</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_stretch_rbc">28.3.8. stretch RBC</h4>
<div class="paragraph">
<p>Apply a constant force to every vertex of every cell. The force is
configured from the file <code>path</code>.</p>
</div>
<div class="paragraph">
<p>Format of the data file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>fx0 fy0 fz0
fx1 fy1 fz1
...
fx_nv fy_nv fz_nv</pre>
</div>
</div>
<div class="paragraph">
<p><code>nv</code> is the number of vertices.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rbc_stretch_ini(<span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="predefined-type">int</span> nv, <span class="comment">/**/</span> RbcStretch**); <span class="comment">/* `nv` is for error check */</span>
<span class="directive">void</span> rbc_stretch_fin(RbcStretch*);
<span class="directive">void</span> rbc_stretch_apply(<span class="predefined-type">int</span> nm, <span class="directive">const</span> RbcStretch*, <span class="comment">/**/</span> Force*);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rig_rigid_objects">29. rig: rigid objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rigid objects consist of frozen particles moving in a rigid fashion.
Interactions with other objects are modeled via pairwise interactions
with the frozen particles.</p>
</div>
<div class="paragraph">
<p>Rigid objects also contain a surface representation on which other
particles may bounce back.</p>
</div>
<div class="paragraph">
<p>Rigid objects are numbered and need a unique id for dumping diagnosis.</p>
</div>
<div class="sect2">
<h3 id="_quantities_3">29.1. Quantities</h3>
<div class="sect3">
<h4 id="_data_structure_5">29.1.1. data structure</h4>
<div class="paragraph">
<p><code>RigidQuants</code> structure contains particles of rigid objects as well as
mesh particles.
<code>Solid</code> structures contain center of mass, orientation, angular and
linear velocity of the rigid object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="keyword">struct</span> RigQuants {
    <span class="predefined-type">int</span> n, ns, nps;              <span class="comment">/* number of particles (total), solid, particle per solid        */</span>
    Particle *pp_hst, *pp;       <span class="comment">/* particles on hst and device                                   */</span>
    Solid    *ss_hst, *ss;       <span class="comment">/* rigid strutures                                               */</span>
    <span class="predefined-type">float</span>   *rr0_hst, *rr0;      <span class="comment">/* frozen particle templates                                     */</span>

    <span class="comment">/* mesh related quantities */</span>
    <span class="predefined-type">int</span> nt, nv;                   <span class="comment">/* number of [t]riangles and [v]ertices                          */</span>
    int4 *dtt;                    <span class="comment">/* triangle indices on device                                    */</span>
    <span class="predefined-type">float</span> *dvv;                   <span class="comment">/* vertices on device (template)                                 */</span>
    Particle *i_pp_hst, *i_pp;    <span class="comment">/* particles representing all meshes of all solids of that node  */</span>

    Solid *ss_dmp, *ss_dmp_bb;

    <span class="predefined-type">long</span> maxp; <span class="comment">/* maximum particle number */</span>
};</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_28">29.1.2. Interface</h4>
<div class="paragraph">
<p>allocate and deallocate the quantities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> rig_ini(<span class="predefined-type">long</span> maxs, <span class="predefined-type">long</span> maxp, <span class="directive">const</span> MeshRead*, RigQuants*);
<span class="directive">void</span> rig_fin(RigQuants *q);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>maxp</code> is the maximum particle number per node.</p>
</div>
<div class="paragraph">
<p>Rigid bodies generation is performed in two stages: create the mesh,
then create the rigid particle template, properties and global ids.
This allows to remove rigid bodies colliding with other entities
before the second phase.
The interface for generation is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> rig_gen_mesh(<span class="directive">const</span> Coords*, MPI_Comm, <span class="directive">const</span> MeshRead*, <span class="directive">const</span> <span class="predefined-type">char</span> *ic, <span class="comment">/**/</span> RigQuants *); <b class="conum">(1)</b>
<span class="directive">void</span> rig_gen_freeze(<span class="directive">const</span> Coords*, <span class="predefined-type">bool</span> empty_pp, <span class="predefined-type">int</span> numdensity, <span class="predefined-type">float</span> rig_mass, <span class="directive">const</span> RigPinInfo*,
                    MPI_Comm, <span class="directive">const</span> MeshRead*, Particle *opp, <span class="predefined-type">int</span> *on, RigQuants *q);          <b class="conum">(2)</b>
<span class="directive">void</span> rig_strt_quants(MPI_Comm, <span class="directive">const</span> MeshRead*, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">int</span> id, RigQuants *q); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>generate the meshes from file <code>ic</code> (see <a href="#mesh_gen">[mesh_gen]</a>)</p>
</li>
<li>
<p>generate particle template, global ids and properties of rigid
objects given mesh. This operation will kill solvent particles inside
the rigid objects</p>
</li>
<li>
<p>generate quantities from <a href="#io_restart">restart</a> files</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Restart files are dumped using the following functions (see <a href="#io_restart">restart</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> rig_strt_dump_templ(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> RigQuants *q);         <b class="conum">(1)</b>
<span class="directive">void</span> rig_strt_dump(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> <span class="predefined-type">int</span> id, <span class="directive">const</span> RigQuants *q); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>to be called only once: dump the frozen particle in local referential (common to every rigid objects)</p>
</li>
<li>
<p>dump <code>Solid</code> structures, describing position, orientation and velocity of the rigid objects</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update">29.2. update</h3>
<div class="paragraph">
<p>Position and velocities of rigid objects are updated from forces
exerted on the particles.</p>
</div>
<div class="sect3">
<h4 id="_pin_info">29.2.1. pin info</h4>
<div class="paragraph">
<p>The hidden structure <code>RigPinInfo</code> is used to store information about
constrained rigid motion.
This can be used to disable the movement of the center of mass of the rigid object along
\(x, y\) or \(z\) axis (see <code>com</code> parameter).
User can also block the rotation along one of the axes  (see <code>axis</code>
parameter).</p>
</div>
<div class="paragraph">
<p>example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>rigid object can rotate but is only able to  move along the \(x\) axis:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>com = {0, 1, 1}
axis = {0, 0, 0}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>rigid object can only rotate along the \(z\) axis and its center
of mass is not able to move:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>com = {1, 1, 1}
axis = {1, 1, 0}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> rig_pininfo_ini(RigPinInfo **); <b class="conum">(1)</b>
<span class="directive">void</span> rig_pininfo_fin(RigPinInfo *); <b class="conum">(2)</b>
<span class="directive">void</span> rig_pininfo_set(int3 com, int3 axis, RigPinInfo *); <b class="conum">(3)</b>
<span class="directive">void</span> rig_pininfo_set_pdir(<span class="predefined-type">int</span> pdir, RigPinInfo *); <b class="conum">(4)</b>
<span class="directive">void</span> rig_pininfo_set_conf(<span class="directive">const</span> Config *cfg, RigPinInfo *); <b class="conum">(5)</b>

<span class="predefined-type">int</span> rig_pininfo_get_pdir(<span class="directive">const</span> RigPinInfo *); <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate the hidden structure</p>
</li>
<li>
<p>deallocate the hidden structure</p>
</li>
<li>
<p>set the motion constrains</p>
</li>
<li>
<p>for periodic objects, set the direction of periodicity
(e.g. cylinder)</p>
</li>
<li>
<p>set the above parameters from configuration file</p>
</li>
<li>
<p>get the perioid direction</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The periodic direction can be 0, 1 or 2 for the \(x, y\) or
\(z\) axis, respectively.
Default value for no periodicty is set via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="keyword">enum</span> {NOT_PERIODIC = -<span class="integer">1</span>};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration has the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">rig = {
    pin_com = [0, 0, 0]
    pin_axis = [0, 0, 0]
    pdir = -1
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_29">29.2.2. interface</h4>
<div class="paragraph">
<p>naming:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ns</code>: number of rigid objects</p>
</li>
<li>
<p><code>ss</code>: array of rigid structures <code>Solid</code></p>
</li>
<li>
<p><code>rr0</code>: positions of the rigid particles in the rigid object
reference frame</p>
</li>
<li>
<p><code>nps</code>: number of rigid particle per rigid object</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> rig_reinit_ft(<span class="directive">const</span> <span class="predefined-type">int</span> ns, <span class="comment">/**/</span> Solid *ss); <b class="conum">(1)</b>
<span class="directive">void</span> rig_update(<span class="directive">const</span> RigPinInfo *pi, <span class="predefined-type">float</span> dt, <span class="predefined-type">int</span> n, <span class="directive">const</span> Force *ff, <span class="directive">const</span> <span class="predefined-type">float</span> *rr0, <span class="predefined-type">int</span> ns, <span class="comment">/**/</span> Particle *pp, Solid *ss); <b class="conum">(2)</b>
<span class="directive">void</span> rig_generate(<span class="predefined-type">int</span> ns, <span class="directive">const</span> Solid *ss, <span class="predefined-type">int</span> nps, <span class="directive">const</span> <span class="predefined-type">float</span> *rr0, <span class="comment">/**/</span> Particle *pp); <b class="conum">(3)</b>
<span class="directive">void</span> rig_update_mesh(<span class="predefined-type">float</span> dt, <span class="predefined-type">int</span> ns, <span class="directive">const</span> Solid *ss, <span class="predefined-type">int</span> nv, <span class="directive">const</span> <span class="predefined-type">float</span> *vv, <span class="comment">/**/</span> Particle *pp); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set the force and torque to 0</p>
</li>
<li>
<p>update particle and rigid objects positions and velocity</p>
</li>
<li>
<p>generate rigid particles from template positions and rigid
structures</p>
</li>
<li>
<p>update the mesh position</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_submodules_4">29.3. Submodules</h3>
<div class="sect3">
<h4 id="_gen">29.3.1. gen</h4>
<div class="paragraph">
<p>helper to generate rigid particles from solvents and compute rigid
properties</p>
</div>
<div class="paragraph">
<p>The solvent particles inside the given rigid objects are removed by
this operation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> rig_gen_from_solvent(<span class="directive">const</span> Coords*, MPI_Comm, RigGenInfo, <span class="comment">/*io*/</span> FluInfo, <span class="comment">/**/</span> RigInfo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid long argument list, the data is packed in helper structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> RigGenInfo {
    <span class="predefined-type">float</span> mass;
    <span class="predefined-type">int</span> numdensity;
    <span class="directive">const</span> RigPinInfo *pi;
    <span class="predefined-type">int</span> nt, nv;
    <span class="directive">const</span> int4 *tt;     <span class="comment">/* on device */</span>
    <span class="directive">const</span> Particle *pp; <span class="comment">/* on device */</span>
    <span class="predefined-type">bool</span> empty_pp;
    <span class="directive">const</span> MeshRead *mesh;
};

<span class="keyword">struct</span> FluInfo {
    Particle *pp;
    <span class="predefined-type">int</span> *n;
};

<span class="comment">/* everything on host */</span>
<span class="keyword">struct</span> RigInfo {
    <span class="predefined-type">int</span> ns, *nps;
    <span class="predefined-type">float</span> *rr0;
    Solid *ss;
    Particle *pp;
};</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scheme">30. scheme</h2>
<div class="sectionbody">
<div class="paragraph">
<p>time stepping scheme related modules</p>
</div>
<div class="sect2">
<h3 id="_body_forces">30.1. body forces</h3>
<div class="paragraph">
<p>Force applied to every particles with active flag <code>push</code>.
It is defined by two structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BForce</code>, contains all informations needed for the  force
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>BForce_v</code> (<em>BForce view</em>), containing only the information needed at
a specific time. It is passed to device kernels.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_interface_30">30.1.1. interface</h4>
<div class="paragraph">
<p>allocate/deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> bforce_ini(BForce **p);
<span class="directive">void</span> bforce_fin(BForce *p);</code></pre>
</div>
</div>
<div class="paragraph">
<p>initialize to a given force function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> bforce_set_none(<span class="comment">/**/</span> BForce *p);            <b class="conum">(1)</b>
<span class="directive">void</span> bforce_set_cste(float3 f, <span class="comment">/**/</span> BForce *p);  <b class="conum">(2)</b>
<span class="directive">void</span> bforce_set_dp(<span class="predefined-type">float</span> a, <span class="comment">/**/</span> BForce *p);     <b class="conum">(3)</b>
<span class="directive">void</span> bforce_set_shear(<span class="predefined-type">float</span> a, <span class="comment">/**/</span> BForce *p);  <b class="conum">(4)</b>
<span class="directive">void</span> bforce_set_rol(<span class="predefined-type">float</span> a, <span class="comment">/**/</span> BForce *p);    <b class="conum">(5)</b>
<span class="directive">void</span> bforce_set_rad(<span class="predefined-type">float</span> a, <span class="comment">/**/</span> BForce *p);    <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>no force</p>
</li>
<li>
<p>constant force <code>f</code></p>
</li>
<li>
<p>double poiseuille</p>
</li>
<li>
<p>shear</p>
</li>
<li>
<p>4 roller mill</p>
</li>
<li>
<p>radial force</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>initialize from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> bforce_set_conf(<span class="directive">const</span> Config *cfg, <span class="comment">/**/</span> BForce *bf);</code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> bforce_adjust(float3 f, <span class="comment">/**/</span> BForce *fpar); <b class="conum">(1)</b>
<span class="directive">void</span> bforce_apply(<span class="directive">const</span> Coords *c, <span class="predefined-type">float</span> mass, <span class="directive">const</span> BForce *bf, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle *pp, <span class="comment">/**/</span> Force *ff); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>change value of the force</p>
</li>
<li>
<p>apply body force to particles</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_8">30.1.2. configuration</h4>
<div class="sect4">
<h5 id="_none_2">none</h5>
<div class="paragraph">
<p>no body force (default value)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce = {
    type = &quot;none&quot;
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_constant">constant</h5>
<div class="paragraph">
<p>constant force</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce = {
    type = &quot;constant&quot;
    f    = [1.0, 0.0, 0.0]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_double_poiseuille">double poiseuille</h5>
<div class="paragraph">
<p><code>fx = y &gt; yc ? a : -a</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce = {
    type = &quot;double_poiseuille&quot;
    a    = 1.0
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_shear">shear</h5>
<div class="paragraph">
<p><code>fx = a * (y - yc)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce = {
    type = &quot;shear&quot;
    a    = 1.0
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_4_roller_mill">4 roller mill</h5>
<div class="listingblock">
<div class="content">
<pre>    f.x =  2*sin(x)*cos(y) * a;
    f.y = -2*cos(x)*sin(y) * a;</pre>
</div>
</div>
<div class="paragraph">
<p>while <code>x</code> and <code>y</code> are coordinates relative to the domain center and
normalized to have <code>x = Pi</code> and <code>x = -Pi</code> at the domain edges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce = {
    type = &quot;four_roller&quot;
    a    = 1.0
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_radial">radial</h5>
<div class="paragraph">
<p><code>fr = a * er / r</code>, where <code>fr</code> is radial force, <code>er</code> is unit radial
vector at position <code>r</code> and <code>r</code> is radial position.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">bforce = {
    type = &quot;rad&quot;
    a    = 1.0
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_move">30.2. move</h3>
<div class="paragraph">
<p>update particles positions and velocities given forces.
Currently implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Forward Euler</p>
</li>
<li>
<p>Velocity-Verlet</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> scheme_move_apply(<span class="predefined-type">float</span> dt, <span class="predefined-type">float</span> mass, <span class="predefined-type">int</span> n, <span class="directive">const</span> Force*, Particle*); <b class="conum">(1)</b>
<span class="directive">void</span> scheme_move_clear_vel(<span class="predefined-type">int</span> n, Particle*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>apply one step of the time scheme to the particles</p>
</li>
<li>
<p>set velocity of particles to 0</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_restrain">30.3. restrain</h3>
<div class="paragraph">
<p>Restrain the movement of drop or rbc membrane by shifting center of
mass velocity.</p>
</div>
<div class="paragraph">
<p>Consider a subset of particles \(P\) with indices \(I \subset \{i\}_{i = 1}^{n}\).
The <code>Restrain</code> module  shifts the center of mass velocity of \(P\) such that</p>
</div>
<div class="stemblock">
<div class="content">
\[\sum\limits_{i \in I} \mathbf{v}_i = 0.\]
</div>
</div>
<div class="paragraph">
<p>The subset \(I\) depends on the colors of the solvent in case of a
single drop.</p>
</div>
<div class="sect3">
<h4 id="_interface_31">30.3.1. interface</h4>
<div class="paragraph">
<p>allocate and free host structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> scheme_restrain_ini(Restrain**);
<span class="directive">void</span> scheme_restrain_fin(Restrain*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> scheme_restrain_set_red(Restrain*); <b class="conum">(1)</b>
<span class="directive">void</span> scheme_restrain_set_rbc(Restrain*); <b class="conum">(2)</b>
<span class="directive">void</span> scheme_restrain_set_none(Restrain*); <b class="conum">(3)</b>
<span class="directive">void</span> scheme_restrain_set_freq(<span class="predefined-type">int</span> freq, Restrain*); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Set to restrain the "red" solvent only</p>
</li>
<li>
<p>Set to restrain the rbc membrane only</p>
</li>
<li>
<p>Set for no restrain</p>
</li>
<li>
<p>Set the diagnosis frequency (0 for no diagnosis)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Set parameters from configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> scheme_restrain_set_conf(<span class="directive">const</span> Config*, Restrain*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply restrain (note: this calls collective mpi operation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> scheme_restrain_apply(MPI_Comm comm, <span class="directive">const</span> <span class="predefined-type">int</span> *cc, <span class="predefined-type">long</span> it, <span class="comment">/**/</span> Restrain *r, SchemeQQ qq);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_9">30.3.2. configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">restrain = {
    kind = [&quot;none&quot;, &quot;red&quot;, &quot;rbc&quot;]
    freq = 1000;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_time_line">30.4. Time line</h3>
<div class="paragraph">
<p>Manage simulation time.</p>
</div>
<div class="paragraph">
<p>Allocate, deallocate structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> time_line_ini(<span class="predefined-type">float</span> start, <span class="comment">/**/</span> TimeLine**);
<span class="directive">void</span> time_line_fin(TimeLine*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Manipulate time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> time_line_advance(<span class="predefined-type">float</span> dt, TimeLine*);           <b class="conum">(1)</b>
<span class="predefined-type">int</span>  time_line_cross(<span class="directive">const</span> TimeLine*, <span class="predefined-type">float</span> interval); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>advance time by <code>dt</code> (should be called at every time step)</p>
</li>
<li>
<p>return <code>true</code> if there exist integer <code>n</code> such that <code>n*interval</code>
is in between current and previous times, in other words has the
simulation just crossed <code>n*interval</code> for some <code>n</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Getters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">float</span> time_line_get_current (<span class="directive">const</span> TimeLine*);  <b class="conum">(1)</b>
<span class="predefined-type">long</span>  time_line_get_iteration(<span class="directive">const</span> TimeLine*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get current time</p>
</li>
<li>
<p>get iteration id</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="scheme_time_step">30.5. Time step</h3>
<div class="paragraph">
<p>Time step manager.</p>
</div>
<div class="paragraph">
<p>Two possible modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>const</code>: constant timestep</p>
</li>
<li>
<p><code>disp</code>: adaptive time step based on the maximum acceleration of
given particles</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_interface_32">30.5.1. interface</h4>
<div class="paragraph">
<p>allocate, deallocate the object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> time_step_ini(<span class="directive">const</span> Config*, <span class="comment">/**/</span> TimeStep**); <b class="conum">(1)</b>
<span class="directive">void</span> time_step_fin(TimeStep*);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The mode is initialised from <a href="#conf">configuration file</a>. See
<a href="#scheme_time_step_conf">Configuration</a> for syntax.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">float</span> time_step_dt(TimeStep*, MPI_Comm, TimeStepAccel*); <b class="conum">(1)</b>
<span class="predefined-type">float</span> time_step_dt0(TimeStep*);                          <b class="conum">(2)</b>
<span class="directive">void</span> time_step_log(TimeStep*);                           <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Compute and return current timestep depending on the mode.
See <a href="#scheme_time_step_acc">acceleration manager</a> for <code>ImeStepAccel</code> argument.</p>
</li>
<li>
<p>return previous timestep</p>
</li>
<li>
<p>print time step informations to screen</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="scheme_time_step_acc">30.5.2. acceleration manager</h4>
<div class="paragraph">
<p>Helper structure to pack multiple arrays of acceleration</p>
</div>
<div class="paragraph">
<p>allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> time_step_accel_ini(<span class="comment">/**/</span> TimeStepAccel**);
<span class="directive">void</span> time_step_accel_fin(TimeStepAccel*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> time_step_accel_push(TimeStepAccel*, <span class="predefined-type">float</span> m, <span class="predefined-type">int</span> n, Force*); <b class="conum">(1)</b>
<span class="directive">void</span> time_step_accel_reset(TimeStepAccel*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add an array of forces. <code>m</code> is the mass of the particles.</p>
</li>
<li>
<p>remove all pushed arrays</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="scheme_time_step_conf">30.5.3. Configuration</h4>
<div class="paragraph">
<p>constant timestep <code>dt = 1e-3</code> (no log):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">time = {
     type = &quot;const&quot;
     dt = 1e-3
     screenlog = false
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>adaptive timestep with maximum <code>dt = 1e-2</code> and maximum displacement
<code>dx = 0.1</code> (active log):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">time = {
     type = &quot;disp&quot;
     dt = 1e-2
     dx = 0.1
     screenlog = true
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sim_simulation">31. sim: simulation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>manages all modules together to run a simulation</p>
</div>
<div class="sect2">
<h3 id="_interface_33">31.1. interface</h3>
<div class="paragraph">
<p>Allocate and deallocate the structure</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> sim_ini(<span class="directive">const</span> Config*, MPI_Comm, <span class="comment">/**/</span> Sim**);
<span class="directive">void</span> sim_fin(Sim*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run simulation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> sim_gen(Sim*);  <b class="conum">(1)</b>
<span class="directive">void</span> sim_strt(Sim*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>run from scratch: this will generate all quantities in two stages
(solvent only, equilibrating; freezing stage, adding walls and solutes)</p>
</li>
<li>
<p>run from restart files</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_submodules_5">31.2. submodules</h3>
<div class="sect3">
<h4 id="_objects">31.2.1. objects</h4>
<div class="paragraph">
<p>Manages all solutes objects.
This includes rigid objects and membranes.</p>
</div>
<div class="sect4">
<h5 id="_interface_34">Interface</h5>
<div class="paragraph">
<p>Allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_ini(<span class="directive">const</span> Config*, <span class="directive">const</span> Opt*, MPI_Comm, <span class="directive">const</span> Coords*, <span class="predefined-type">int</span> maxp, Objects**);
<span class="directive">void</span> objects_fin(Objects*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generate the quantities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_gen_mesh(Objects*);                           <b class="conum">(1)</b>
<span class="directive">void</span> objects_remove_from_wall(<span class="directive">const</span> Sdf *sdf, Objects *o); <b class="conum">(2)</b>
<span class="directive">void</span> objects_gen_freeze(PFarray*, Objects*);               <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Generate the meshes of all objects from the template mesh and an
initial condition files (see <a href="#mesh_gen">[mesh_gen]</a>)</p>
</li>
<li>
<p>Remove all meshes colliding with walls</p>
</li>
<li>
<p>Build all remaining quantities after removal from walls. The rigid
objects need solvent particles</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The quantities can be instead generated from restart files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_restart(Objects*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The state of the objects can be dumped using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_mesh_dump(Objects*);                    <b class="conum">(1)</b>
<span class="directive">void</span> objects_diag_dump(<span class="predefined-type">float</span> t, Objects*);           <b class="conum">(2)</b>
<span class="directive">void</span> objects_part_dump(<span class="predefined-type">long</span> id, Objects*, IoBop*);

<span class="directive">void</span> objects_strt_templ(<span class="directive">const</span> <span class="predefined-type">char</span> *base, Objects*);         <b class="conum">(3)</b>
<span class="directive">void</span> objects_strt_dump(<span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="predefined-type">long</span> id, Objects*); <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Dump all meshes of objects</p>
</li>
<li>
<p>Dump diagnosis. This include the solid objects dumps and the
membrane centers of mass.</p>
</li>
<li>
<p>Dump rigid templates to restart files</p>
</li>
<li>
<p>Dump current state to restart files</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The objects are updated using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_clear_vel(Objects*);        <b class="conum">(1)</b>
<span class="directive">void</span> objects_update(<span class="predefined-type">float</span> dt, Objects*); <b class="conum">(2)</b>
<span class="directive">void</span> objects_distribute(Objects*);       <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set all velocities to 0</p>
</li>
<li>
<p>advance objects for one timestep</p>
</li>
<li>
<p>redistribute objects accross nodes</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The objects forces can be managed by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_clear_forces(Objects*);                 <b class="conum">(1)</b>
<span class="directive">void</span> objects_internal_forces(<span class="predefined-type">float</span> dt, Objects *o);  <b class="conum">(2)</b>
<span class="directive">void</span> objects_body_forces(<span class="directive">const</span> BForce*, Objects *o); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set all forces to 0</p>
</li>
<li>
<p>compute internal forces (membranes only)</p>
</li>
<li>
<p>apply body forces to the objects</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Other forces can be set via the getter functions (see link with
<a href="#sim_objinter">objinter : object interactions</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_get_particles_all(Objects*, PFarrays*);    <b class="conum">(1)</b>
<span class="directive">void</span> objects_get_particles_mbr(Objects*, PFarrays*);    <b class="conum">(2)</b>
<span class="directive">void</span> objects_get_accel(<span class="directive">const</span> Objects*, TimeStepAccel*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get particle infos of all objects</p>
</li>
<li>
<p>get particle infos of membranes</p>
</li>
<li>
<p>retrieve acceleration infos (see <a href="#scheme_time_step">Time step</a>)</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> objects_bounce(<span class="predefined-type">float</span> dt, <span class="predefined-type">float</span> flu_mass, <span class="directive">const</span> Clist flu_cells, PFarray *flu, Objects*); <b class="conum">(1)</b>
<span class="directive">void</span> objects_recolor_flu(Objects*, PFarray *flu); <b class="conum">(2)</b>
<span class="predefined-type">double</span> objects_mbr_tot_volume(<span class="directive">const</span> Objects*);    <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>bounce solvent particles against objects</p>
</li>
<li>
<p>recolor solvent particles located inside membranes</p>
</li>
<li>
<p>compute the total volume occupied by all membranes</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sim_objinter">31.2.2. objinter : object interactions</h4>
<div class="paragraph">
<p>Helper to manage interactions between objects (<a href="#cnt">contact
forces</a>) and interactions with solvent particles (<a href="#fsi">fsi
forces</a>).</p>
</div>
<div class="paragraph">
<p>Allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> obj_inter_ini(<span class="directive">const</span> Config*, <span class="directive">const</span> Opt*, MPI_Comm, <span class="predefined-type">float</span> dt, <span class="predefined-type">int</span> maxp, <span class="comment">/**/</span> ObjInter**);
<span class="directive">void</span> obj_inter_fin(ObjInter*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compute interactions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> obj_inter_forces(ObjInter*, PFarray *flu, <span class="predefined-type">int</span> *flu_start, PFarrays *obj);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sim_walls">31.2.3. walls</h4>
<div class="paragraph">
<p>Helper to manage solid walls.</p>
</div>
<div class="paragraph">
<p>Allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_ini(<span class="directive">const</span> Config*, int3 L, Wall**);
<span class="directive">void</span> wall_fin(Wall*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generate from solvent particles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_gen(MPI_Comm, <span class="directive">const</span> Coords*, OptParams, <span class="predefined-type">bool</span> dump_sdf,
              <span class="comment">/*io*/</span> <span class="predefined-type">int</span> *n, Particle *pp, <span class="comment">/**/</span> Wall*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, can be generated from restart files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_restart(MPI_Comm, <span class="directive">const</span> Coords*, OptParams, <span class="predefined-type">bool</span> dump_sdf,
                  <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="comment">/**/</span> Wall*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The restart file is dumped by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_dump_templ(<span class="directive">const</span> Wall*, MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Interactions with other quantities are possible with the functions</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_interact(<span class="directive">const</span> Coords*, <span class="directive">const</span> PairParams*, Wall*, PFarrays*);
<span class="directive">void</span> wall_bounce(<span class="directive">const</span> Wall*, <span class="directive">const</span> Coords*, <span class="predefined-type">float</span> dt, PFarrays*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The wall velocity can be updated in time with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_update_vel(<span class="predefined-type">float</span> t, Wall *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Getter functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_get_sdf_ptr(<span class="directive">const</span> Wall*, <span class="directive">const</span> Sdf**);           <b class="conum">(1)</b>
<span class="predefined-type">double</span> wall_compute_volume(<span class="directive">const</span> Wall*, MPI_Comm, int3 L); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get a pointer to <a href="#sdf">sdf: signed distance function</a> object</p>
</li>
<li>
<p>compute the volume inside the walls (where the solvent can be
located). This is evaluated via Monte Carlo</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sdf">32. sdf: signed distance function</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Signed Distance Function (SDF) \(S(x, y, z)\) is used to give the distance from a
given position to the wall.
The sign of the SDF field tells if the position is inside or outside
the wall.</p>
</div>
<div class="paragraph">
<p>Conventions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(S(x,y,z) &lt; -1\) : inside domain, far from wall</p>
</li>
<li>
<p>\(S(x,y,z) &lt; 0\) : inside domain</p>
</li>
<li>
<p>\(S(x,y,z) = 0\) : wall interface</p>
</li>
<li>
<p>\(S(x,y,z) &gt; 0\) : inside wall</p>
</li>
<li>
<p>\(S(x,y,z) &gt; 1\) : inside wall, far from surface</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example of sdf function in 2D:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/udoc/include/sdf.png" alt="sdf">
</div>
</div>
<div class="paragraph">
<p>The above example denotes a circular wall of radius 2.
The isosurface \(S(x,y,z) = 0\) is located at the wall interface.</p>
</div>
<div class="sect2">
<h3 id="_interface_35">32.1. interface</h3>
<div class="paragraph">
<p>allocate, deallocate the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> sdf_ini(int3 L, Sdf**);
<span class="directive">void</span> sdf_fin(Sdf*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> sdf_gen(<span class="directive">const</span> Coords*, MPI_Comm cart, <span class="predefined-type">bool</span> dump, Sdf*); <b class="conum">(1)</b>
<span class="directive">void</span> sdf_get_view(<span class="directive">const</span> Sdf*, <span class="comment">/**/</span> Sdf_v*);                  <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>generate the sdf field from file "sdf.dat"</p>
</li>
<li>
<p>get view to be passed to kernels</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">_I_ float3 sdf_ugrad(<span class="directive">const</span> Sdf_v *texsdf, <span class="directive">const</span> float3 *r) <b class="conum">(1)</b>
_I_ <span class="predefined-type">bool</span> sdf_far(<span class="directive">const</span> Sdf_v *sdf, <span class="predefined-type">float</span> x, <span class="predefined-type">float</span> y, <span class="predefined-type">float</span> z) <b class="conum">(2)</b>
_I_ <span class="predefined-type">float</span> sdf_eval(<span class="directive">const</span> Sdf_v *sdf0, <span class="predefined-type">float</span> x, <span class="predefined-type">float</span> y, <span class="predefined-type">float</span> z)  <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>returns gradient of sdf (normalised) at given position (finite difference)</p>
</li>
<li>
<p>returns true if position is far inside the domain (approximation)</p>
</li>
<li>
<p>returns the sdf value at given position (linear interpolation)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Bounce back from wall:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> sdf_bounce(<span class="predefined-type">float</span> dt, <span class="directive">const</span> WvelStep*, <span class="directive">const</span> Coords*, <span class="directive">const</span> Sdf*, <span class="predefined-type">int</span> n, <span class="comment">/**/</span> Particle*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sorting tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> sdf_bulk_wall(<span class="directive">const</span> Sdf*, <span class="comment">/*io*/</span> <span class="predefined-type">int</span> *s_n, Particle *s_pp, <span class="comment">/*o*/</span> <span class="predefined-type">int</span> *w_n, Particle *w_pp); <b class="conum">(1)</b>
<span class="predefined-type">int</span>  sdf_who_stays(<span class="directive">const</span> Sdf*, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*, <span class="predefined-type">int</span> nc, <span class="predefined-type">int</span> nv, <span class="comment">/**/</span> <span class="predefined-type">int</span> *stay);          <b class="conum">(2)</b>
<span class="predefined-type">double</span> sdf_compute_volume(MPI_Comm, int3 L, <span class="directive">const</span> Sdf*, <span class="predefined-type">long</span> nsamples);                          <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>extract wall particles from solvent particles. Solvent particles
which are not inside the domain are not kept.</p>
</li>
<li>
<p>label <code>nc</code> objects of <code>nv</code> particles to inside domain or not.</p>
</li>
<li>
<p>compute the volume between walls using monte carlo
integration. <code>nsamples</code> is the number of samples per subdomain.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_submodules_6">32.2. submodules</h3>
<div class="paragraph">
<p>Some tasks of the SDF object are splitted into submodules:</p>
</div>
<div class="sect3">
<h4 id="_array3d">32.2.1. array3D</h4>
<div class="paragraph">
<p>a simple data holder for storing a 3D cuda array scalar field.</p>
</div>
<div class="sect4">
<h5 id="_data_structure_6">data structure</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> Array3d {
    cudaArray_t a;  <b class="conum">(1)</b>
    size_t x, y, z; <b class="conum">(2)</b>
};</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>data on device</p>
</li>
<li>
<p>grid size</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_interface_36">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> Array3d;
<span class="directive">void</span> array3d_ini(Array3d**, size_t x, size_t y, size_t z);                <b class="conum">(1)</b>
<span class="directive">void</span> array3d_fin(Array3d*);                                               <b class="conum">(2)</b>
<span class="directive">void</span> array3d_copy(size_t x, size_t y, size_t z, <span class="predefined-type">float</span> *D, <span class="comment">/**/</span> Array3d*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate the structure</p>
</li>
<li>
<p>deallocate the structure</p>
</li>
<li>
<p>copy data from host to cuda array on device</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bounce">32.2.2. bounce</h4>
<div class="paragraph">
<p>Particles crossing the wall surface are bounced back into the domain.
We define:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>\(\mathbf{r}_0, \mathbf{v}_0\) position and velocity before the particle has
crossed the surface</p>
</li>
<li>
<p>\(\mathbf{r}_1, \mathbf{v}_1\) position and velocity after the particle has
crossed the surface, not bounced back</p>
</li>
<li>
<p>\(\mathbf{r}_n, \mathbf{v}_n\) position and velocity after bounce-back</p>
</li>
<li>
<p>\(\mathbf{r}_w, \mathbf{v}_w\) position and velocity of the wall
at collision point</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The collision point is found by solving for the collision time \(h\)</p>
</div>
<div class="stemblock">
<div class="content">
\[S(\mathbf{r}_0 + h \mathbf{v}_0) = 0\]
</div>
</div>
<div class="paragraph">
<p>with Newton iterations.
We obtain \(\mathbf{r}_w = \mathbf{r}_0 + h \mathbf{v}_0\).</p>
</div>
<div class="paragraph">
<p>The bounced particle is set to</p>
</div>
<div class="stemblock">
<div class="content">
\[\mathbf{r}_n = \mathbf{r}_w + (dt - h) \mathbf{v}_n \\
\mathbf{v}_n = 2 \mathbf{v}_w - \mathbf{v}_0\]
</div>
</div>
<div class="sect4">
<h5 id="_interface_37">interface</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> bounce_back(<span class="predefined-type">float</span> dt, <span class="directive">const</span> WvelStep *wv, <span class="directive">const</span> Coords *c, <span class="directive">const</span> Sdf *sdf, <span class="predefined-type">int</span> n, <span class="comment">/**/</span> Particle *pp);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_field">32.2.3. field</h4>
<div class="paragraph">
<p>read and manage a scalar field on host</p>
</div>
<div class="sect4">
<h5 id="_interface_38">interface</h5>
<div class="paragraph">
<p>allocate, deallocate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> field_ini(<span class="directive">const</span> <span class="predefined-type">char</span> *path, <span class="comment">/**/</span> Field**); <b class="conum">(1)</b>
<span class="directive">void</span> field_fin(Field*);                         <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>allocate and read field from file "path"</p>
</li>
<li>
<p>deallocate the field structure</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>getter functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> field_size(<span class="directive">const</span> Field*, <span class="comment">/**/</span> <span class="predefined-type">int</span> N[<span class="integer">3</span>]);       <b class="conum">(1)</b>
<span class="directive">void</span> field_extend(<span class="directive">const</span> Field*, <span class="comment">/**/</span> <span class="predefined-type">float</span> ext[<span class="integer">3</span>]); <b class="conum">(2)</b>
<span class="directive">void</span> field_data(<span class="directive">const</span> Field*, <span class="comment">/**/</span> <span class="predefined-type">float</span>**);        <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>get grid size</p>
</li>
<li>
<p>get extents of the grid</p>
</li>
<li>
<p>get pointer to data</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> field_sample(<span class="directive">const</span> Field*, <span class="directive">const</span> Tform*, <span class="directive">const</span> <span class="predefined-type">int</span> N[<span class="integer">3</span>], <span class="comment">/**/</span> Field**); <b class="conum">(1)</b>
<span class="directive">void</span> field_dump(<span class="directive">const</span> Field*, <span class="directive">const</span> Coords*, MPI_Comm cart); <b class="conum">(2)</b>
<span class="directive">void</span> field_scale(Field*, <span class="predefined-type">float</span> scale); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>sample field to a new grid size <code>N</code></p>
</li>
<li>
<p>dump field to "wall.h5"</p>
</li>
<li>
<p>scale field by <code>scale</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_label">32.2.4. label</h4>
<div class="paragraph">
<p>a simple tool to mark particles in wall regions</p>
</div>
<div class="paragraph">
<p>labels can be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">    LABEL_BULK,  <span class="comment">/* remains in bulk */</span>
    LABEL_WALL,  <span class="comment">/* becomes wall particle */</span>
    LABEL_DEEP   <span class="comment">/* deep inside the wall */</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_label_dev(<span class="directive">const</span> Sdf *sdf, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> <span class="predefined-type">int</span> *labels); <b class="conum">(1)</b>
<span class="directive">void</span> wall_label_hst(<span class="directive">const</span> Sdf *sdf, <span class="predefined-type">int</span> n, <span class="directive">const</span> Particle*, <span class="comment">/**/</span> <span class="predefined-type">int</span> *labels); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>set labels on an array of particles on device</p>
</li>
<li>
<p>set labels on an array of particles on host</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_tex3d">32.2.5. tex3D</h4>
<div class="paragraph">
<p>a simple texture object manager for representing 3d grid scalar field</p>
</div>
<div class="sect4">
<h5 id="_data_structures_7">data structures</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> Tex3d_v { cudaTextureObject_t t; }; <b class="conum">(1)</b>
<span class="keyword">struct</span> Tex3d   { cudaTextureObject_t t; }; <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>view, to be passed on device</p>
</li>
<li>
<p>Host structure</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_interface_39">interface</h5>
<div class="paragraph">
<p>allocate and destroy texture object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> tex3d_ini(Tex3d**);
<span class="directive">void</span> tex3d_fin(Tex3d*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>manipulate texture object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> tex3d_copy(<span class="directive">const</span> Array3d*, <span class="comment">/**/</span> Tex3d*);    <b class="conum">(1)</b>
<span class="directive">void</span> tex3d_to_view(<span class="directive">const</span> Tex3d*, <span class="comment">/**/</span> Tex3d_v*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>create texture object from <code>Array3d</code> object</p>
</li>
<li>
<p>create a view to be passed to kernels</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tform">32.2.6. tform</h4>
<div class="paragraph">
<p>A simple set of linear transformations for sdf.
Based on <a href="#math_tform">tform module</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="comment">/* T: texture size, N: sdf file size, M: wall margin */</span>
<span class="directive">void</span> tex2sdf_ini(<span class="directive">const</span> Coords*, <span class="directive">const</span> <span class="predefined-type">int</span> T[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">int</span> N[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">int</span> M[<span class="integer">3</span>], <span class="comment">/**/</span> Tform*); <b class="conum">(1)</b>
<span class="directive">void</span> out2sdf_ini(<span class="directive">const</span> Coords*, <span class="directive">const</span> <span class="predefined-type">int</span> N[<span class="integer">3</span>], <span class="comment">/**/</span> Tform*); <b class="conum">(2)</b>
<span class="directive">void</span> sub2tex_ini(<span class="directive">const</span> Coords*, <span class="directive">const</span> <span class="predefined-type">int</span> T[<span class="integer">3</span>], <span class="directive">const</span> <span class="predefined-type">int</span> M[<span class="integer">3</span>], <span class="comment">/**/</span> Tform*); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>transform from texture coordinates to sdf coordinates</p>
</li>
<li>
<p>transform from Glbal coordinates to sdf coordinates</p>
</li>
<li>
<p>transform from subdomain coordinates to texture coordinates</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_struct_helper_structures">33. Struct: helper structures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Helper structures to pass particle data between modules.</p>
</div>
<div class="sect2">
<h3 id="_partlist">33.1. partlist</h3>
<div class="paragraph">
<p>Part list: a structure to handle a list of dead or alive particles
Purpose: kill particles during redistribution or cell lists build</p>
</div>
<div class="sect3">
<h4 id="_data_structure_7">33.1.1. data structure</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> PartList {
    <span class="directive">const</span> Particle *pp;   <span class="comment">/* particles array          */</span>
    <span class="directive">const</span> <span class="predefined-type">int</span> *deathlist; <span class="comment">/* what pp is dead or alive */</span>
};</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interface_40">33.1.2. interface</h4>
<div class="paragraph">
<p>contains only device interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">static</span> __device__ <span class="predefined-type">bool</span> is_dead(<span class="predefined-type">int</span> i, <span class="directive">const</span> PartList lp) {
    <span class="keyword">if</span> (lp.deathlist)
        <span class="keyword">return</span> lp.deathlist[i] == DEAD;
    <span class="keyword">return</span> <span class="predefined-constant">false</span>;
}

<span class="directive">static</span> __device__ <span class="predefined-type">bool</span> is_alive(<span class="predefined-type">int</span> i, <span class="directive">const</span> PartList lp) {
    <span class="keyword">return</span> !is_dead(i, lp);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parray">33.2. parray</h3>
<div class="paragraph">
<p>Generic particle array to be passed to interaction kernels.</p>
</div>
<div class="sect3">
<h4 id="_host_interface_4">33.2.1. host interface</h4>
<div class="paragraph">
<p>A <code>PaArray</code> structure can be configured by pushing particles and,
optionally, colors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> parray_push_pp(<span class="directive">const</span> Particle *pp, PaArray *a);
<span class="directive">void</span> parray_push_cc(<span class="directive">const</span> <span class="predefined-type">int</span> *cc, PaArray *a);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Particles must be pushed before colors
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Client can check if the colors has been pushed by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">bool</span> parray_is_colored(<span class="directive">const</span> PaArray *a);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The particle array data are meant to be passed to kernels.
In order to inline the fetching mode (see device interface), different
views can be generated from the <code>PaArray</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> parray_get_view(<span class="directive">const</span> PaArray *a, PaArray_v *v);  <b class="conum">(1)</b>
<span class="directive">void</span> parray_get_view(<span class="directive">const</span> PaArray *a, PaCArray_v *v); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get a view to fetch particles without colors</p>
</li>
<li>
<p>Get a view to fetch particles with colors</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_device_interface_3">33.2.2. device interface</h4>
<div class="paragraph">
<p>Generic particle (see <em>pair</em> module)  can be fetched depending on the view:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">_I_ <span class="directive">void</span> parray_get(PaArray_v a, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> PairPa *p) <b class="conum">(1)</b>
_I_ <span class="directive">void</span> parray_get(PaCArray_v a, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> PairPa *p) <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>fetch position and velocity only</p>
</li>
<li>
<p>fetch position, velocity and color</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_farray">33.3. farray</h3>
<div class="paragraph">
<p>Generic force array to be passed to interaction kernels.
Implemented versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>forces only</p>
</li>
<li>
<p>forces and stresses</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_host_interface_5">33.3.1. host interface</h4>
<div class="paragraph">
<p>A <code>FoArray</code> structure can be configured by pushing forces and,
optionally, stresses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> farray_push_ff(Force *ff, FoArray *a);
<span class="directive">void</span> farray_push_ss(<span class="predefined-type">float</span> *ss, FoArray *a);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Forces must be pushed before stresses
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Client can check if the stresses has been pushed by calling</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">bool</span> farray_has_stress(<span class="directive">const</span> FoArray *a);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The force array data are meant to be passed to kernels.
In order to inline the forces computations mode (see device interface), different
views can be generated from the <code>FoArray</code> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> farray_get_view(<span class="directive">const</span> FoArray *a, FoArray_v *v);  <b class="conum">(1)</b>
<span class="directive">void</span> farray_get_view(<span class="directive">const</span> FoArray *a, FoSArray_v *v); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get a view to compute forces only</p>
</li>
<li>
<p>Get a view to compute forces and stresses</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_device_interface_4">33.3.2. device interface</h4>
<div class="paragraph">
<p>Generic forces (see <em>pair</em> module) can be added to the generic force
array depending on the view type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">template</span> &lt;<span class="predefined-type">int</span> S&gt;
_I_ <span class="directive">void</span> farray_add(<span class="directive">const</span> PairFo *f, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> FoArray_v a) <b class="conum">(1)</b>
<span class="keyword">template</span> &lt;<span class="predefined-type">int</span> S&gt;
_I_ <span class="directive">void</span> farray_add(<span class="directive">const</span> PairSFo *f, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> FoSArray_v a) <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>add forces only to the array</p>
</li>
<li>
<p>add forces and stresse to the array</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The template parameter <code>S</code> is the sign, must be either <code>-1</code> or <code>1</code>.
Note that it only affects the forces, stresses are always added with
positive sign, as opposed to forces.</p>
</div>
<div class="paragraph">
<p>For equivalent atomic operations, the following functions can be called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">template</span> &lt;<span class="predefined-type">int</span> S&gt;
_I_ <span class="directive">void</span> farray_atomic_add(<span class="directive">const</span> PairFo *f, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> FoArray_v a)
<span class="keyword">template</span> &lt;<span class="predefined-type">int</span> S&gt;
_I_ <span class="directive">void</span> farray_atomic_add(<span class="directive">const</span> PairSFo *f, <span class="predefined-type">int</span> i, <span class="comment">/**/</span> FoSArray_v a)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generic Force structure can be initialised to 0 based on the type
of the Generic array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">_I_ PairFo farray_fo0(FoArray_v)
_I_ PairSFo farray_fo0(FoSArray_v)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_utils_2">34. utils</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_utility_functions">34.1. utility functions</h3>
<div class="paragraph">
<p>a set of utility functions</p>
</div>
<div class="sect3">
<h4 id="_general_tools">34.1.1. general tools</h4>
<div class="paragraph">
<p>the following functions are provided in the <code>imp.h</code> header file.</p>
</div>
<div class="paragraph">
<p>memory management functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> emalloc(size_t, <span class="comment">/**/</span> <span class="directive">void</span>**); <b class="conum">(1)</b>
<span class="directive">void</span> efree(<span class="directive">void</span>*); <b class="conum">(2)</b>
<span class="directive">void</span> *ememcpy(<span class="directive">void</span> *dest, <span class="directive">const</span> <span class="directive">void</span> *src, size_t n); <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>safe <code>malloc</code>: throws an error on failure</p>
</li>
<li>
<p>safe <code>free</code></p>
</li>
<li>
<p>safe <code>memcpy</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>convenient macros for the above functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="preprocessor">#define</span> EMALLOC(n, ppdata) UC(emalloc((n)*<span class="keyword">sizeof</span>(**(ppdata)), (<span class="directive">void</span>**)(ppdata)))
<span class="preprocessor">#define</span> EFREE(pdata) UC(efree(pdata))
<span class="preprocessor">#define</span> EMEMCPY(n, src, dest) ememcpy((<span class="directive">void</span>*)(dest), (<span class="directive">const</span> <span class="directive">void</span>*)(src), (n)*<span class="keyword">sizeof</span>(*(dest)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>safe versions of the <code>stdio</code> functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> efopen(<span class="directive">const</span> <span class="predefined-type">char</span> *fname, <span class="directive">const</span> <span class="predefined-type">char</span> *mode, <span class="comment">/**/</span> FILE**);
<span class="directive">void</span> efclose(FILE*);
<span class="directive">void</span> efread(<span class="directive">void</span> *ptr, size_t size, size_t nmemb, FILE*);
<span class="directive">void</span> efwrite(<span class="directive">const</span> <span class="directive">void</span> *ptr, size_t size, size_t nmemb, FILE*);
<span class="directive">void</span> efgets(<span class="predefined-type">char</span> *s, <span class="predefined-type">int</span> size, FILE*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>additional tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="predefined-type">bool</span> same_str(<span class="directive">const</span> <span class="predefined-type">char</span> *a, <span class="directive">const</span> <span class="predefined-type">char</span> *b); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>returns true if the two strings are the same</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_msg_messages">34.1.2. msg: messages</h4>
<div class="paragraph">
<p>a simple logging tool for many rank application.
a message is printed in the <code>stderr</code> stream by the master rank (rank 0).
all ranks also print the message in file <code>.XXX</code>, where <code>XXX</code> is the
MPI rank id.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> msg_ini(<span class="predefined-type">int</span> rank); <b class="conum">(1)</b>
<span class="directive">void</span> msg_print(<span class="directive">const</span> <span class="predefined-type">char</span> *fmt, ...); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>initialise the logger</p>
</li>
<li>
<p>log message. format is the same as printf</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_os_operating_system_tasks">34.1.3. os: operating system tasks</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> os_mkdir(<span class="directive">const</span> <span class="predefined-type">char</span>* path); <b class="conum">(1)</b>
<span class="predefined-type">long</span> os_time();                  <b class="conum">(2)</b>
<span class="directive">void</span> os_srand(<span class="predefined-type">long</span> <span class="predefined-type">int</span> seedval); <b class="conum">(3)</b>
<span class="predefined-type">double</span> os_drand();               <b class="conum">(4)</b>
<span class="directive">void</span> os_sleep(<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span> seconds); <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>create a directory</p>
</li>
<li>
<p>returns local time</p>
</li>
<li>
<p>seed for <code>os_drand()</code></p>
</li>
<li>
<p>returns double random number between 0 and 1</p>
</li>
<li>
<p>sleep for <code>seconds</code> seconds</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_error_handling">34.2. error handling</h3>
<div class="paragraph">
<p><em>uDeviceX</em> has a primitive error handling mechanism. Error is raised if</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ERR(fmt, &#8230;&#8203;)</code> is called. Syntax of ERR is the same as one of
<code>printf(3)</code>.</p>
</li>
<li>
<p>a function wrapped with <code>CC</code> returns a error code</p>
</li>
<li>
<p>a function wrapped with <code>MC</code> returns a error code</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If error is raised the <em>uDeviceX</em> aborts and prints a error message
with a function call trace. Only the function calls wrapped with <code>UC</code>
go into trace. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre>void c() { ERR("c failed"); }
void b() { UC(c()); }
void a() { UC(b()); }
void main () {
    a();
}</pre>
</div>
</div>
<div class="paragraph">
<p>produces a log with source file name and line number of two <code>UC</code> calls
and <code>ERR</code> call.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cc_cuda_check">34.3. cc: cuda check</h3>
<div class="paragraph">
<p>[C]uda [C]heck macro.</p>
</div>
<div class="paragraph">
<p>Error handling for cuda API calls.
usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">CC(my_cuda_api_call());</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">[error]</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_mc_mpi_check">34.4. mc: mpi check</h3>
<div class="paragraph">
<p>[M]PI [C]heck macro.</p>
</div>
<div class="paragraph">
<p>Error handling for MPI API calls.
usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">MC(my_mpi_api_call());</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MC</code> uses internally <code>UdxError</code> in case of failure. This allows to
dump a backtrace (see <a href="#error">[error]</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_kl_kernel_launch">34.5. kl: kernel launch</h3>
<div class="paragraph">
<p>[K]ernel [L]aunch macro.</p>
</div>
<div class="paragraph">
<p>a macro for cuds kernel launches</p>
</div>
<div class="paragraph">
<p>All but <code>unsafe</code> skip kernels with zero thread number.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp">KL(fun, (i+<span class="integer">1</span>, j, k), ())     -&gt; fun&lt;&lt;&lt;i+<span class="integer">1</span>, j, k&gt;&gt;&gt;()
KL(fun, (i+<span class="integer">1</span>, j, k), (a, b)) -&gt; fun&lt;&lt;&lt;i+<span class="integer">1</span>, j, k&gt;&gt;&gt;(a, b)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_texo_texture_object">34.6. texo: texture object</h3>
<div class="paragraph">
<p>a simple wrapper for texture objects in cuda.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<span class="keyword">struct</span> Texo {
    cudaTextureObject_t d;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>on host: create and destroy the texture object of a given type <code>T</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> texo_setup(<span class="predefined-type">int</span> n, T *data, <span class="comment">/**/</span> Texo&lt;T&gt; *to)
<span class="directive">void</span> texo_destroy(<span class="comment">/**/</span> Texo&lt;T&gt; *to)</code></pre>
</div>
</div>
<div class="paragraph">
<p>on device: fetch from texture object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">const</span> T texo_fetch(<span class="directive">const</span> Texo&lt;T&gt; t, <span class="directive">const</span> <span class="predefined-type">int</span> i)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wall">35. wall</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Manages frozen wall particles data.</p>
</div>
<div class="sect2">
<h3 id="_data_structure_8">35.1. data structure</h3>
<div class="paragraph">
<p>The data is stored in a visible structure. The user can access
directly the fields.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> WallQuants {
    float4 *pp; <span class="comment">/* particle positions xyzo xyzo ... */</span>
    <span class="predefined-type">int</span> n;      <span class="comment">/* number of particles              */</span>
    int3 L;     <span class="comment">/* subdomain size                   */</span>
};

<span class="keyword">struct</span> WallTicket;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only positions of the particles are stored, Their velocity can be
computed by using the <a href="#wall_wvel">wvel submodule</a>.</p>
</div>
<div class="paragraph">
<p>The <code>Ticket</code> hidden structure contains helpers (cell lists, texture objects,
random number generator) for force interactions with external
particles.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interface_41">35.2. interface</h3>
<div class="paragraph">
<p>allocate and deallocate the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_ini_quants(int3 L, WallQuants*);
<span class="directive">void</span> wall_ini_ticket(int3 L, WallTicket**);

<span class="directive">void</span> wall_fin_quants(WallQuants*);
<span class="directive">void</span> wall_fin_ticket(WallTicket*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>generate the quantities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_gen_quants(MPI_Comm, <span class="predefined-type">int</span> maxn, <span class="directive">const</span> Sdf*, <span class="comment">/* io */</span> <span class="predefined-type">int</span> *o_n, Particle *o_pp, <span class="comment">/**/</span> WallQuants*); <b class="conum">(1)</b>
<span class="directive">void</span> wall_gen_ticket(<span class="directive">const</span> WallQuants*, WallTicket*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>freeze the particles from a given equilibrated array of solvent particles
occupying the subdomain. The input array of particles is resized
and only solvent particles remain. Creates additional "margin
particles" copied from neighbouring ranks. See <a href="#wall_exch">exch</a>.</p>
</li>
<li>
<p>generate <code>Ticket</code> structure from quantities</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#io_restart">restart</a> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_strt_quants(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="predefined-type">int</span> maxn, WallQuants*); <b class="conum">(1)</b>
<span class="directive">void</span> wall_strt_dump_templ(MPI_Comm, <span class="directive">const</span> <span class="predefined-type">char</span> *base, <span class="directive">const</span> WallQuants*); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>read quantities from restart files</p>
</li>
<li>
<p>dump quantities to restart files (set 0 velocity to particles)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>compute interactions with other particles (see <a href="#wall_force">force submodule</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_force(<span class="directive">const</span> PairParams*, <span class="directive">const</span> WvelStep *, <span class="directive">const</span> Coords*, <span class="directive">const</span> Sdf*, <span class="directive">const</span> WallQuants*,
                <span class="directive">const</span> WallTicket*, <span class="predefined-type">int</span> n, <span class="directive">const</span> PaArray*, <span class="directive">const</span> FoArray*);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_submodules_7">35.3. submodules</h3>
<div class="sect3">
<h4 id="wall_exch">35.3.1. exch</h4>
<div class="paragraph">
<p>a simple module to exchange the "margin particles" between
neighbouring ranks (on host).
These particles are used in interactions and act as <em>ghost particles</em>.</p>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_exch_pp(MPI_Comm cart, int3 L, <span class="predefined-type">int</span> maxn, <span class="comment">/*io*/</span> Particle *pp, <span class="predefined-type">int</span> *n);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>maxn</code> is the maximum number of particles that can be stored in the
<code>pp</code> buffer.</p>
</div>
</div>
<div class="sect3">
<h4 id="wall_force">35.3.2. force</h4>
<div class="paragraph">
<p>compute interaction forces between frozen wall particles and other particles.</p>
</div>
<div class="paragraph">
<p>interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="directive">void</span> wall_force_apply(<span class="directive">const</span> PairParams*, <span class="directive">const</span> WvelStep*, <span class="directive">const</span> Coords*, <span class="directive">const</span> PaArray*, <span class="predefined-type">int</span> n, RNDunif*, WallForce,
                      <span class="comment">/**/</span> <span class="directive">const</span> FoArray*);</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the helper structure <code>WallForce</code> acts as a view to be passed to
the kernel. It is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cpp"><span class="keyword">struct</span> WallForce { <span class="comment">/* local wall data */</span>
    Sdf_v sdf_v;
    Texo&lt;<span class="predefined-type">int</span>&gt; start;
    Texo&lt;float4&gt; pp;
    <span class="predefined-type">int</span> n;
    int3 L;
};</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sdf">35.3.3. sdf</h4>
<div class="paragraph">
<p>See <a href="#sdf">sdf: signed distance function</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="wall_wvel">35.3.4. wvel</h4>
<div class="paragraph">
<p>Wall velocity field.
Used to set velocity to wall particles for wall interactions.
Also used to get wall velocity for bounce back on walls</p>
</div>
<div class="sect4">
<h5 id="_data_structures_8">data structures</h5>
<div class="paragraph">
<p>data structures are separated into 3 kinds of data structures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Wvel</code> (hidden), which contains all informations needed for the velocity
field. It is hold and maintained on host.</p>
</li>
<li>
<p><code>WvelStep</code> (hidden), containing only the information needed for one
specific time step. It is generated from <code>Wvel</code> structure.</p>
</li>
<li>
<p>Views, passed to kernels. They are generated from the <code>WvelStep</code> structure.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_interface_42">interface</h5>
<div class="paragraph">
<p>Interface is splitted between host and device</p>
</div>
<div class="sect5">
<h6 id="_host">Host</h6>
<div class="paragraph">
<p>Host code is responsible for initialisation of <code>Wvel</code> and convert
<code>Wvel</code> to a view at a given timestep.</p>
</div>
<div class="paragraph">
<p>alloc, free structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> wvel_ini(Wvel **wv);
<span class="directive">void</span> wvel_fin(Wvel *wv);

<span class="directive">void</span> wvel_step_ini(WvelStep **wv);
<span class="directive">void</span> wvel_step_fin(WvelStep *wv);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> wvel_set_cste(float3 u, Wvel *vw);
<span class="directive">void</span> wvel_set_shear(<span class="predefined-type">float</span> gdot, <span class="predefined-type">int</span> vdir, <span class="predefined-type">int</span> gdir, Wvel *vw);
<span class="directive">void</span> wvel_set_shear_sin(<span class="predefined-type">float</span> gdot, <span class="predefined-type">int</span> vdir, <span class="predefined-type">int</span> gdir, <span class="predefined-type">float</span> w, Wvel *vw);
<span class="directive">void</span> wvel_set_hs(<span class="predefined-type">float</span> u, <span class="predefined-type">float</span> h, Wvel *vw);
<span class="directive">void</span> wvel_set_timestep(<span class="predefined-type">float</span> dt, Wvel *vw);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set velocity type from configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> wvel_set_conf(<span class="directive">const</span> Config *cfg, Wvel *vw);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get <em>step</em> structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> wvel_get_step(<span class="predefined-type">float</span> t, <span class="directive">const</span> Wvel *wv, <span class="comment">/**/</span> WvelStep *);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get <em>view</em> structures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> wvel_get_view(<span class="directive">const</span> WvelStep *w, <span class="comment">/**/</span> WvelCste_v *v);
<span class="directive">void</span> wvel_get_view(<span class="directive">const</span> WvelStep *w, <span class="comment">/**/</span> WvelShear_v *v);
<span class="directive">void</span> wvel_get_view(<span class="directive">const</span> WvelStep *w, <span class="comment">/**/</span> WvelHS_v *v);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The convertion to <em>view</em> structures can be dispatch using the type of
the parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="keyword">enum</span> {
    WALL_VEL_V_CSTE,
    WALL_VEL_V_SHEAR,
    WALL_VEL_V_HS,
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>which can be retrieved from the <em>Step</em> structure using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> wvel_get_type(<span class="directive">const</span> WvelStep *w);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_device">Device</h6>
<div class="paragraph">
<p>Velocity field can be retrieved, depending on the view structure, using</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">static</span> __device__ <span class="directive">void</span> wvel(WvelCste_v p, Coords_v c, float3 r, <span class="comment">/**/</span> float3 *v)
<span class="directive">static</span> __device__ <span class="directive">void</span> wvel(WvelShear_v p, Coords_v c, float3 r, <span class="comment">/**/</span> float3 *v)
<span class="directive">static</span> __device__ <span class="directive">void</span> wvel(WvelHS_v p, Coords_v c, float3 r, <span class="comment">/**/</span> float3 *v)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bounce function: gives bounced-back velocity from
position and velocity of particle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Wvel_v&gt;
<span class="directive">static</span> __device__ <span class="directive">void</span> bounce_vel(Wvel_v wv, Coords_v c, float3 rw, <span class="comment">/* io */</span> float3* v)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuration_10">Configuration</h5>
<div class="sect5">
<h6 id="_constant_2">constant</h6>
<div class="paragraph">
<p>constant velocity \(u = (1, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel = {
    type = &quot;constant&quot;
    u    = [1.0, 0.0, 0.0]
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_shear_2">shear</h6>
<div class="paragraph">
<p>shear velocity \(u = (3 y, 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel = {
    type = &quot;shear&quot;
    gdot = 3.0
    vdir = 0
    gdir = 1
    half = 0
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_sinusoidal_shear">sinusoidal shear</h6>
<div class="paragraph">
<p>shear velocity \(u(t) = (3 y \sin(5 t), 0, 0)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel = {
    type = &quot;shear sin&quot;
    gdot = 3.0
    vdir = 0
    gdir = 1
    w = 5.0
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_hele_shaw">Hele Shaw</h6>
<div class="paragraph">
<p>velocity \(u_r = \frac u r \left(1 - \frac {4 z^2}{h^2}\right)\):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cfg">wvel = {
    type = &quot;hele shaw&quot;
    u = 1.0
    h = 8.0
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_third_party_dependencies">36. third party dependencies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_nvcc">36.1. nvcc</h3>
<div class="paragraph">
<p><a href="http://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc">cuda compiler driver</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_mpi_library">36.2. MPI library</h3>
<div class="paragraph">
<p>To get the flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mpicxx -show</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pkg-config --libs mpich</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_libconfig">36.3. libconfig</h3>
<div class="paragraph">
<p><a href="http://hyperrealm.com/libconfig/libconfig.html">a library for processing structured configuration files</a></p>
</div>
<div class="sect3">
<h4 id="_from_source">36.3.1. from source</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">v=1.7.1
wget https://hyperrealm.github.io/libconfig/dist/libconfig-$v.tar.gz
tar zxvf libconfig-$v.tar.gz
cd libconfig-$v
./configure --prefix=${HOME}/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_from_git">36.3.2. from git</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">git clone git@github.com:hyperrealm/libconfig.git
cd libconfig
autoreconf
./configure --prefix=${HOME}/prefix/libconfig --disable-cxx
make -j
make install</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_from_apt">36.3.3. from apt</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">sudo apt install libconfig-dev</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pkgconfig">36.3.4. pkgconfig</h4>
<div class="paragraph">
<p>add path for pkg config</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:$HOME/prefix/libconfig/lib/pkgconfig</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="third_h5">36.4. hdf5</h3>
<div class="paragraph">
<p>a data model, library, and file format for storing and managing data</p>
</div>
<div class="paragraph">
<p>To get the compilation and linking flags</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">h5c++ -show</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">pkg-config hdf5-mpich --libs</code></pre>
</div>
</div>
<div class="paragraph">
<p>To build from the
<a href="https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.17/src/hdf5-1.8.17.tar.gz">source</a></p>
</div>
<div class="paragraph">
<p>Configuration options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">      ./configure --prefix=$HOME/prefix/hdf5 --enable-parallel CXX=mpic++ CC=mpicc</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="third_bop">36.5. bop</h3>
<div class="paragraph">
<p>a simple format for particle data, see
<a href="https://github.com/amlucas/bop">bop</a>.</p>
</div>
<div class="paragraph">
<p>installation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">git clone git@github.com:amlucas/bop.git
cd bop
./configure [OPTIONS] <b class="conum">(1)</b>
make
make -s test</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>see <code>./configure --help</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wrappers">37. wrappers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="intro">37.1. intro</h3>
<div class="paragraph">
<p><code>u.run</code> respects several environment variables to modify the way <code>udx</code>
is run</p>
</div>
</div>
<div class="sect2">
<h3 id="mem">37.2. MEM</h3>
<div class="paragraph">
<p>if <code>MEM</code> is set <code>udx</code> is ran with <code>cuda-memcheck</code> and <code>MEM</code> is used as a
list of parameters</p>
</div>
<div class="listingblock">
<div class="content">
<pre>MEM= u.test test/*
MEM='--leakcheck --blocking'              u.test test/*
MEM='--tool initcheck'                    u.test test/*</pre>
</div>
</div>
<div class="paragraph">
<p>see also <a href="poc/memcheck">poc/memcheck</a></p>
</div>
</div>
<div class="sect2">
<h3 id="val">37.3. VAL</h3>
<div class="paragraph">
<p>if <code>VAL</code> is set <code>udx</code> is ran with valgrind and <code>VAL</code> is used as a list
of parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>VAL= u.test test/*
VAL="--leak-check=full --show-leak-kinds=all"  u.test test/*</pre>
</div>
</div>
<div class="paragraph">
<p><code>u.run</code> respect <code>DRYRUN</code> : only show the commands do not execute them</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DRYRUN= VAL=--option u.run ./udx

module: load cray-hdf5-parallel cudatoolkit daint-gpu
cmd: srun -n 1 -u valgrind --option ./udx</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="prof">37.4. PROF</h3>
<div class="paragraph">
<p>if <code>PROF</code> is set is ran with <code>nvprof</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>PROF="--export-profile main.prof" u.run ./udx
nvprof -i main.prof</pre>
</div>
</div>
<div class="paragraph">
<p>See also <a href="poc/prof/ppbandwidth">poc/ppbandwidth</a></p>
</div>
</div>
<div class="sect2">
<h3 id="tim">37.5. TIM</h3>
<div class="paragraph">
<p>if <code>TIM</code> is set is ran with <code>time</code></p>
</div>
</div>
</div>
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>